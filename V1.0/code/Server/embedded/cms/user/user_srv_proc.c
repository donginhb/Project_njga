
/*----------------------------------------------*
 * 包含头文件                                   *
 *----------------------------------------------*/
#include <stdio.h>
#ifdef WIN32
#include <winsock.h>
#include <sys/types.h>
#else
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include <string.h>
#include <errno.h>
#endif

#include "common/gblfunc_proc.inc"
#include "common/gblconfig_proc.inc"
#include "common/log_proc.inc"
#include "common/db_proc.h"
#include "platformms/BoardInit.h"

#include "user/user_srv_proc.inc"

#include "device/device_info_mgn.inc"
#include "device/device_srv_proc.inc"

#include "route/route_info_mgn.inc"

#include "service/call_func_proc.inc"

#include "record/record_srv_proc.inc"
#include "record/record_info_mgn.inc"
#include "service/poll_srv_proc.inc"
#include "service/plan_srv_proc.inc"
#include "service/cruise_srv_proc.inc"
#include "service/preset_proc.inc"

#include "resource/resource_info_mgn.inc"

/*----------------------------------------------*
 * 外部变量说明                                 *
 *----------------------------------------------*/
extern gbl_conf_t* pGblconf;              /* 全局配置信息 */
extern BOARD_NET_ATTR  g_BoardNetConfig;
extern int g_IsPay;                       /* 是否付费，默认1 */
extern int g_LocalMediaTransferFlag;      /* 下级媒体流是否经过本地TSU转发,默认转发 */
extern char g_StrConLog[2][100];

/*----------------------------------------------*
 * 外部函数原型说明                             *
 *----------------------------------------------*/

/*----------------------------------------------*
 * 内部函数原型说明                             *
 *----------------------------------------------*/
user_response_msg_list_t* g_UserResponseMsgList;    /* 需要回应的用户Message 消息队列*/

/*----------------------------------------------*
 * 全局变量                                     *
 *----------------------------------------------*/
unsigned int g_transfer_xml_sn = 0;      /* 全局的转发XML的SN */

/*----------------------------------------------*
 * 模块级变量                                   *
 *----------------------------------------------*/

/*----------------------------------------------*
 * 常量定义                                     *
 *----------------------------------------------*/

/*----------------------------------------------*
 * 宏定义                                       *
 *----------------------------------------------*/
#if DECS("用户业务消息")
/*****************************************************************************
 函 数 名  : user_srv_msg_init
 功能描述  : 用户业务消息结构初始化
 输入参数  : user_srv_msg_t ** user_srv_msg
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月11日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_srv_msg_init(user_srv_msg_t** user_srv_msg)
{
    *user_srv_msg = (user_srv_msg_t*)osip_malloc(sizeof(user_srv_msg_t));

    if (*user_srv_msg == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_srv_msg_init() exit---: *user_srv_msg Smalloc Error \r\n");
        return -1;
    }

    (*user_srv_msg)->msg_type = MSG_TYPE_NULL;
    (*user_srv_msg)->caller_id[0] = '\0';
    (*user_srv_msg)->callee_id[0] = '\0';
    (*user_srv_msg)->response_code = 0;
    (*user_srv_msg)->reasonphrase[0] = '\0';
    (*user_srv_msg)->ua_dialog_index = -1;
    (*user_srv_msg)->msg_body[0] = '\0';
    (*user_srv_msg)->msg_body_len = 0;
    (*user_srv_msg)->cr_pos = -1;

    return 0;
}

/*****************************************************************************
 函 数 名  : user_srv_msg_free
 功能描述  : 用户业务消息结构释放
 输入参数  : user_srv_msg_t * user_srv_msg
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月11日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
void user_srv_msg_free(user_srv_msg_t* user_srv_msg)
{
    if (user_srv_msg == NULL)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_srv_msg_free() exit---: Param Error \r\n");
        return;
    }

    user_srv_msg->msg_type = MSG_TYPE_NULL;

    memset(user_srv_msg->caller_id, 0, MAX_ID_LEN + 4);
    memset(user_srv_msg->callee_id, 0, MAX_ID_LEN + 4);

    user_srv_msg->response_code = 0;

    memset(user_srv_msg->reasonphrase, 0, MAX_128CHAR_STRING_LEN + 4);

    user_srv_msg->ua_dialog_index = -1;

    memset(user_srv_msg->msg_body, 0, MAX_MSG_BODY_STRING_LEN + 4);

    user_srv_msg->msg_body_len = 0;
    user_srv_msg->cr_pos = -1;

    osip_free(user_srv_msg);
    user_srv_msg = NULL;

    return;
}

/*****************************************************************************
 函 数 名  : user_srv_msg_add
 功能描述  : 添加用户业务消息到队列中
 输入参数  : user_srv_proc_tl_t* pUserSrvProcThd
             msg_type_t msg_type
             char* caller_id
             char* callee_id
             int response_code
             char* reasonphrase
             int ua_dialog_index
             char* msg_body
             int msg_body_len
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月11日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_srv_msg_add(user_srv_proc_tl_t* pUserSrvProcThd, msg_type_t msg_type, char* caller_id, char* callee_id, int response_code, char* reasonphrase, int ua_dialog_index, char* msg_body, int msg_body_len, int cr_pos)
{
    user_srv_msg_t* pUserSrvMsg = NULL;
    int iRet = 0;

    if (NULL == pUserSrvProcThd || caller_id == NULL || callee_id == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_srv_msg_add() exit---: Param Error \r\n");
        return -1;
    }

    if (NULL == pUserSrvProcThd->pUserSrvMsgQueue)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_srv_msg_add() exit---: Param Error \r\n");
        return -1;
    }

    iRet = user_srv_msg_init(&pUserSrvMsg);

    if (iRet != 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_add() exit---: Message Init Error \r\n");
        return -1;
    }

    pUserSrvMsg->msg_type = msg_type;

    if (NULL != caller_id)
    {
        osip_strncpy(pUserSrvMsg->caller_id, caller_id, MAX_ID_LEN);
    }

    if (NULL != callee_id)
    {
        osip_strncpy(pUserSrvMsg->callee_id, callee_id, MAX_ID_LEN);
    }

    pUserSrvMsg->response_code = response_code;

    if (NULL != reasonphrase)
    {
        osip_strncpy(pUserSrvMsg->reasonphrase, reasonphrase, MAX_128CHAR_STRING_LEN);
    }

    pUserSrvMsg->ua_dialog_index = ua_dialog_index;

    if (NULL != msg_body)
    {
        osip_strncpy(pUserSrvMsg->msg_body, msg_body, MAX_MSG_BODY_STRING_LEN);
    }

    pUserSrvMsg->msg_body_len = msg_body_len;

    pUserSrvMsg->cr_pos = cr_pos;

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_LOCK((struct osip_mutex*)pUserSrvProcThd->pUserSrvMsgQueueLock);
#endif

    pUserSrvProcThd->pUserSrvMsgQueue->push_back(pUserSrvMsg);

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_UNLOCK((struct osip_mutex*)pUserSrvProcThd->pUserSrvMsgQueueLock);
#endif

    return 0;
}

/*****************************************************************************
 函 数 名  : user_srv_msg_list_clean
 功能描述  : 用户业务队列消息清除
 输入参数  : user_srv_proc_tl_t* run
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年3月8日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
void user_srv_msg_list_clean(user_srv_proc_tl_t* run)
{
    int iRet = 0;
    user_srv_msg_t* pUserSrvMsg = NULL;

    if (NULL == run)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_list_clean() Param Error \r\n");
        return;
    }

    if (NULL == run->pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_list_clean() User Info Error \r\n");
        return;
    }

    if (NULL == run->pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_list_clean() User Srv dboper Error \r\n");
        return;
    }

    if (NULL == run->pUserSrvMsgQueue)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_list_clean() User Srv Message Queue Error \r\n");
        return;
    }

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_LOCK((struct osip_mutex*)run->pUserSrvMsgQueueLock);
#endif

    while (!run->pUserSrvMsgQueue->empty())
    {
        pUserSrvMsg = (user_srv_msg_t*) run->pUserSrvMsgQueue->front();
        run->pUserSrvMsgQueue->pop_front();

        if (NULL != pUserSrvMsg)
        {
            user_srv_msg_free(pUserSrvMsg);
            pUserSrvMsg = NULL;
        }
    }

    run->pUserSrvMsgQueue->clear();

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_UNLOCK((struct osip_mutex*)run->pUserSrvMsgQueueLock);
#endif

    return;
}

/*****************************************************************************
 函 数 名  : scan_user_srv_msg_list
 功能描述  : 扫描用户业务消息队列
 输入参数  : user_info_t* pUserInfo
             user_srv_msg_queue* pUserSrvMsgQueue
             DBOper* pUser_Srv_dboper

 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int scan_user_srv_msg_list(user_srv_proc_tl_t* run)
{
    int iRet = 0;
    user_srv_msg_t* pUserSrvMsg = NULL;
    static int connect_interval = 0;

    if (NULL == run)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "scan_user_srv_msg_list() Param Error \r\n");
        return -1;
    }

    if (NULL == run->pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "scan_user_srv_msg_list() User Info Error \r\n");
        return -1;
    }

    if (NULL == run->pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "scan_user_srv_msg_list() User Srv dboper Error \r\n");
        return -1;
    }

    if (NULL == run->pUserSrvMsgQueue)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "scan_user_srv_msg_list() User Srv Message Queue Error \r\n");
        return -1;
    }

    if (!run->iUserLogDBOperConnectStatus)
    {
        connect_interval++;

        if (connect_interval >= 60 * 200)
        {
            if (run->pUserLogDbOper->Connect(g_StrConLog, (char*)"") < 0)
            {
                run->iUserLogDBOperConnectStatus = 0;
            }
            else
            {
                run->iUserLogDBOperConnectStatus = 1;
            }

            connect_interval = 0;
        }
    }

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_LOCK((struct osip_mutex*)run->pUserSrvMsgQueueLock);
#endif

    while (!run->pUserSrvMsgQueue->empty())
    {
        pUserSrvMsg = (user_srv_msg_t*) run->pUserSrvMsgQueue->front();
        run->pUserSrvMsgQueue->pop_front();

        if (NULL != pUserSrvMsg)
        {
            break;
        }
    }

#ifdef MULTI_THR
    CMS_GBL_SMUTEX_UNLOCK((struct osip_mutex*)run->pUserSrvMsgQueueLock);
#endif

    if (NULL != pUserSrvMsg)
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO,  "scan_user_srv_msg_list() \
        \r\n In Param: \
        \r\n msg_type=%d \
        \r\n caller_id=%s \
        \r\n callee_id=%s \
        \r\n response_code=%d \
        \r\n ua_dialog_index=%d \
        \r\n msg_body_len=%d \
        \r\n ", pUserSrvMsg->msg_type, pUserSrvMsg->caller_id, pUserSrvMsg->callee_id, pUserSrvMsg->response_code, pUserSrvMsg->ua_dialog_index, pUserSrvMsg->msg_body_len);

        if (!run->iUserLogDBOperConnectStatus)
        {
            iRet = user_srv_msg_proc(run->pUserInfo, pUserSrvMsg, run->pUser_Srv_dboper, NULL);
        }
        else
        {
            iRet = user_srv_msg_proc(run->pUserInfo, pUserSrvMsg, run->pUser_Srv_dboper, run->pUserLogDbOper);
        }

        user_srv_msg_free(pUserSrvMsg);
        pUserSrvMsg = NULL;
    }

    return 0;
}
#endif

#if DECS("需要回应的用户Message消息")
/*****************************************************************************
 函 数 名  : user_response_msg_init
 功能描述  : 需要回应的用户Message消息结构初始化
 输入参数  : user_response_msg_t ** user_response_msg
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_init(user_response_msg_t** user_response_msg)
{
    *user_response_msg = (user_response_msg_t*)osip_malloc(sizeof(user_response_msg_t));

    if (*user_response_msg == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_init() exit---: *user_response_msg Smalloc Error \r\n");
        return -1;
    }

    (*user_response_msg)->msg_type = XML_TYPE_NULL;
    (*user_response_msg)->message_sn[0] = '\0';
    (*user_response_msg)->pUserInfo = NULL;
    (*user_response_msg)->source_id[0] = '\0';
    (*user_response_msg)->dc_id[0] = '\0';
    (*user_response_msg)->dialog_index = -1;

    return 0;
}

/*****************************************************************************
 函 数 名  : user_response_msg_free
 功能描述  : 需要回应的用户Message消息结构释放
 输入参数  : user_response_msg_t * user_response_msg
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
void user_response_msg_free(user_response_msg_t* user_response_msg)
{
    if (user_response_msg == NULL)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_free() exit---: Param Error \r\n");
        return;
    }

    user_response_msg->msg_type = XML_TYPE_NULL;

    memset(user_response_msg->message_sn, 0, MAX_32CHAR_STRING_LEN + 4);

    user_response_msg->pUserInfo = NULL;

    memset(user_response_msg->source_id, 0, MAX_ID_LEN + 4);
    memset(user_response_msg->dc_id, 0, MAX_ID_LEN + 4);

    user_response_msg->dialog_index = -1;

    osip_free(user_response_msg);
    user_response_msg = NULL;

    return;
}

/*****************************************************************************
 函 数 名  : user_response_msg_list_init
 功能描述  : 需要回应的用户Message消息队列初始化
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_list_init()
{
    g_UserResponseMsgList = (user_response_msg_list_t*)osip_malloc(sizeof(user_response_msg_list_t));

    if (g_UserResponseMsgList == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_init() exit---: *user_response_msg_list Smalloc Error \r\n");
        return -1;
    }

    g_UserResponseMsgList->pResponseMsgList = (osip_list_t*)osip_malloc(sizeof(osip_list_t));

    if (NULL == g_UserResponseMsgList->pResponseMsgList)
    {
        osip_free(g_UserResponseMsgList);
        g_UserResponseMsgList = NULL;
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_init() exit---: User Service Message List Init Error \r\n");
        return -1;
    }

    osip_list_init(g_UserResponseMsgList->pResponseMsgList);

#ifdef MULTI_THR
    /* init smutex */
    g_UserResponseMsgList->lock = (osip_mutex_t*)osip_mutex_init();

    if (NULL == g_UserResponseMsgList->lock)
    {
        osip_free(g_UserResponseMsgList->pResponseMsgList);
        g_UserResponseMsgList->pResponseMsgList = NULL;
        osip_free(g_UserResponseMsgList);
        g_UserResponseMsgList = NULL;
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_init() exit---: User Service Message List Lock Init Error \r\n");
        return -1;
    }

#endif
    return 0;
}

/*****************************************************************************
 函 数 名  : user_response_msg_list_free
 功能描述  : 需要回应的用户Message消息队列释放
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
void user_response_msg_list_free()
{
    if (NULL == g_UserResponseMsgList)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_free() exit---: Param Error \r\n");
        return;
    }

    if (NULL != g_UserResponseMsgList->pResponseMsgList)
    {
        osip_list_special_free(g_UserResponseMsgList->pResponseMsgList, (void (*)(void*))&user_response_msg_free);
        osip_free(g_UserResponseMsgList->pResponseMsgList);
        g_UserResponseMsgList->pResponseMsgList = NULL;
    }

#ifdef MULTI_THR

    if (NULL != g_UserResponseMsgList->lock)
    {
        osip_mutex_destroy((struct osip_mutex*)g_UserResponseMsgList->lock);
        g_UserResponseMsgList->lock = NULL;
    }

#endif
    osip_free(g_UserResponseMsgList);
    g_UserResponseMsgList = NULL;
    return;
}

/*****************************************************************************
 函 数 名  : user_response_msg_list_lock
 功能描述  : 需要回应的用户Message消息队列锁定
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_list_lock()
{
    int iRet = 0;

#ifdef MULTI_THR

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->lock == NULL)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_lock() exit---: Param Error \r\n");
        return -1;
    }

    iRet = osip_mutex_lock((struct osip_mutex*)g_UserResponseMsgList->lock);

#endif
    return iRet;
}

/*****************************************************************************
 函 数 名  : user_response_msg_list_unlock
 功能描述  : 需要回应的用户Message消息解锁
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_list_unlock()
{
    int iRet = 0;

#ifdef MULTI_THR

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->lock == NULL)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_list_unlock() exit---: Param Error \r\n");
        return -1;
    }

    iRet = osip_mutex_unlock((struct osip_mutex*)g_UserResponseMsgList->lock);

#endif
    return iRet;
}

/*****************************************************************************
 函 数 名  : debug_user_response_msg_list_lock
 功能描述  : 需要回应的用户Message消息队列锁定
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int debug_user_response_msg_list_lock(const char* file, int line, const char* func)
{
    int iRet = 0;

#ifdef MULTI_THR

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->lock == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "debug_user_response_msg_list_lock() exit---: Param Error \r\n");
        return -1;
    }

    iRet = osip_debug_mutex_lock((struct osip_mutex*)g_UserResponseMsgList->lock, file, line, func);

#endif
    return iRet;
}

/*****************************************************************************
 函 数 名  : debug_user_response_msg_list_unlock
 功能描述  : 需要回应的用户Message消息解锁
 输入参数  : 无
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int debug_user_response_msg_list_unlock(const char* file, int line, const char* func)
{
    int iRet = 0;

#ifdef MULTI_THR

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->lock == NULL)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "debug_user_response_msg_list_unlock() exit---: Param Error \r\n");
        return -1;
    }

    iRet = osip_debug_mutex_unlock((struct osip_mutex*)g_UserResponseMsgList->lock, file, line, func);

#endif
    return iRet;
}

/*****************************************************************************
 函 数 名  : user_response_msg_add
 功能描述  : 添加需要回应的用户Message消息到队列中
 输入参数  : xml_type_t msg_type
             char* message_sn
             user_info_t* pUserInfo
             char* source_id
             char* dc_id
             int dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_add(xml_type_t msg_type, char* message_sn, user_info_t* pUserInfo, char* source_id, char* dc_id, int dialog_index)
{
    user_response_msg_t* pUserResponseMsg = NULL;
    int iRet = 0;

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->pResponseMsgList == NULL
        || message_sn == NULL || pUserInfo == NULL
        || source_id == NULL || dc_id == NULL || dialog_index < 0)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_add() exit---: Param Error \r\n");
        return -1;
    }

    iRet = user_response_msg_init(&pUserResponseMsg);

    if (iRet != 0)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_response_msg_add() exit---: Message Init Error \r\n");
        return -1;
    }

    pUserResponseMsg->msg_type = msg_type;
    osip_strncpy(pUserResponseMsg->message_sn, message_sn, MAX_32CHAR_STRING_LEN);
    pUserResponseMsg->pUserInfo = pUserInfo;

    if (NULL != source_id)
    {
        osip_strncpy(pUserResponseMsg->source_id, source_id, MAX_ID_LEN);
    }

    if (NULL != dc_id)
    {
        osip_strncpy(pUserResponseMsg->dc_id, dc_id, MAX_ID_LEN);
    }

    pUserResponseMsg->dialog_index = dialog_index;

    USER_RESPMSG_SMUTEX_LOCK();

    iRet = osip_list_add(g_UserResponseMsgList->pResponseMsgList, pUserResponseMsg, -1); /* add to list tail */

    if (iRet < 0)
    {
        USER_RESPMSG_SMUTEX_UNLOCK();
        user_response_msg_free(pUserResponseMsg);
        pUserResponseMsg = NULL;
        //DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_response_msg_add() exit---: List Add Error \r\n");
        return -1;
    }

    USER_RESPMSG_SMUTEX_UNLOCK();
    return 0;
}

/*****************************************************************************
 函 数 名  : user_response_msg_remove
 功能描述  : 从队列中移除需要回应的用户Message消息
 输入参数  : int pos
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_remove(int pos)
{
    user_response_msg_t* pUserResponseMsg = NULL;

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->pResponseMsgList == NULL
        || pos < 0 || (pos >= osip_list_size(g_UserResponseMsgList->pResponseMsgList)))
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_remove() exit---: Param Error \r\n");
        return -1;
    }

    USER_RESPMSG_SMUTEX_LOCK();

    pUserResponseMsg = (user_response_msg_t*)osip_list_get(g_UserResponseMsgList->pResponseMsgList, pos);

    if (NULL == pUserResponseMsg)
    {
        USER_RESPMSG_SMUTEX_UNLOCK();
        //DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_response_msg_remove() exit---: Message NULL \r\n");
        return -1;
    }

    osip_list_remove(g_UserResponseMsgList->pResponseMsgList, pos);
    user_response_msg_free(pUserResponseMsg);
    pUserResponseMsg = NULL;
    USER_RESPMSG_SMUTEX_UNLOCK();
    return 0;
}

/*****************************************************************************
 函 数 名  : user_response_msg_find
 功能描述  : 查找需要回应的用户Message消息
 输入参数  : xml_type_t msg_type
                            int dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_find(xml_type_t msg_type, int dialog_index)
{
    int pos = -1;
    user_response_msg_t* pUserResponseMsg = NULL;

    if (NULL == g_UserResponseMsgList || g_UserResponseMsgList->pResponseMsgList == NULL
        || dialog_index < 0)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_find() exit---: Param Error \r\n");
        return -1;
    }

    USER_RESPMSG_SMUTEX_LOCK();

    if (osip_list_size(g_UserResponseMsgList->pResponseMsgList) <= 0)
    {
        USER_RESPMSG_SMUTEX_UNLOCK();
        //DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_response_msg_find() exit---: User Response Message List NULL \r\n");
        return -1;
    }

    for (pos = 0; pos < osip_list_size(g_UserResponseMsgList->pResponseMsgList); pos++)
    {
        pUserResponseMsg = (user_response_msg_t*)osip_list_get(g_UserResponseMsgList->pResponseMsgList, pos);

        if ((NULL == pUserResponseMsg) || (pUserResponseMsg->dialog_index < 0))
        {
            continue;
        }

        if ((msg_type == pUserResponseMsg->msg_type) && (pUserResponseMsg->dialog_index == dialog_index))
        {
            USER_RESPMSG_SMUTEX_UNLOCK();
            return pos;
        }
    }

    USER_RESPMSG_SMUTEX_UNLOCK();
    return -1;
}

/*****************************************************************************
 函 数 名  : user_response_msg_find_by_source_id_and_dc_id
 功能描述  : 根据电视墙ID和逻辑点位ID查找用户响应消息
 输入参数  : xml_type_t msg_type
             char* source_id
             char* dc_id
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年1月19日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_response_msg_find_by_source_id_and_dc_id(xml_type_t msg_type, char* source_id, char* dc_id)
{
    int pos = -1;
    user_response_msg_t* pUserResponseMsg = NULL;

    if (NULL == g_UserResponseMsgList || g_UserResponseMsgList->pResponseMsgList == NULL)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_find_by_source_id_and_dc_id() exit---: Param Error \r\n");
        return -1;
    }

    if (NULL == source_id || NULL == dc_id)
    {
        return -1;
    }

    USER_RESPMSG_SMUTEX_LOCK();

    if (osip_list_size(g_UserResponseMsgList->pResponseMsgList) <= 0)
    {
        USER_RESPMSG_SMUTEX_UNLOCK();
        //DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_response_msg_find_by_source_id_and_dc_id() exit---: User Response Message List NULL \r\n");
        return -1;
    }

    for (pos = 0; pos < osip_list_size(g_UserResponseMsgList->pResponseMsgList); pos++)
    {
        pUserResponseMsg = (user_response_msg_t*)osip_list_get(g_UserResponseMsgList->pResponseMsgList, pos);

        if ((NULL == pUserResponseMsg) || (pUserResponseMsg->dialog_index != 999999))
        {
            continue;
        }

        if ((msg_type == pUserResponseMsg->msg_type)
            && (0 == sstrcmp(source_id, pUserResponseMsg->source_id))
            && (0 == sstrcmp(dc_id, pUserResponseMsg->dc_id)))
        {
            USER_RESPMSG_SMUTEX_UNLOCK();
            return pos;
        }
    }

    USER_RESPMSG_SMUTEX_UNLOCK();
    return -1;
}


/*****************************************************************************
 函 数 名  : update_user_response_msg_dialog_index
 功能描述  : 更新用户的响应消息的会话句柄
 输入参数  : xml_type_t msg_type
             char* source_id
             char* dc_id
             int dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年1月19日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int update_user_response_msg_dialog_index(xml_type_t msg_type, char* source_id, char* dc_id, int dialog_index)
{
    int pos = -1;
    user_response_msg_t* pUserResponseMsg = NULL;

    if (NULL == g_UserResponseMsgList || g_UserResponseMsgList->pResponseMsgList == NULL
        || dialog_index < 0)
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "update_user_response_msg_dialog_index() exit---: Param Error \r\n");
        return -1;
    }

    USER_RESPMSG_SMUTEX_LOCK();

    if (osip_list_size(g_UserResponseMsgList->pResponseMsgList) <= 0)
    {
        USER_RESPMSG_SMUTEX_UNLOCK();
        //DEBUG_TRACE(MODULE_USER, LOG_WARN, "update_user_response_msg_dialog_index() exit---: User Response Message List NULL \r\n");
        return -1;
    }

    for (pos = 0; pos < osip_list_size(g_UserResponseMsgList->pResponseMsgList); pos++)
    {
        pUserResponseMsg = (user_response_msg_t*)osip_list_get(g_UserResponseMsgList->pResponseMsgList, pos);

        if ((NULL == pUserResponseMsg) || (pUserResponseMsg->dialog_index != 999999))
        {
            continue;
        }

        if ((msg_type == pUserResponseMsg->msg_type)
            && (0 == sstrcmp(source_id, pUserResponseMsg->source_id))
            && (0 == sstrcmp(dc_id, pUserResponseMsg->dc_id)))
        {
            pUserResponseMsg->dialog_index = dialog_index;
        }
    }

    USER_RESPMSG_SMUTEX_UNLOCK();
    return 0;
}

/*****************************************************************************
 函 数 名  : user_response_msg_get
 功能描述  : 获取需要回应的用户Message消息
 输入参数  : int pos
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
user_response_msg_t* user_response_msg_get(int pos)
{
    user_response_msg_t* pUserResponseMsg = NULL;

    if (g_UserResponseMsgList == NULL || g_UserResponseMsgList->pResponseMsgList == NULL
        || pos < 0 || pos >= osip_list_size(g_UserResponseMsgList->pResponseMsgList))
    {
        //DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_response_msg_get() exit---: Param Error \r\n");
        return NULL;
    }

    USER_RESPMSG_SMUTEX_LOCK();

    pUserResponseMsg = (user_response_msg_t*)osip_list_get(g_UserResponseMsgList->pResponseMsgList, pos);

    USER_RESPMSG_SMUTEX_UNLOCK();

    return pUserResponseMsg;
}

/*****************************************************************************
 函 数 名  : SendConnectTVResponseToUser
 功能描述  : 发送回应给需要回应的用户Message消息
 输入参数  : int iResult
                            int dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月29日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int SendConnectTVResponseToUser(int iResult, int dialog_index)
{
    int i = 0;
    int msg_pos = -1;
    user_response_msg_t* pUserResponseMsg = NULL;
    user_info_t* pUserInfo;           /* 用户信息 */

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    msg_pos = user_response_msg_find(XML_NOTIFY_CONNECT_TV, dialog_index);

    if (msg_pos >= 0)
    {
        pUserResponseMsg = user_response_msg_get(msg_pos);

        if (NULL != pUserResponseMsg)
        {
            /* 通知客户端, 回复响应,组建消息 */
            outPacket.SetRootTag("Response");
            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"ConnectTV");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, pUserResponseMsg->message_sn);

            AccNode = outPacket.CreateElement((char*)"Result");

            if (0 == iResult)
            {
                outPacket.SetElementValue(AccNode, (char*)"Error");
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"OK");
            }

            pUserInfo = pUserResponseMsg->pUserInfo;

            if (NULL != pUserInfo)
            {
                /* 发送响应消息 */
                i = SIP_SendMessage(NULL, local_cms_id_get(), pUserInfo->user_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_NOTIFY_CONNECT_TV_ERROR, EV9000_LOG_LEVEL_ERROR, "发送电视墙切换响应结果Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_NOTIFY_CONNECT_TV_ERROR, EV9000_LOG_LEVEL_ERROR, "Sends the TV wall switch response results Message message to the user  failure: the user ID = % s, = % s IP address, port number = %d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "SendConnectTVResponseToUser() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "发送电视墙切换响应结果Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Sends the TV wall switch response results Message message to the user  success: the user ID = % s, = % s IP address, port number = %d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "SendConnectTVResponseToUser() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "SendConnectTVResponseToUser() User Info NULL In UserResponseMsg \r\n");
            }
        }

        user_response_msg_remove(msg_pos);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : SendConnectTVResponseToUserByDeviceIDAndDECID
 功能描述  : 根据电视墙ID和逻辑点位ID，发送连接状态信息给用户
 输入参数  : int iResult
             char* source_id
             char* dc_id
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年1月19日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int SendConnectTVResponseToUserByDeviceIDAndDECID(int iResult, char* source_id, char* dc_id)
{
    int i = 0;
    int msg_pos = -1;
    user_response_msg_t* pUserResponseMsg = NULL;
    user_info_t* pUserInfo;           /* 用户信息 */

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    if (NULL == source_id || NULL == dc_id)
    {
        return -1;
    }

    msg_pos = user_response_msg_find_by_source_id_and_dc_id(XML_NOTIFY_CONNECT_TV, source_id, dc_id);

    if (msg_pos >= 0)
    {
        pUserResponseMsg = user_response_msg_get(msg_pos);

        if (NULL != pUserResponseMsg)
        {
            /* 通知客户端, 回复响应,组建消息 */
            outPacket.SetRootTag("Response");
            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"ConnectTV");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, pUserResponseMsg->message_sn);

            AccNode = outPacket.CreateElement((char*)"Result");

            if (0 == iResult)
            {
                outPacket.SetElementValue(AccNode, (char*)"Error");
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"OK");
            }

            pUserInfo = pUserResponseMsg->pUserInfo;

            if (NULL != pUserInfo)
            {
                /* 发送响应消息 */
                i = SIP_SendMessage(NULL, local_cms_id_get(), pUserInfo->user_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_NOTIFY_CONNECT_TV_ERROR, EV9000_LOG_LEVEL_ERROR, "发送电视墙切换响应结果Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_NOTIFY_CONNECT_TV_ERROR, EV9000_LOG_LEVEL_ERROR, "Sends the TV wall switch response results Message message to the user  failure: the user ID = % s, = % s IP address, port number = %d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "SendConnectTVResponseToUserByDeviceIDAndDECID() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "发送电视墙切换响应结果Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Sends the TV wall switch response results Message message to the user  success: the user ID = % s, = % s IP address, port number = %d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "SendConnectTVResponseToUser() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "SendConnectTVResponseToUserByDeviceIDAndDECID() User Info NULL In UserResponseMsg \r\n");
            }
        }

        user_response_msg_remove(msg_pos);
    }

    return i;
}
#endif

/*****************************************************************************
 函 数 名  : user_srv_msg_proc
 功能描述  : 用户业务消息处理
 输入参数  : user_info_t* pUserInfo
             user_srv_msg_t* pUserSrvMsg
             DBOper* pUser_Srv_dboper
             DBOper* pUserLogDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_srv_msg_proc(user_info_t* pUserInfo, user_srv_msg_t* pUserSrvMsg, DBOper* pUser_Srv_dboper, DBOper* pUserLogDbOper)
{
    int i = 0;

    if (NULL == pUserSrvMsg)
    {
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_srv_msg_proc() msg_type=%d \r\n ", pUserSrvMsg->msg_type);

    switch (pUserSrvMsg->msg_type)
    {
        case MSG_INVITE:
            i = user_invite_msg_proc(pUserInfo, pUserSrvMsg->caller_id, pUserSrvMsg->callee_id, pUserSrvMsg->ua_dialog_index, pUserSrvMsg->msg_body, pUserSrvMsg->msg_body_len);
            break;

        case  MSG_INVITE_RESPONSE:
            i = user_invite_response_msg_proc(pUserSrvMsg->cr_pos, pUserSrvMsg->ua_dialog_index, pUserSrvMsg->response_code, pUserSrvMsg->reasonphrase, pUserSrvMsg->msg_body, pUserSrvMsg->msg_body_len);
            break;

        case  MSG_CANCEL:
            i = user_cancel_msg_proc(pUserSrvMsg->cr_pos, pUserSrvMsg->ua_dialog_index);
            break;

        case  MSG_ACK:
            i = user_ack_msg_proc(pUserSrvMsg->cr_pos, pUserSrvMsg->ua_dialog_index);
            break;

        case  MSG_BYE:
            i = user_bye_msg_proc(pUserSrvMsg->cr_pos, pUserSrvMsg->ua_dialog_index);
            break;

        case  MSG_BYE_RESPONSE:
            i = user_bye_response_msg_proc(pUserSrvMsg->cr_pos, pUserSrvMsg->ua_dialog_index, pUserSrvMsg->response_code);
            break;

        case  MSG_INFO:
            i = user_info_msg_proc(pUserSrvMsg->caller_id, pUserSrvMsg->callee_id, pUserSrvMsg->ua_dialog_index, pUserSrvMsg->msg_body, pUserSrvMsg->msg_body_len);
            break;

        case MSG_MESSAGE:
            i = user_message_msg_proc(pUserInfo, pUserSrvMsg->caller_id, pUserSrvMsg->callee_id, pUserSrvMsg->msg_body, pUserSrvMsg->msg_body_len, pUser_Srv_dboper, pUserLogDbOper);
            break;

        default:
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_srv_msg_proc() exit---: Not Support Message Type:%d \r\n", pUserSrvMsg->msg_type);
            return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_msg_proc
 功能描述  : 用户INVITE消息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             int ua_dialog_index
             char* msg_body
             int msg_body_len
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 SDP回话描述
 v = （协议版本）
 o = （所有者/创建者和会话标识符）
 s = （会话名称）
 i = * （会话信息）
 u = * （URI 描述）
 e = * （Email 地址）
 p = * （电话号码）
 c = * （连接信息 D 如果包含在所有媒体中，则不需要该字段）
 b = * （带宽信息）
 一个或更多时间描述（如下所示）：

 z = * （时间区域调整）
 k = * （加密密钥）
 a = * （0 个或多个会话属性行）
 0个或多个媒体描述（如下所示）
 时间描述

 t = （会话活动时间）
 r = * （0或多次重复次数）
 媒体描述

 m = （媒体名称和传输地址）
 i = * （媒体标题）
 c = * （连接信息 ― 如果包含在会话层则该字段可选）
 b = * （带宽信息）
 k = * （加密密钥）
 a = * （0 个或多个会话属性行）

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_msg_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, int ua_dialog_index, char* msg_body, int msg_body_len)
{
    int i = 0;
    sdp_message_t* pClientSDP = NULL;
    sdp_param_t stClientSDPParam;
    sdp_extend_param_t stClientSDPExParam;
    GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo = NULL;
    char strErrorCode[32] = {0};

    if (NULL == pUserInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_USER_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"User Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if ((NULL == caller_id) || (NULL == callee_id))
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_PARAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Param Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User requests for real-time video: user ID = % s, IP address = % s, port = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    if (NULL == msg_body || msg_body_len == 0)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_MSG_BODY_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Message SDP Body Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Get Message SDP Body Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取用户SDP消息体失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic DeviceID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get user SDP message body failed.");
        return -1;
    }

    if (!g_IsPay) /* 没有付费，返回失败 */
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_PAY_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Pay Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Get Pay Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取授权信息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Failed to obtain license information");
        return -1;
    }

    /* 1、查找逻辑设备信息 */
    pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Callee GBlogicDevice Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Get Callee GBlogicDevice Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取逻辑设备信息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get logical device information failed.");
        return -1;
    }

    /* 2、获取来源的客户端sdp信息，根据其中的s字段，判断业务类型 */
    i = sdp_message_init(&pClientSDP);

    if (0 != i)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MSG_INIT_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"SDP Message Init Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: SDP Message Init Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"SDP消息初始化失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"SDP message initialization failed");
        return -1;
    }

    i = sdp_message_parse(pClientSDP, msg_body);

    if (0 != i)
    {
        sdp_message_free(pClientSDP);
        pClientSDP = NULL;

        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MSG_PARSE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"SDP Message Parse Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: SDP Message Parse Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"SDP消息解析失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"SDP message parsing failed.");
        return -1;
    }

    /* 3、解析sdp中的信息*/
    memset(&stClientSDPParam, 0, sizeof(sdp_param_t));
    memset(&stClientSDPExParam, 0, sizeof(sdp_extend_param_t));

    i = SIP_GetSDPInfoEx(pClientSDP, &stClientSDPParam, &stClientSDPExParam);

    if (i != 0)
    {
        sdp_message_free(pClientSDP);
        pClientSDP = NULL;

        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_GET_VIDEO_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Client SDP Video Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Get Client SDP Video Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取SDP消息中的信息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get information SDP message failed.");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 请求方携带的视频参数:audio_port=%d, audio_code_type=%d, video_port=%d, video_code_type=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, stClientSDPParam.audio_port, stClientSDPParam.audio_code_type, stClientSDPParam.video_port, stClientSDPParam.video_code_type);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User request for real-time video: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, the requester to carry video parameters: audio_port = % d, audio_code_type = % d, video_port = % d, video_code_type = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, stClientSDPParam.audio_port, stClientSDPParam.audio_code_type, stClientSDPParam.video_port, stClientSDPParam.video_code_type);

    /* 4.判断请求类型，是视频请求还是音频请求 */
    if (stClientSDPParam.audio_port > 0
        && stClientSDPParam.video_port <= 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 用户请求的是音频对讲业务", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User requests for real-time video: user ID = % s, IP address = % s, port = % d, logical device ID = % s, user requests are audio intercom business", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

        i = user_invite_audio_msg_proc(pUserInfo, pClientSDP, &stClientSDPParam, pCalleeGBLogicDeviceInfo, caller_id, callee_id, ua_dialog_index);

        if (i != 0)
        {
            sdp_message_free(pClientSDP);
            pClientSDP = NULL;
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Audio Invite Proc Error \r\n");
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 用户请求的是实时视频业务", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User requests for real-time video: user ID = % s, IP address = % s, port = % d, logical device ID = % s, user requests are real-time video business", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

        i = user_invite_video_msg_proc(pUserInfo, pClientSDP, &stClientSDPParam, pCalleeGBLogicDeviceInfo, caller_id, callee_id, ua_dialog_index);

        if (i != 0)
        {
            sdp_message_free(pClientSDP);
            pClientSDP = NULL;
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_msg_proc() exit---: Video Invite Proc Error \r\n");
            return -1;
        }
    }

    sdp_message_free(pClientSDP);
    pClientSDP = NULL;
    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_video_msg_proc
 功能描述  : 用户INVITE视频请求消息处理
 输入参数  : user_info_t* pUserInfo
             sdp_message_t* pClientSDP
             sdp_param_t* pClientSDPParam
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
             char* caller_id
             char* callee_id
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_video_msg_proc(user_info_t* pUserInfo, sdp_message_t* pClientSDP, sdp_param_t* pClientSDPParam, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo, char* caller_id, char* callee_id, int ua_dialog_index)
{
    int i = 0;
    char strErrorCode[32] = {0};

    if (NULL == pUserInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_USER_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"User Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDP)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_msg_proc() exit---: Client SDP Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDPParam)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_PARAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Param Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_msg_proc() exit---: Client SDP Param Info Error \r\n");
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBLogic Device Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_msg_proc() exit---: Callee GBLogic Device Info Error \r\n");
        return -1;
    }

    /* 根据逻辑设备所属域进行判断，决定消息走向 */
    if (1 == pCalleeGBLogicDeviceInfo->other_realm)
    {
        i = user_invite_route_video_msg_proc(pUserInfo, pClientSDP, pClientSDPParam, pCalleeGBLogicDeviceInfo, caller_id, callee_id, ua_dialog_index);
    }
    else
    {
        i = user_invite_sub_video_msg_proc(pUserInfo, pClientSDP, pClientSDPParam, pCalleeGBLogicDeviceInfo, caller_id, callee_id, ua_dialog_index);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_sub_video_msg_proc
 功能描述  : 用户INVITE视频请求消息处理
 输入参数  : user_info_t* pUserInfo
             sdp_message_t* pClientSDP
             sdp_param_t* pClientSDPParam
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
             char* caller_id
             char* callee_id
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_sub_video_msg_proc(user_info_t* pUserInfo, sdp_message_t* pClientSDP, sdp_param_t* pClientSDPParam, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo, char* caller_id, char* callee_id, int ua_dialog_index)
{
    int i = 0;
    int cr_pos = -1;
    cr_t* pCrData = NULL;
    int record_info_pos = -1;
    record_info_t* pRecordInfo = NULL;

    GBDevice_info_t* pCalleeGBDeviceInfo = NULL;
    GBDevice_info_t* pCalleeCmsGBDeviceInfo = NULL;

    //int iAuth = 0;
    //char* realm = NULL;
    //osip_authorization_t* pAuthorization = NULL;

    char* sdp_url = NULL;
    char* sdp_ssrc = NULL;
    char* o_name = NULL;
    char* o_sess_id = NULL;
    char* o_sess_version = NULL;
    char* time_r_repeat = NULL;
    //char strSDPUrl[128] = {0};
    //int iSessionExpires = 0;
    call_type_t eCallType = CALL_TYPE_NULL;
    int stream_type = 0;
    int record_type = 0;
    transfer_protocol_type_t trans_type = TRANSFER_PROTOCOL_NULL;

    char strStartTime[64] = {0};
    char strEndTime[64] = {0};
    char strPlayBackURL[64] = {0};
    int iPlaybackTimeGap = 0;
    char strErrorCode[32] = {0};
    int record_cr_index = -1;

    if (NULL == pUserInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_USER_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"User Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDP)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Client SDP Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDPParam)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_PARAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Param Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Client SDP Param Info Error \r\n");
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBLogic Device Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Callee GBLogic Device Info Error \r\n");
        return -1;
    }

    /* 1、获取流类型，查找对应的物理设备 */
    if (pClientSDPParam->stream_type <= 0)
    {
        stream_type = EV9000_STREAM_TYPE_MASTER;
    }
    else
    {
        stream_type = pClientSDPParam->stream_type;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() Stream Type=%d \r\n", stream_type);

    if (stream_type == EV9000_STREAM_TYPE_SLAVE && pCalleeGBLogicDeviceInfo->stream_count == 1)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_NOT_SUPPORT_MULTI_STREAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBDevice Not Support Multi stream");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Callee GBDevice Not Support Multi stream \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s ", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"逻辑设备信息不支持多码流");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s ", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Logical device information does not support multi-stream.");
        return -1;
    }

    /* 2、获取传输类型 */
    if (pClientSDPParam->trans_type <= 0)
    {
        trans_type = TRANSFER_PROTOCOL_UDP;
    }
    else if (pClientSDPParam->trans_type == 2)
    {
        trans_type = TRANSFER_PROTOCOL_TCP;
    }
    else
    {
        trans_type = TRANSFER_PROTOCOL_UDP;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() Transfer Protocol Type=%d \r\n", trans_type);

    /* 查找目的物理设备信息 */
    pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, stream_type);

    if (NULL == pCalleeGBDeviceInfo)
    {
        /* 如果是智能分析流，可能是下级平台的点位，这个时候需要再查找一下主流设备 */
        if (EV9000_STREAM_TYPE_INTELLIGENCE == stream_type)
        {
            pCalleeCmsGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pCalleeCmsGBDeviceInfo
                && EV9000_DEVICETYPE_SIPSERVER == pCalleeCmsGBDeviceInfo->device_type)
            {
                pCalleeGBDeviceInfo = pCalleeCmsGBDeviceInfo;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() CalleeCmsGBDevice: id=%s, ip=%s \r\n", pCalleeCmsGBDeviceInfo->device_id, pCalleeCmsGBDeviceInfo->login_ip);
            }
        }
        else if (EV9000_STREAM_TYPE_SLAVE == stream_type) /* 如果是辅流，再找一下主流设备 */
        {
            pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);
        }
    }

    if (NULL == pCalleeGBDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Callee GBDevice Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Get Callee GBDevice Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 媒体流类型=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取逻辑设备对应的物理设备信息失败", stream_type);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Media stream type=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get the physical device information which corresponding to logical device failed.", stream_type);
        return -1;
    }

    /* 检查是否有认证信息 */
#if 0
    /* get authorization*/
    pAuthorization = SIP_GetInviteDialogAuthorization(ua_dialog_index);

    if (pAuthorization != NULL && pAuthorization->realm != NULL)
    {
        realm = osip_getcopy_unquoted_string(pAuthorization->realm);
        i = IsLocalAuthRealm(realm);
        osip_free(realm);
        realm = NULL;

        if (0 == i)
        {
            SIP_AnswerToInvite(ua_dialog_index, 403, (char*)"Auth Realm Is Not Local");
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_sub_video_msg_proc() exit---: Auth Realm Is Not Local \r\n");
            return -1;
        }
        else
        {
            iAuth = SIP_Auth(pAuthorization, pCallerUserInfo->register_account, pCallerUserInfo->register_password, (char*)"INVITE");

            if (0 == iAuth) /*认证失败*/
            {
                SIP_AnswerToInvite(ua_dialog_index, 407, NULL);
                DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_sub_video_msg_proc() exit---: NEED AUTH \r\n");
                return -1;
            }
        }
    }
    else
    {
        SIP_AnswerToInvite(ua_dialog_index, 407, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_sub_video_msg_proc() exit---: NEED AUTH \r\n");
        return -1;
    }

    /* 4、查找会话是否支持超时时间 */
    iSessionExpires = SIP_GetInviteDialogSessionExpires(ua_dialog_index);

    if (iSessionExpires > 0)
    {
        if (iSessionExpires < MIN_SESSION_EXPIRE)
        {
            SIP_AnswerToInviteForSessionExpires(ua_dialog_index, MIN_SESSION_EXPIRE);
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_sub_video_msg_proc() exit---: Session Interval Too Small \r\n");
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 会话超时时间间隔=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"用户会话超时时间间隔太小", iSessionExpires);
            return -1;
        }
    }

#endif

    /* 如果是第三方平台，去掉扩展的SDP信息 */
    if (EV9000_DEVICETYPE_SIPSERVER == pCalleeGBDeviceInfo->device_type
        && 1 == pCalleeGBDeviceInfo->three_party_flag)
    {
        DelSDPMediaAttributeByName(pClientSDP, (char*)"recordtype");
        DelSDPMediaAttributeByName(pClientSDP, (char*)"streamtype");

        /* 修改名称 */
        o_name = sdp_message_o_username_get(pClientSDP);

        if (NULL != o_name && 0 != sstrcmp(o_name, local_cms_id_get()))
        {
            osip_free(o_name);
            o_name = NULL;

            o_name = osip_getcopy(local_cms_id_get());
            sdp_message_o_username_set(pClientSDP, o_name);
        }
        else if (NULL == o_name)
        {
            o_name = osip_getcopy(local_cms_id_get());
            sdp_message_o_username_set(pClientSDP, o_name);
        }

        o_sess_id = sdp_message_o_sess_id_get(pClientSDP);

        if (NULL != o_sess_id && 0 != sstrcmp(o_sess_id, (char*)"0"))
        {
            osip_free(o_sess_id);
            o_sess_id = NULL;

            o_sess_id = osip_getcopy((char*)"0");
            sdp_message_o_sess_id_set(pClientSDP, o_sess_id);
        }
        else if (NULL == o_sess_id)
        {
            o_sess_id = osip_getcopy(local_cms_id_get());
            sdp_message_o_sess_id_set(pClientSDP, o_sess_id);
        }

        o_sess_version = sdp_message_o_sess_version_get(pClientSDP);

        if (NULL != o_sess_version && 0 != sstrcmp(o_sess_version, (char*)"0"))
        {
            osip_free(o_sess_version);
            o_sess_version = NULL;

            o_sess_version = osip_getcopy((char*)"0");
            sdp_message_o_sess_version_set(pClientSDP, o_sess_version);
        }
        else if (NULL == o_sess_version)
        {
            o_sess_version = osip_getcopy(local_cms_id_get());
            sdp_message_o_sess_version_set(pClientSDP, o_sess_version);
        }

        time_r_repeat = sdp_message_r_repeat_get(pClientSDP, 0, 0);

        if (NULL != time_r_repeat)
        {
            DelSDPTimeRepeatInfo(pClientSDP);
        }
    }

    if (0 == strncmp(pClientSDPParam->s_name, (char*)"Playback", 8))
    {
        eCallType = CALL_TYPE_RECORD_PLAY;

        /* 增加SDP URL信息 */
        sdp_url = sdp_message_u_uri_get(pClientSDP);

        if (NULL == sdp_url)
        {
            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }
        else
        {
            osip_free(sdp_url);
            sdp_url = NULL;

            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }

#if 1
        /* 增加SDP ssrc信息 */
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"1100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        /* 确定录像类型 */
        if (pClientSDPParam->record_type <= 0)
        {
            record_type = EV9000_RECORD_TYPE_NORMAL;
        }
        else
        {
            record_type = pClientSDPParam->record_type;
        }

        i = format_time(pClientSDPParam->start_time, strStartTime);
        i = format_time(pClientSDPParam->end_time, strEndTime);

#if 0

        /* 如果是前端的NVR或者DVR录像，则修改播放时间 */
        if (EV9000_DEVICETYPE_DVR == pCalleeGBDeviceInfo->device_type || EV9000_DEVICETYPE_NVR == pCalleeGBDeviceInfo->device_type)
        {
            if (1 == pCalleeGBLogicDeviceInfo->record_type)
            {
                i = ModifySDPRecordPlayTime(pClientSDP);
                iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
            }
        }
        else if (EV9000_DEVICETYPE_SIPSERVER == pCalleeGBDeviceInfo->device_type && 1 == pCalleeGBDeviceInfo->three_party_flag) /* 第三方平台 */
        {
            i = ModifySDPRecordPlayTime(pClientSDP);
            iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
        }

#endif
        UserLog(EV9000_USER_LOG_VIDEO_PLAYBACK, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求历史视频回放, 前端逻辑设备ID=%s, 录像类型=%d, 媒体流类型=%d, 传输方式=%d, 回放开始时间=%s, 结束时间=%s", callee_id, record_type, stream_type, trans_type, strStartTime, strEndTime);
        EnUserLog(EV9000_USER_LOG_VIDEO_PLAYBACK, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request history video playback, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d, playback start time=%s, end time=%s", callee_id, stream_type, trans_type, strStartTime, strEndTime);
    }
    else if (0 == strncmp(pClientSDPParam->s_name, (char*)"Play", 4))
    {
        eCallType = CALL_TYPE_REALTIME;

#if 1
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"0100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        UserLog(EV9000_USER_LOG_VIDEO_PLAY, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求实时视频, 前端逻辑设备ID=%s, 媒体流类型=%d, 传输方式=%d", callee_id, stream_type, trans_type);
        EnUserLog(EV9000_USER_LOG_VIDEO_PLAY, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request real time video, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d", callee_id, stream_type, trans_type);
    }
    else if (0 == strncmp(pClientSDPParam->s_name, (char*)"Download", 8))
    {
        eCallType = CALL_TYPE_DOWNLOAD;

        sdp_url = sdp_message_u_uri_get(pClientSDP);

        if (NULL == sdp_url)
        {
            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }
        else
        {
            osip_free(sdp_url);
            sdp_url = NULL;

            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }

#if 1
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"1100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        /* 确定录像类型 */
        if (pClientSDPParam->record_type <= 0)
        {
            record_type = EV9000_RECORD_TYPE_NORMAL;
        }
        else
        {
            record_type = pClientSDPParam->record_type;
        }

        i = format_time(pClientSDPParam->start_time, strStartTime);
        i = format_time(pClientSDPParam->end_time, strEndTime);

#if 0

        /* 如果是前端的NVR或者DVR录像，则修改播放时间 */
        if (EV9000_DEVICETYPE_DVR == pCalleeGBDeviceInfo->device_type || EV9000_DEVICETYPE_NVR == pCalleeGBDeviceInfo->device_type)
        {
            if (1 == pCalleeGBLogicDeviceInfo->record_type)
            {
                i = ModifySDPRecordPlayTime(pClientSDP);
                iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
            }
        }
        else if (EV9000_DEVICETYPE_SIPSERVER == pCalleeGBDeviceInfo->device_type && 1 == pCalleeGBDeviceInfo->three_party_flag) /* 第三方平台 */
        {
            i = ModifySDPRecordPlayTime(pClientSDP);
            iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
        }

#endif
        UserLog(EV9000_USER_LOG_VIDEO_DOWNLOAD, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求历史视频下载, 前端逻辑设备ID=%s, 录像类型=%d, 媒体流类型=%d, 传输方式=%d, 文件下载开始时间=%s, 结束时间=%s", callee_id, record_type, stream_type, trans_type, strStartTime, strEndTime);
        EnUserLog(EV9000_USER_LOG_VIDEO_DOWNLOAD, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request history video playback download, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d, file download start time=%s, end time=%s", callee_id, stream_type, trans_type, strStartTime, strEndTime);
    }
    else
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_NOT_SUPPORT_S_TYPE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 488, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 488, (char*)"SDP S Type Not Support");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: SDP S Type Not Support \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, S名称=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"不支持的S名称类型", pClientSDPParam->s_name);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, S name=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Unsupported S Name Type", pClientSDPParam->s_name);
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() Call Type=%d \r\n", eCallType);

    /* 实时视频查看需要判断设备在线状态 */
    if (eCallType == CALL_TYPE_REALTIME)
    {
        /* 看物理设备是否在线 */
        if (0 == pCalleeGBDeviceInfo->reg_status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_OFFLINE_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Device Not Online:device_id=%s \r\n", pCalleeGBDeviceInfo->device_id);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 物理设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端物理设备不在线", pCalleeGBDeviceInfo->device_id);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Physical device ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"The front end of the physical device is not online", pCalleeGBDeviceInfo->device_id);
            return -1;
        }

        /* 看逻辑设备点位状态, 如果是下级CMS的点，则不需要判断 */
        if (EV9000_DEVICETYPE_SIPSERVER != pCalleeGBDeviceInfo->device_type && 0 == pCalleeGBLogicDeviceInfo->status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_OFFLINE_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: GBLogic Device Not Online \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备不在线");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logic device is not online");
            return -1;
        }

#if 0

        if (2 == pCalleeGBLogicDeviceInfo->status)
        {
            SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_sub_video_msg_proc() exit---: GBLogic Device No Stream \r\n");
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备没有码流");
            return -1;
        }

#endif

        if (3 == pCalleeGBLogicDeviceInfo->status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_UNREACHED_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: GBLogic Device NetWork UnReached \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备网络不可达");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logical device network is unreachable.");
            return -1;
        }
    }

    /* 3、申请呼叫资源 */
    cr_pos = call_record_add();
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() call_record_add:cr_pos=%d \r\n", cr_pos);

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_GET_IDLE_CR_DATA_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Call Record Data Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Get Call Record Data Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"申请呼叫资源失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Application call resource failed.");
        return -1;
    }

    pCrData->call_type = eCallType;

    /* 4、添加 主被叫信息到呼叫资源信息 */
    /* 主叫端信息 */
    osip_strncpy(pCrData->caller_id, caller_id, MAX_ID_LEN);
    osip_strncpy(pCrData->caller_ip, pUserInfo->login_ip, MAX_IP_LEN);
    pCrData->caller_port = pUserInfo->login_port;
    pCrData->caller_ua_index = ua_dialog_index;
    osip_strncpy(pCrData->caller_server_ip_ethname, pUserInfo->strRegServerEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->caller_server_ip, pUserInfo->strRegServerIP, MAX_IP_LEN);
    pCrData->caller_server_port = pUserInfo->iRegServerPort;
    pCrData->caller_transfer_type = trans_type;
    pCrData->iPlaybackTimeGap = iPlaybackTimeGap;

    /* 主叫端的SDP信息 */
    osip_strncpy(pCrData->caller_sdp_ip, pClientSDPParam->sdp_ip, MAX_IP_LEN);
    pCrData->caller_sdp_port = pClientSDPParam->video_port;

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_sub_video_msg_proc() pCrData->caller_id=%s \r\n", pCrData->caller_id);
    printf(" user_invite_sub_video_msg_proc() pCrData->caller_ip=%s \r\n", pCrData->caller_ip);
    printf(" user_invite_sub_video_msg_proc() pCrData->caller_port=%d \r\n", pCrData->caller_port);
    printf(" user_invite_sub_video_msg_proc() pCrData->caller_sdp_ip=%s \r\n", pCrData->caller_sdp_ip);
    printf(" user_invite_sub_video_msg_proc() pCrData->caller_sdp_port=%d \r\n", pCrData->caller_sdp_port);
    printf(" user_invite_sub_video_msg_proc) pCrData->caller_ua_index=%d \r\n", pCrData->caller_ua_index);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 被叫端信息 */
    osip_strncpy(pCrData->callee_id, callee_id, MAX_ID_LEN);
    osip_strncpy(pCrData->callee_ip, pCalleeGBDeviceInfo->login_ip, MAX_IP_LEN);
    pCrData->callee_port = pCalleeGBDeviceInfo->login_port;
    osip_strncpy(pCrData->callee_server_ip_ethname, pCalleeGBDeviceInfo->strRegServerEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->callee_server_ip, pCalleeGBDeviceInfo->strRegServerIP, MAX_IP_LEN);
    pCrData->callee_server_port = pCalleeGBDeviceInfo->iRegServerPort;
    pCrData->callee_framerate = pCalleeGBLogicDeviceInfo->frame_count;
    pCrData->callee_stream_type = stream_type;
    pCrData->callee_gb_device_type = pCalleeGBDeviceInfo->device_type;

    if (1 == pCalleeGBDeviceInfo->trans_protocol)
    {
        pCrData->callee_transfer_type = TRANSFER_PROTOCOL_TCP;
    }
    else
    {
        pCrData->callee_transfer_type = TRANSFER_PROTOCOL_UDP; /* 默认UDP */
    }

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_sub_video_msg_proc() pCrData->callee_id=%s \r\n", pCrData->callee_id);
    printf(" user_invite_sub_video_msg_proc() pCrData->callee_ip=%s \r\n", pCrData->callee_ip);
    printf(" user_invite_sub_video_msg_proc() pCrData->callee_port=%d \r\n", pCrData->callee_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    if (eCallType == CALL_TYPE_RECORD_PLAY)
    {
        if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER
            || pCalleeGBLogicDeviceInfo->record_type == 1)
        {
            //i = shdb_user_operate_cmd_proc(pUserInfo, EV9000_SHDB_DVR_REMOTE_PLAY_BACK);
        }
        else
        {
            //i = shdb_user_operate_cmd_proc(pUserInfo, EV9000_SHDB_DVR_LOCAL_PLAY_BACK);
        }
    }

    /* 如果是录像回放或者下载, 判断录像是在前端还是在本地,如果录在本地，则不需要转到前端处理 */
    if (eCallType == CALL_TYPE_RECORD_PLAY || eCallType == CALL_TYPE_DOWNLOAD)
    {
        /* 查看该点位是否配置了录像 */
        if (EV9000_RECORD_TYPE_NORMAL == record_type
            || EV9000_RECORD_TYPE_ALARM == record_type)
        {
            record_info_pos = record_info_find_by_stream_type(pCalleeGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_MASTER);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_MASTER, record_info_pos);
        }
        else if (EV9000_RECORD_TYPE_BACKUP == record_type)
        {
            record_info_pos = record_info_find_by_stream_type(pCalleeGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_SLAVE);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_SLAVE, record_info_pos);
        }
        else if (EV9000_RECORD_TYPE_INTELLIGENCE == record_type)
        {
            record_info_pos = record_info_find_by_stream_type(pCalleeGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_INTELLIGENCE);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_INTELLIGENCE, record_info_pos);
        }
        else
        {
            record_info_pos = record_info_find_by_stream_type(pCalleeGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_MASTER);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_MASTER, record_info_pos);
        }

        if (record_info_pos >= 0)
        {
            pRecordInfo = record_info_get(record_info_pos);

            if (NULL != pRecordInfo)
            {
                if (1 == pRecordInfo->record_enable)
                {
                    i = user_video_sevice_current_cms_proc(pCrData, pClientSDP, eCallType, pClientSDPParam->start_time, pClientSDPParam->end_time, pClientSDPParam->play_time, 0, record_type);

                    if (0 != i)
                    {
                        memset(strErrorCode, 0, 32);
                        snprintf(strErrorCode, 32, "%d", i);
                        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
                        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Current CMS Proc Error");
                        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
                        i = call_record_remove(cr_pos);

                        if (0 != i)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
                        }
                    }

                    return i;
                }
            }
        }
    }
    else if (eCallType == CALL_TYPE_REALTIME) /* 实时视频 */
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() CalleeGBLogicDeviceInfo Record Type=%d, Status=%d \r\n", pCalleeGBLogicDeviceInfo->record_type, pCalleeGBLogicDeviceInfo->status);

        if (0 == pCalleeGBLogicDeviceInfo->record_type && 2 != pCalleeGBLogicDeviceInfo->status)/* 本地录像并且不是前端没有码流的状态情况下检查录像信息，因为前端没有码流情况下不影响实时视频流程 */
        {
            /* 检查该点位是否录像了 */
            record_info_pos = record_info_find_by_stream_type(pCalleeGBLogicDeviceInfo->id, stream_type);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, stream_type, record_info_pos);

            if (record_info_pos >= 0)
            {
                pRecordInfo = record_info_get(record_info_pos);

                if (NULL != pRecordInfo)
                {
                    if (1 == pRecordInfo->record_enable)
                    {
                        if (pRecordInfo->record_cr_index < 0 && pRecordInfo->record_status != RECORD_STATUS_NO_TSU)
                        {
                            record_cr_index = StartDeviceRecord(pRecordInfo);

                            if (record_cr_index >= 0)
                            {
                                pRecordInfo->record_retry_interval = 5;
                                pRecordInfo->record_try_count = 0;
                                pRecordInfo->iTSUPauseStatus = 0;
                                pRecordInfo->iTSUResumeStatus = 0;
                                pRecordInfo->iTSUAlarmRecordStatus = 0;

                                i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
                                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备录像业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                                return 0;
                            }
                            else
                            {
                                pRecordInfo->tsu_index = -1;
                                pRecordInfo->iTSUPauseStatus = 0;
                                pRecordInfo->iTSUResumeStatus = 0;
                                pRecordInfo->iTSUAlarmRecordStatus = 0;

                                if (-2 == record_cr_index)
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_OFFLINE;
                                }
                                else if (-3 == record_cr_index)
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_NOSTREAM;
                                }
                                else if (-5 == record_cr_index)
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_NETWORK_ERROR;
                                }
                                else if (-4 == record_cr_index)
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_NO_TSU;
                                }
                                else if (-6 == record_cr_index)
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_NOT_SUPPORT_MULTI_STREAM;
                                }
                                else
                                {
                                    pRecordInfo->record_status = RECORD_STATUS_INIT;
                                }

                                pRecordInfo->record_start_time = 0;

                                pRecordInfo->record_try_count++;

                                if (pRecordInfo->record_try_count >= 3)
                                {
                                    pRecordInfo->record_try_count = 0;
                                    pRecordInfo->record_retry_interval = 5;
                                }

                                memset(strErrorCode, 0, 32);
                                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_START_ERROR);
                                SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);

                                i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
                                i = call_record_remove(cr_pos);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
                                }

                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() exit---: Callee GBDevice Not Start Record \r\n");
                                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"逻辑设备配置了录像，但是启动录像失败了");
                                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Logic device is configured with video, but have not started recording.");
                                return -1;
                            }
                        }
                        else if (pRecordInfo->record_cr_index >= 0 && pRecordInfo->record_status != RECORD_STATUS_COMPLETE)
                        {
                            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备录像业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                            return 0;
                        }
                    }
                }
            }
        }
    }

    /* 5、根据设备类型作不同的处理 */
    /*下级CMS*/
    if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER)
    {
        i = user_video_sevice_sub_cms_proc(pCrData, pClientSDP, eCallType);

        if (EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR == i)
        {
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备录像业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            return 0;
        }
        else if (EV9000_CMS_ERR_INVITE_CALLEE_VIDEO_NOT_COMPLETE_ERROR == i)
        {
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备视频业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            return 0;
        }
        else if (0 != 0)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", i);
            SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Sub CMS Proc rror");
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
        }
    }
    else
    {
        /*本级CMS*/
        i = user_video_sevice_current_cms_proc(pCrData, pClientSDP, eCallType, pClientSDPParam->start_time, pClientSDPParam->end_time, pClientSDPParam->play_time, pCalleeGBLogicDeviceInfo->record_type, record_type);

        if (EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR == i)
        {
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备录像业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            return 0;
        }
        else if (EV9000_CMS_ERR_INVITE_CALLEE_VIDEO_NOT_COMPLETE_ERROR == i)
        {
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备视频业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            return 0;
        }
        else if (0 != i)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", i);
            SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Current CMS Proc Error");
            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_route_video_msg_proc
 功能描述  : 用户INVITE视频请求消息处理
 输入参数  : user_info_t* pUserInfo
             sdp_message_t* pClientSDP
             sdp_param_t* pClientSDPParam
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
             char* caller_id
             char* callee_id
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_route_video_msg_proc(user_info_t* pUserInfo, sdp_message_t* pClientSDP, sdp_param_t* pClientSDPParam, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo, char* caller_id, char* callee_id, int ua_dialog_index)
{
    int i = 0;
    int cr_pos = -1;
    cr_t* pCrData = NULL;
    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    char* sdp_url = NULL;
    char* sdp_ssrc = NULL;
    char* o_name = NULL;
    char* o_sess_id = NULL;
    char* o_sess_version = NULL;
    char* time_r_repeat = NULL;
    call_type_t eCallType = CALL_TYPE_NULL;
    int stream_type = 0;
    int record_type = 0;
    transfer_protocol_type_t trans_type = TRANSFER_PROTOCOL_NULL;

    char strStartTime[64] = {0};
    char strEndTime[64] = {0};
    char strPlayBackURL[64] = {0};
    int iPlaybackTimeGap = 0;
    char strErrorCode[32] = {0};

    if (NULL == pUserInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_USER_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"User Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDP)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Client SDP Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDPParam)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_PARAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Param Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Client SDP Param Info Error \r\n");
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBLogic Device Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Callee GBLogic Device Info Error \r\n");
        return -1;
    }

    /* 1、获取流类型，查找对应的物理设备 */
    if (pClientSDPParam->stream_type <= 0)
    {
        stream_type = EV9000_STREAM_TYPE_MASTER;
    }
    else
    {
        stream_type = pClientSDPParam->stream_type;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() Stream Type=%d \r\n", stream_type);

    if (stream_type == EV9000_STREAM_TYPE_SLAVE && pCalleeGBLogicDeviceInfo->stream_count == 1)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_NOT_SUPPORT_MULTI_STREAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBDevice Not Support Multi stream");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Callee GBDevice Not Support Multi stream \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s ", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"逻辑设备信息不支持多码流");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s ", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Logical device information does not support multi-stream.");
        return -1;
    }

    /* 2、获取传输类型 */
    if (pClientSDPParam->trans_type <= 0)
    {
        trans_type = TRANSFER_PROTOCOL_UDP;
    }
    else if (pClientSDPParam->trans_type == 2)
    {
        trans_type = TRANSFER_PROTOCOL_TCP;
    }
    else
    {
        trans_type = TRANSFER_PROTOCOL_UDP;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() Transfer Protocol Type=%d \r\n", trans_type);

    /* 查找目的上级路由信息 */
    iCalleeRoutePos = route_info_find(pCalleeGBLogicDeviceInfo->cms_id);

    if (iCalleeRoutePos < 0)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_ROUTE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Find Callee Route Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Find Callee Route Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 媒体流类型=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"查找逻辑设备对应的上级路由信息失败", stream_type);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Media stream type=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Find the route information which corresponding to logical device failed.", stream_type);
        return -1;
    }

    pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

    if (NULL == pCalleeRouteInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_ROUTE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Callee Route Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Get Callee Route Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 媒体流类型=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取逻辑设备对应的上级路由信息失败", stream_type);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Media stream type=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get the route information which corresponding to logical device failed.", stream_type);
        return -1;
    }

    /* 如果是第三方平台，去掉扩展的SDP信息 */
    if (1 == pCalleeRouteInfo->three_party_flag)
    {
        DelSDPMediaAttributeByName(pClientSDP, (char*)"recordtype");
        DelSDPMediaAttributeByName(pClientSDP, (char*)"streamtype");

        /* 修改名称 */
        o_name = sdp_message_o_username_get(pClientSDP);

        if (NULL != o_name && 0 != sstrcmp(o_name, local_cms_id_get()))
        {
            osip_free(o_name);
            o_name = NULL;

            o_name = osip_getcopy(local_cms_id_get());
            sdp_message_o_username_set(pClientSDP, o_name);
        }
        else if (NULL == o_name)
        {
            o_name = osip_getcopy(local_cms_id_get());
            sdp_message_o_username_set(pClientSDP, o_name);
        }

        o_sess_id = sdp_message_o_sess_id_get(pClientSDP);

        if (NULL != o_sess_id && 0 != sstrcmp(o_sess_id, (char*)"0"))
        {
            osip_free(o_sess_id);
            o_sess_id = NULL;

            o_sess_id = osip_getcopy((char*)"0");
            sdp_message_o_sess_id_set(pClientSDP, o_sess_id);
        }
        else if (NULL == o_sess_id)
        {
            o_sess_id = osip_getcopy(local_cms_id_get());
            sdp_message_o_sess_id_set(pClientSDP, o_sess_id);
        }

        o_sess_version = sdp_message_o_sess_version_get(pClientSDP);

        if (NULL != o_sess_version && 0 != sstrcmp(o_sess_version, (char*)"0"))
        {
            osip_free(o_sess_version);
            o_sess_version = NULL;

            o_sess_version = osip_getcopy((char*)"0");
            sdp_message_o_sess_version_set(pClientSDP, o_sess_version);
        }
        else if (NULL == o_sess_version)
        {
            o_sess_version = osip_getcopy(local_cms_id_get());
            sdp_message_o_sess_version_set(pClientSDP, o_sess_version);
        }

        time_r_repeat = sdp_message_r_repeat_get(pClientSDP, 0, 0);

        if (NULL != time_r_repeat)
        {
            DelSDPTimeRepeatInfo(pClientSDP);
        }
    }

    if (0 == strncmp(pClientSDPParam->s_name, (char*)"Playback", 8))
    {
        eCallType = CALL_TYPE_RECORD_PLAY;

        sdp_url = sdp_message_u_uri_get(pClientSDP);

        if (NULL == sdp_url)
        {
            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }
        else
        {
            osip_free(sdp_url);
            sdp_url = NULL;

            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }

#if 1
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"1100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        /* 确定录像类型 */
        if (pClientSDPParam->record_type <= 0)
        {
            record_type = EV9000_RECORD_TYPE_NORMAL;
        }
        else
        {
            record_type = pClientSDPParam->record_type;
        }

        i = format_time(pClientSDPParam->start_time, strStartTime);
        i = format_time(pClientSDPParam->end_time, strEndTime);

#if 0

        /* 如果是前端的NVR或者DVR录像，则修改播放时间 */
        if (EV9000_DEVICETYPE_DVR == pCalleeGBDeviceInfo->device_type || EV9000_DEVICETYPE_NVR == pCalleeGBDeviceInfo->device_type)
        {
            if (1 == pCalleeGBLogicDeviceInfo->record_type)
            {
                i = ModifySDPRecordPlayTime(pClientSDP);
                iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
            }
        }
        else if (EV9000_DEVICETYPE_SIPSERVER == pCalleeGBDeviceInfo->device_type && 1 == pCalleeGBDeviceInfo->three_party_flag) /* 第三方平台 */
        {
            i = ModifySDPRecordPlayTime(pClientSDP);
            iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
        }

#endif
        UserLog(EV9000_USER_LOG_VIDEO_PLAYBACK, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求历史视频回放, 前端逻辑设备ID=%s, 媒体流类型=%d, 录像类型=%d, 传输方式=%d, 回放开始时间=%s, 结束时间=%s", callee_id, record_type, stream_type, trans_type, strStartTime, strEndTime);
        EnUserLog(EV9000_USER_LOG_VIDEO_PLAYBACK, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request history video playback, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d, playback start time=%s, end time=%s", callee_id, stream_type, trans_type, strStartTime, strEndTime);
    }
    else if (0 == strncmp(pClientSDPParam->s_name, (char*)"Play", 4))
    {
        eCallType = CALL_TYPE_REALTIME;

#if 1
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"0100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        UserLog(EV9000_USER_LOG_VIDEO_PLAY, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求实时视频, 前端逻辑设备ID=%s, 媒体流类型=%d, 传输方式=%d", callee_id, stream_type, trans_type);
        EnUserLog(EV9000_USER_LOG_VIDEO_PLAY, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request realtime video, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d", callee_id, stream_type, trans_type);
    }
    else if (0 == strncmp(pClientSDPParam->s_name, (char*)"Download", 8))
    {
        eCallType = CALL_TYPE_DOWNLOAD;

        sdp_url = sdp_message_u_uri_get(pClientSDP);

        if (NULL == sdp_url)
        {
            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }
        else
        {
            osip_free(sdp_url);
            sdp_url = NULL;

            snprintf(strPlayBackURL, 64, "%s:%s", callee_id, (char*)"application");
            sdp_url = osip_getcopy(strPlayBackURL);
            sdp_message_u_uri_set(pClientSDP, sdp_url);
        }

#if 1
        sdp_ssrc = sdp_message_y_ssrc_get(pClientSDP);

        if (NULL == sdp_ssrc)
        {
            sdp_ssrc = osip_getcopy((char*)"1100000001");
            sdp_message_y_ssrc_set(pClientSDP, sdp_ssrc);
        }

#endif

        /* 确定录像类型 */
        if (pClientSDPParam->record_type <= 0)
        {
            record_type = EV9000_RECORD_TYPE_NORMAL;
        }
        else
        {
            record_type = pClientSDPParam->record_type;
        }

        i = format_time(pClientSDPParam->start_time, strStartTime);
        i = format_time(pClientSDPParam->end_time, strEndTime);

#if 0

        /* 如果是前端的NVR或者DVR录像，则修改播放时间 */
        if (EV9000_DEVICETYPE_DVR == pCalleeGBDeviceInfo->device_type || EV9000_DEVICETYPE_NVR == pCalleeGBDeviceInfo->device_type)
        {
            if (1 == pCalleeGBLogicDeviceInfo->record_type)
            {
                i = ModifySDPRecordPlayTime(pClientSDP);
                iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
            }
        }
        else if (EV9000_DEVICETYPE_SIPSERVER == pCalleeGBDeviceInfo->device_type && 1 == pCalleeGBDeviceInfo->three_party_flag) /* 第三方平台 */
        {
            i = ModifySDPRecordPlayTime(pClientSDP);
            iPlaybackTimeGap = pClientSDPParam->play_time - pClientSDPParam->start_time;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() PlaybackTimeGap=%d \r\n", iPlaybackTimeGap);
        }

#endif
        UserLog(EV9000_USER_LOG_VIDEO_DOWNLOAD, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求历史视频下载, 前端逻辑设备ID=%s, 媒体流类型=%d, 录像类型=%d, 传输方式=%d, 文件下载开始时间=%s, 结束时间=%s", callee_id, record_type, stream_type, trans_type, strStartTime, strEndTime);
        EnUserLog(EV9000_USER_LOG_VIDEO_DOWNLOAD, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User request history video download, Front-end logic device ID=%s, media stream type =%d, transmission mode =%d, file download start time=%s, end time=%s", callee_id, stream_type, trans_type, strStartTime, strEndTime);
    }
    else
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_NOT_SUPPORT_S_TYPE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 488, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 488, (char*)"SDP S Type Not Support");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: SDP S Type Not Support \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, S名称=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"不支持的S名称类型", pClientSDPParam->s_name);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, S name=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Unsupported S Name Type", pClientSDPParam->s_name);
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() Call Type=%d \r\n", eCallType);

    /* 实时视频查看需要判断设备在线状态 */
    if (eCallType == CALL_TYPE_REALTIME)
    {
        /* 看物理设备是否在线 */
        if (0 == pCalleeRouteInfo->reg_status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_OFFLINE_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Route Not Online:device_id=%s \r\n", pCalleeRouteInfo->server_id);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 物理设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"上级CMS不在线", pCalleeRouteInfo->server_id);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Physical device ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"The Route Info is not online", pCalleeRouteInfo->server_id);
            return -1;
        }

#if 0

        /* 看逻辑设备点位状态 */
        if (0 == pCalleeGBLogicDeviceInfo->status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_OFFLINE_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: GBLogic Device Not Online \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备不在线");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logic device is not online");
            return -1;
        }

        if (2 == pCalleeGBLogicDeviceInfo->status)
        {
            SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_invite_route_video_msg_proc() exit---: GBLogic Device No Stream \r\n");
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备没有码流");
            return -1;
        }

#endif

        if (3 == pCalleeGBLogicDeviceInfo->status)
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_UNREACHED_ERROR);
            SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
            //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: GBLogic Device NetWork UnReached \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备网络不可达");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logical device network is unreachable.");
            return -1;
        }
    }

    /* 3、申请呼叫资源 */
    cr_pos = call_record_add();
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() call_record_add:cr_pos=%d \r\n", cr_pos);

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_GET_IDLE_CR_DATA_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Call Record Data Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() exit---: Get Call Record Data Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求实时视频失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"申请呼叫资源失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User requests in real-time video failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Application call resource failed.");
        return -1;
    }

    pCrData->call_type = eCallType;

    /* 4、添加 主被叫信息到呼叫资源信息 */
    /* 主叫端信息 */
    osip_strncpy(pCrData->caller_id, caller_id, MAX_ID_LEN);
    osip_strncpy(pCrData->caller_ip, pUserInfo->login_ip, MAX_IP_LEN);
    pCrData->caller_port = pUserInfo->login_port;
    pCrData->caller_ua_index = ua_dialog_index;
    osip_strncpy(pCrData->caller_server_ip_ethname, pUserInfo->strRegServerEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->caller_server_ip, pUserInfo->strRegServerIP, MAX_IP_LEN);
    pCrData->caller_server_port = pUserInfo->iRegServerPort;
    pCrData->caller_transfer_type = trans_type;
    pCrData->iPlaybackTimeGap = iPlaybackTimeGap;

    /* 主叫端的SDP信息 */
    osip_strncpy(pCrData->caller_sdp_ip, pClientSDPParam->sdp_ip, MAX_IP_LEN);
    pCrData->caller_sdp_port = pClientSDPParam->video_port;

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_route_video_msg_proc() pCrData->caller_id=%s \r\n", pCrData->caller_id);
    printf(" user_invite_route_video_msg_proc() pCrData->caller_ip=%s \r\n", pCrData->caller_ip);
    printf(" user_invite_route_video_msg_proc() pCrData->caller_port=%d \r\n", pCrData->caller_port);
    printf(" user_invite_route_video_msg_proc() pCrData->caller_sdp_ip=%s \r\n", pCrData->caller_sdp_ip);
    printf(" user_invite_route_video_msg_proc() pCrData->caller_sdp_port=%d \r\n", pCrData->caller_sdp_port);
    printf(" user_invite_route_video_msg_proc) pCrData->caller_ua_index=%d \r\n", pCrData->caller_ua_index);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 被叫端信息 */
    osip_strncpy(pCrData->callee_id, callee_id, MAX_ID_LEN);
    osip_strncpy(pCrData->callee_ip, pCalleeRouteInfo->server_ip, MAX_IP_LEN);
    pCrData->callee_port = pCalleeRouteInfo->server_port;
    osip_strncpy(pCrData->callee_server_ip_ethname, pCalleeRouteInfo->strRegLocalEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->callee_server_ip, pCalleeRouteInfo->strRegLocalIP, MAX_IP_LEN);
    pCrData->callee_server_port = pCalleeRouteInfo->iRegLocalPort;
    pCrData->callee_framerate = pCalleeGBLogicDeviceInfo->frame_count;
    pCrData->callee_stream_type = stream_type;
    pCrData->callee_gb_device_type = EV9000_DEVICETYPE_SIPSERVER;

    if (1 == pCalleeRouteInfo->trans_protocol)
    {
        pCrData->callee_transfer_type = TRANSFER_PROTOCOL_TCP;
    }
    else
    {
        pCrData->callee_transfer_type = TRANSFER_PROTOCOL_UDP; /* 默认UDP */
    }

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_route_video_msg_proc() pCrData->callee_id=%s \r\n", pCrData->callee_id);
    printf(" user_invite_route_video_msg_proc() pCrData->callee_ip=%s \r\n", pCrData->callee_ip);
    printf(" user_invite_route_video_msg_proc() pCrData->callee_port=%d \r\n", pCrData->callee_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    i = user_video_sevice_sub_cms_proc(pCrData, pClientSDP, eCallType);

    if (EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR == i)
    {
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备录像业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        return 0;
    }
    else if (EV9000_CMS_ERR_INVITE_CALLEE_VIDEO_NOT_COMPLETE_ERROR == i)
    {
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_ANSWER);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_WARNING, "用户请求实时视频:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 等待逻辑设备视频业务流程结束", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        return 0;
    }
    else if (0 != i)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", i);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Route CMS Proc rror");
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_route_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_route_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_audio_msg_proc
 功能描述  : 用户INVITE音频对讲消息处理
 输入参数  : user_info_t* pUserInfo
             sdp_message_t* pClientSDP
             sdp_param_t* pClientSDPParam
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
             char* caller_id
             char* callee_id
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_audio_msg_proc(user_info_t* pUserInfo, sdp_message_t* pClientSDP, sdp_param_t* pClientSDPParam, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo, char* caller_id, char* callee_id, int ua_dialog_index)
{
    int i = 0;
    int cr_pos = -1;
    cr_t* pCrData = NULL;

    GBDevice_info_t* pCalleeGBDeviceInfo = NULL;
    char strErrorCode[32] = {0};

    //int iAuth = 0;
    //char* realm = NULL;
    //osip_authorization_t* pAuthorization = NULL;
    //char* sdp_ssrc = NULL;
    //char strSDPUrl[128] = {0};
    //int iSessionExpires = 0;
    call_type_t eCallType = CALL_TYPE_NULL;

    if (NULL == pUserInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_USER_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"User Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDP)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Client SDP Info Error \r\n");
        return -1;
    }

    if (NULL == pClientSDPParam)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLER_SDP_PARAM_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Client SDP Param Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Client SDP Param Info Error \r\n");
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Callee GBLogic Device Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Callee GBLogic Device Info Error \r\n");
        return -1;
    }

    /* 1、查找对应的物理设备 */
    pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

    if (NULL == pCalleeGBDeviceInfo)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_DEVICE_INFO_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Callee GBDevice Info Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Get Callee GBDevice Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 媒体流类型=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"获取逻辑设备对应的物理设备信息失败", EV9000_STREAM_TYPE_MASTER);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s,Media stream type=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Get the physical device information which corresponding to logical device failed", EV9000_STREAM_TYPE_MASTER);
        return -1;
    }

    /* 目前语音对讲只支持实时对讲 */
    if (0 == strncmp(pClientSDPParam->s_name, "Play", 4))
    {
        eCallType = CALL_TYPE_AUDIO;
    }
    else
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_NOT_SUPPORT_S_TYPE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 488, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 488, (char*)"SDP S Type Not Support");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: SDP S Type Not Support \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, S名称=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"不支持的S名称类型", pClientSDPParam->s_name);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, S name=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Unsupported S Name Type", pClientSDPParam->s_name);
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_audio_msg_proc() Call Type=%d \r\n", eCallType);

    /* 2.看物理设备是否在线 */
    if (0 == pCalleeGBDeviceInfo->reg_status)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_OFFLINE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Device Not Online:device_id=%s \r\n", pCalleeGBDeviceInfo->device_id);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 物理设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端物理设备不在线", pCalleeGBDeviceInfo->device_id);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Physical device ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end physical device is not online", pCalleeGBDeviceInfo->device_id);
        return -1;
    }

    /* 看逻辑设备点位状态, 如果是下级CMS的点，则不需要判断 */
    if (EV9000_DEVICETYPE_SIPSERVER != pCalleeGBDeviceInfo->device_type && 0 == pCalleeGBLogicDeviceInfo->status)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_OFFLINE_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 480, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: GBLogic Device Not Online \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备不在线");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR,  "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logic device is not online");
        return -1;
    }

    if (3 == pCalleeGBLogicDeviceInfo->status)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_LOGIC_DEVICE_UNREACHED_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 480, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: GBLogic Device NetWork UnReached \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"前端逻辑设备网络不可达");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Front-end logical device network unreachable");
        return -1;
    }

    /* 4、申请呼叫资源 */
    cr_pos = call_record_add();
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_audio_msg_proc() call_record_add:cr_pos=%d \r\n", cr_pos);

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_GET_IDLE_CR_DATA_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Get Call Record Data Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Get Call Record Data Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求音频对讲失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"申请呼叫资源失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Users request audio intercom failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Application call resource failed.");
        return -1;
    }

    pCrData->call_type = eCallType;

    /* 5、添加 主被叫信息到呼叫资源信息 */
    /* 主叫端信息 */
    osip_strncpy(pCrData->caller_id, caller_id, MAX_ID_LEN);
    osip_strncpy(pCrData->caller_ip, pUserInfo->login_ip, MAX_IP_LEN);
    pCrData->caller_port = pUserInfo->login_port;
    pCrData->caller_ua_index = ua_dialog_index;
    osip_strncpy(pCrData->caller_server_ip_ethname, pUserInfo->strRegServerEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->caller_server_ip, pUserInfo->strRegServerIP, MAX_IP_LEN);
    pCrData->caller_server_port = pUserInfo->iRegServerPort;
    pCrData->caller_transfer_type = TRANSFER_PROTOCOL_UDP; /* 赋默认值 */

    /* 主叫端的SDP信息 */
    osip_strncpy(pCrData->caller_sdp_ip, pClientSDPParam->sdp_ip, MAX_IP_LEN);
    pCrData->caller_sdp_port = pClientSDPParam->audio_port;

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_audio_msg_proc() pCrData->caller_id=%s \r\n", pCrData->caller_id);
    printf(" user_invite_audio_msg_proc() pCrData->caller_ip=%s \r\n", pCrData->caller_ip);
    printf(" user_invite_audio_msg_proc() pCrData->caller_port=%d \r\n", pCrData->caller_port);
    printf(" user_invite_audio_msg_proc() pCrData->caller_sdp_ip=%s \r\n", pCrData->caller_sdp_ip);
    printf(" user_invite_audio_msg_proc() pCrData->caller_sdp_port=%d \r\n", pCrData->caller_sdp_port);
    printf(" user_invite_audio_msg_proc() pCrData->caller_ua_index=%d \r\n", pCrData->caller_ua_index);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 被叫端信息 */
    osip_strncpy(pCrData->callee_id, callee_id, MAX_ID_LEN);
    osip_strncpy(pCrData->callee_ip, pCalleeGBDeviceInfo->login_ip, MAX_IP_LEN);
    pCrData->callee_port = pCalleeGBDeviceInfo->login_port;
    osip_strncpy(pCrData->callee_server_ip_ethname, pCalleeGBDeviceInfo->strRegServerEthName, MAX_IP_LEN);
    osip_strncpy(pCrData->callee_server_ip, pCalleeGBDeviceInfo->strRegServerIP, MAX_IP_LEN);
    pCrData->callee_server_port = pCalleeGBDeviceInfo->iRegServerPort;
    pCrData->callee_framerate = pCalleeGBLogicDeviceInfo->frame_count;
    pCrData->callee_stream_type = EV9000_STREAM_TYPE_MASTER;
    pCrData->callee_transfer_type = TRANSFER_PROTOCOL_UDP; /* 赋默认值 */
    pCrData->callee_gb_device_type = pCalleeGBDeviceInfo->device_type;

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_audio_msg_proc() pCrData->callee_id=%s \r\n", pCrData->callee_id);
    printf(" user_invite_audio_msg_proc() pCrData->callee_ip=%s \r\n", pCrData->callee_ip);
    printf(" user_invite_audio_msg_proc() pCrData->callee_port=%d \r\n", pCrData->callee_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 6、转发消息到前端 */
    i = user_transfer_invite_to_dest_for_audio_proc(pCrData, pClientSDP);

    if (0 != i)
    {
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_TRANSFER_MSG_TO_DEST_ERROR);
        SIP_AnswerToInvite(ua_dialog_index, 503, strErrorCode);
        //SIP_AnswerToInvite(ua_dialog_index, 503, (char*)"Transfer Invite Message Proc Error");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() exit---: Transfer Invite Message Proc Error \r\n");
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_audio_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_response_msg_proc
 功能描述  : 用户INVITE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             int response_code
             char* reasonphrase
             char* msg_body
             int msg_body_len
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_response_msg_proc(int cr_pos, int ua_dialog_index, int response_code, char* reasonphrase, char* msg_body, int msg_body_len)
{
    int i = 0;
    cr_t* pCrData = NULL;
    sdp_message_t* pRemoteSDP = NULL;
    sdp_param_t stRemoteSDPParam;
    sdp_extend_param_t stRemoteSDPExParam;
    GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo = NULL;
    char strErrorCode[32] = {0};

    if (cr_pos < 0)
    {
        if (200 == response_code)
        {
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    /* invite的响应一般由被叫发送过来*/
    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        if (200 == response_code)
        {
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Get Call Record Error \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video,INVITE response message processing:User ID=%s, User IP=%s, Logic Device ID=%s, IP Address=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

    /* 查找逻辑设备信息 */
    pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(pCrData->callee_id);

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获对前端逻辑设备信息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get the front-end logical device information failed.");

        if (200 == response_code)
        {
            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get Callee GBlogicDevice Info Error");
        }

        i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_INVITE_CALLEE_LOGIC_DEVICE_INFO_ERROR);

        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Get Callee GBlogicDevice Info Error \r\n");
        return -1;
    }

    /* 根据响应码作不同的处理 */
    if (200 == response_code)
    {
        if (NULL == msg_body || msg_body_len == 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获对端的SDP信息失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Eligible peer SDP information failed.");

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_CALLEE_MSG_BODY_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);

            i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_INVITE_CALLEE_MSG_BODY_ERROR);

            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Get Remote Message SDP Body Error \r\n");
            return -1;
        }

        /* 获取200消息中的被叫的sdp信息 */
        i = sdp_message_init(&pRemoteSDP);

        if (0 != i)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"SDP初始化失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"SDP initialization failed.");

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MSG_INIT_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);

            i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_SDP_MSG_INIT_ERROR);

            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Remote SDP Message Init Error \r\n");
            return -1;
        }

        /* 解析SDP信息 */
        i = sdp_message_parse(pRemoteSDP, msg_body);

        if (0 != i)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"SDP信息解析失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to parse SDP information.");

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MSG_PARSE_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);

            i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_SDP_MSG_PARSE_ERROR);

            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }

            sdp_message_free(pRemoteSDP);
            pRemoteSDP = NULL;

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Remote SDP Message Parse Error \r\n");
            return -1;
        }

        /* 获取协商的SDP信息 */
        memset(&stRemoteSDPParam, 0, sizeof(sdp_param_t));
        memset(&stRemoteSDPExParam, 0, sizeof(sdp_extend_param_t));

        i = SIP_GetSDPInfoEx(pRemoteSDP, &stRemoteSDPParam, &stRemoteSDPExParam);

        if (0 != i)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取SDP中的信息失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get the information of SDP failed.");
            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_GET_VIDEO_INFO_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);

            i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_SDP_GET_VIDEO_INFO_ERROR);

            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }

            sdp_message_free(pRemoteSDP);
            pRemoteSDP = NULL;

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Get Remote SDP Video Info Error \r\n");
            return -1;
        }

        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() addr=%s,port=%d,code=%d,flag=%d \r\n", stRemoteSDPParam.sdp_ip, stRemoteSDPParam.video_port, stRemoteSDPParam.video_code_type, stRemoteSDPParam.media_direction);

        /* 判断前端设备的ONVIF URL */
        if (stRemoteSDPExParam.onvif_url[0] != '\0')
        {
            if (strlen(stRemoteSDPExParam.onvif_url) < 255)
            {
                osip_strncpy(pCrData->callee_onvif_url, stRemoteSDPExParam.onvif_url, strlen(stRemoteSDPExParam.onvif_url));
            }
            else
            {
                osip_strncpy(pCrData->callee_onvif_url, stRemoteSDPExParam.onvif_url, 255);
            }

            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_response_msg_proc() callee_onvif_url=%s \r\n", pCrData->callee_onvif_url);

            /* 被叫侧的协议类型改为RTSP */
            //pCrData->callee_transfer_type = TRANSFER_PROTOCOL_RTSP;
        }

        /* 添加被叫的SDP 信息 */
        osip_strncpy(pCrData->callee_sdp_ip, stRemoteSDPParam.sdp_ip, MAX_IP_LEN);

#if 0
        printf("\r\n\r\n ************************************************* \r\n");
        printf(" user_invite_response_msg_proc() pCrData->callee_sdp_ip=%s \r\n", pCrData->callee_sdp_ip);
        printf(" user_invite_response_msg_proc() pCrData->callee_sdp_port=%d \r\n", pCrData->callee_sdp_port);
        printf(" user_invite_response_msg_proc() pCrData->tsu_code=%d \r\n", pCrData->tsu_code);
        printf(" ************************************************* \r\n\r\n ");
#endif

        if (CALL_TYPE_AUDIO == pCrData->call_type)
        {
            pCrData->callee_sdp_port = stRemoteSDPParam.audio_port;
            pCrData->tsu_code = stRemoteSDPParam.audio_code_type;

            i = user_invite_audio_response_msg_proc(cr_pos, ua_dialog_index, pCrData, pRemoteSDP, pCalleeGBLogicDeviceInfo);
        }
        else
        {
            pCrData->callee_sdp_port = stRemoteSDPParam.video_port;
            pCrData->tsu_code = stRemoteSDPParam.video_code_type;

            i = user_invite_video_response_msg_proc(cr_pos, ua_dialog_index, pCrData, pRemoteSDP, pCalleeGBLogicDeviceInfo);
        }

        if (i != 0)
        {
            i = return_error_for_wait_answer_call_record(pCrData, i);

            i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
            i = call_record_remove(cr_pos);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
            }

            sdp_message_free(pRemoteSDP);
            pRemoteSDP = NULL;

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() exit---: Accept Invite Error \r\n");
            return -1;
        }

        /* 通知等待的呼叫任务，接受请求，通知TSU转发码流 */
        i = resumed_wait_answer_call_record1(pCrData);

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users real-time video, INVITE response message processing success: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        sdp_message_free(pRemoteSDP);
        pRemoteSDP = NULL;
    }
    else
    {
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 错误码=%d, reasonphrase=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"非200的错误响应消息", response_code, reasonphrase);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Error code=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Non-200 error response message", response_code);

        if (EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)/* 可能是下级CMS返回的有具体错误原因 */
        {
            if (NULL != reasonphrase && reasonphrase[0] != '\0')
            {
                SIP_AnswerToInvite(pCrData->caller_ua_index, response_code, reasonphrase);
                i = return_error_for_wait_answer_call_record(pCrData, response_code);
            }
            else
            {
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_FRONT_RETURN_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, response_code, strErrorCode);
                i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_INVITE_FRONT_RETURN_ERROR);
            }
        }
        else
        {
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_FRONT_RETURN_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, response_code, strErrorCode);
            i = return_error_for_wait_answer_call_record(pCrData, EV9000_CMS_ERR_INVITE_FRONT_RETURN_ERROR);
        }
    }

    /* 4、如果是错误回应，移除呼叫信息 */
    if (response_code >= 400)
    {
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_invite_response_msg_proc
 功能描述  : 用户实时视频INVITE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             sdp_message_t* pRemoteSDP
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_video_response_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, sdp_message_t* pRemoteSDP, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;

    /* 根据逻辑设备所属域进行判断，决定消息走向 */
    if (1 == pCalleeGBLogicDeviceInfo->other_realm)
    {
        i = user_invite_video_route_response_msg_proc(cr_pos, ua_dialog_index, pCrData, pRemoteSDP, pCalleeGBLogicDeviceInfo);
    }
    else
    {
        i = user_invite_video_sub_response_msg_proc(cr_pos, ua_dialog_index, pCrData, pRemoteSDP, pCalleeGBLogicDeviceInfo);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_invite_video_sub_response_msg_proc
 功能描述  : 用户实时视频INVITE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             sdp_message_t* pRemoteSDP
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_video_sub_response_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, sdp_message_t* pRemoteSDP, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;
    int send_port = 0;
    char* sdp_tsu_ip = NULL;
    char strErrorCode[32] = {0};

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到媒体流请求方", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users real-time video, INVITE response message processing: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, stream without forward at the corresponding level, the forward message directly to the requesting party media flow", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        if (EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type
            && (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD)) /* 下级CMS 过来的 */
        {
            //发送端口号从新获取
            /* 获取TSU 发送端口号 */
            send_port = get_send_port_by_tsu_resource(pCrData->tsu_ip);

            if (send_port <= 0)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCrData->tsu_ip);
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU Send port failed", pCrData->tsu_ip);

                /* 回应消息给被叫 */
                i = SIP_SendAck(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                i = SIP_SendBye(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                /* 回应消息给主叫 */
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Send Port rror");

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
                return -1;
            }

            pCrData->tsu_send_port = send_port;

            /* 通知TSU开始转发码流 */
            i = notify_tsu_add_transfer_for_replay_task(pCrData, 0, pCrData->callee_stream_type);
        }
        else if (pCalleeGBLogicDeviceInfo->record_type == 1 && (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD)) /* 调看前端录像 */
        {
            //发送端口号从新获取
            /* 获取TSU 发送端口号 */
            send_port = get_send_port_by_tsu_resource(pCrData->tsu_ip);

            if (send_port <= 0)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCrData->tsu_ip);
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU Send port failed", pCrData->tsu_ip);

                /* 回应消息给被叫 */
                i = SIP_SendAck(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                i = SIP_SendBye(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                /* 回应消息给主叫 */
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Send Port rror");

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
                return -1;
            }

            pCrData->tsu_send_port = send_port;

            /* 通知TSU开始转发码流 */
            i = notify_tsu_add_transfer_for_replay_task(pCrData, 0, pCrData->callee_stream_type);
        }
        else
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->caller_transfer_type) /* TCP的情况下，直接调用TSU转发接口，返回值是TSU的发送端口号 */
            {
                /* 通知TSU开始转发码流 */
                i = notify_tsu_add_transfer_task(pCrData, pCrData->callee_service_type, pCrData->callee_stream_type);

                if (i > 0)
                {
                    pCrData->tsu_send_port = i;
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_video_sub_response_msg_proc() tsu_send_port=%d \r\n", pCrData->tsu_send_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() tsu_send_port=%d \r\n", pCrData->tsu_send_port);
                }
            }
            else
            {
                //发送端口号从新获取
                /* 获取TSU 发送端口号 */
                send_port = get_send_port_by_tsu_resource(pCrData->tsu_ip);

                if (send_port <= 0)
                {
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCrData->tsu_ip);
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU Send port failed.", pCrData->tsu_ip);

                    /* 回应消息给被叫 */
                    i = SIP_SendAck(ua_dialog_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                    i = SIP_SendBye(ua_dialog_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                    /* 回应消息给主叫 */
                    memset(strErrorCode, 0, 32);
                    snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR);
                    SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                    //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Send Port rror");

                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
                    return -1;
                }

                pCrData->tsu_send_port = send_port;

                /* 通知TSU开始转发码流 */
                i = notify_tsu_add_transfer_task(pCrData, pCrData->callee_service_type, pCrData->callee_stream_type);
            }
        }

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: notify_tsu_add_transfer_task Error: TSU IP=%s, i=%d \r\n", pCrData->tsu_ip, i);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"通知TSU添加转发任务失败", pCrData->tsu_ip, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Notify TSU Add forwarded task failed.", pCrData->tsu_ip, i);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);

            return -1;
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 通知TSU添加转发任务成功, TSU IP=%s, task_id=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users real-time video, INVITE response message processing: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, notify the TSU add forward mission success, TSU IP = % s, task_id = % s, iRet = %d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
        }

        /* 组建本地SDP信息*/
        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->caller_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get Caller TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->caller_server_ip_ethname);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取主叫侧的SDP消息中的TSU的IP地址失败", pCrData->caller_server_ip_ethname, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get calling side SIP message TSU's IP address failed.", pCrData->caller_server_ip_ethname, i);

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP S Name Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get sdp_tsu_ip Error \r\n");
            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改SDP中的S Name */
        i = ModifySDPSName(pRemoteSDP, pCrData->call_type);

        if (i != 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的S Name失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the S name of SDP");

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_S_NAME_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP S Name Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Modify SDP S Name Error \r\n");
            return EV9000_CMS_ERR_SDP_MODIFY_S_NAME_ERROR;
        }

        /* 修改SDP中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pRemoteSDP, sdp_tsu_ip, pCrData->tsu_send_port);

        if (i != 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的IP和端口号失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the IP and port of SDP .");

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP IP And Addr Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Modify SDP IP And Addr Error \r\n");
            return -1;
        }

        /* 修改SDP中的协议传输类型 */
        if (pCrData->caller_transfer_type != pCrData->callee_transfer_type)
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->caller_transfer_type)
            {
                i = ModifySDPTransProtocol(pRemoteSDP, 1);
            }
            else
            {
                i = ModifySDPTransProtocol(pRemoteSDP, 0);
            }

            if (i != 0)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的协议传输类型失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the transport protocol type of SDP .");

                /* 通知TSU停止转发码流 */
                i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

                /* 回应消息给被叫 */
                i = SIP_SendAck(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                i = SIP_SendBye(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                /* 回应消息给主叫 */
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_PROTOCOL_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP Protocol Error");

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Modify SDP Protocol Error \r\n");
                return -1;
            }
        }
    }

    /* 接收主叫方的呼叫*/
    i = SIP_AcceptInvite(pCrData->caller_ua_index, pRemoteSDP);

    if (i != 0)
    {
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"接收客户端的INVITE消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Receiving client INVITE message failed.");

        if (!g_LocalMediaTransferFlag
            && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
        {
            /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        }
        else
        {
            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);
        }

        /* 回应消息给被叫 */
        i = SIP_SendAck(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        i = SIP_SendBye(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        /* 回应消息给主叫 */
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_ACCEPT_ERROR);
        SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
        //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Accept Invite Error");

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Accept Invite Error \r\n");
        return -1;
    }

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        i = SIP_SendAck(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
    }
    else
    {
        if (EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type
            && (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD)) /* 下级CMS 过来的 */
        {
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
        }
        else if (pCalleeGBLogicDeviceInfo->record_type == 1 && (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD)) /* 调看前端录像 */
        {
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
        }
        else
        {
            /* 加入待发送ACK 消息队列 */
            if (ua_dialog_index == pCrData->caller_ua_index)
            {
                i = ack_send_use(cr_pos, ua_dialog_index, -1);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() ack_send_use:cr_pos=%d, caller_ua_index=%d, i=%d \r\n", cr_pos, ua_dialog_index, i);
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理, 添加等待TSU通知任务创建结果消息处理结果事件, 等待发送ACK消息:cr_pos=%d, caller_ua_index=%d, iRet=%d", cr_pos, ua_dialog_index, i);
            }
            else if (ua_dialog_index == pCrData->callee_ua_index)
            {
                i = ack_send_use(cr_pos, -1, ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() ack_send_use:cr_pos=%d, callee_ua_index=%d, i=%d \r\n", cr_pos, ua_dialog_index, i);
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理, 添加等待TSU通知任务创建结果消息处理结果事件, 等待发送ACK消息:cr_pos=%d, callee_ua_index=%d, iRet=%d", cr_pos, ua_dialog_index, i);
            }
        }
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_invite_video_route_response_msg_proc
 功能描述  : 用户实时视频INVITE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             sdp_message_t* pRemoteSDP
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_video_route_response_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, sdp_message_t* pRemoteSDP, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;
    int send_port = 0;
    char* sdp_tsu_ip = NULL;
    char strErrorCode[32] = {0};

    if (!g_LocalMediaTransferFlag)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到媒体流请求方", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video, INVITE response message processing: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, stream without forward at the corresponding level, the forward message directly to the requesting party media flow", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        if (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD) /* 调看前端录像 */
        {
            //发送端口号从新获取
            /* 获取TSU 发送端口号 */
            send_port = get_send_port_by_tsu_resource(pCrData->tsu_ip);

            if (send_port <= 0)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCrData->tsu_ip);
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU Send port failed", pCrData->tsu_ip);

                /* 回应消息给被叫 */
                i = SIP_SendAck(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                i = SIP_SendBye(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                /* 回应消息给主叫 */
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Send Port rror");

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
                return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
            }

            pCrData->tsu_send_port = send_port;

            /* 通知TSU开始转发码流 */
            i = notify_tsu_add_transfer_for_replay_task(pCrData, 0, pCrData->callee_stream_type);
        }
        else
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->caller_transfer_type) /* TCP的情况下，直接调用TSU转发接口，返回值是TSU的发送端口号 */
            {
                /* 通知TSU开始转发码流 */
                i = notify_tsu_add_transfer_task(pCrData, pCrData->callee_service_type, pCrData->callee_stream_type);

                if (i > 0)
                {
                    pCrData->tsu_send_port = i;
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_invite_video_route_response_msg_proc() tsu_send_port=%d \r\n", pCrData->tsu_send_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() tsu_send_port=%d \r\n", pCrData->tsu_send_port);
                }
            }
            else
            {
                //发送端口号从新获取
                /* 获取TSU 发送端口号 */
                send_port = get_send_port_by_tsu_resource(pCrData->tsu_ip);

                if (send_port <= 0)
                {
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCrData->tsu_ip);
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU Send port failed.", pCrData->tsu_ip);

                    /* 回应消息给被叫 */
                    i = SIP_SendAck(ua_dialog_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                    i = SIP_SendBye(ua_dialog_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                    /* 回应消息给主叫 */
                    memset(strErrorCode, 0, 32);
                    snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR);
                    SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                    //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Send Port rror");

                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
                    return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
                }

                pCrData->tsu_send_port = send_port;

                /* 通知TSU开始转发码流 */
                i = notify_tsu_add_transfer_task(pCrData, pCrData->callee_service_type, pCrData->callee_stream_type);
            }
        }

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: notify_tsu_add_transfer_task Error: TSU IP=%s, i=%d \r\n", pCrData->tsu_ip, i);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"通知TSU添加转发任务失败", pCrData->tsu_ip, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Notify TSU Add forwarded task failed.", pCrData->tsu_ip, i);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);

            return EV9000_CMS_ERR_TSU_NOTIFY_ADD_TRANSFER_ERROR;
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 通知TSU添加转发任务成功, TSU IP=%s, task_id=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video, INVITE response message processing: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, notify the TSU add forward mission success, TSU IP = % s, task_id = % s, iRet = % d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
        }

        /* 组建本地SDP信息*/
        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->caller_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Get Caller TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->caller_server_ip_ethname);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取主叫侧的SDP消息中的TSU的IP地址失败", pCrData->caller_server_ip_ethname, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get calling side SIP message TSU's IP address failed.", pCrData->caller_server_ip_ethname, i);

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_sub_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP S Name Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_sub_response_msg_proc() exit---: Get sdp_tsu_ip Error \r\n");
            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改SDP中的S Name */
        i = ModifySDPSName(pRemoteSDP, pCrData->call_type);

        if (i != 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的S Name失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the S name of SDP");

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_S_NAME_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP S Name Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Modify SDP S Name Error \r\n");
            return EV9000_CMS_ERR_SDP_MODIFY_S_NAME_ERROR;
        }

        /* 修改SDP中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pRemoteSDP, sdp_tsu_ip, pCrData->tsu_send_port);

        if (i != 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的IP和端口号失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the IP and port of SDP .");

            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP IP And Addr Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Modify SDP IP And Addr Error \r\n");
            return EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR;
        }

        /* 修改SDP中的协议传输类型 */
        if (pCrData->caller_transfer_type != pCrData->callee_transfer_type)
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->caller_transfer_type)
            {
                i = ModifySDPTransProtocol(pRemoteSDP, 1);
            }
            else
            {
                i = ModifySDPTransProtocol(pRemoteSDP, 0);
            }

            if (i != 0)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP中的协议传输类型失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Failed to modify the transport protocol type of SDP .");

                /* 通知TSU停止转发码流 */
                i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

                /* 回应消息给被叫 */
                i = SIP_SendAck(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                i = SIP_SendBye(ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

                /* 回应消息给主叫 */
                memset(strErrorCode, 0, 32);
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_PROTOCOL_ERROR);
                SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
                //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP Protocol Error");

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Modify SDP Protocol Error \r\n");
                return EV9000_CMS_ERR_SDP_MODIFY_PROTOCOL_ERROR;
            }
        }

        /* 去除SDP中的ONVIF URL，级联之间不能用RTSP */
        if (NULL != pRemoteSDP->u_uri)
        {
            osip_free(pRemoteSDP->u_uri);
            pRemoteSDP->u_uri = NULL;
        }
    }

    /* 接收主叫方的呼叫*/
    i = SIP_AcceptInvite(pCrData->caller_ua_index, pRemoteSDP);

    if (i != 0)
    {
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时视频, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"接收客户端的INVITE消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time video,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Receiving client INVITE message failed.");

        if (!g_LocalMediaTransferFlag)
        {
            /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        }
        else
        {
            /* 通知TSU停止转发码流 */
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);
        }

        /* 回应消息给被叫 */
        i = SIP_SendAck(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        i = SIP_SendBye(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        /* 回应消息给主叫 */
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_ACCEPT_ERROR);
        SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
        //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Accept Invite Error");

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_video_route_response_msg_proc() exit---: Accept Invite Error \r\n");
        return EV9000_CMS_ERR_INVITE_ACCEPT_ERROR;
    }

    if (!g_LocalMediaTransferFlag)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        i = SIP_SendAck(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
    }
    else
    {
        if (pCrData->call_type == CALL_TYPE_RECORD_PLAY || pCrData->call_type == CALL_TYPE_DOWNLOAD) /* 调看前端录像 */
        {
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);
        }
        else
        {
            /* 加入待发送ACK 消息队列 */
            if (ua_dialog_index == pCrData->caller_ua_index)
            {
                i = ack_send_use(cr_pos, ua_dialog_index, -1);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() ack_send_use:cr_pos=%d, caller_ua_index=%d, i=%d \r\n", cr_pos, ua_dialog_index, i);
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理, 添加等待TSU通知任务创建结果消息处理结果事件, 等待发送ACK消息:cr_pos=%d, caller_ua_index=%d, iRet=%d", cr_pos, ua_dialog_index, i);
            }
            else if (ua_dialog_index == pCrData->callee_ua_index)
            {
                i = ack_send_use(cr_pos, -1, ua_dialog_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_video_route_response_msg_proc() ack_send_use:cr_pos=%d, callee_ua_index=%d, i=%d \r\n", cr_pos, ua_dialog_index, i);
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, INVITE回应消息处理, 添加等待TSU通知任务创建结果消息处理结果事件, 等待发送ACK消息:cr_pos=%d, callee_ua_index=%d, iRet=%d", cr_pos, ua_dialog_index, i);
            }
        }
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_invite_response_msg_proc
 功能描述  : 用户音频对讲INVITE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             sdp_message_t* pRemoteSDP
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_invite_audio_response_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, sdp_message_t* pRemoteSDP, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;
    int recv_port = 0;
    char* sdp_tsu_ip = NULL;
    char strErrorCode[32] = {0};

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时音频对讲, INVITE回应消息处理:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到媒体流请求方", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time audio speaker, INVITE response message processing: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, stream without forward at the corresponding level, the forward message directly to the requesting party media flow ", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        /* 获取TSU 音频接收端口号 */
        recv_port = get_tsu_audio_recv_port(pCrData->tsu_ip);

        if (recv_port <= 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时音频对讲, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的接收端口号失败", pCrData->tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time audio intercom,INVITE response message processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU receiving port failed.", pCrData->tsu_ip);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_RECV_PORT_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get TSU Port rror");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_response_msg_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCrData->tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_RECV_PORT_ERROR;
        }

        pCrData->tsu_recv_port = recv_port;

        /* 组建本地SDP信息*/
        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->caller_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时音频对讲, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取主叫侧的SDP消息中的TSU的IP地址失败", pCrData->caller_server_ip_ethname, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time audio intercom,INVITE response message processing failed::User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, callee_server_ip_ethname=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get calling side SIP message TSU's IP address failed.", pCrData->caller_server_ip_ethname, i);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Get Caller TSU SDP IP Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_response_msg_proc() exit---: Get Caller TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->caller_server_ip_ethname);

            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改SDP中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pRemoteSDP, sdp_tsu_ip, pCrData->tsu_recv_port);

        if (i != 0)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时音频对讲, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time audio intercom,INVITE response message processing failed::User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify SDP information failed.");

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR);
            SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
            //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Modify SDP Info Error");

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_response_msg_proc() exit---: Modify SDP Info Error \r\n");
            return EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR;
        }
    }

    /* 接收主叫方的呼叫*/
    i = SIP_AcceptInvite(pCrData->caller_ua_index, pRemoteSDP);

    if (i != 0)
    {
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时音频对讲, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"接收客户端的INVITE消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time audio intercom,INVITE response message processing failed::User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Receiving client INVITE message failed.");

        /* 回应消息给被叫 */
        i = SIP_SendAck(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        i = SIP_SendBye(ua_dialog_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

        /* 回应消息给主叫 */
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_INVITE_ACCEPT_ERROR);
        SIP_AnswerToInvite(pCrData->caller_ua_index, 503, strErrorCode);
        //SIP_AnswerToInvite(pCrData->caller_ua_index, 503, (char*)"Accept Invite Error");

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_response_msg_proc() exit---: Accept Invite Error \r\n");
        return EV9000_CMS_ERR_INVITE_ACCEPT_ERROR;
    }

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
    }
    else
    {
        /* 通知TSU开始转发音频流 */
        i = notify_tsu_add_audio_transfer_task(pCrData);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_invite_audio_response_msg_proc() exit---: notify_tsu_add_audio_transfer_task Error: TSU IP=%s, i=%d \r\n", pCrData->tsu_ip, i);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "用户实时音频对讲, INVITE回应消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"通知TSU添加音频转发任务失败", pCrData->tsu_ip, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "User real-time audio intercom,INVITE response message processing failed::User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Notify TSU add audio forwarded task failed.", pCrData->tsu_ip, i);

            /* 回应消息给被叫 */
            i = SIP_SendAck(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            i = SIP_SendBye(ua_dialog_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

            /* 回应消息给主叫 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendBye:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);

            return EV9000_CMS_ERR_TSU_NOTIFY_ADD_TRANSFER_ERROR;
        }
    }

    i = SIP_SendAck(ua_dialog_index);
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_invite_audio_response_msg_proc() SIP_SendAck:ua_dialog_index=%d, i=%d \r\n", ua_dialog_index, i);

    return 0;
}

/*****************************************************************************
 函 数 名  : user_cancel_msg_proc
 功能描述  :  用户收到Cancel消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月22日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_cancel_msg_proc(int cr_pos, int ua_dialog_index)
{
    int i = 0;
    cr_t* pCrData = NULL;

    if (cr_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_cancel_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    /* Cancel消息由客户端在发送Invite之后没有收到最终应答前发出 */
    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_cancel_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, 收到CANCEL取消消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video, receive the user cancel message processing:User ID=%s, User IP=%s,Logic Device ID=%s, IP Address=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

    /* 2、如果是实时视频业务，服务器需要将Cancel 消息转发给被叫方 */
    if (pCrData->callee_ua_index >= 0)
    {
        i = SIP_SendCancel(pCrData->callee_ua_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_cancel_msg_proc() SIP_SendCancel:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
    }

    /* 3、移除呼叫记录信息 */
    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
    i = call_record_remove(cr_pos);

    if (0 != i)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_cancel_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_cancel_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_ack_msg_proc
 功能描述  : 用户ACK消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_ack_msg_proc(int cr_pos, int ua_dialog_index)
{
    int i = 0;
    cr_t* pCrData = NULL;

    if (cr_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_ack_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    /* Ack消息由客户端收到200后发出 */
    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_ack_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, 收到ACK消息处理:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User's real-time video, receives an ACK message processing: user ID = % s, IP address = % s, logical device ID = % s, IP address = %s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

    /* 2、如果是实时视频业务，服务器需要将ack消息转发给被叫方 */
    /*if (pCrData->callee_ua_index >= 0) //收到前端响应的时候直接回复了ACK,所以这个地方收到客户端的ACK不需要再转发给前端
    {
        i = SIP_SendAck(pCrData->callee_ua_index);
    }*/


    return i;
}

/*****************************************************************************
 函 数 名  : user_bye_msg_proc
 功能描述  : 用户BYE 消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_msg_proc(int cr_pos, int ua_dialog_index)
{
    int i = 0;
    cr_t* pCrData = NULL;
    GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo = NULL;

    if (cr_pos < 0)
    {
        SIP_AnswerToBye(ua_dialog_index, 403, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        SIP_AnswerToBye(ua_dialog_index, 481, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户实时视频, 收到BYE关闭消息处理:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video, receive the user close message processing:User ID=%s, User IP=%s,Logic Device ID=%s, IP Address=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

    /* 查找逻辑设备信息 */
    pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(pCrData->callee_id);

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        SIP_AnswerToBye(ua_dialog_index, 503, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_msg_proc() exit---: Get Callee GBLogic Device Info Error:callee_id=%s \r\n", pCrData->callee_id);
        return -1;
    }

    if (CALL_TYPE_AUDIO == pCrData->call_type)
    {
        i = user_bye_audio_msg_proc(cr_pos, ua_dialog_index, pCrData, pCalleeGBLogicDeviceInfo);
    }
    else
    {
        i = user_bye_video_msg_proc(cr_pos, ua_dialog_index, pCrData, pCalleeGBLogicDeviceInfo);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_bye_video_msg_proc
 功能描述  : 用户BYE 视频消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_video_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;

    /* 根据逻辑设备所属域进行判断，决定消息走向 */
    if (1 == pCalleeGBLogicDeviceInfo->other_realm)
    {
        i = user_bye_route_video_msg_proc(cr_pos, ua_dialog_index, pCrData, pCalleeGBLogicDeviceInfo);
    }
    else
    {
        i = user_bye_sub_video_msg_proc(cr_pos, ua_dialog_index, pCrData, pCalleeGBLogicDeviceInfo);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_bye_sub_video_msg_proc
 功能描述  : 用户BYE 视频消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_sub_video_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;
    int other_cr_pos = -1;
    cr_t* pOtherCrData = NULL;
    GBDevice_info_t* pCalleeGBDeviceInfo = NULL;
    GBDevice_info_t* pCalleeCmsGBDeviceInfo = NULL;

    if (NULL == pCrData)
    {
        SIP_AnswerToBye(ua_dialog_index, 481, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        SIP_AnswerToBye(ua_dialog_index, 503, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() exit---: Get Callee GBLogic Device Info Error:callee_id=%s \r\n", pCrData->callee_id);
        return -1;
    }

    /* 查找对应的物理设备 */
    pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, pCrData->callee_stream_type);

    if (NULL == pCalleeGBDeviceInfo)
    {
        /* 如果是智能分析流，可能是下级平台的点位，这个时候需要再查找一下主流设备 */
        if (EV9000_STREAM_TYPE_INTELLIGENCE == pCrData->callee_stream_type)
        {
            pCalleeCmsGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pCalleeCmsGBDeviceInfo
                && EV9000_DEVICETYPE_SIPSERVER == pCalleeCmsGBDeviceInfo->device_type)
            {
                pCalleeGBDeviceInfo = pCalleeCmsGBDeviceInfo;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_sub_video_msg_proc() CalleeCmsGBDevice: id=%s, ip=%s \r\n", pCalleeCmsGBDeviceInfo->device_id, pCalleeCmsGBDeviceInfo->login_ip);
            }
        }
    }

    if (NULL == pCalleeGBDeviceInfo)
    {
        SIP_AnswerToBye(ua_dialog_index, 503, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() exit---: Get Callee GBDevice Info Error \r\n");
        return -1;
    }

    /* Bye 消息可能是主叫发送的也可能是被叫发送的*/
    if (pCrData->callee_ua_index == ua_dialog_index)    /* 源端发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到前端BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video request, receive front-end BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 直接发送200 响应消息给被叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 通知TSU停止接收码流*/
        if ((CALL_TYPE_RECORD_PLAY == pCrData->call_type)
            || (CALL_TYPE_DOWNLOAD == pCrData->call_type))
        {
            /* 可能TSU中的缓存还没有放完，这个时候不能发送Bye 给客户端 */
            i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_sub_video_msg_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 如果是下级录像查看或者前端录像的情况下，需要转发Bye上级或者客户端 */
            if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER) /* 下级CMS 的录像 */
            {
                /* 发送Bye 给主叫侧 */
                i = SIP_SendBye(pCrData->caller_ua_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Callee:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);
            }
            else if (pCalleeGBLogicDeviceInfo->record_type == 1) /* 调看前端录像 */
            {
                /* 发送Bye 给主叫侧 */
                i = SIP_SendBye(pCrData->caller_ua_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Callee:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);
            }
        }
        else
        {
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_sub_video_msg_proc() notify_tsu_delete_transfer_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() notify_tsu_delete_transfer_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 发送Bye 给所有其他业务主叫侧用户*/
            i = send_bye_to_all_other_caller_by_callee_id_and_streamtype(pCrData->callee_id, pCrData->callee_stream_type, cr_pos);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() send_bye_to_all_other_caller_by_callee_id_and_streamtype:callee_id=%s, callee_stream_type=%d, i=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, i);

            /* 发送Bye 给主叫侧 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Caller:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);
        }

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }
    else if (pCrData->caller_ua_index == ua_dialog_index) /* 主叫发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到请求方BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video request, received the requester BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s ", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 通知TSU停止接收码流*/
        if ((CALL_TYPE_RECORD_PLAY == pCrData->call_type)
            || (CALL_TYPE_DOWNLOAD == pCrData->call_type))
        {
            i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_sub_video_msg_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 如果是下级录像查看或者前端录像的情况下，需要转发Bye到下级或者前端 */
            if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER) /* 下级CMS  的录像 */
            {
                /*发送Bye 给被叫侧 */
                i = SIP_SendBye(pCrData->callee_ua_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
            }
            else if (pCalleeGBLogicDeviceInfo->record_type == 1) /* 调看前端录像 */
            {
                /*发送Bye 给被叫侧 */
                i = SIP_SendBye(pCrData->callee_ua_index);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
            }
        }
        else
        {
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_sub_video_msg_proc() notify_tsu_delete_transfer_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() notify_tsu_delete_transfer_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 看是否有前端连接 */
            if (pCrData->callee_ua_index >= 0)
            {
                /* 查看是否有其他客户端业务 */
                other_cr_pos = is_GBLogic_device_has_other_service(pCrData->callee_id, pCrData->callee_stream_type, cr_pos);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() is_GBLogic_device_has_other_service:other_cr_pos=%d \r\n", other_cr_pos);

                if (other_cr_pos < 0) /* 没有其他业务 */
                {
                    /*发送Bye 给被叫侧 */
                    i = SIP_SendBye(pCrData->callee_ua_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
                }
                else
                {
                    pOtherCrData = call_record_get(other_cr_pos);

                    if (NULL != pOtherCrData)
                    {
                        pOtherCrData->callee_ua_index = pCrData->callee_ua_index; /* 将前端的会话句柄拷贝到下个业务 */
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_sub_video_msg_proc() callee_ua_index=%d copy from %d to %d \r\n", pOtherCrData->callee_ua_index, cr_pos, other_cr_pos);
                    }
                }
            }
        }

        /* 直接发送200 响应消息主叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }

    /* 移除呼叫记录信息 */
    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
    i = call_record_remove(cr_pos);

    if (0 != i)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_sub_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_sub_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }

    SIP_AnswerToBye(ua_dialog_index, 481, NULL);
    return -1;
}

/*****************************************************************************
 函 数 名  : user_bye_route_video_msg_proc
 功能描述  : 用户BYE 视频消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_route_video_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;
    int other_cr_pos = -1;
    cr_t* pOtherCrData = NULL;

    if (NULL == pCrData)
    {
        SIP_AnswerToBye(ua_dialog_index, 481, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_route_video_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        SIP_AnswerToBye(ua_dialog_index, 503, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_route_video_msg_proc() exit---: Get Callee GBLogic Device Info Error:callee_id=%s \r\n", pCrData->callee_id);
        return -1;
    }

    /* Bye 消息可能是主叫发送的也可能是被叫发送的*/
    if (pCrData->callee_ua_index == ua_dialog_index)    /* 源端发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到前端BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User of real-time video request, receive front-end BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 直接发送200 响应消息给被叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 通知TSU停止接收码流*/
        if ((CALL_TYPE_RECORD_PLAY == pCrData->call_type)
            || (CALL_TYPE_DOWNLOAD == pCrData->call_type))
        {
            /* 可能TSU中的缓存还没有放完，这个时候不能发送Bye 给客户端 */
            i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_route_video_msg_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 发送Bye 给主叫侧 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() SIP_SendBye To Callee:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);
        }
        else
        {
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_route_video_msg_proc() notify_tsu_delete_transfer_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() notify_tsu_delete_transfer_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 发送Bye 给所有其他业务主叫侧用户*/
            i = send_bye_to_all_other_caller_by_callee_id_and_streamtype(pCrData->callee_id, pCrData->callee_stream_type, cr_pos);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() send_bye_to_all_other_caller_by_callee_id_and_streamtype:callee_id=%s, callee_stream_type=%d, i=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, i);

            /* 发送Bye 给主叫侧 */
            i = SIP_SendBye(pCrData->caller_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() SIP_SendBye To Caller:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);
        }

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_route_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_route_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }
    else if (pCrData->caller_ua_index == ua_dialog_index) /* 主叫发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到请求方BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video request, received the requester BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s ", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 通知TSU停止接收码流*/
        if ((CALL_TYPE_RECORD_PLAY == pCrData->call_type)
            || (CALL_TYPE_DOWNLOAD == pCrData->call_type))
        {
            i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_route_video_msg_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_route_video_msg_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /*发送Bye 给被叫侧 */
            i = SIP_SendBye(pCrData->callee_ua_index);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
        }
        else
        {
            i = notify_tsu_delete_transfer_task(pCrData->tsu_ip, pCrData->task_id);

            if (i < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_route_video_msg_proc() notify_tsu_delete_transfer_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() notify_tsu_delete_transfer_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 看是否有前端连接 */
            if (pCrData->callee_ua_index >= 0)
            {
                /* 查看是否有其他客户端业务 */
                other_cr_pos = is_GBLogic_device_has_other_service(pCrData->callee_id, pCrData->callee_stream_type, cr_pos);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() is_GBLogic_device_has_other_service:other_cr_pos=%d \r\n", other_cr_pos);

                if (other_cr_pos < 0) /* 没有其他业务 */
                {
                    /*发送Bye 给被叫侧 */
                    i = SIP_SendBye(pCrData->callee_ua_index);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);
                }
                else
                {
                    pOtherCrData = call_record_get(other_cr_pos);

                    if (NULL != pOtherCrData)
                    {
                        pOtherCrData->callee_ua_index = pCrData->callee_ua_index; /* 将前端的会话句柄拷贝到下个业务 */
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_route_video_msg_proc() callee_ua_index=%d copy from %d to %d \r\n", pOtherCrData->callee_ua_index, cr_pos, other_cr_pos);
                    }
                }
            }
        }

        /* 直接发送200 响应消息主叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_route_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_route_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }

    /* 移除呼叫记录信息 */
    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
    i = call_record_remove(cr_pos);

    if (0 != i)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_route_video_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_route_video_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }

    SIP_AnswerToBye(ua_dialog_index, 481, NULL);
    return -1;
}

/*****************************************************************************
 函 数 名  : user_bye_audio_msg_proc
 功能描述  : 用户BYE 音频对讲消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             cr_t* pCrData
             GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_audio_msg_proc(int cr_pos, int ua_dialog_index, cr_t* pCrData, GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo)
{
    int i = 0;

    if (NULL == pCrData)
    {
        SIP_AnswerToBye(ua_dialog_index, 481, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_audio_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        SIP_AnswerToBye(ua_dialog_index, 503, NULL);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_audio_msg_proc() exit---: Get Callee GBLogic Device Info Error:callee_id=%s \r\n", pCrData->callee_id);
        return -1;
    }

    /* Bye 消息可能是主叫发送的也可能是被叫发送的*/
    if (pCrData->callee_ua_index == ua_dialog_index)    /* 源端发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时音频对讲请求, 收到前端BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User over the real-time audio intercom request, receive front-end BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 直接发送200 响应消息给被叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 通知TSU停止转发音频流*/
        i = notify_tsu_delete_audio_transfer_task(pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_audio_msg_proc() notify_tsu_delete_audio_transfer_task Error:tsu_ip=%s, receive_ip=%s, receive_port=%d, i=%d \r\n", pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_audio_msg_proc() notify_tsu_delete_audio_transfer_task OK:tsu_ip=%s, receive_ip=%s, receive_port=%d, i=%d \r\n", pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port, i);
        }

        /* 发送Bye 给主叫侧 */
        i = SIP_SendBye(pCrData->caller_ua_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_audio_msg_proc() SIP_SendBye To Caller:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_audio_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_audio_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }
    else if (pCrData->caller_ua_index == ua_dialog_index) /* 主叫发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时音频对讲请求, 收到请求方BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User over the real-time audio intercom request, receive front-end BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s ", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 直接发送200 响应消息给主叫侧 */
        SIP_AnswerToBye(ua_dialog_index, 200, NULL);

        /* 通知TSU停止转发音频流*/
        i = notify_tsu_delete_audio_transfer_task(pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_bye_audio_msg_proc() notify_tsu_delete_audio_transfer_task Error:tsu_ip=%s, receive_ip=%s, receive_port=%d, i=%d \r\n", pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_audio_msg_proc() notify_tsu_delete_audio_transfer_task OK:tsu_ip=%s, receive_ip=%s, receive_port=%d, i=%d \r\n", pCrData->tsu_ip, pCrData->caller_sdp_ip, pCrData->caller_sdp_port, i);
        }

        /*发送Bye 给被叫侧 */
        i = SIP_SendBye(pCrData->callee_ua_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_bye_audio_msg_proc() SIP_SendBye To Callee:callee_ua_index=%d, i=%d \r\n", pCrData->callee_ua_index, i);

        /* 移除呼叫记录信息 */
        i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
        i = call_record_remove(cr_pos);

        if (0 != i)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_audio_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_audio_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
        }

        return 0;
    }

    /* 移除呼叫记录信息 */
    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
    i = call_record_remove(cr_pos);

    if (0 != i)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_audio_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_audio_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }

    SIP_AnswerToBye(ua_dialog_index, 481, NULL);
    return -1;
}

/*****************************************************************************
 函 数 名  : user_bye_response_msg_proc
 功能描述  : 用户BYE 回应消息处理
 输入参数  : int cr_pos
             int ua_dialog_index
             int response_code
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月17日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_bye_response_msg_proc(int cr_pos, int ua_dialog_index, int response_code)
{
    int i = 0;
    cr_t* pCrData = NULL;

    if (cr_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_response_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_response_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到BYE响应消息处理:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User real-time video request, receive the response message processing: BYE, user ID = % s IP address = % s, logical device ID = % s, IP address = % s ", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

    /* Bye 响应消息可能是主叫发送的也可能是被叫发送的*/
    if (pCrData->callee_ua_index == ua_dialog_index)    /* 主叫发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到请求方BYE响应消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, " User real-time video request, received the requester BYE response message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = % s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 如果是实时视频业务，服务器需要将Bye响应消息转给主叫侧 */
        if (pCrData->caller_ua_index >= 0)
        {
            SIP_AnswerToBye(pCrData->caller_ua_index, response_code, NULL);
        }
    }
    else if (pCrData->caller_ua_index == ua_dialog_index) /* 被叫发送的Bye */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户过来的实时视频请求, 收到前端BYE消息处理, 实时视频关闭:用户ID=%s, IP地址=%s, 逻辑设备ID=%s, IP地址=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users real-time video request, receive front-end BYE message processing, real-time video closed: user ID = % s, IP address = % s, logical device ID = % s, IP address = %s", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

        /* 如果是实时视频业务，服务器需要将Bye响应消息转给被叫侧 */
        if (pCrData->callee_ua_index >= 0)
        {
            SIP_AnswerToBye(pCrData->callee_ua_index, response_code, NULL);
        }
    }

    /* 移除呼叫记录信息 */
    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
    i = call_record_remove(cr_pos);

    if (0 != i)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_bye_response_msg_proc() call_record_remove Error:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_bye_response_msg_proc() call_record_remove OK:cr_pos=%d, i=%d \r\n", cr_pos, i);
    }

    return -1;
}

#if 1
/*****************************************************************************
 函 数 名  : user_info_msg_proc
 功能描述  : 用户Info 消息处理
 输入参数  : char* caller_id
             char* callee_id
             int dialog_index
             char* msg_body
             int msg_body_len
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月22日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_info_msg_proc(char* caller_id, char* callee_id, int dialog_index, char* msg_body, int msg_body_len)
{
    int i = 0;
    int cr_pos = -1;
    mansrtsp_t* rtsp = NULL;
    cr_t* pCrData = NULL;
    GBDevice_info_t* pCalleeGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo = NULL;
    float iScale = 0.0;
    int iLen = 0;
    int iNtp = 0;
    char tmpNtp[32] = {0};

    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    if ((NULL == caller_id) || (NULL == callee_id) || (NULL == msg_body) || dialog_index < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_info_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    //处理过程

    /* 获取呼叫记录 */
    cr_pos = call_record_find_by_caller_index(dialog_index);

    if (cr_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Find Call Record Error:dialog_index=%d \r\n", dialog_index);
        return -1;
    }

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d", caller_id, pCrData->caller_ip, callee_id, cr_pos);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control process: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = %d", caller_id, pCrData->caller_ip, callee_id, cr_pos);

    /* 查找逻辑设备信息 */
    pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_info_msg_proc() exit---: Get Callee GBlogicDevice Info Error \r\n");
        return -1;
    }

    /* 根据逻辑设备所属域进行判断，决定消息走向 */
    if (1 == pCalleeGBLogicDeviceInfo->other_realm)
    {
        /* 查找上级路由信息 */
        iCalleeRoutePos = route_info_find(pCalleeGBLogicDeviceInfo->cms_id);

        if (iCalleeRoutePos >= 0)
        {
            pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

            if (NULL != pCalleeRouteInfo)
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, 转发到上级CMS:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d, 转发上级CMS ID=%s, IP地址=%s, 端口号=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, cr_pos, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, forwarded to the superior CMS: requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = % d, forwarding the superior CMS, ID = % s = % s IP address, port number = % d ", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, cr_pos, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                if (0 != i)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() route_info_get Error:CalleeRoutePos=%d \r\n", iCalleeRoutePos);
            }
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() route_info_get Error:cms_id=%s \r\n", pCalleeGBLogicDeviceInfo->cms_id);
        }
    }
    else
    {
        /* 查找对应的物理设备 */
        pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, pCrData->callee_stream_type);

        if (NULL != pCalleeGBDeviceInfo)
        {
            if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER
                || pCalleeGBLogicDeviceInfo->record_type == 1) /* 下级CMS或者前端录像*/
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, 转发到前端设备:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d, 前端设备ID=%s, IP地址=%s, 端口号=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, cr_pos, pCalleeGBDeviceInfo->device_id, pCalleeGBDeviceInfo->login_ip, pCalleeGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, forwarded to the front-end equipment: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = % d, ID = % s front-end equipment, IP address = % s, port = % d", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, cr_pos, pCalleeGBDeviceInfo->device_id, pCalleeGBDeviceInfo->login_ip, pCalleeGBDeviceInfo->login_port);

                i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                if (0 != i)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                }
            }
            else
            {
                //根据RTSP中的信息，传输给TSU
                if (0 == strncmp(msg_body, "PLAY", 4))
                {
                    i = notify_tsu_start_replay(pCrData->tsu_ip, pCrData->task_id);

                    if (0 != i)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_start_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_start_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }

                    /* 解析MANSRTSP 消息 */
                    i = mansrtsp_init(&rtsp);

                    if (i != 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Init Error \r\n");
                        return -1;
                    }

                    i = mansrtsp_parse(rtsp, msg_body);

                    if (i != 0)
                    {
                        mansrtsp_free(rtsp);
                        osip_free(rtsp);
                        rtsp = NULL;

                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Parse Error \r\n");
                        return -1;
                    }

                    /* 快放慢放 */
                    if (NULL != rtsp->scale && NULL != rtsp->scale->number)
                    {
                        iScale = atof(rtsp->scale->number);

                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() Scale Number=%f \r\n", iScale);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_info_msg_proc() No Scale Value \r\n");
                    }

                    /* 拖放 */
                    if (NULL != rtsp->range && NULL != rtsp->range->start)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() NPT Start=%s \r\n", rtsp->range->start);

                        if (0 != sstrcmp(rtsp->range->start, "now")
                            && 0 != sstrcmp(rtsp->range->start, "196")
                            && 0 != sstrcmp(rtsp->range->start, "196-")
                            && 0 != sstrcmp(rtsp->range->start, "0-")) /* 老版本客户端里面暂停后的继续命令里面携带的是196，防止从头开始播放 */
                        {
                            iLen = strlen(rtsp->range->start);

                            if (iLen > 0)
                            {
                                osip_strncpy(tmpNtp, rtsp->range->start, iLen - 1); /* 去掉最后的"-" */
                                iNtp = osip_atoi(tmpNtp);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Get NPT Error \r\n");
                            }
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Range Start Now \r\n");
                        }
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_info_msg_proc() No NPT Value \r\n");
                    }

                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, PLAY命令处理:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d, Scale=%f, NPT=%d", caller_id, pCrData->caller_ip, callee_id, cr_pos, iScale, iNtp);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, PLAY order processing: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = % d, Scale = % f, NPT = %d", caller_id, pCrData->caller_ip, callee_id, cr_pos, iScale, iNtp);

                    if (iScale > 0 || iNtp > 0)
                    {
                        if (iScale > 0 && iScale != 1.0)
                        {
                            pCrData->iScale = iScale;
                        }

                        if (iScale > 0)
                        {
                            i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                            if (0 != i)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                            }
                        }

                        if (iNtp > 0)
                        {
                            i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                            if (0 != i)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                            }
                        }
                    }

                    mansrtsp_free(rtsp);
                    osip_free(rtsp);
                    rtsp = NULL;

                    return i;
                }
                else if (0 == strncmp(msg_body, "PAUSE", 5))
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, PAUSE命令处理:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d", caller_id, pCrData->caller_ip, callee_id, cr_pos);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, PAUSE command processing: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = %d", caller_id, pCrData->caller_ip, callee_id, cr_pos);

                    i = notify_tsu_pause_replay(pCrData->tsu_ip, pCrData->task_id);

                    if (0 != i)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_pause_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_pause_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }

                    return i;
                }
                else if (0 == strncmp(msg_body, "TEARDOWN", 8))
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, TEARDOWN命令处理:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d", caller_id, pCrData->caller_ip, callee_id, cr_pos);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, TEARDOWN order processing: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = % d", caller_id, pCrData->caller_ip, callee_id, cr_pos);

                    i = notify_tsu_stop_replay(pCrData->tsu_ip, pCrData->task_id);

                    if (0 != i)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_stop_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_stop_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
                    }

                    return i;
                }
                else if (0 == strncmp(msg_body, "SEEK", 4))
                {
                    /* 解析MANSRTSP 消息 */
                    i = mansrtsp_init(&rtsp);

                    if (i != 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Init Error \r\n");
                        return -1;
                    }

                    i = mansrtsp_parse(rtsp, msg_body);

                    if (i != 0)
                    {
                        mansrtsp_free(rtsp);
                        osip_free(rtsp);
                        rtsp = NULL;

                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Parse Error \r\n");
                        return -1;
                    }

                    if (NULL != rtsp->range && NULL != rtsp->range->start)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() NPT Start=%s \r\n", rtsp->range->start);

                        if (0 != sstrcmp(rtsp->range->start, "now"))
                        {
                            iLen = strlen(rtsp->range->start);

                            if (iLen > 0)
                            {
                                osip_strncpy(tmpNtp, rtsp->range->start, iLen - 1); /* 去掉最后的"-" */
                                iNtp = osip_atoi(tmpNtp);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Get NPT Error \r\n");
                            }

                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户历史视频回放控制处理, SEEK命令处理:请求方ID=%s, IP地址=%s, 逻辑设备ID=%s, cr_pos=%d, NPT=%d", caller_id, pCrData->caller_ip, callee_id, cr_pos, iNtp);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User history video playback control processing, the SEEK order processing: the requester, ID = % s IP address = % s, logical device ID = % s, cr_pos = % d, NPT = %d", caller_id, pCrData->caller_ip, callee_id, cr_pos, iNtp);

                            if (iNtp > 0)
                            {
                                i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, osip_atoi(rtsp->range->start), i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, osip_atoi(rtsp->range->start), i);
                                }
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() NPT Value Error \r\n");
                            }
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Range Start Now \r\n");
                        }
                    }

                    mansrtsp_free(rtsp);
                    osip_free(rtsp);
                    rtsp = NULL;

                    return i;
                }
            }
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() GBDevice_info_get_by_stream_type Error:device_id=%s, callee_stream_type=%d \r\n", pCalleeGBLogicDeviceInfo->device_id, pCrData->callee_stream_type);
        }
    }

    return -1;
}
#endif

#if 0
/*****************************************************************************
 函 数 名  : user_info_msg_proc
 功能描述  : 用户Info 消息处理
 输入参数  : char* caller_id
             char* callee_id
             int dialog_index
             char* msg_body
             int msg_body_len
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月22日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_info_msg_proc(char* caller_id, char* callee_id, int dialog_index, char* msg_body, int msg_body_len)
{
    int i = 0;
    int cr_pos = -1;
    mansrtsp_t* rtsp = NULL;
    cr_t* pCrData = NULL;
    GBDevice_info_t* pCalleeGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pCalleeGBLogicDeviceInfo = NULL;
    float iScale = 0.0;
    int iLen = 0;
    int iNtp = 0;
    char tmpBuf[128] = {0};
    char tmpNtp[32] = {0};

    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    if ((NULL == caller_id) || (NULL == callee_id) || (NULL == msg_body) || dialog_index < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_info_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    //处理过程

    /* 获取呼叫记录 */
    cr_pos = call_record_find_by_caller_index(dialog_index);

    //DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() call_record_find_by_caller_index:cr_pos=%d \r\n", cr_pos);

    if (cr_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Find Call Record Error:dialog_index=%d \r\n", dialog_index);
        return -1;
    }

    pCrData = call_record_get(cr_pos);

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Get Call Record Error:cr_pos=%d \r\n", cr_pos);
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc():caller_id=%s, caller_ip=%s, callee_id=%s, callee_ip=%s \r\n", pCrData->caller_id, pCrData->caller_ip, pCrData->callee_id, pCrData->callee_ip);

#if 0

    /* 查找逻辑设备信息 */
    pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL == pCalleeGBLogicDeviceInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_info_msg_proc() exit---: Get Callee GBlogicDevice Info Error \r\n");
        return -1;
    }

    /* 查找对应的物理设备 */
    pCalleeGBDeviceInfo = pCalleeGBLogicDeviceInfo->ptGBDeviceInfo;

    if (NULL == pCalleeGBDeviceInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_info_msg_proc() exit---: Get Callee GBDevice Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() CalleeGBDeviceInfo device_type=%d \r\n", pCalleeGBDeviceInfo->device_type);

    if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER || pCalleeGBLogicDeviceInfo->record_type == 1) /* 下级CMS 获取前端录像*/
    {
        /* 转发消息出去 */
        SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

        return 0;
    }
    else
#endif
    {
        // TODO:根据RTSP中的信息，传输给TSU
        if (0 == strncmp(msg_body, "PLAY", 4))
        {
            i = notify_tsu_start_replay(pCrData->tsu_ip, pCrData->task_id);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_start_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_start_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            /* 解析MANSRTSP 消息 */
            i = mansrtsp_init(&rtsp);

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Init Error \r\n");
                return -1;
            }

            i = mansrtsp_parse(rtsp, msg_body);

            if (i != 0)
            {
                mansrtsp_free(rtsp);
                osip_free(rtsp);
                rtsp = NULL;

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Parse Error \r\n");
                return -1;
            }

            /* 快放慢放 */
            if (NULL != rtsp->scale && NULL != rtsp->scale->number)
            {
                iScale = atof(rtsp->scale->number);

                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() Scale Number=%f \r\n", iScale);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_info_msg_proc() No Scale Value \r\n");
            }

            /* 拖放 */
            if (NULL != rtsp->range && NULL != rtsp->range->start)
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() NPT Start=%s \r\n", rtsp->range->start);

                if (0 != sstrcmp(rtsp->range->start, "now")
                    && 0 != sstrcmp(rtsp->range->start, "196")
                    && 0 != sstrcmp(rtsp->range->start, "196-")
                    && 0 != sstrcmp(rtsp->range->start, "0-")) /* 老版本客户端里面暂停后的继续命令里面携带的是196，防止从头开始播放 */
                {
                    iLen = strlen(rtsp->range->start);

                    if (iLen > 0)
                    {
                        osip_strncpy(tmpNtp, rtsp->range->start, iLen - 1); /* 去掉最后的"-" */
                        iNtp = osip_atoi(tmpNtp);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Get NPT Error \r\n");
                    }
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Range Start Now \r\n");
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_info_msg_proc() No NPT Value \r\n");
            }

            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() Scale=%f, NPT=%d \r\n", iScale, iNtp);

            if (iScale > 0 || iNtp > 0)
            {
                if (iScale > 0 && iScale != 1.0)
                {
                    pCrData->iScale = iScale;
                }

                /* 查找逻辑设备信息 */
                pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

                if (NULL != pCalleeGBLogicDeviceInfo)
                {
                    /* 根据逻辑设备所属域进行判断，决定消息走向 */
                    if (1 == pCalleeGBLogicDeviceInfo->other_realm)
                    {
                        /* 查找上级路由信息 */
                        iCalleeRoutePos = route_info_find(pCalleeGBLogicDeviceInfo->cms_id);

                        if (iCalleeRoutePos >= 0)
                        {
                            pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

                            if (NULL != pCalleeRouteInfo)
                            {
                                if (iNtp > 0)
                                {
                                    i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }

                                    /* 拖放之前先发送一下恢复命令，大华NVR在暂停状态下，不响应拖放命令 */
                                    if (iScale > 0 && iScale != 1.0)
                                    {
                                        snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nScale: %f\r\nRange: npt=now-\r\n", rtsp->cseq->number, pCrData->iScale);
                                    }
                                    else
                                    {
                                        snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nRange: npt=now-\r\n", rtsp->cseq->number);
                                    }

                                    i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, tmpBuf, strlen(tmpBuf));

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }

                                    /* 修改拖放时间 */
                                    if (pCrData->iPlaybackTimeGap > 0)
                                    {
                                        if (iScale > 0 && iScale != 1.0)
                                        {
                                            snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nScale: %f\r\nRange: npt=%d-\r\n", rtsp->cseq->number, pCrData->iScale, iNtp - pCrData->iPlaybackTimeGap);
                                        }
                                        else
                                        {
                                            snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nRange: npt=%d-\r\n", rtsp->cseq->number, iNtp - pCrData->iPlaybackTimeGap);
                                        }

                                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() SIP_SendInfoWithinDialog:Scale=%f, NPT=%d \r\n", iScale, iNtp - pCrData->iPlaybackTimeGap);

                                        i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, tmpBuf, strlen(tmpBuf));

                                        if (0 != i)
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                        else
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                    }
                                    else
                                    {
                                        /* 转发消息出去 */
                                        i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                                        if (0 != i)
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                        else
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                    }
                                }
                                else
                                {
                                    /* 转发消息出去 */
                                    i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                }
                            }
                            else
                            {
                                if (iScale > 0)
                                {
                                    i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                    }
                                }

                                if (iNtp > 0)
                                {
                                    i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (iScale > 0)
                            {
                                i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                }
                            }

                            if (iNtp > 0)
                            {
                                i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                }
                            }
                        }
                    }
                    else
                    {
                        /* 查找对应的物理设备 */
                        pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, pCrData->callee_stream_type);

                        if (NULL != pCalleeGBDeviceInfo)
                        {
                            if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER || pCalleeGBLogicDeviceInfo->record_type == 1) /* 下级CMS或者前端录像*/
                            {
                                if (iNtp > 0)
                                {
                                    i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }

                                    /* 拖放之前先发送一下恢复命令，大华NVR在暂停状态下，不响应拖放命令 */
                                    if (iScale > 0 && iScale != 1.0)
                                    {
                                        snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nScale: %f\r\nRange: npt=now-\r\n", rtsp->cseq->number, pCrData->iScale);
                                    }
                                    else
                                    {
                                        snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nRange: npt=now-\r\n", rtsp->cseq->number);
                                    }

                                    i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, tmpBuf, strlen(tmpBuf));

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }

                                    /* 修改拖放时间 */
                                    if (pCrData->iPlaybackTimeGap > 0)
                                    {
                                        if (iScale > 0 && iScale != 1.0)
                                        {
                                            snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nScale: %f\r\nRange: npt=%d-\r\n", rtsp->cseq->number, pCrData->iScale, iNtp - pCrData->iPlaybackTimeGap);
                                        }
                                        else
                                        {
                                            snprintf(tmpBuf, 128, (char*)"PLAY RTSP/1.0\r\nCSeq: %s\r\nRange: npt=%d-\r\n", rtsp->cseq->number, iNtp - pCrData->iPlaybackTimeGap);
                                        }

                                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() SIP_SendInfoWithinDialog:Scale=%f, NPT=%d \r\n", iScale, iNtp - pCrData->iPlaybackTimeGap);

                                        i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, tmpBuf, strlen(tmpBuf));

                                        if (0 != i)
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                        else
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog:callee_ua_index=%d, callee_id=%s, callip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                    }
                                    else
                                    {
                                        /* 转发消息出去 */
                                        i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                                        if (0 != i)
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                        else
                                        {
                                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                        }
                                    }
                                }
                                else
                                {
                                    /* 转发消息出去 */
                                    i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                                    }
                                }
                            }
                            else
                            {
                                if (iScale > 0)
                                {
                                    i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                    }
                                }

                                if (iNtp > 0)
                                {
                                    i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                    if (0 != i)
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                    else
                                    {
                                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (iScale > 0)
                            {
                                i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                                }
                            }

                            if (iNtp > 0)
                            {
                                i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                                if (0 != i)
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                }
                                else
                                {
                                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                                }
                            }
                        }
                    }
                }
                else
                {
                    if (iScale > 0)
                    {
                        i = notify_set_replay_speed(pCrData->tsu_ip, pCrData->task_id, iScale);

                        if (0 != i)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_set_replay_speed Error:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_set_replay_speed OK:tsu_ip=%s, task_id=%s, Scale=%f, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iScale, i);
                        }
                    }

                    if (iNtp > 0)
                    {
                        i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                        if (0 != i)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, iNtp, i);
                        }
                    }
                }
            }

            return i;
        }
        else if (0 == strncmp(msg_body, "PAUSE", 5))
        {
            i = notify_tsu_pause_replay(pCrData->tsu_ip, pCrData->task_id);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_pause_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_pause_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            return i;
        }
        else if (0 == strncmp(msg_body, "TEARDOWN", 8))
        {
            i = notify_tsu_stop_replay(pCrData->tsu_ip, pCrData->task_id);

            if (0 != i)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_stop_replay Error:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_stop_replay OK:tsu_ip=%s, task_id=%s, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
            }

            return i;
        }
        else if (0 == strncmp(msg_body, "SEEK", 4))
        {
            /* Seek 命令需要同时发送给前端 */
            /* 查找逻辑设备信息 */
            pCalleeGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

            if (NULL != pCalleeGBLogicDeviceInfo)
            {
                /* 根据逻辑设备所属域进行判断，决定消息走向 */
                if (1 == pCalleeGBLogicDeviceInfo->other_realm)
                {
                    /* 查找上级路由信息 */
                    iCalleeRoutePos = route_info_find(pCalleeGBLogicDeviceInfo->cms_id);

                    if (iCalleeRoutePos >= 0)
                    {
                        pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

                        if (NULL != pCalleeRouteInfo)
                        {
                            /* 转发消息出去 */
                            i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                            if (0 != i)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                            }
                        }
                    }
                }
                else
                {
                    /* 查找对应的物理设备 */
                    pCalleeGBDeviceInfo = GBDevice_info_get_by_stream_type(pCalleeGBLogicDeviceInfo, pCrData->callee_stream_type);

                    if (NULL != pCalleeGBDeviceInfo)
                    {
                        if (pCalleeGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER || pCalleeGBLogicDeviceInfo->record_type == 1) /* 下级CMS 获取前端录像*/
                        {
                            /* 转发消息出去 */
                            i = SIP_SendInfoWithinDialog(pCrData->callee_ua_index, msg_body, msg_body_len);

                            if (0 != i)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() SIP_SendInfoWithinDialog Error:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() SIP_SendInfoWithinDialog OK:callee_ua_index=%d, callee_id=%s, callee_ip=%s, iRet=%d \r\n", pCrData->callee_ua_index, pCrData->callee_id, pCrData->callee_ip, i);
                            }
                        }
                    }
                }
            }

            /* 解析MANSRTSP 消息 */
            i = mansrtsp_init(&rtsp);

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Init Error \r\n");
                return -1;
            }

            i = mansrtsp_parse(rtsp, msg_body);

            if (i != 0)
            {
                mansrtsp_free(rtsp);
                osip_free(rtsp);
                rtsp = NULL;

                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() exit---: Mansrtsp Parse Error \r\n");
                return -1;
            }

            if (NULL != rtsp->range && NULL != rtsp->range->start)
            {
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_info_msg_proc() NPT Start=%s \r\n", rtsp->range->start);

                if (0 != sstrcmp(rtsp->range->start, "now"))
                {
                    iLen = strlen(rtsp->range->start);

                    if (iLen > 0)
                    {
                        osip_strncpy(tmpNtp, rtsp->range->start, iLen - 1); /* 去掉最后的"-" */
                        iNtp = osip_atoi(tmpNtp);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Get NPT Error \r\n");
                    }

                    if (iNtp > 0)
                    {
                        i = notify_tsu_seek_replay(pCrData->tsu_ip, pCrData->task_id, iNtp);

                        if (0 != i)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() notify_tsu_seek_replay Error:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, osip_atoi(rtsp->range->start), i);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_info_msg_proc() notify_tsu_seek_replay OK:tsu_ip=%s, task_id=%s, start=%d, iRet=%d \r\n", pCrData->tsu_ip, pCrData->task_id, osip_atoi(rtsp->range->start), i);
                        }
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() NPT Value Error \r\n");
                    }
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_info_msg_proc() Range Start Now \r\n");
                }
            }

            mansrtsp_free(rtsp);
            osip_free(rtsp);
            rtsp = NULL;

            return i;
        }
    }

    return -1;
}
#endif

/*****************************************************************************
 函 数 名  : user_message_msg_proc
 功能描述  : 用户Message消息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             char* msg_body
             int msg_body_len
             DBOper* pUser_Srv_dboper
             DBOper* pUserLogDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年4月22日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_message_msg_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, char* msg_body, int msg_body_len, DBOper* pUser_Srv_dboper, DBOper* pUserLogDbOper)
{
    int i = 0;
    int iRet = 0;
    xml_type_t xml_type = XML_TYPE_NULL;
    CPacket inPacket;
    vector<string> NodeName_Vector;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_message_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if ((NULL == caller_id) || (NULL == callee_id) || (NULL == msg_body))
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_message_msg_proc() exit---: Param Error \r\n");
        return -1;
    }

    if (NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG,  "user_message_msg_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    //解析XML
    iRet = inPacket.BuiltTree(msg_body, msg_body_len);//生成DOM树结构.

    if (iRet < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "user_message_msg_proc() exit---: XML Build Tree Error \r\nmsg=%s \r\n", msg_body);
        return iRet;
    }

    NodeName_Vector.clear();
    DOMDocument* pDOMDocument = inPacket.GetDOMDocument();
    DOMElement* pDOMElement = pDOMDocument->get_root();
    pDOMElement->ClearNodeNumber();

    if (pDOMElement->GetNodeName(NodeName_Vector) <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_message_msg_proc() exit---: Get Node Name Error \r\n");
        return -1;
    }

    /* 解析出xml的消息类型 */
    xml_type = get_xml_type_from_xml_body(NodeName_Vector, inPacket);
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_message_msg_proc() get_xml_type_from_xml_body:xml_type=%d \r\n", xml_type);

    switch (xml_type)
    {
        case XML_CONTROL_DEVICECONTROL : /* 设备控制 */
            i = user_device_control_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper, pUserLogDbOper);
            break;

        case XML_CONTROL_LOGICDEVICECONTROL : /* RCU设备控制 */
            i = user_device_control_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper, pUserLogDbOper);
            break;

        case XML_CONTROL_DEVICECONFIG : /* 设备配置 */
            i = user_device_config_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_CONTROL_SETDEVICEVIDEOPARAM :    /* 设置前端图像参数 */
            i = user_set_device_video_param_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_CONTROL_REQUESTIFRAMDATA :        /* 请求I 帧 */
            i = user_request_ifram_data_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_CONTROL_AUTOZOOMIN :             /* 点击放大*/
            i = user_control_autozoomin_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_CONTROL_SETDEVICEXYPARAM :/* 设置前端经纬度参数 */
            i = user_set_device_xy_param_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_CATALOG : /* 查询设备目录 */
            i = user_query_catalog_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DEVICEINFO : /* 查询设备信息 */
            i = user_query_device_info_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DEVICESTATUS :    /* 查询设备状态 */
            i = user_query_device_status_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_DEVICECONFIG : /* 设备配置查询 */
            i = user_query_device_config_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_RECORDINFO :  /* 查询设备录像配置 */
            i = user_query_record_info_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_GETPRESET :                    /* 获取预置位 */
            i = user_query_preset_info_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_USERCONFIG :  /* 用户配置获取 */
            i = user_query_user_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DEVICEGROUP :/*获取逻辑分组信息*/
            i = user_query_device_group_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_USERDEVICEGROUP :/* 逻辑设备重新分组信息 */
            i = user_query_user_device_group_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DEVICEMAPGROUP :/*获取逻辑分组映射关系*/
            i = user_query_device_map_group_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_USERDEVICEMAPGROUP :  /* 逻辑设备重新分组映射关系 */
            i = user_query_user_device_map_group_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_POLLCONFIG : /* 用户查询轮巡 */
            i = user_query_poll_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_POLLACTION_CONFIG :  /* 用户查询轮巡动作 */
            i = user_query_poll_action_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_PLANCONFIG :   /* 用户查询预案 */
            i = user_query_plan_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_PLANACTION_CONFIG : /* 用户查询预案动作 */
            i = user_query_plan_action_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_CRUISE_CONFIG :   /* 用户查询巡航 */
            i = user_query_cruise_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_CRUISE_ACTION_CONFIG : /* 用户查询巡航动作 */
            i = user_query_cruise_action_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DEVICEVIDEOPARAM :        /* 获取前端图像参数*/
            i = user_query_device_video_param_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_DEVICEPRESET :            /* 获取前端预置位*/
            i = user_query_device_preset_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_GETDBIP :                    /* 获取数据库IP地址 */
            i = user_get_db_ip_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_CHANNELSTATUS :              /*获取解码器通道状态*/
            i = user_query_channel_status_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_WEBINTERFACECONFIG :          /* 获取 URL信息  */
            i = user_query_web_interface_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_ALARMRECORD :                /* 获取告警信息 */
            i = user_query_alarm_record_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper, pUserLogDbOper);
            break;

        case XML_QUERY_ONLINEUSER :                 /* 获取在线用户信息 */
            i = user_query_online_user_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_DATA_VALUE :                 /*获取前端点位数据值 */
            i = user_query_data_value_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_QUERY_LABEL_RECORD :               /* 获取标签录像数据 */
            i = user_query_label_record_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_ADD_POLLCONFIG :                   /* 增加轮巡配置 */
            i = user_add_poll_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_DEL_POLLCONFIG :                   /* 删除轮巡配置 */
            i = user_del_poll_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_ADD_LABEL_RECORD_CONFIG :          /* 增加标签录像配置 */
            i = user_add_label_record_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_DEL_LABEL_RECORD_CONFIG :          /* 删除标签录像配置 */
            i = user_del_label_record_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_CHANGE_USER_PASSWORD :          /* 修改用户密码 */
            i = user_change_password_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_CONFIRM_ALARM :          /* 用户确认报警信息 */
            i = user_confirm_alarm_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper, pUserLogDbOper);
            break;

        case XML_NOTIFY_ALARM :    /* 告警通知 */
            i = user_notify_alarm_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_NOTIFY_KEEPLIVE :  /* 保活通知 */
            i = user_notify_keep_alive_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_NOTIFY_CONNECT_TV : /* 用户通知连接解码器 */
            i = user_notify_connect_tv_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_NOTIFY_EXECUTE_PLAN : /* 用户通知执行预案 */
            i = user_notify_execute_plan_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_NOTIFY_EXECUTE_POLL :   /* 用户通知执行轮巡 */
            i = user_notify_execute_poll_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_NOTIFY_EXECUTE_CRUISE : /* 用户通知执行巡航 */
            i = user_notify_execute_cruise_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_NOTIFY_TV_STATUS :
            i = user_notify_tv_status_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_NOTIFY_SEND_NOTIFY : /* 高级别用户发送通知命令 */
            i = user_notify_send_notify_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_NOTIFY_SWITCH_ALARM : /* 客户端切换是否发送告警消息 */
            i = user_notify_switch_alarm_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_NOTIFY_SHDB_CMD : /* 用户通知上海地标协议操作 */
            i = user_notify_shdb_cmd_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        case XML_RESPONSE_DEVICECONTROL :
            i = user_device_control_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_RESPONSE_ALARM :
            i = user_notify_alarm_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_RESPONSE_CATALOG :
            i = user_query_catalog_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_RESPONSE_DEVICEINFO :
            i = user_device_info_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_RESPONSE_DEVICESTATUS:
            i = user_device_status_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_RESPONSE_RECORDINFO:
            i = user_record_info_response_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_GET_SYSTEMINFO : /* 获取系统信息 */
            i = user_get_system_info_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        default:
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_message_msg_proc() exit---: Not Support Message Type:%d \r\n", xml_type);
            return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_device_control_proc
 功能描述  : 用户设备控制处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
             DBOper* pUserLogDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_device_control_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper, DBOper* pUserLogDbOper)
{
    int i = 0;
    int iLen = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strPTZCmd[64] = {0};      /* 球机/云台控制命令 */
    char strRecordCmd[32] = {0};   /* 录像控制命令 */
    char strGuardCmd[32] = {0};    /* 报警布防/撤防命令 */
    char strLockCmd[32] = {0};     /* 点位锁定命令 */
    char strTeleBootCmd[32] = {0}; /* 远程启动控制命令 */
    char strAlarmCmd[32] = {0};    /* 报警复位命令 */
    char strAlarmControl[32] = {0};/* 报警确认命令 */

    time_t utc_time;
    struct tm local_time = { 0 };
    char str_date[12] = {0};
    char str_time[12] = {0};
    char strTime[32] = {0};
    char strReason[128] = {0};     /* 原因 */

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    unsigned char szPtzCmd[PTZCMD_28181_LEN + 1] = {0};

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_device_control_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_device_control_proc() exit---: Param Error \r\n");
        return -1;
    }

    /* 设备控制的命令直接转发给前段设备，不做处理
          控制流程见9.3.2

          命令包括如下字段:
          <!-- 命令类型：设备控制（必选） -->
          <element name="CmdType" fixed ="DeviceControl" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 球机/云台控制命令（可选，控制码应符合附录L中的规定) -->
          <element name=" PTZCmd " type="tg:PTZType" />
          <!-- 远程启动控制命令（可选） -->
          <element name="TeleBoot" minOccurs= "0">
          <restriction base="string">
          <enumeration value="Boot"/>
          </restriction>
          </element>
          <!-- 录像控制命令（可选） -->
          <element name=" RecordCmd " type="tg:recordType" minOccurs= "0"/>
          <!-- 报警布防/撤防命令（可选） -->
          <element name=" GuardCmd " type="tg:guardType" minOccurs= "0"/>
          <!-- 报警复位命令（可选） -->
          <element name="AlarmCmd" minOccurs= "0">
          <restriction base="string">
          <enumeration value="ResetAlarm"/>
          </restriction>
          </element>
          <!-- 扩展信息，可多项 -->
          <element name= "Info" minOccurs= "0" maxOccurs="unbounded">
          <restriction base= "string">
          <maxLength value= "1024" />
          </restriction>
          </element>
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"PTZCmd", strPTZCmd);
    inPacket.GetElementValue((char*)"RecordCmd", strRecordCmd);
    inPacket.GetElementValue((char*)"GuardCmd", strGuardCmd);
    inPacket.GetElementValue((char*)"LockCmd", strLockCmd);
    inPacket.GetElementValue((char*)"TeleBoot", strTeleBootCmd);
    inPacket.GetElementValue((char*)"AlarmCmd", strAlarmCmd);
    inPacket.GetElementValue((char*)"AlarmControl", strAlarmControl);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_device_control_proc() \
    \r\n XML Para: \
    \r\n SN=%s, DeviceID=%s, PTZCmd=%s, RecordCmd=%s, GuardCmd=%s, LockCmd=%s, TeleBoot=%s, AlarmCmd=%s, AlarmControl=%s \r\n", strSN, strDeviceID, strPTZCmd, strRecordCmd, strGuardCmd, strLockCmd, strTeleBootCmd, strAlarmCmd, strAlarmControl);

    UserLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户前端设备控制, 前端逻辑设备ID=%s, 命令:PTZCmd=%s, RecordCmd=%s, GuardCmd=%s, LockCmd=%s, TeleBoot=%s, AlarmCmd=%s, AlarmControl=%s", strDeviceID, strPTZCmd, strRecordCmd, strGuardCmd, strLockCmd, strTeleBootCmd, strAlarmCmd, strAlarmControl);
    EnUserLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User front-end device control，Front-end logic device ID=%s", strDeviceID);

    /* 重新启动 */
    if (strTeleBootCmd[0] != '\0')
    {
        if (0 == sstrcmp(strTeleBootCmd, (char*)"Boot"))
        {
            if (0 == sstrcmp(strDeviceID, local_cms_id_get()))
            {
                /* 发送去注册 */
                i = SendUnRegisterToAllRouteCMS();

                if (i < 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SendUnRegisterToAllRouteCMS Error: iRet=%d \r\n", i);
                }
                else if (i > 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SendUnRegisterToAllRouteCMS OK: iRet=%d \r\n", i);
                }

                osip_usleep(5000000);

                BoardReboot();

                return i;
            }
        }
    }

    /* 报警设备控制 */
    if (strAlarmControl[0] != '\0')
    {
        if (0 == sstrcmp(strAlarmControl, (char*)"ConfirmAlarm"))     /* 报警确认 */
        {
            i = user_confirm_alarm_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper, pUserLogDbOper);

            return i;
        }
    }

    /* 点位锁定 */
    if (strLockCmd[0] != '\0')
    {
        i = UserLockDeviceProc(strLockCmd, strDeviceID, pUserInfo);
    }

    /* 手动录像 */
    if (strRecordCmd[0] != '\0')
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

        if (NULL != pGBLogicDeviceInfo)
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (EV9000_DEVICETYPE_SIPSERVER != pGBDeviceInfo->device_type)
            {
                if (0 == sstrcmp(strRecordCmd, (char*)"Record")) /* 开始手动录像 */
                {
                    if (0 == pGBLogicDeviceInfo->record_type) /* 本地录像 */
                    {
                        /* 启动录像 */
                        i = add_record_info_by_message_cmd(pGBLogicDeviceInfo->id, pUser_Srv_dboper);

                        if (i != 0)
                        {
                            SystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 手动启动录像失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"添加录像任务失败");
                            EnSystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_ERROR, "User control command processing equipment, manual start video failed: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"添加录像任务失败");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() add_record_info_by_message_cmd Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理, 手动启动录像成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                            EnSystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, "User control command processing equipment, manual start video success: user ID = % s, = % s IP address, port number = % d, logical device ID = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() add_record_info_by_message_cmd OK \r\n");
                        }

                        /* 组建XML信息 */
                        outPacket.SetRootTag("Response");
                        AccNode = outPacket.CreateElement((char*)"CmdType");
                        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                        AccNode = outPacket.CreateElement((char*)"SN");
                        outPacket.SetElementValue(AccNode, strSN);

                        AccNode = outPacket.CreateElement((char*)"DeviceID");
                        outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                        AccNode = outPacket.CreateElement((char*)"Result");
                        outPacket.SetElementValue(AccNode, (char*)"OK");

                        /* 发送响应消息给用户 */
                        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                        if (i != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }

                        return i;
                    }
                }
                else if (0 == sstrcmp(strRecordCmd, (char*)"StopRecord")) /* 停止手动录像 */
                {
                    if (0 == pGBLogicDeviceInfo->record_type) /* 本地录像 */
                    {
                        /* 停止录像 */
                        i = del_record_info_by_message_cmd(pGBLogicDeviceInfo->id, pUser_Srv_dboper);

                        if (i != 0)
                        {
                            SystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 手动停止录像失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"删除录像任务失败");
                            EnSystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_ERROR, "User control command processing equipment, video is stopped manually failed: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"删除录像任务失败");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() del_record_info_by_message_cmd Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理, 手动停止录像成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                            EnSystemLog(EV9000_USER_LOG_DEVICE_CONTROL, EV9000_LOG_LEVEL_NORMAL, "User control command processing equipment, manual stop video success: user ID = % s, = % s IP address, port number = % d, logical device ID = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() del_record_info_by_message_cmd OK \r\n");
                        }

                        /* 组建XML信息 */
                        outPacket.SetRootTag("Response");
                        AccNode = outPacket.CreateElement((char*)"CmdType");
                        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                        AccNode = outPacket.CreateElement((char*)"SN");
                        outPacket.SetElementValue(AccNode, strSN);

                        AccNode = outPacket.CreateElement((char*)"DeviceID");
                        outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                        AccNode = outPacket.CreateElement((char*)"Result");
                        outPacket.SetElementValue(AccNode, (char*)"OK");

                        /* 发送响应消息给用户 */
                        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                        if (i != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }

                        return i;
                    }
                }
                else
                {
                    SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 手动录像失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=不支持的录像命令:RecordCmd=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strRecordCmd);
                    EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, Manual recording failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason= not supported video command:RecordCmd=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strRecordCmd);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Record Cmd Error: RecordCmd=%s \r\n", strRecordCmd);
                }
            }
        }
        else
        {
            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 手动录像失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=查找逻辑设备失败:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, Manual recording failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=find logical device failed:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Find GB LogicDevice Info Error: DeviceID=%s \r\n", strDeviceID);
        }
    }

    /* 布防、撤防 */
    if (strGuardCmd[0] != '\0')
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

        if (NULL != pGBLogicDeviceInfo)
        {
            if (0 == sstrcmp(strGuardCmd, (char*)"SetGuard")) /* 布防*/
            {
                pGBLogicDeviceInfo->guard_type = 1;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() GBLogicDevice=%s, GuardStatus=%d \r\n", pGBLogicDeviceInfo->device_id, pGBLogicDeviceInfo->guard_type);
            }
            else if (0 == sstrcmp(strGuardCmd, (char*)"ResetGuard")) /*  撤防 */
            {
                pGBLogicDeviceInfo->guard_type = 0;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() GBLogicDevice=%s, GuardStatus=%d \r\n", pGBLogicDeviceInfo->device_id, pGBLogicDeviceInfo->guard_type);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Guard Cmd Error: GuardCmd=%s \r\n", strGuardCmd);
            }
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Find GB LogicDevice Info Error: DeviceID=%s \r\n", strDeviceID);
        }

        /* 组建XML信息 */
        outPacket.SetRootTag("Response");
        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, (char*)strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        /* 发送响应消息给用户 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
    }

    /* 报警复位 */
    if (strAlarmCmd[0] != '\0')
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

        if (NULL != pGBLogicDeviceInfo)
        {
            if (0 == sstrcmp(strAlarmCmd, (char*)"ResetAlarm")) /* 复位告警 */
            {
                pGBLogicDeviceInfo->guard_type = 0;
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() GBLogicDevice=%s, GuardStatus=%d \r\n", pGBLogicDeviceInfo->device_id, pGBLogicDeviceInfo->guard_type);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Alarm Cmd Error: AlarmCmd=%s \r\n", strAlarmCmd);
            }
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Find GB LogicDevice Info Error: DeviceID=%s \r\n", strDeviceID);
        }

        /* 组建XML信息 */
        outPacket.SetRootTag("Response");
        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, (char*)strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        /* 发送响应消息给用户 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
    }

    /* PTZ云台控制命令 */
    if (strPTZCmd[0] != '\0')
    {
        /* 如果是控球命令，需要检查逻辑点位是否被锁定 */
        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

        if (NULL != pGBLogicDeviceInfo)
        {
            /* 如果是本级用户锁定的时候，判断用户是否一致 */
            if (LOCK_STATUS_USER_LOCK == pGBLogicDeviceInfo->lock_status)
            {
                if (NULL != pGBLogicDeviceInfo->pLockUserInfo)
                {
                    if (pGBLogicDeviceInfo->pLockUserInfo == pUserInfo)
                    {
                        /* 更新锁定时间 */
                        i = device_auto_unlock_update(pGBLogicDeviceInfo->id);
                    }
                    else
                    {
                        /* 判断用户等级 */
                        if (pUserInfo->user_level <= pGBLogicDeviceInfo->pLockUserInfo->user_level)
                        {
                            /* 发送报警数据给客户端用户 */
                            outPacket.SetRootTag("Notify");

                            AccNode = outPacket.CreateElement((char*)"CmdType");
                            outPacket.SetElementValue(AccNode, (char*)"Alarm");

                            AccNode = outPacket.CreateElement((char*)"SN");
                            outPacket.SetElementValue(AccNode, strSN);

                            AccNode = outPacket.CreateElement((char*)"DeviceID");
                            outPacket.SetElementValue(AccNode, strDeviceID);

                            AccNode = outPacket.CreateElement((char*)"AlarmPriority");
                            outPacket.SetElementValue(AccNode, (char*)"7");

                            AccNode = outPacket.CreateElement((char*)"AlarmMethod");
                            outPacket.SetElementValue(AccNode, (char*)"5");

                            AccNode = outPacket.CreateElement((char*)"AlarmTime");
                            utc_time = time(NULL);
                            localtime_r(&utc_time, &local_time);
                            strftime(str_date, sizeof(str_date), "%Y-%m-%d", &local_time);
                            strftime(str_time, sizeof(str_time), "%H:%M:%S", &local_time);
                            snprintf(strTime, 32, "%sT%s", str_date, str_time);
                            outPacket.SetElementValue(AccNode, strTime);

                            AccNode = outPacket.CreateElement((char*)"AlarmDescription");
                            snprintf(strReason, 128, "逻辑设备已经被高等级用户锁定:锁定用户ID=%s, 锁定用户IP地址=%s, 锁定用户端口号=%d", pGBLogicDeviceInfo->pLockUserInfo->user_id, pGBLogicDeviceInfo->pLockUserInfo->login_ip, pGBLogicDeviceInfo->pLockUserInfo->login_port);
                            outPacket.SetElementValue(AccNode, strReason);

                            /* 发送响应消息给用户 */
                            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }

                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=逻辑设备已经被高等级用户锁定:锁定用户ID=%s, 锁定用户IP地址=%s, 锁定用户端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBLogicDeviceInfo->pLockUserInfo->user_id, pGBLogicDeviceInfo->pLockUserInfo->login_ip, pGBLogicDeviceInfo->pLockUserInfo->login_port);
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Logical device has been locked", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Record Cmd Error: GBLogicDevice Locked: ID=%s \r\n", strDeviceID);
                            return -1;
                        }
                    }
                }
                else /* 原有用户锁定失效 */
                {
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                    pGBLogicDeviceInfo->pLockUserInfo = NULL;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                }
            }
            else if (LOCK_STATUS_ROUTE_LOCK == pGBLogicDeviceInfo->lock_status)
            {
                if (NULL != pGBLogicDeviceInfo->pLockRouteInfo)
                {
                    if (0 == pGBLogicDeviceInfo->pLockRouteInfo->reg_status) /* 原有上级平台锁定失效 */
                    {
                        pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                        pGBLogicDeviceInfo->pLockUserInfo = NULL;
                        pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                    }
                    else
                    {
                        /* 发送报警数据给客户端用户 */
                        outPacket.SetRootTag("Notify");

                        AccNode = outPacket.CreateElement((char*)"CmdType");
                        outPacket.SetElementValue(AccNode, (char*)"Alarm");

                        AccNode = outPacket.CreateElement((char*)"SN");
                        outPacket.SetElementValue(AccNode, strSN);

                        AccNode = outPacket.CreateElement((char*)"DeviceID");
                        outPacket.SetElementValue(AccNode, strDeviceID);

                        AccNode = outPacket.CreateElement((char*)"AlarmPriority");
                        outPacket.SetElementValue(AccNode, (char*)"7");

                        AccNode = outPacket.CreateElement((char*)"AlarmMethod");
                        outPacket.SetElementValue(AccNode, (char*)"5");

                        AccNode = outPacket.CreateElement((char*)"AlarmTime");
                        utc_time = time(NULL);
                        localtime_r(&utc_time, &local_time);
                        strftime(str_date, sizeof(str_date), "%Y-%m-%d", &local_time);
                        strftime(str_time, sizeof(str_time), "%H:%M:%S", &local_time);
                        snprintf(strTime, 32, "%sT%s", str_date, str_time);
                        outPacket.SetElementValue(AccNode, strTime);

                        AccNode = outPacket.CreateElement((char*)"AlarmDescription");
                        snprintf(strReason, 128, "逻辑设备已经被上级锁定:锁定上级CMD ID=%s, 锁定上级CMS IP地址=%s, 锁定上级CMS端口号=%d", pGBLogicDeviceInfo->pLockRouteInfo->server_id, pGBLogicDeviceInfo->pLockRouteInfo->server_ip, pGBLogicDeviceInfo->pLockRouteInfo->server_port);
                        outPacket.SetElementValue(AccNode, strReason);

                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=逻辑设备已经被上级锁定:锁定上级CMD ID=%s, 锁定上级CMS IP地址=%s, 锁定上级CMS端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBLogicDeviceInfo->pLockRouteInfo->server_id, pGBLogicDeviceInfo->pLockRouteInfo->server_ip, pGBLogicDeviceInfo->pLockRouteInfo->server_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Logical device has been locked", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Record Cmd Error: GBLogicDevice Locked: ID=%s \r\n", strDeviceID);
                        return -1;
                    }
                }
                else /* 原有上级平台锁定失效 */
                {
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                    pGBLogicDeviceInfo->pLockUserInfo = NULL;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                }
            }
        }
    }

    /* 转发消息到前端 */
    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL != pGBLogicDeviceInfo)
    {
        /* 其他域的点位 */
        if (1 == pGBLogicDeviceInfo->other_realm)
        {
            /* 查找上级路由信息 */
            iCalleeRoutePos = route_info_find(pGBLogicDeviceInfo->cms_id);

            if (iCalleeRoutePos < 0)
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的上级路由信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding route information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Get LogicDevice's Route Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }

            pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

            if (NULL == pCalleeRouteInfo)
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的上级路由信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding route information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Get LogicDevice's Route Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }

            if (strPTZCmd[0] != '\0') /* 可能是设置预置位操作的，前端有返回 */
            {
                iLen = String2Bytes((unsigned char*)strPTZCmd, szPtzCmd, PTZCMD_28181_LEN);

                if (szPtzCmd[3] == 0x81 || szPtzCmd[3] == 0x83)
                {
                    /* 获取老的SN节点 */
                    AccSnNode = inPacket.SearchElement((char*)"SN");

                    if (NULL != AccSnNode)
                    {
                        g_transfer_xml_sn++;
                        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                        inPacket.SetElementValue(AccSnNode, strTransferSN);
                    }

                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, superior CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to superior CMS failed.", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到上级CMS, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);

                        old_xml_sn = strtoul(strSN, NULL, 10);
                        transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                        i = transfer_xml_msg_add(XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                    }
                }
                else
                {
                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, superior CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to superior CMS failed.", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到上级CMS, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    }
                }
            }
            else
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, superior CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to superior CMS failed.", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到上级CMS, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                }
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() GBDeviceInfo device_type=%d\r\n", pGBDeviceInfo->device_type);

                if (strPTZCmd[0] != '\0')
                {
                    //如果是预置位命令，判断是否需要更新数据库,下级cms情况下不需要判断
                    if (EV9000_DEVICETYPE_SIPSERVER != pGBDeviceInfo->device_type)
                    {
                        i = preset_record(inPacket, pGBLogicDeviceInfo->id, pUser_Srv_dboper);

                        if (i < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Preset Record Error:device_id=%s \r\n", pGBDeviceInfo->device_id);

                            /* 组建XML信息 */
                            outPacket.SetRootTag("Response");
                            AccNode = outPacket.CreateElement((char*)"CmdType");
                            outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                            AccNode = outPacket.CreateElement((char*)"SN");
                            outPacket.SetElementValue(AccNode, strSN);

                            AccNode = outPacket.CreateElement((char*)"DeviceID");
                            outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                            AccNode = outPacket.CreateElement((char*)"Result");
                            outPacket.SetElementValue(AccNode, (char*)"ERROR");

                            /* 发送响应消息给用户 */
                            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }

                            return -1;
                        }
                        else
                        {
                            /* 组建XML信息 */
                            outPacket.SetRootTag("Response");
                            AccNode = outPacket.CreateElement((char*)"CmdType");
                            outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                            AccNode = outPacket.CreateElement((char*)"SN");
                            outPacket.SetElementValue(AccNode, strSN);

                            AccNode = outPacket.CreateElement((char*)"DeviceID");
                            outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                            AccNode = outPacket.CreateElement((char*)"Result");
                            outPacket.SetElementValue(AccNode, (char*)"OK");

                            /* 发送响应消息给用户 */
                            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                        }
                    }
                    else if (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type
                             && 1 == pGBDeviceInfo->three_party_flag) /* 第三方平台的下级点位 */
                    {
                        i = preset_record(inPacket, pGBLogicDeviceInfo->id, pUser_Srv_dboper);

                        if (i < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() Preset Record Error:device_id=%s \r\n", pGBDeviceInfo->device_id);

                            /* 组建XML信息 */
                            outPacket.SetRootTag("Response");
                            AccNode = outPacket.CreateElement((char*)"CmdType");
                            outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                            AccNode = outPacket.CreateElement((char*)"SN");
                            outPacket.SetElementValue(AccNode, strSN);

                            AccNode = outPacket.CreateElement((char*)"DeviceID");
                            outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                            AccNode = outPacket.CreateElement((char*)"Result");
                            outPacket.SetElementValue(AccNode, (char*)"ERROR");

                            /* 发送响应消息给用户 */
                            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }

                            return -1;
                        }
                        else
                        {
                            /* 组建XML信息 */
                            outPacket.SetRootTag("Response");
                            AccNode = outPacket.CreateElement((char*)"CmdType");
                            outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

                            AccNode = outPacket.CreateElement((char*)"SN");
                            outPacket.SetElementValue(AccNode, strSN);

                            AccNode = outPacket.CreateElement((char*)"DeviceID");
                            outPacket.SetElementValue(AccNode, (char*)strDeviceID);

                            AccNode = outPacket.CreateElement((char*)"Result");
                            outPacket.SetElementValue(AccNode, (char*)"OK");

                            /* 发送响应消息给用户 */
                            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                            else
                            {
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            }
                        }
                    }
                }

                if (strLockCmd[0] != '\0') /* 如果是锁定命令，只发给下级平台 */
                {
                    if (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type)
                    {
                        i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User device control command processing success, Forwarding messages to the front end physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        }
                    }
                }
                else if (strRecordCmd[0] != '\0') /* 如果是手动录像命令，前端有返回 */
                {
                    /* 获取老的SN节点 */
                    AccSnNode = inPacket.SearchElement((char*)"SN");

                    if (NULL != AccSnNode)
                    {
                        g_transfer_xml_sn++;
                        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                        inPacket.SetElementValue(AccSnNode, strTransferSN);
                    }

                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User equipment control command processing is successful, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                        old_xml_sn = strtoul(strSN, NULL, 10);
                        transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                        i = transfer_xml_msg_add(XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                    }
                }
                else if (strPTZCmd[0] != '\0') /* 可能是设置预置位操作的，前端有返回 */
                {
                    if (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type
                        && 0 == pGBDeviceInfo->three_party_flag) /* 下级点位 */
                    {
                        iLen = String2Bytes((unsigned char*)strPTZCmd, szPtzCmd, PTZCMD_28181_LEN);

                        if (szPtzCmd[3] == 0x81 || szPtzCmd[3] == 0x83)
                        {
                            /* 获取老的SN节点 */
                            AccSnNode = inPacket.SearchElement((char*)"SN");

                            if (NULL != AccSnNode)
                            {
                                g_transfer_xml_sn++;
                                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                                inPacket.SetElementValue(AccSnNode, strTransferSN);
                            }

                            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            }
                            else
                            {
                                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User equipment control command processing is successful, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                                old_xml_sn = strtoul(strSN, NULL, 10);
                                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                                i = transfer_xml_msg_add(XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_device_control_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_CONTROL_DEVICECONTROL, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                            }
                        }
                        else
                        {
                            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                            if (i != 0)
                            {
                                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            }
                            else
                            {
                                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User equipment control command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            }
                        }
                    }
                    else
                    {
                        i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User equipment control command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        }
                    }
                }
                else
                {
                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User equipment control command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }
                }
            }
            else
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }
    else
    {
        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_control_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_RCU_device_control_proc
 功能描述  : RCU设备控制处理
 输入参数  : GBDevice_info_t* pGBDeviceInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pDevice_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年11月22日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_RCU_device_control_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;
    char strDeviceID[32] = {0};
    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_RCU_device_control_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_RCU_device_control_proc() exit---: Param Error \r\n");
        return -1;
    }


    /* 取得数据*/
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    /* 转发消息到前端 */
    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL != pGBLogicDeviceInfo)
    {
        /* 其他域的点位 */
        if (1 == pGBLogicDeviceInfo->other_realm)
        {
            /* 查找上级路由信息 */
            iCalleeRoutePos = route_info_find(pGBLogicDeviceInfo->cms_id);

            if (iCalleeRoutePos < 0)
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的上级路由信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding route information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() exit---: Get LogicDevice's Route Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }

            pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

            if (NULL == pCalleeRouteInfo)
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的上级路由信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding route information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() exit---: Get LogicDevice's Route Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }

            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, superior CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to superior CMS failed.", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() SIP_SendMessage Error:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            }
            else
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户RCU设备控制命令处理成功, 转发消息到上级CMS, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 上级CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_RCU_device_control_proc() SIP_SendMessage OK:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_RCU_device_control_proc() GBDeviceInfo device_type=%d\r\n", pGBDeviceInfo->device_type);

                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户RCU设备控制命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User RCU equipment control command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_RCU_device_control_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }
    else
    {
        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户RCU设备控制命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User RCU device control command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_RCU_device_control_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_device_config_proc
 功能描述  : 用户前端设备配置命令的处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年7月15日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_device_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_message_msg_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_device_config_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户前端设备配置, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User fron-end  device config, Front-end logic device ID=%s", callee_id);

    /* 网络设备配置

          设备配置命令直接转发给前段设备，不做处理
          命令包括如下字段:
          <!-- 命令类型：设备信息查询（必选） -->
          <element name="CmdType" fixed ="DeviceConfig" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_device_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 查看被叫是否是本CMS ID */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        // TODO:本级CMS的配置是否需要回复?
    }
    else
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

        if (NULL != pGBLogicDeviceInfo)
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户前端设备配置命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User front-end device configure command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_config_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户前端设备配置命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User front-end device configuration command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_config_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户前端设备配置命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User front-end device configure command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_config_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_find(callee_id);

            if (NULL != pGBDeviceInfo)
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户前端设备配置命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User front-end device configure command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_config_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户前端设备配置命令处理成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User front-end device configuration command processing is successful, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_device_config_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户前端设备配置命令处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_SET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User front-end device configure command processing failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_device_config_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }

    return i;
}

//added by chenyu 140106
//预置位记录数据库
int preset_record(CPacket& inPacket, unsigned int device_index, DBOper* pdb)
{
    int iLen = 0;
    int iRet = 0;
    char szSql[200] = {0};
    char strPtzCmd[64] = {0};
    char strPresetName[32] = {0};
    char strResved1[16] = {0};
    unsigned char szPtzCmd[PTZCMD_28181_LEN + 1] = {0};
    preset_auto_back_t* pPresetAutoBackNode = NULL;
    int iResved1 = 0;

    if (device_index <= 0 || NULL == pdb)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "preset_record() Param Error \r\n");
        return -1;
    }

    //解析命令, 取得数据
    inPacket.GetElementValue((char*)"PTZCmd", strPtzCmd);
    inPacket.GetElementValue((char*)"PresetName", strPresetName);
    inPacket.GetElementValue((char*)"Resved1", strResved1); /* 是否为自动归位预置位点 */

    if (strPtzCmd[0] == '\0' || strlen(strPtzCmd) <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "preset_record() PTZ Cmd Error:strPtzCmd=%s, strPresetName=%s \r\n", strPtzCmd, strPresetName);
        return -1;
    }

    iLen = String2Bytes((unsigned char*)strPtzCmd, szPtzCmd, PTZCMD_28181_LEN);

    if (iLen == -1)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() String2Bytes Error \r\n");
        //printf("PTZCmd字符串转换fail\n");
        return -1;
    }

    switch (szPtzCmd[3])
    {
        case 0x81:    //set
        {
            //查询看看预置位信息是否已经存在
            memset(szSql, 0, 200);
            snprintf(szSql, 200, "SELECT * from PresetConfig WHERE DeviceIndex=%u and PresetID=%d;", device_index, (int)szPtzCmd[5]);
            iRet = pdb->DB_Select(szSql, 1);

            DEBUG_TRACE(MODULE_USER, LOG_INFO, "preset_record() set:szSql=%s, iRet=%d \r\n", szSql, iRet);

            if (iRet < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                return -2;
            }
            else if (0 == iRet) /* 不存在 */
            {
                if (strResved1[0] != '\0') /* 设置自动归位预置位 */
                {
                    /* 先全部去除 */
                    memset(szSql, 0, 200);
                    snprintf(szSql, 200, "UPDATE PresetConfig SET Resved1=0 WHERE DeviceIndex=%u;", device_index);

                    iRet = pdb->DB_Update(szSql, 1);

                    if (iRet < 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                        return -2;
                    }

                    /* 移除自动归位信息 */
                    iRet = preset_auto_back_remove(device_index);

                    if (iRet != 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_remove Error:DeviceIndex=%u\r\n", device_index);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_remove OK:DeviceIndex=%u\r\n", device_index);
                    }

                    /* 获取自动归位的时间 */
                    iResved1 = osip_atoi(strResved1);

                    /* 如果是设置自动归位点 */
                    if (iResved1 == 1) /* 兼容老版本 */
                    {
                        //插入记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "insert into PresetConfig (DeviceIndex,PresetID,PresetName,Resved1) values (%u,%d,'%s',1);", device_index, (int)szPtzCmd[5], strPresetName);
                        iRet = pdb->DB_Insert("", "", szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }

                        /* 增加自动归位预置位信息 */
                        iRet = preset_auto_back_use(device_index, (unsigned int)szPtzCmd[5], 60);

                        if (iRet != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_use Error:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_use OK:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }

                        /* 更新自动归位预置位信息 */
                        iRet = preset_auto_back_update(device_index);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
                        }
                        else if (iRet > 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
                        }
                    }
                    else if (iResved1 >= 60)
                    {
                        //插入记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "insert into PresetConfig (DeviceIndex,PresetID,PresetName,Resved1) values (%u,%d,'%s',%d);", device_index, (int)szPtzCmd[5], strPresetName, iResved1);
                        iRet = pdb->DB_Insert("", "", szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }

                        /* 增加自动归位预置位信息 */
                        iRet = preset_auto_back_use(device_index, (unsigned int)szPtzCmd[5], iResved1);

                        if (iRet != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_use Error:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_use OK:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }

                        /* 更新自动归位预置位信息 */
                        iRet = preset_auto_back_update(device_index);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
                        }
                        else if (iRet > 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
                        }
                    }
                    else
                    {
                        //插入记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "insert into PresetConfig (DeviceIndex,PresetID,PresetName,Resved1) values (%u,%d,'%s',0);", device_index, (int)szPtzCmd[5], strPresetName);
                        iRet = pdb->DB_Insert("", "", szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }
                    }
                }
                else
                {
                    //插入记录
                    memset(szSql, 0, 200);
                    snprintf(szSql, 200, "insert into PresetConfig (DeviceIndex,PresetID,PresetName,Resved1) values (%u,%d,'%s',0);", device_index, (int)szPtzCmd[5], strPresetName);
                    iRet = pdb->DB_Insert("", "", szSql, 1);

                    if (iRet < 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                        return -2;
                    }
                }
            }
            else if (iRet > 0) /* 更新操作，不能执行删除，否则有关联删除的表数据被删除 */
            {
                if (strResved1[0] != '\0') /* 设置自动归位预置位 */
                {
                    /* 先全部去除 */
                    memset(szSql, 0, 200);
                    snprintf(szSql, 200, "UPDATE PresetConfig SET Resved1=0 WHERE DeviceIndex=%u;", device_index);

                    iRet = pdb->DB_Update(szSql, 1);

                    if (iRet < 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                        return -2;
                    }

                    /* 移除自动归位信息 */
                    iRet = preset_auto_back_remove(device_index);

                    if (iRet != 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_remove Error:DeviceIndex=%u\r\n", device_index);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_remove OK:DeviceIndex=%u\r\n", device_index);
                    }

                    /* 获取自动归位的时间 */
                    iResved1 = osip_atoi(strResved1);

                    /* 如果是设置自动归位点 */
                    if (iResved1 == 1) /* 兼容老版本 */
                    {
                        //更新记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "UPDATE PresetConfig Set PresetName='%s', Resved1=1 WHERE DeviceIndex=%u AND PresetID=%d;", strPresetName, device_index, (int)szPtzCmd[5]);
                        iRet = pdb->DB_Update(szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }

                        /* 增加自动归位预置位信息 */
                        iRet = preset_auto_back_use(device_index, (unsigned int)szPtzCmd[5], 60);

                        if (iRet != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_use Error:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_use OK:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }

                        /* 更新自动归位预置位信息 */
                        iRet = preset_auto_back_update(device_index);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
                        }
                        else if (iRet > 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
                        }
                    }
                    else if (iResved1 >= 60)
                    {
                        //更新记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "UPDATE PresetConfig Set PresetName='%s', Resved1=%d WHERE DeviceIndex=%u AND PresetID=%d;", strPresetName, iResved1, device_index, (int)szPtzCmd[5]);
                        iRet = pdb->DB_Update(szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }

                        /* 增加自动归位预置位信息 */
                        iRet = preset_auto_back_use(device_index, (unsigned int)szPtzCmd[5], iResved1);

                        if (iRet != 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_use Error:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }
                        else
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_use OK:DeviceIndex=%u and PresetID=%d \r\n", device_index, (int)szPtzCmd[5]);
                        }

                        /* 更新自动归位预置位信息 */
                        iRet = preset_auto_back_update(device_index);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
                        }
                        else if (iRet > 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
                        }
                    }
                    else
                    {
                        //更新记录
                        memset(szSql, 0, 200);
                        snprintf(szSql, 200, "UPDATE PresetConfig Set PresetName='%s', Resved1=0 WHERE DeviceIndex=%u AND PresetID=%d;", strPresetName, device_index, (int)szPtzCmd[5]);
                        iRet = pdb->DB_Update(szSql, 1);

                        if (iRet < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                            return -2;
                        }
                    }
                }
                else
                {
                    //更新记录
                    memset(szSql, 0, 200);
                    snprintf(szSql, 200, "UPDATE PresetConfig Set PresetName='%s', Resved1=0 WHERE DeviceIndex=%u AND PresetID=%d;", strPresetName, device_index, (int)szPtzCmd[5]);
                    iRet = pdb->DB_Update(szSql, 1);

                    if (iRet < 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                        return -2;
                    }
                }
            }

            return iRet;
        }
        break;

        case 0x82:   //do
        {
            /* 更新自动归位预置位信息，执行预置位之后需要自动归为操作 */
            iRet = preset_auto_back_update(device_index);

            if (iRet < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
            }
            else if (iRet > 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
            }
        }
        break;

        case 0x83:   //del
        {
            //先删除
            memset(szSql, 0, 200);
            snprintf(szSql, 200, "delete from PresetConfig WHERE DeviceIndex = %u and PresetID = %d;", device_index, (int)szPtzCmd[5]);
            iRet = pdb->DB_Delete(szSql, 1);

            if (iRet < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() DB Oper Error:szSql=%s, iRet=%d \r\n", szSql, iRet);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() ErrorMsg=%s\r\n", pdb->GetLastDbErrorMsg());
                return -2;
            }

            /* 查找自动归位预置位信息 */
            pPresetAutoBackNode = preset_auto_back_find(device_index);

            if (NULL != pPresetAutoBackNode)
            {
                if (pPresetAutoBackNode->uPresetID == (unsigned int)szPtzCmd[5])
                {
                    /* 移除自动归位信息 */
                    iRet = preset_auto_back_remove(device_index);

                    if (iRet != 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_remove Error:DeviceIndex=%u\r\n", device_index);
                    }
                    else
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_remove OK:DeviceIndex=%u\r\n", device_index);
                    }
                }
            }

            return iRet;
        }
        break;

        default:
        {
            /* 更新自动归位预置位信息，执行预置位之后需要自动归为操作 */
            iRet = preset_auto_back_update(device_index);

            if (iRet < 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "preset_record() preset_auto_back_update Error:DeviceIndex=%u\r\n", device_index);
            }
            else if (iRet > 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "preset_record() preset_auto_back_update OK:DeviceIndex=%u\r\n", device_index);
            }
        }
        break;
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_set_device_video_param_proc
 功能描述  : 用户设置前端图像参数
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_set_device_video_param_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_set_device_video_param_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_set_device_video_param_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_USER_LOG_SET_CAMERA_PARAM, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户设置前端图像参数, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_USER_LOG_SET_CAMERA_PARAM, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User set front-end picture parameter，Front-end logic device ID=%s", callee_id);

    /* 设置前端图像参数的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <?xml version="1.0"?>
      <Control>
      <CmdType>SetDeviceVideoParam</CmdType>
      <SN>43</SN>
      <DeviceID>64010000001110000001</DeviceID>
      <Brightness>12</ Brightness >        // 亮度
      <Saturation>22</ Saturation >         // 饱和度
      <Contrast>2</ Contrast>                 // 对比度
      <ColourDegree>2</ ColourDegree >  // 色度
      </Control>
      */

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set front-end image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_video_param_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设置前端图像参数成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users set the front image parameters successfully, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_set_device_video_param_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set front-end image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_video_param_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_find(callee_id);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set front-end image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_video_param_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设置前端图像参数成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users set the front image parameters successfully, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_set_device_video_param_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_SET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set front-end image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_video_param_proc() exit---: Find GB Device Info Error:DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_request_ifram_data_proc
 功能描述  : 请求I帧
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_request_ifram_data_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_request_ifram_data_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_request_ifram_data_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户请求I帧, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User requestI frame，Front-end logic device ID=%s", callee_id);

    /* 请求I 帧的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <?xml version="1.0"?>
      < Control >
      <CmdType>RequestIFrameData</CmdType>
      <SN>43</SN>
      <DeviceID>64010000001110000001</DeviceID>
      </ Control >

      */

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            if (EV9000_DEVICETYPE_MGWSERVER == pGBDeviceInfo->device_type
                || (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type && 0 == pGBDeviceInfo->three_party_flag))
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求I帧失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User request I-frame failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_request_ifram_data_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求I帧成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User request frame is successful, I forward the message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_request_ifram_data_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
        }
        else
        {
            SystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求I帧失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User request I-frame failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=没Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_request_ifram_data_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_find(callee_id);

        if (NULL != pGBDeviceInfo)
        {
            if (EV9000_DEVICETYPE_MGWSERVER == pGBDeviceInfo->device_type
                || (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type && 0 == pGBDeviceInfo->three_party_flag))
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求I帧失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User request I-frame failed败:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_request_ifram_data_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户请求I帧成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User request frame is successful, I forward the message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_request_ifram_data_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
        }
        else
        {
            SystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户请求I帧失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_REQUEST_IFRAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User request I-frame failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_request_ifram_data_proc() exit---: Find GB Device Info Error:DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_control_autozoomin_proc
 功能描述  : 点击放大
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int user_control_autozoomin_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_control_autozoomin_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_control_autozoomin_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户点击放大, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User click to enlarge，Front-end logic device ID=%s", callee_id);

    /* 点击放大的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <?xml version="1.0"?>
      <Control>
      <CmdType> AutoZoomIn</CmdType>
      <SN>43</SN>
      <DeviceID>64010000001110000001</DeviceID>
      <DisplayFrameWide>12</ DisplayFrameWide>      //显示画面宽
      <DisplayFrameHigh>12</ DisplayFrameHigh >      //显示画面高
      <DestMatrixTopLeftX>1.2</ DestMatrixTopLeftX >  //目标矩形左上角位置：
      <DestMatrixTopLeftY>1.2</ DestMatrixTopLeftY >  //目标矩形左上角位置：
      <DestMatrixWide>22</ DestMatrixWide >             //目标矩形宽
      <DestMatrixHigh>13</ DestMatrixHigh >              //目标矩形高
      </ Control >

      */

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "用户点击放大失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "User click to enlarge failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_control_autozoomin_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户点击放大成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users click to enlarge the success, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_control_autozoomin_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "用户点击放大失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "User click to enlarge failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_control_autozoomin_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_find(callee_id);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "用户点击放大失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "User click to enlarge failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding messages to front-end  physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_control_autozoomin_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户点击放大成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users click to enlarge the success, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_control_autozoomin_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "用户点击放大失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_CONTROL_AUTOZOMMIN_ERROR, EV9000_LOG_LEVEL_ERROR, "User click to enlarge failed:User ID=%s, User IP=%s, Port=%d,  Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_control_autozoomin_proc() exit---: Find GB Device Info Error:DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_set_device_xy_param_proc
 功能描述  : 设置本级点位的经纬度
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年3月28日 星期五
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_set_device_xy_param_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strLongitude[64] = {0};
    char strLatitude[64] = {0};
    char strMapLayer[MAX_128CHAR_STRING_LEN + 4] = {0};
    double longitude = 0.0;
    double latitude = 0.0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_set_device_xy_param_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_set_device_xy_param_proc() exit---: Param Error \r\n");
        return -1;
    }

    if (NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_set_device_xy_param_proc() exit---: User Srv dboper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户设置点位的经纬度, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User set latitude and longtitude of the point, Front-end logic device ID=%s", callee_id);

    /* 设置前端经纬度的命令直接设置到数据库

          命令包括如下字段:

      <?xml version="1.0"?>
          <Control>
          <CmdType>SetDeviceXYParam</CmdType>
          <SN>1234</SN>
          <DeviceID>逻辑设备ID</DeviceID>
          <Longitude>经度</Longitude>
          <Latitude>纬度</Latitude>
          </Control>
      */

    /* 取得 数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"Longitude", strLongitude);
    inPacket.GetElementValue((char*)"Latitude", strLatitude);
    inPacket.GetElementValue((char*)"MapLayer", strMapLayer);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_set_device_xy_param_proc() \
    \r\n XML Para: \
    \r\n SN=%s \
    \r\n DeviceID=%s \
    \r\n Longitude=%s \
    \r\n Latitude=%s \
    \r\n MapLayer=%s \r\n", strSN, strDeviceID, strLongitude, strLatitude, strMapLayer);

    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            if (EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type) /* 如果是下级的点位，并且是同级的时候 ，设置下级点位的经纬度信息 */
            {
                if (pGBDeviceInfo->link_type == 1)
                {
                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置点位的经纬度失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 下级 CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"点位属于同级CMS中的下级CMS, 转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set point latitude and longitude failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason =%s, Subordinate CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Point below to the subordinate CMS of the same level CMS, forwarding message to front-end physical device failed.", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_xy_param_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设置点位的经纬度成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 下级 CMS ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users to set point of latitude and longitude, successful forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, the lower the CMS, ID = % s IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_set_device_xy_param_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }

                    return 0;
                }
            }

            /* 经度 */
            if (strLongitude[0] != '\0')
            {
                longitude = strtod(strLongitude, (char**) NULL);
            }

            /* 纬度 */
            if (strLatitude[0] != '\0')
            {
                latitude = strtod(strLatitude, (char**) NULL);
            }

            DEBUG_TRACE(MODULE_USER, LOG_TRACE,  "user_set_device_xy_param_proc() Longitude=%.16lf, Latitude=%.16lf \r\n", longitude, latitude);

            if (pGBLogicDeviceInfo->longitude != longitude
                || pGBLogicDeviceInfo->latitude != latitude
                || 0 != sstrcmp(pGBLogicDeviceInfo->map_layer, strMapLayer)) /* 有变化就更新 */
            {
                pGBLogicDeviceInfo->longitude = longitude;
                pGBLogicDeviceInfo->latitude = latitude;

                if (0 != sstrcmp(pGBLogicDeviceInfo->map_layer, strMapLayer))
                {
                    memset(pGBLogicDeviceInfo->map_layer, 0, MAX_128CHAR_STRING_LEN + 4);
                    osip_strncpy(pGBLogicDeviceInfo->map_layer, strMapLayer, MAX_128CHAR_STRING_LEN);
                }

                /* 更新到数据库 */
                i = UpdateGBLogicDeviceXYParam2DB(pGBLogicDeviceInfo->device_id, longitude, latitude, strMapLayer, pUser_Srv_dboper);

                if (i < 0)
                {
                    SystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置点位的经纬度失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 经度=%.16lf, 纬度=%.16lf, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, longitude, latitude, (char*)"更新到数据库失败");
                    EnSystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set point latitude and longitude failed:User ID=%s, User IP=%s, Port=%d, User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, Longitude=%.16lf, Latitude=%.16lf, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, longitude, latitude, (char*)"Update the database failed.");
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_xy_param_proc() UpdateGBLogicDeviceXYParam2DB Error \r\n");
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设置点位的经纬度成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 经度=%.16lf, 纬度=%.16lf", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, longitude, latitude);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User set point latitude and longitude successfully:User ID = % s, = % s IP address, port number = % d, logical device ID = % s, longitude = %. 16 lf, latitude = %. 16 lf", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, longitude, latitude);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_set_device_xy_param_proc() UpdateGBLogicDeviceXYParam2DB OK \r\n");
                }
            }
        }
        else
        {
            SystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置点位的经纬度失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:GBLogicDeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
            EnSystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set point latitude and longitude failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:GBLogicDeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_xy_param_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", strDeviceID);
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设置点位的经纬度失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的逻辑设备信息:GBLogicDeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        EnSystemLog(EV9000_CMS_SET_XY_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User set point latitude and longitude failed:User ID=%s, User IP=%s, Port=%d, 逻Logic Device ID=%s,reason=Not find the corresponding logic device information:GBLogicDeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_set_device_xy_param_proc() exit---: Find GBLogicDevice Info Error:GBLogicDeviceID=%s \r\n", strDeviceID);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_video_param_proc
 功能描述  : 用户获取前端图像参数
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_video_param_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strSN[32] = {0};
    char strTransferSN[32] = {0};
    char strDeviceID[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_video_param_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_video_param_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取前端图像参数, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access front-end picture parameter, Front-end logic device ID=%s", callee_id);

    /* 获取前端图像参数的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <?xml version="1.0"?>
      <Query>
      <CmdType>GetDeviceVideoParam</CmdType>
      <SN>43</SN>
      <DeviceID>64010000001110000001</DeviceID>
      </Query>
      */
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    if (strSN[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=获取XML消息中的SN失败", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Get XML message SN failed.", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() exit---: Get XML SN Error\r\n");
        return -1;
    }

    if (strDeviceID[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=获取XML消息中的DeviceID失败", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Get XML messages Device ID failed.", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() exit---: Get XML DeviceID Error\r\n");
        return -1;
    }

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            /* 获取老的SN节点 */
            AccSnNode = inPacket.SearchElement((char*)"SN");

            if (NULL != AccSnNode)
            {
                g_transfer_xml_sn++;
                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                inPacket.SetElementValue(AccSnNode, strTransferSN);
            }

            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取前端图像参数成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User get front-end device image parameters successfully:User ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_video_param_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                old_xml_sn = strtoul(strSN, NULL, 10);
                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                i = transfer_xml_msg_add(XML_QUERY_DEVICEVIDEOPARAM, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_video_param_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_DEVICEVIDEOPARAM, old_xml_sn, transfer_xml_sn, strDeviceID, i);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_find(callee_id);

        if (NULL != pGBDeviceInfo)
        {
            /* 获取老的SN节点 */
            AccSnNode = inPacket.SearchElement((char*)"SN");

            if (NULL != AccSnNode)
            {
                g_transfer_xml_sn++;
                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                inPacket.SetElementValue(AccSnNode, strTransferSN);
            }

            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取前端图像参数成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to the front image parameters successfully, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_video_param_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                old_xml_sn = strtoul(strSN, NULL, 10);
                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                i = transfer_xml_msg_add(XML_QUERY_DEVICEVIDEOPARAM, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_video_param_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_DEVICEVIDEOPARAM, old_xml_sn, transfer_xml_sn, strDeviceID, i);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端图像参数失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device image parameters failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_preset_proc
 功能描述  : 获取前端预置位
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_preset_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_preset_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_preset_proc() exit---: Param Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取前端预置位, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access front-end preset，Front-end logic device ID=%s", callee_id);

    /* 获取前端预置位的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <Query>
      <CmdType>GetDevicePreset</CmdType>
      <SN>43</SN>
      <DeviceID>64010000001110000001</DeviceID>
      </Query>

      */

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端预置位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device presets failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_preset_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取前端预置位成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, " user access front-end preset successfully, forwarding message to front a physical device, the user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d ", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_preset_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端预置位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device presets failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_video_param_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_find(callee_id);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端预置位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device presets failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_preset_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取前端预置位成功, 转发消息到前端物理设备, 用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User get front-end device presets successfully, 转发消息到前端物理设备, User ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_preset_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取前端预置位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User get front-end device presets failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_preset_proc() exit---: Find GB Device Info Error:DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_catalog_proc
 功能描述  : 用户查询设备目录
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_catalog_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};

    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;
    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_catalog_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_catalog_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取逻辑设备信息, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access logic device information，Front-end logic device ID=%s", callee_id);

    /* 网络设备信息查询
          控制流程见9.5.2
          设备目录查询的命令直接转发给前段设备，不做处理

          命令包括如下字段:
          <!-- 命令类型：设备目录查询（必选） -->
          <element name="CmdType" fixed ="Catalog" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
      */
    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_catalog_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 查看被叫是否是本CMS ID */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        if (0 == sstrcmp(callee_id, strDeviceID)) /* 如果查询的设备ID为本CMS ID，表示获取本设备列表*/
        {
            if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
            {
                i = UserGetAllGBDeviceListAndSendCataLogToClient(pUserInfo, strDeviceID, strSN, pUser_Srv_dboper);
            }
            else
            {
                i = UserGetGBDeviceListAndSendCataLogToClient(pUserInfo, strDeviceID, strSN, pUser_Srv_dboper);
            }
        }
        else /* 获取具体的某一个设备信息 */
        {
            pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

            if (NULL != pGBLogicDeviceInfo)
            {
                pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

                if (NULL != pGBDeviceInfo)
                {
                    AccSnNode = inPacket.SearchElement((char*)"SN");

                    if (NULL != AccSnNode)
                    {
                        g_transfer_xml_sn++;
                        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                        inPacket.SetElementValue(AccSnNode, strTransferSN);
                        //inPacket.SetTextContent();
                    }

                    i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取逻辑设备信息消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users get logical device information message processing failure: the user ID = % s, IP address = % s, port = % d, logical device ID = % s, reason = % s, forward front physical device ID = % s, IP address = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取逻辑设备信息消息处理成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User message processing logical device information is successful, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_catalog_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                        old_xml_sn = strtoul(strSN, NULL, 10);
                        transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                        i = transfer_xml_msg_add(XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_catalog_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                    }
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() exit---: Find GB Logic Device Info Error  \r\n");
                return -1;
            }
        }
    }
    else
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

        if (NULL != pGBLogicDeviceInfo)
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                AccSnNode = inPacket.SearchElement((char*)"SN");

                if (NULL != AccSnNode)
                {
                    g_transfer_xml_sn++;
                    snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                    inPacket.SetElementValue(AccSnNode, strTransferSN);
                    //inPacket.SetTextContent();
                }

                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取逻辑设备信息消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users get logical device information message processing failure: the user ID = % s, IP address = % s, port = % d, logical device ID = % s, reason = % s, forward front physical device ID = % s, IP address = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取逻辑设备信息消息处理成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User processing logical device information is successful, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port =%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_catalog_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                    old_xml_sn = strtoul(strSN, NULL, 10);
                    transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                    i = transfer_xml_msg_add(XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_catalog_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_find(callee_id);

            if (NULL != pGBDeviceInfo)
            {
                AccSnNode = inPacket.SearchElement((char*)"SN");

                if (NULL != AccSnNode)
                {
                    g_transfer_xml_sn++;
                    snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                    inPacket.SetElementValue(AccSnNode, strTransferSN);
                    //inPacket.SetTextContent();
                }

                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取逻辑设备信息消息处理失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users get logical device information message processing failure: the user ID = % s, IP address = % s, port = % d, logical device ID = % s, reason = % s, forward front physical device ID = % s, IP address = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取逻辑设备信息消息处理成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to logical device information processing is successful, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, forwarding the front-end, physical device ID = % s = % s IP address, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_catalog_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                    old_xml_sn = strtoul(strSN, NULL, 10);
                    transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                    i = transfer_xml_msg_add(XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_catalog_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_CATALOG, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_catalog_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取逻辑设备信息成功，前端逻辑设备ID=%s", callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to logical device information is successful, the front-end logical device ID = %s", callee_id);
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_catalog_proc() Exit---\r\n");

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_info_proc
 功能描述  : 用户查询设备信息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_info_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_info_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_info_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户查询设备信息, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User search for device info，Front-end logic device ID=%s", callee_id);

    /* 网络设备信息查询
          控制流程见9.5.2
          设备信息查询的命令直接转发给前段设备，不做处理

          命令包括如下字段:
          <!-- 命令类型：设备信息查询（必选） -->
          <element name="CmdType" fixed ="DeviceInfo" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
      */
    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_device_info_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 查看被叫是否是本CMS ID */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        i = SendDeviceInfoMessageToRouteCMS(caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, strSN, strDeviceID, 0, 0);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_info_proc() SendDeviceInfoMessageToRouteCMS Error\r\n");
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_info_proc() SendDeviceInfoMessageToRouteCMS OK\r\n");
        }
    }
    else
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

        if (NULL != pGBLogicDeviceInfo)
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device information failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备信息成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device information successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device information failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_info_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_find(callee_id);

            if (NULL != pGBDeviceInfo)
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device information failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备信息成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device information successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_GET_DEVICE_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device information failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_info_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_status_proc
 功能描述  : 用户查询设备状态处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_status_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    CPacket outPacket;
    DOMElement* AccNode = NULL;
    string strStatus;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_status_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_status_proc() exit---: Param Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_status_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户查询设备状态, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User search for device status，Front-end logic device ID=%s", callee_id);

    /* 网络设备信息查询
          控制流程见9.5.2
          设备状态查询的命令直接转发给前段设备，不做处理

          命令包括如下字段:
          <!-- 命令类型：设备状态查询（必选） -->
          <element name="CmdType" fixed ="DeviceStatus" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_device_status_proc() \
    \r\n XML Para: \
    \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 查看被叫是否是本CMS ID */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        strStatus = "OFFLINE";

        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);  /* 查找逻辑设备队列 */

        if (NULL != pGBLogicDeviceInfo)
        {
            if (1 == pGBLogicDeviceInfo->status)
            {
                if (INTELLIGENT_STATUS_ON == pGBLogicDeviceInfo->intelligent_status)
                {
                    strStatus = "INTELLIGENT";
                }
                else if (ALARM_STATUS_CLOSE == pGBLogicDeviceInfo->alarm_status)
                {
                    strStatus = "CLOSE";
                }
                else if (ALARM_STATUS_APART == pGBLogicDeviceInfo->alarm_status)
                {
                    strStatus = "APART";
                }
                else
                {
                    strStatus = "ONLINE";
                }
            }
            else if (2 == pGBLogicDeviceInfo->status)
            {
                strStatus = "NOVIDEO";
            }
        }

        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");
        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceStatus");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"Online");
        outPacket.SetElementValue(AccNode, (char*)strStatus.c_str());

        /* 发送响应消息 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            SystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"发送响应消息失败");
            EnSystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device status Failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Sends a response message failed.");
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_status_proc() SIP_SendMessage Error:caller_id=%s, caller_ip=%s, caller_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device status successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_status_proc() SIP_SendMessage OK:caller_id=%s, caller_ip=%s, caller_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
    }
    else
    {
        strStatus = "OFFLINE";

        pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);  /* 查找逻辑设备队列 */

        if (NULL != pGBLogicDeviceInfo)
        {
            if (1 == pGBLogicDeviceInfo->status)
            {
                if (INTELLIGENT_STATUS_ON == pGBLogicDeviceInfo->intelligent_status)
                {
                    strStatus = "INTELLIGENT";
                }
                else if (ALARM_STATUS_CLOSE == pGBLogicDeviceInfo->alarm_status)
                {
                    strStatus = "CLOSE";
                }
                else if (ALARM_STATUS_APART == pGBLogicDeviceInfo->alarm_status)
                {
                    strStatus = "APART";
                }
                else
                {
                    strStatus = "ONLINE";
                }
            }
            else if (2 == pGBLogicDeviceInfo->status)
            {
                strStatus = "NOVIDEO";
            }

            /* 回复响应,组建消息 */
            outPacket.SetRootTag("Response");
            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"DeviceStatus");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Result");
            outPacket.SetElementValue(AccNode, (char*)"OK");

            AccNode = outPacket.CreateElement((char*)"Online");
            outPacket.SetElementValue(AccNode, (char*)strStatus.c_str());

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"发送响应消息失败");
                EnSystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Sends a response message failed.");
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_status_proc() SIP_SendMessage Error:caller_id=%s, caller_ip=%s, caller_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device status successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_status_proc() SIP_SendMessage OK:caller_id=%s, caller_ip=%s, caller_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_find(callee_id);

            if (NULL != pGBDeviceInfo)
            {
                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_status_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device status successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_status_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_GET_DEVICE_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "Users query the device status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_status_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_config_proc
 功能描述  : 用户查询设备配置处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年7月15日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_config_proc() exit---: Param Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_config_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户查询设备配置, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User search for device configuration，Front-end logic device ID=%s", callee_id);

    /* 网络设备配置查询

          设备配置查询的命令直接转发给前段设备，不做处理
          命令包括如下字段:
          <!-- 命令类型：设备信息查询（必选） -->
          <element name="CmdType" fixed ="ConfigDownload" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_device_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    if (strSN[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=获取XML消息中的SN失败", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Get XML message SN failed.", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() exit---: Get XML SN Error\r\n");
        return -1;
    }

    if (strDeviceID[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=获取XML消息中的DeviceID失败", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        EnSystemLog(EV9000_CMS_GET_VIDEO_PARAM_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Get XML messages Device ID failed", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() exit---: Get XML DeviceID Error\r\n");
        return -1;
    }

    /* 查看被叫是否是本CMS ID */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        // TODO:本级CMS的配置是否需要回复?
    }
    else
    {
        pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

        if (NULL != pGBLogicDeviceInfo)
        {
            pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

            if (NULL != pGBDeviceInfo)
            {
                /* 获取老的SN节点 */
                AccSnNode = inPacket.SearchElement((char*)"SN");

                if (NULL != AccSnNode)
                {
                    g_transfer_xml_sn++;
                    snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                    inPacket.SetElementValue(AccSnNode, strTransferSN);
                }

                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备配置成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device status successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_config_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                    old_xml_sn = strtoul(strSN, NULL, 10);
                    transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                    i = transfer_xml_msg_add(XML_QUERY_DEVICECONFIG, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_config_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_DEVICECONFIG, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
        else
        {
            pGBDeviceInfo = GBDevice_info_find(callee_id);

            if (NULL != pGBDeviceInfo)
            {
                /* 获取老的SN节点 */
                AccSnNode = inPacket.SearchElement((char*)"SN");

                if (NULL != AccSnNode)
                {
                    g_transfer_xml_sn++;
                    snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                    inPacket.SetElementValue(AccSnNode, strTransferSN);
                }

                i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询设备配置成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users query the device status successfully,Forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_config_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                    old_xml_sn = strtoul(strSN, NULL, 10);
                    transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                    i = transfer_xml_msg_add(XML_QUERY_DEVICECONFIG, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_config_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_DEVICECONFIG, old_xml_sn, transfer_xml_sn, strDeviceID, i);
                }
            }
            else
            {
                SystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询设备配置失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                EnSystemLog(EV9000_CMS_GET_DEVICE_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query device configuration failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_config_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
                return -1;
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_record_info_proc
 功能描述  : 用户查询设备视频文件处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_record_info_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 设备视音频文件检索
          控制流程见9.7.2
      */
    int i = 0;
    int iRet = 0;
    int index = 0;
    int tsu_index = -1;
    int record_count = 0;
    int query_count = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strRecordType[32] = {0};
    char strStartTime[32] = {0};
    char strEndTime[32] = {0};
    char strFilePath[32] = {0};
    char strAddress[32] = {0};
    char strSecrecy[32] = {0};
    char strRecorderID[32] = {0};
    char strErrorCode[32] = {0};

    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;
    tsu_resource_info_t* pTsuResourceInfo = NULL;
    VideoRecordList stVideoRecordList;
    unsigned int iStartTime = 0;
    unsigned int iEndTime = 0;
    int record_type = 0;

    DOMElement* RecordListAccNode = NULL;
    char strTransferSN[32] = {0};
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    int record_info_pos = -1;
    record_info_t* pRecordInfo = NULL;

    int iRecordCRPos = -1;
    cr_t* pRecordCrData = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_record_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_record_info_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得查询条件数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"StartTime", strStartTime);
    inPacket.GetElementValue((char*)"EndTime", strEndTime);
    inPacket.GetElementValue((char*)"FilePath", strFilePath);
    inPacket.GetElementValue((char*)"Address", strAddress);
    inPacket.GetElementValue((char*)"Secrecy", strSecrecy);
    inPacket.GetElementValue((char*)"Type", strRecordType);
    inPacket.GetElementValue((char*)"RecorderID", strRecorderID);

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, DeviceID=%s \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_record_info_proc() \
    \r\n XML Param: \
    \r\n SN=%s \
    \r\n DeviceID=%s \
    \r\n RecordType=%s \
    \r\n StartTime=%s \
    \r\n EndTime=%s \
    \r\n", strSN, strDeviceID, strRecordType, strStartTime, strEndTime);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户查询录像记录信息, 前端逻辑设备ID=%s", strDeviceID);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User search for video record information, Front-end logic device ID=%s", strDeviceID);

    /* 1、获取录像点位信息 */
    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL == pGBLogicDeviceInfo)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Name");
        outPacket.SetElementValue(AccNode, (char*)" ");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"-1");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_FIND_LOGIC_DEVICE_INFO_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"获取逻辑设备信息失败");

        RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
        outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

        /* 发送响应消息 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get GBLogic Device Info Error \r\n");
        SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取逻辑设备信息失败");
        EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get logical device information failed");
        return -1;
    }

    /* 看是否是其他域的点位 */
    if (1 == pGBLogicDeviceInfo->other_realm)
    {
        /* 查找上级路由信息 */
        iCalleeRoutePos = route_info_find(pGBLogicDeviceInfo->cms_id);

        if (iCalleeRoutePos < 0)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, (char*)" ");

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_ROUTE_FIND_ROUTE_INFO_ERROR);
            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"获取上级路由信息失败");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get GBLogic Device Info Error \r\n");
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取上级路由信息失败");
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get route information failed");
            return -1;
        }

        pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

        if (NULL == pCalleeRouteInfo)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, (char*)" ");

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_ROUTE_GET_ROUTE_INFO_ERROR);
            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"获取上级路由信息失败");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get GBLogic Device Info Error \r\n");
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取上级路由信息失败");
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get route information failed");
            return -1;
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息是上级CMS中的点位:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 所在的上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video information is the higher level in the CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, where the superior CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);

        /* 从新组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Query");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        g_transfer_xml_sn++;
        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
        outPacket.SetElementValue(AccNode, strTransferSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"StartTime");
        outPacket.SetElementValue(AccNode, strStartTime);

        AccNode = outPacket.CreateElement((char*)"EndTime");
        outPacket.SetElementValue(AccNode, strEndTime);

        AccNode = outPacket.CreateElement((char*)"Type");

        if (strRecordType[0] != 0)
        {
            outPacket.SetElementValue(AccNode, strRecordType);
        }
        else
        {
            outPacket.SetElementValue(AccNode, (char*)"all");
        }

        AccNode = outPacket.CreateElement((char*)"RecorderID");
        outPacket.SetElementValue(AccNode, pCalleeRouteInfo->server_id);

        /* 将查询录像任务的消息转发出去 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), pCalleeRouteInfo->server_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 转发上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发查询消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information, forwards the query message to the superior CMS failure:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, Superior CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息成功,转发查询消息到上级CMS:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 转发上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video recording information successfully,Forwarding query message to the superior CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, forwarding the superior CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:server_id=%s, server_ip=%s, server_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);

            old_xml_sn = strtoul(strSN, NULL, 10);
            transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
            i = transfer_xml_msg_add(XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, strDeviceID, i);
        }

        return i;
    }

    /* 确定录像类型 */
    if (strRecordType[0] != 0)
    {
        record_type = osip_atoi(strRecordType);
    }
    else
    {
        record_type = EV9000_RECORD_TYPE_NORMAL;
    }

    if (record_type <= 0)
    {
        record_type = EV9000_RECORD_TYPE_NORMAL;
    }

    /* 获取逻辑设备所属的物理设备 */
    if (EV9000_RECORD_TYPE_NORMAL == record_type
        || EV9000_RECORD_TYPE_BACKUP == record_type
        || EV9000_RECORD_TYPE_ALARM == record_type)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);
    }
    else
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_INTELLIGENCE);
    }

    if (NULL == pGBDeviceInfo)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Name");
        outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"-1");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DEVICE_GET_DEVICE_INFO_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"获取物理设备信息失败");

        RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
        outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

        /* 发送响应消息 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get GBLogic Device Info Error \r\n");
        SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取物理设备信息失败");
        EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get physical device information failed");
        return -1;
    }

    /* 查看该点位本地是否配置了录像，如果配置了，则在本地查找录像记录 */
    if (EV9000_RECORD_TYPE_NORMAL == record_type
        || EV9000_RECORD_TYPE_ALARM == record_type)
    {
        record_info_pos = record_info_find_by_stream_type(pGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_MASTER);
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_MASTER, record_info_pos);
    }
    else if (EV9000_RECORD_TYPE_BACKUP == record_type)
    {
        record_info_pos = record_info_find_by_stream_type(pGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_SLAVE);
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_SLAVE, record_info_pos);
    }
    else if (EV9000_RECORD_TYPE_INTELLIGENCE == record_type)
    {
        record_info_pos = record_info_find_by_stream_type(pGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_INTELLIGENCE);
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_INTELLIGENCE, record_info_pos);
    }
    else
    {
        record_info_pos = record_info_find_by_stream_type(pGBLogicDeviceInfo->id, EV9000_STREAM_TYPE_MASTER);
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() record_info_find_by_stream_type:device_id=%s, stream_type=%d, record_info_pos=%d \r\n", pGBLogicDeviceInfo->device_id, EV9000_STREAM_TYPE_MASTER, record_info_pos);
    }

    if (record_info_pos >= 0)
    {
        pRecordInfo = record_info_get(record_info_pos);

        if (NULL != pRecordInfo)
        {
            if (1 == pRecordInfo->record_enable)
            {
                goto normal_record;
            }
        }
    }

    if (pGBDeviceInfo->device_type == EV9000_DEVICETYPE_SIPSERVER) /* 下级cms 的录像  */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息是下级CMS中的点位:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 所在的下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video information is lower in the CMS point: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, the lower the CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

        /* 从新组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Query");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        g_transfer_xml_sn++;
        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
        outPacket.SetElementValue(AccNode, strTransferSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"StartTime");
        outPacket.SetElementValue(AccNode, strStartTime);

        AccNode = outPacket.CreateElement((char*)"EndTime");
        outPacket.SetElementValue(AccNode, strEndTime);

        AccNode = outPacket.CreateElement((char*)"Type");

        if (1 == pGBDeviceInfo->three_party_flag)
        {
            outPacket.SetElementValue(AccNode, (char*)"all");
        }
        else
        {
            if (strRecordType[0] != 0)
            {
                outPacket.SetElementValue(AccNode, strRecordType);
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"all");
            }
        }

        AccNode = outPacket.CreateElement((char*)"RecorderID");
        outPacket.SetElementValue(AccNode, pGBDeviceInfo->device_id);

        /* 将查询录像任务的消息转发出去 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), strDeviceID, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 转发下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发查询消息到下级CMS失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information, forwards the query message to the subordinate CMS failure:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, Subordinate CMS ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息成功,转发查询消息到下级CMS:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 转发下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video recording information successfully,Forwarding query message to the superior CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, forwarding the superior CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

            old_xml_sn = strtoul(strSN, NULL, 10);
            transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
            i = transfer_xml_msg_add(XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, strDeviceID, i);
        }

        return i;
    }
    else if (1 == pGBLogicDeviceInfo->record_type) /* 前端录像的情况下，直接转发给前端处理 */
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息的点位是在前端录像, 用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 所在的前端设备ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video information is On the front end of video: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, the lower the CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

        /* 从新组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Query");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        g_transfer_xml_sn++;
        snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
        outPacket.SetElementValue(AccNode, strTransferSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"StartTime");
        outPacket.SetElementValue(AccNode, strStartTime);

        AccNode = outPacket.CreateElement((char*)"EndTime");
        outPacket.SetElementValue(AccNode, strEndTime);

        AccNode = outPacket.CreateElement((char*)"Type");

        /* 如果是NVR或者DVR,则要改为all */
        if (EV9000_DEVICETYPE_IPC == pGBDeviceInfo->device_type
            || EV9000_DEVICETYPE_DVR == pGBDeviceInfo->device_type
            || EV9000_DEVICETYPE_NVR == pGBDeviceInfo->device_type)
        {
            outPacket.SetElementValue(AccNode, (char*)"all");
        }
        else
        {
            if (strRecordType[0] != 0)
            {
                outPacket.SetElementValue(AccNode, strRecordType);
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"all");
            }
        }

        AccNode = outPacket.CreateElement((char*)"RecorderID");
        outPacket.SetElementValue(AccNode, pGBDeviceInfo->device_id);

        /* 将查询录像任务的消息转发出去 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), strDeviceID, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 转发前端设备ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发查询消息到前端设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information, forwards the query message to the front-end device failure:User ID=%s, User IP=%s, Port=%d, Front-end device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 转发前端设备ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video information successfully, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, forwarding the front-end device ID = % s, = % s IP address, port number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

            old_xml_sn = strtoul(strSN, NULL, 10);
            transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
            i = transfer_xml_msg_add(XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_RECORDINFO, old_xml_sn, transfer_xml_sn, strDeviceID, i);
        }

        return i;
    }

normal_record:
    {
        /* 2、查找录像回放TSU 资源 */
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() get_idle_tsu_by_resource_balance_for_replay: Begin--- \r\n");
        tsu_index = get_idle_tsu_by_resource_balance_for_replay();
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() get_idle_tsu_by_resource_balance_for_replay: End--- tsu_index=%d \r\n", tsu_index);

        if (tsu_index < 0)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_IDLE_TSU_INDEX_ERROR);
            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"获取可用的TSU索引失败");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            if (-2 == tsu_index)
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败,TSU资源队列为空");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }
            else if (-3 == tsu_index)
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败,TSU资源信息错误");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }
            else if (-4 == tsu_index)
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败,TSU资源都没有启用");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }
            else if (-5 == tsu_index)
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败,TSU资源都不在线");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }
            else if (-9 == tsu_index)
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败,通过ICE获取所有的TSU资源状态失败");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }
            else
            {
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找可用的录像回放TSU索引失败");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU index failed.");
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get Idle TSU Index Error \r\n");
            return -1;
        }

        pTsuResourceInfo = tsu_resource_info_get(tsu_index);

        if (NULL == pTsuResourceInfo)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_GET_TSU_INFO_ERROR);
            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"获取可用的TSU信息失败");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get TSU Resource Info Error \r\n");
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, tsu_index=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取录像回放的TSU信息失败", tsu_index);
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Get available TSU information failed.");
            return -1;
        }

        /* 3、通知TSU, 查询录像列表 */
        iStartTime = analysis_time(strStartTime);
        iEndTime = analysis_time(strEndTime);

        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() iStartTime=%d,iEndTime=%d \r\n", iStartTime, iEndTime);

        if ((iStartTime <= 0) || (iEndTime <= 0))
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);
            snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_RECORD_TIME_INFO_ERROR);
            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"录像时间信息不对");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Get Time Error \r\n");
            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 开始时间=%s, 结束时间=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"录像时间信息不对", strStartTime, strEndTime);
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s, Start time=%s, End time=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Recording time information wrong.", strStartTime, strEndTime);
            return -1;
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息, 开始通知TSU查询记录:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, TSU ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pTsuResourceInfo->tsu_device_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video recording information, notify TSU start to search record.:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, TSU ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pTsuResourceInfo->tsu_device_id);

        /* 查找该点位的录像任务，通知TSU更新结束时间 */
        if (EV9000_RECORD_TYPE_NORMAL == record_type
            || EV9000_RECORD_TYPE_ALARM == record_type)
        {
            iRecordCRPos = record_call_record_find_by_calleeid_and_streamtype(strDeviceID, EV9000_STREAM_TYPE_MASTER);
        }
        else if (EV9000_RECORD_TYPE_BACKUP == record_type)
        {
            iRecordCRPos = record_call_record_find_by_calleeid_and_streamtype(strDeviceID, EV9000_STREAM_TYPE_SLAVE);
        }
        else if (EV9000_RECORD_TYPE_INTELLIGENCE == record_type)
        {
            iRecordCRPos = record_call_record_find_by_calleeid_and_streamtype(strDeviceID, EV9000_STREAM_TYPE_INTELLIGENCE);
        }

        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc():record_call_record_find_by_calleeid_and_streamtype:callee_id=%s, RecordCRPos=%d\r\n", strDeviceID, iRecordCRPos);

        if (iRecordCRPos >= 0)
        {
            pRecordCrData = call_record_get(iRecordCRPos);

            if (NULL != pRecordCrData)
            {
                i = notify_tsu_update_mysql_record_stoptime(pRecordCrData->tsu_ip, pRecordCrData->task_id);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc():notify_tsu_update_mysql_record_stoptime:tsu_ip=%s, task_id=%s, i=%d \r\n", pRecordCrData->tsu_ip, pRecordCrData->task_id, i);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: call_record_get Error: RecordCRPos=%d \r\n", iRecordCRPos);
            }
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: record_call_record_find_by_calleeid_and_streamtype Error: callee_id=%s \r\n", strDeviceID);
        }

        /* 通知TSU查询录像 */
        iRet = notify_tsu_query_replay_list(pTsuResourceInfo, strDeviceID, 1, record_type, iStartTime, iEndTime, stVideoRecordList);

        if (iRet < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() notify_tsu_query_replay_list Error:iRet=%d \r\n", iRet);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() notify_tsu_query_replay_list OK:iRet=%d \r\n", iRet);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息, TSU查询记录结束:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, TSU ID=%s, iRet=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pTsuResourceInfo->tsu_device_id, iRet, stVideoRecordList.size());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video recording information, TSU search record ended.:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, TSU ID=%s, iRet=%d, Records=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pTsuResourceInfo->tsu_device_id, iRet, stVideoRecordList.size());

        if (iRet < 0)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"-1");

            AccNode = outPacket.CreateElement((char*)"ErrCode");
            memset(strErrorCode, 0, 32);

            if (-1 == iRet)
            {
                snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_TSU_ICE_ERROR);
            }
            else
            {
                snprintf(strErrorCode, 32, "%d", iRet);
            }

            outPacket.SetElementValue(AccNode, strErrorCode);

            AccNode = outPacket.CreateElement((char*)"Reason");
            outPacket.SetElementValue(AccNode, (char*)"TSU查询录像记录返回失败,ICE异常");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"-1");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            if (-1 == iRet)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Notify TSU Query Replay List Error \r\n");
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"TSU查询录像记录返回失败, ICE异常");
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"TSU failed to query video recordings, ICE exception.");
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() exit---: Notify TSU Query Replay List Error \r\n");
                SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, iRet=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"TSU查询录像记录返回失败", iRet);
                EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s, iRet=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"TSU failed to query video recordings", iRet);
            }

            return -1;
        }

        record_count = stVideoRecordList.size();
        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_record_info_proc() record_count=%d \r\n", record_count);

        if (record_count == 0)
        {
            /* 回复响应,组建消息 */
            CPacket outPacket;
            DOMElement* AccNode = NULL;

            outPacket.SetRootTag("Response");

            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"RecordInfo");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"DeviceID");
            outPacket.SetElementValue(AccNode, strDeviceID);

            AccNode = outPacket.CreateElement((char*)"Name");
            outPacket.SetElementValue(AccNode, pGBLogicDeviceInfo->device_name);

            AccNode = outPacket.CreateElement((char*)"SumNum");
            outPacket.SetElementValue(AccNode, (char*)"0");

            RecordListAccNode = outPacket.CreateElement((char*)"RecordList");
            outPacket.SetElementAttr(RecordListAccNode, (char*)"Num", (char*)"0");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "用户查询录像记录信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"没有查询到录像记录");
            EnSystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "User query video recording information failed:User ID=%s, User IP=%s, Port=%d, Front-end logic device ID=%s, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)" No video recording has been queried.");
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_record_info_proc() exit---: No Record Count \r\n");
            return i;
        }

        /* 4、循环查找容器，读取录像文件列表信息，加入xml中 */
        CPacket* pOutPacket = NULL;

        for (index = 0; index < record_count; index++)
        {
            /* 如果记录数大于10，则要分次发送 */
            query_count++;

            /* 创建XML头部 */
            i = CreateRecordInfoQueryResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, pGBLogicDeviceInfo->device_name, &RecordListAccNode);

            /* 加入Item 值 */
            i = AddRecordInfoToXMLItem(pOutPacket, RecordListAccNode, stVideoRecordList[index], strDeviceID, pGBLogicDeviceInfo->device_name);

            if ((query_count % MAX_USER_RECORD_INFO_COUT_SEND == 0) || (query_count == record_count))
            {
                if (NULL != pOutPacket)
                {
                    /* 发送出去 */
                    i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_GET_CATALOG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        EnSystemLog(EV9000_CMS_GET_CATALOG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video record information , sending messages to the user failed: user ID = % s, = % s IP address, port number = %", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_record_info_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video record information , sending messages to the user successfully: user ID = % s, = % s IP address, port number = %", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_record_info_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    }

                    delete pOutPacket;
                    pOutPacket = NULL;
                }
            }
        }
    }

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询录像记录信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query video record information , sending messages to the user successfully: user ID = % s, = % s IP address, port number = %", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        SystemLog(EV9000_CMS_QUERY_RECORD_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询录像记录信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 查询的逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_CATALOG_ERROR, EV9000_LOG_LEVEL_ERROR, "User query video record information , sending messages to the user failed: User ID = % s, = % s IP address, port number = % d, reason = % s, query logic device ID = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"SIP response message sent failure");
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_preset_info_proc
 功能描述  : 用户查询preset 处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_preset_info_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    int while_count = 0;
    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    int iCalleeRoutePos = 0;
    route_info_t* pCalleeRouteInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_preset_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_preset_info_proc() exit---: para Error \r\n");
        return -1;
    }

    /* 取得查询条件数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户查询预置位信息, 前端逻辑设备ID=%s", strDeviceID);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User search for preset information, Front-end logic device ID=%s", strDeviceID);

    /* 1、获取录像点位信息 */
    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL == pGBLogicDeviceInfo)
    {
        /* 回复响应,组建消息 */
        CPacket* pOutPacket = NULL;
        DOMElement* AccNode = NULL;
        DOMElement* ListAccNode = NULL;

        //DOMElement* ItemAccNode = NULL;
        if (!pOutPacket)
        {
            pOutPacket = new CPacket();
        }

        pOutPacket->SetRootTag("Response");

        AccNode = pOutPacket->CreateElement((char*)"CmdType");
        pOutPacket->SetElementValue(AccNode, (char*)"PresetConfig");

        AccNode = pOutPacket->CreateElement((char*)"SN");
        pOutPacket->SetElementValue(AccNode, strSN);

        AccNode = pOutPacket->CreateElement((char*)"DeviceID");
        pOutPacket->SetElementValue(AccNode, strDeviceID);

        AccNode = pOutPacket->CreateElement((char*)"SumNum");
        pOutPacket->SetElementValue(AccNode, (char*)"0");

        ListAccNode = pOutPacket->CreateElement((char*)"PresetConfigList");
        pOutPacket->SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        /* 发送响应消息 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
        }

        if (pOutPacket)
        {
            delete pOutPacket;
        }

        pOutPacket = NULL;
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() exit---: Get GBLogic Device Info Error \r\n");
        SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取逻辑设备信息失败");
        EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information failed:User ID=%s, IP address=%s, port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Get logical device information failed");
        return -1;
    }

    /* 根据逻辑设备所属域进行判断，决定消息走向 */
    if (1 == pGBLogicDeviceInfo->other_realm)
    {
        /* 查找上级路由信息 */
        iCalleeRoutePos = route_info_find(pGBLogicDeviceInfo->cms_id);

        if (iCalleeRoutePos < 0)
        {
            /* 回复响应,组建消息 */
            CPacket* pOutPacket = NULL;
            DOMElement* AccNode = NULL;
            DOMElement* ListAccNode = NULL;

            //DOMElement* ItemAccNode = NULL;
            if (!pOutPacket)
            {
                pOutPacket = new CPacket();
            }

            pOutPacket->SetRootTag("Response");

            AccNode = pOutPacket->CreateElement((char*)"CmdType");
            pOutPacket->SetElementValue(AccNode, (char*)"PresetConfig");

            AccNode = pOutPacket->CreateElement((char*)"SN");
            pOutPacket->SetElementValue(AccNode, strSN);

            AccNode = pOutPacket->CreateElement((char*)"DeviceID");
            pOutPacket->SetElementValue(AccNode, strDeviceID);

            AccNode = pOutPacket->CreateElement((char*)"SumNum");
            pOutPacket->SetElementValue(AccNode, (char*)"0");

            ListAccNode = pOutPacket->CreateElement((char*)"PresetConfigList");
            pOutPacket->SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:User ID=%s, IP address=%s, port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:User ID=%s, IP address=%s, port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            if (pOutPacket)
            {
                delete pOutPacket;
            }

            pOutPacket = NULL;
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() exit---: Find Callee Route Info Error \r\n");
            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查找逻辑设备对应的上级路由信息失败");
            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information failed:User ID=%s, IP address=%s, port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Find the route information which corresponding to logical device failed.");
            return -1;
        }

        pCalleeRouteInfo = route_info_get(iCalleeRoutePos);

        if (NULL == pCalleeRouteInfo)
        {
            /* 回复响应,组建消息 */
            CPacket* pOutPacket = NULL;
            DOMElement* AccNode = NULL;
            DOMElement* ListAccNode = NULL;

            //DOMElement* ItemAccNode = NULL;
            if (!pOutPacket)
            {
                pOutPacket = new CPacket();
            }

            pOutPacket->SetRootTag("Response");

            AccNode = pOutPacket->CreateElement((char*)"CmdType");
            pOutPacket->SetElementValue(AccNode, (char*)"PresetConfig");

            AccNode = pOutPacket->CreateElement((char*)"SN");
            pOutPacket->SetElementValue(AccNode, strSN);

            AccNode = pOutPacket->CreateElement((char*)"DeviceID");
            pOutPacket->SetElementValue(AccNode, strDeviceID);

            AccNode = pOutPacket->CreateElement((char*)"SumNum");
            pOutPacket->SetElementValue(AccNode, (char*)"0");

            ListAccNode = pOutPacket->CreateElement((char*)"PresetConfigList");
            pOutPacket->SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

            /* 发送响应消息 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:User ID=%s, IP address=%s, port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:User ID=%s, IP address=%s, port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            if (pOutPacket)
            {
                delete pOutPacket;
            }

            pOutPacket = NULL;
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() exit---: Get Callee Route Info Error \r\n");
            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"获取逻辑设备对应的上级路由信息失败");
            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information failed:User ID=%s, IP address=%s, port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Get the route information which corresponding to logical device failed.");
            return -1;
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息是上级CMS中的点位:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 所在的上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "user query preset information is the higher level in the CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, the superior CMS, ID = % s = % s IP address, port number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);

        AccSnNode = inPacket.SearchElement((char*)"SN");

        if (NULL != AccSnNode)
        {
            g_transfer_xml_sn++;
            snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
            inPacket.SetElementValue(AccSnNode, strTransferSN);
            //inPacket.SetTextContent();
        }

        /* 将查询录像任务的消息转发出去 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), pCalleeRouteInfo->server_id, pCalleeRouteInfo->strRegLocalIP, pCalleeRouteInfo->iRegLocalPort, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

        if (i != 0)
        {
            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 转发上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发查询消息到上级CMS失败", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information, forwards the query message to the superior CMS failure:User ID=%s, IP address=%s, port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息成功,转发查询消息到上级CMS:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 转发上级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query preset information successdully, forwarding query message to the lower CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, forwarding the superior CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pCalleeRouteInfo->server_id, pCalleeRouteInfo->server_ip, pCalleeRouteInfo->server_port);

            old_xml_sn = strtoul(strSN, NULL, 10);
            transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
            i = transfer_xml_msg_add(XML_QUERY_GETPRESET, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_preset_info_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_GETPRESET, old_xml_sn, transfer_xml_sn, strDeviceID, i);
        }
    }
    else
    {
        /* 获取逻辑设备所属的物理设备 */
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo
            && EV9000_DEVICETYPE_SIPSERVER == pGBDeviceInfo->device_type
            && 0 == pGBDeviceInfo->three_party_flag) /* 非第三方平台的下级cms 的点位 */
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息是下级CMS中的点位:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 所在的下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "user query preset information is the lower points in the CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, the lower the CMS, ID = % s = % s IP address, port number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            AccSnNode = inPacket.SearchElement((char*)"SN");

            if (NULL != AccSnNode)
            {
                g_transfer_xml_sn++;
                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                inPacket.SetElementValue(AccSnNode, strTransferSN);
                //inPacket.SetTextContent();
            }

            /* 将查询录像任务的消息转发出去 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), pGBDeviceInfo->device_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s, 转发下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发查询消息到下级CMS失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information, forwards the query message to the subordinate CMS failure:User ID=%s, IP address=%s, port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息成功,转发查询消息到下级CMS:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 转发下级CMS ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query preset information successdully, forwarding query message to the lower CMS: user ID = % s, = % s IP address, port number = % d, query logic device ID = % s, forwarding the superior CMS, ID = % s = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                old_xml_sn = strtoul(strSN, NULL, 10);
                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                i = transfer_xml_msg_add(XML_QUERY_GETPRESET, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_preset_info_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_GETPRESET, old_xml_sn, transfer_xml_sn, strDeviceID, i);
            }
        }
        else
        {
            //query
            char szSql[100] = {0};
            char strSumNum[32] = {0};
            snprintf(szSql, 100, "select * from PresetConfig WHERE DeviceIndex = %u order by PresetID asc;", pGBLogicDeviceInfo->id);
            record_count  = pUser_Srv_dboper->DB_Select(szSql, 1);
            snprintf(strSumNum, 32, "%d", record_count);

            if (record_count < 0)
            {
                /* 回复响应,组建消息 */
                CPacket* pOutPacket = NULL;
                DOMElement* AccNode = NULL;
                DOMElement* ListAccNode = NULL;

                //DOMElement* ItemAccNode = NULL;
                if (!pOutPacket)
                {
                    pOutPacket = new CPacket();
                }

                pOutPacket->SetRootTag("Response");

                AccNode = pOutPacket->CreateElement((char*)"CmdType");
                pOutPacket->SetElementValue(AccNode, (char*)"PresetConfig");

                AccNode = pOutPacket->CreateElement((char*)"SN");
                pOutPacket->SetElementValue(AccNode, strSN);

                AccNode = pOutPacket->CreateElement((char*)"DeviceID");
                pOutPacket->SetElementValue(AccNode, strDeviceID);

                AccNode = pOutPacket->CreateElement((char*)"SumNum");
                pOutPacket->SetElementValue(AccNode, (char*)"0");

                ListAccNode = pOutPacket->CreateElement((char*)"PresetConfigList");
                pOutPacket->SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

                /* 发送响应消息 */
                i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                if (pOutPacket)
                {
                    delete pOutPacket;
                }

                pOutPacket = NULL;
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() Error DB Oper Error:strSQL=%s, record_count=%d \r\n", szSql, record_count);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"查询数据库失败");
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User queries preset information failed:User ID=%s, IP address=%s, port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database");
                return -1;
            }
            else if (record_count == 0)
            {
                /* 回复响应,组建消息 */
                CPacket* pOutPacket = NULL;
                DOMElement* AccNode = NULL;
                DOMElement* ListAccNode = NULL;

                //DOMElement* ItemAccNode = NULL;
                if (!pOutPacket)
                {
                    pOutPacket = new CPacket();
                }

                pOutPacket->SetRootTag("Response");

                AccNode = pOutPacket->CreateElement((char*)"CmdType");
                pOutPacket->SetElementValue(AccNode, (char*)"PresetConfig");

                AccNode = pOutPacket->CreateElement((char*)"SN");
                pOutPacket->SetElementValue(AccNode, strSN);

                AccNode = pOutPacket->CreateElement((char*)"DeviceID");
                pOutPacket->SetElementValue(AccNode, strDeviceID);

                AccNode = pOutPacket->CreateElement((char*)"SumNum");
                pOutPacket->SetElementValue(AccNode, (char*)"0");

                ListAccNode = pOutPacket->CreateElement((char*)"PresetConfigList");
                pOutPacket->SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

                /* 发送响应消息 */
                i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                if (pOutPacket)
                {
                    delete pOutPacket;
                }

                pOutPacket = NULL;
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_preset_info_proc() exit---: No Record Count \r\n");
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_WARNING, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"没有查询到数据库记录");
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_WARNING, "用User queries preset information failed:User ID=%s, IP address=%s, port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
                return i;
            }

            CPacket* pOutPacket = NULL;
            DOMElement* ListAccNode = NULL;

            /* 循环查找数据库，将数据组成XML 发送给客户端 */
            do
            {
                int             nID = 0;                                      //记录编号
                unsigned int    nDeviceIndex = 0;                            //设备ID
                int             nPresetID = 0;                               //预置位编号
                string          strPresetName = "";                          //预置位名称
                int             nResved1 = 0;                                //保留1
                string          strResved2 = "";

                while_count++;

                if (while_count % 10000 == 0)
                {
                    DEBUG_TRACE(MODULE_DEVICE, LOG_WARN, "user_query_preset_info_proc() While Count=%d \r\n", while_count);
                }

                query_count++;

                /* 创建XML头部 */
                i = CreatePresetConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, &ListAccNode);

                /* 索引 */
                pUser_Srv_dboper->GetFieldValue("ID", nID);

                /* 点位索引 */
                pUser_Srv_dboper->GetFieldValue("DeviceIndex", nDeviceIndex);

                /* 预置位ID */
                pUser_Srv_dboper->GetFieldValue("PresetID", nPresetID);

                /* 预置位名称 */
                strPresetName.clear();
                pUser_Srv_dboper->GetFieldValue("PresetName", strPresetName);

                /* 预留1 */
                pUser_Srv_dboper->GetFieldValue("Resved1", nResved1);

                /* 预留2 */
                strResved2.clear();
                pUser_Srv_dboper->GetFieldValue("ParentID", strResved2);

                /* 加入Item 值 */
                i = AddPresetConfigToXMLItem(pOutPacket, ListAccNode, nID, nDeviceIndex, nPresetID, strPresetName, nResved1, strResved2);

                if ((query_count % MAX_DEVICE_PRESET_COUT_SEND == 0) || (query_count == record_count))
                {
                    if (NULL != pOutPacket)
                    {
                        send_count++;
                        /* 发送出去 */
                        i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "User query preset information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_preset_info_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query preset information, send a message to the user: the user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_preset_info_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                        }

                        delete pOutPacket;
                        pOutPacket = NULL;
                    }
                }
            }
            while (pUser_Srv_dboper->MoveNext() >= 0);

            if (i == 0)
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Access logic device group information success:front-end ID=%s, IP=%s, port=%d, record count=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
            }
            else
            {
                SystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "用户查询预置位信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
                EnSystemLog(EV9000_CMS_GET_PRESET_ERROR, EV9000_LOG_LEVEL_ERROR, "Access logic device group information failure:front-end ID=%s, IP=%s, port=%d, cause=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
            }
        }
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户查询预置位信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 查询的逻辑设备ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User query preset information, send a message to the user: the user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_user_config_proc
 功能描述  : 用户查询用户配置信息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_user_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 用户登录成功之后获取配置信息
      */
    int i = 0;
    int record_count = 0;
    char strSN[32] = {0};
    char strUserID[32] = {0};

    char strID[32] = {0};
    int iID = 0;

    char strPermission[32] = {0};
    int iPermission = 0;
    char strLevel[32] = {0};
    int iLevel = 0;
    string strUserName = "";
    string strPassword = "";
    string strLogInIP = "";
    string strLogInMAC = "";

    CPacket outPacket;
    DOMElement* AccNode = NULL;
    string strSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_config_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    /* 取得查询条件数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", strUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_user_config_proc() \
    \r\n XML Para: \
    \r\n SN=%s, UserID=%s \r\n", strSN, strUserID);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取用户配置信息, 获取的用户ID=%s", strUserID);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access user configuration information, 用户ID=%s", strUserID);

    /* 根据查询条件，查找数据库，找到相应的录像记录 */
    strSQL.clear();
    strSQL = "select * from UserConfig WHERE UserID like '";
    strSQL += strUserID;
    strSQL += "'";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_config_proc() Select UserConfig:record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "User get users configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        /* 发送响应消息 */
        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, NULL, 0);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "用户获取用户配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "User get users configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    pUser_Srv_dboper->GetFieldValue("ID", iID);
    pUser_Srv_dboper->GetFieldValue("Permission", iPermission);
    pUser_Srv_dboper->GetFieldValue("Level", iLevel);
    pUser_Srv_dboper->GetFieldValue("UserName", strUserName);
    pUser_Srv_dboper->GetFieldValue("Password", strPassword);
    pUser_Srv_dboper->GetFieldValue("LogInIP", strLogInIP);
    pUser_Srv_dboper->GetFieldValue("LogInMAC", strLogInMAC);

    /* 回复响应,组建消息 */
    outPacket.SetRootTag("Response");
    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"UserConfig");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    snprintf(strID, 32, "%d", iID);
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, strUserID);

    AccNode = outPacket.CreateElement((char*)"UserName");
    outPacket.SetElementValue(AccNode, (char*)strUserName.c_str());

    AccNode = outPacket.CreateElement((char*)"PassWord");
    outPacket.SetElementValue(AccNode, (char*)strPassword.c_str());

    AccNode = outPacket.CreateElement((char*)"Level");
    snprintf(strLevel, 32, "%d", iLevel);
    outPacket.SetElementValue(AccNode, strLevel);

    AccNode = outPacket.CreateElement((char*)"Permission");
    snprintf(strPermission, 32, "%d", iPermission);
    outPacket.SetElementValue(AccNode, strPermission);

    AccNode = outPacket.CreateElement((char*)"LoginIP");
    outPacket.SetElementValue(AccNode, pUserInfo->login_ip);

    AccNode = outPacket.CreateElement((char*)"LoginMac");
    outPacket.SetElementValue(AccNode, (char*)strLogInMAC.c_str());

    AccNode = outPacket.CreateElement((char*)"Resved1");
    outPacket.SetElementValue(AccNode, (char*)"");

    AccNode = outPacket.CreateElement((char*)"Resved2");
    outPacket.SetElementValue(AccNode, (char*)"");

    /* 发送响应消息 */
    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取用户配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access configuration information successfully: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access configuration information fialed:User ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_device_group_config_proc
 功能描述  : 用户获取逻辑设备分组配置表
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_group_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 用户登录成功之后获取逻辑设备分组配置表
      */
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_group_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取默认逻辑设备分组配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access default logic device group configuration information.");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get the default logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_device_group_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 如果查询的设备ID不是本CMS ID*/
    if (0 != sstrcmp(callee_id, strDeviceID))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", strDeviceID);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get the default logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() exit---: Device ID Not Belong To Mine CMSID:DeviceID=%s \r\n", strDeviceID);
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组配置信息 */
    strSQL.clear();
    strSQL = "select * from LogicDeviceGroupConfig order by GroupID asc";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get the default logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LogicDeviceGroupConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"LogicDeviceGroupConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_group_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING, "用户获取默认逻辑设备分组配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING, "User get the default logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_device_group_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int id = 0;
        string strName = "";
        string strGroupID = "";
        string strCMSID = "";
        int SortID = 0;
        string strParentID = "";

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_device_group_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateDeviceGroupConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", id);

        /* 组编号 */
        strGroupID.clear();
        pUser_Srv_dboper->GetFieldValue("GroupID", strGroupID);

        /* CMS编号 */
        strCMSID.clear();
        pUser_Srv_dboper->GetFieldValue("CMSID", strCMSID);

        /* 组名称 */
        strName.clear();
        pUser_Srv_dboper->GetFieldValue("Name", strName);

        /* 同一父节点下组排序编号 */
        pUser_Srv_dboper->GetFieldValue("SortID", SortID);

        /* 父节点编号 */
        strParentID.clear();
        pUser_Srv_dboper->GetFieldValue("ParentID", strParentID);

        /* 加入Item 值 */
        i = AddDeviceGroupConfigToXMLItem(pOutPacket, ListAccNode, id, strGroupID, strCMSID, strName, SortID, strParentID);

        if ((query_count % MAX_DEVICE_GROUP_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User access to the default logic devices group configuration information, send a message to the user failed: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_group_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取默认逻辑设备分组配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to the default logic devices group configuration information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_group_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取默认逻辑设备分组配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to the default logic devices group configuration information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get the default logic equipment group configuration information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_user_device_group_config_proc
 功能描述  : 用户获取逻辑设备重新分组配置表
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_user_device_group_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 用户登录成功之后获取逻辑设备分组配置表
      */
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_device_group_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_device_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取用户逻辑设备分组配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access user logic device group configuration information.");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get user logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserIndex", strUserIndex);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_user_device_group_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, UserIndex=%s \r\n", strSN, strUserIndex);

    /* 如果查询的用户索引为空 */
    if (strUserIndex[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的用户索引为空");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get user logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"The query user index is empty.");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() exit---: User Index Is NULL \r\n");
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组配置信息 */
    strSQL.clear();
    strSQL = "select * from UserLogicDeviceGroupConfig WHERE UserIndex = ";
    strSQL += strUserIndex;
    strSQL += " order by GroupID asc";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_user_device_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户逻辑设备分组配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get user logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"UserLogicDeviceGroupConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserIndex");
        outPacket.SetElementValue(AccNode, strUserIndex);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"UserLogicDeviceGroupConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_group_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING, "用户获取用户逻辑设备分组配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING, "User get user logical device grouping configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_device_group_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int id = 0;
        string strName = "";
        string strGroupID = "";
        int SortID = 0;
        string strParentID = "";

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_device_group_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateUserDeviceGroupConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strUserIndex, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", id);

        /* 组编号 */
        strGroupID.clear();
        pUser_Srv_dboper->GetFieldValue("GroupID", strGroupID);

        /* 组名称 */
        strName.clear();
        pUser_Srv_dboper->GetFieldValue("Name", strName);

        /* 同一父节点下组排序编号 */
        pUser_Srv_dboper->GetFieldValue("SortID", SortID);

        /* 父节点编号 */
        strParentID.clear();
        pUser_Srv_dboper->GetFieldValue("ParentID", strParentID);

        /* 加入Item 值 */
        i = AddUserDeviceGroupConfigToXMLItem(pOutPacket, ListAccNode, id, strGroupID, strUserIndex, strName, SortID, strParentID);

        if ((query_count % MAX_USER_DEVICE_GROUP_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户逻辑设备分组配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to logical device group configuration information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_group_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取用户逻辑设备分组配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Grouping users access to logical device configuration information, successfully send a message to the user: the user ID = % s, = % s IP address, port number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_group_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取用户逻辑设备分组配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to the default logic devices group configuration information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户逻辑设备分组配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get the default logic equipment group configuration information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_channel_status_proc
 功能描述  : 用户查询解码器通道状态处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年5月5日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_channel_status_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    char strSN[32] = {0};
    char strChannelID[32] = {0};
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_channel_status_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_channel_status_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取解码器通道状态, 解码器通道ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access decoder channel status，decoder channel ID=%s", callee_id);

    /* 获取解码器通道状态消息直接转发给前端解码器
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"ChannelID", strChannelID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_channel_status_proc() \
        \r\n XML Para: \
        \r\n SN=%s, ChannelID=%s \r\n", strSN, strChannelID);

    pGBLogicDeviceInfo = GBLogicDevice_info_find(strChannelID);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            AccSnNode = inPacket.SearchElement((char*)"SN");

            if (NULL != AccSnNode)
            {
                g_transfer_xml_sn++;
                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                inPacket.SetElementValue(AccSnNode, strTransferSN);
                //inPacket.SetTextContent();
            }

            /* 将查询消息转发出去 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取解码器通道状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User get a decoder channel status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取解码器通道状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users get decoder channel status is successful, forwarding messages to the front end physical device: user ID = % s, IP address = % s, port = % d, logical device ID = % s, forward front physical device ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_channel_status_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                old_xml_sn = strtoul(strSN, NULL, 10);
                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                i = transfer_xml_msg_add(XML_QUERY_CHANNELSTATUS, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strChannelID);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_channel_status_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_CHANNELSTATUS, old_xml_sn, transfer_xml_sn, strChannelID, i);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取解码器通道状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, strChannelID);
            EnSystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User get a decoder channel status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, strChannelID);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", strChannelID);
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取解码器通道状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的逻辑设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, strChannelID);
        EnSystemLog(EV9000_CMS_QUERY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User get a decoder channel status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding logic device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strChannelID, strChannelID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() Find GBDevice Info Error:device_id=%s \r\n", strChannelID);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_device_map_group_config_proc
 功能描述  : 用户获取逻辑设备分组关系配置表
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_device_map_group_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 用户登录成功之后获取逻辑设备分组关系配置表
      */
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_map_group_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_device_map_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取默认逻辑设备分组关系配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access default logic device group relationship cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get the default logical device grouping relationship configuration information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_map_group_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_device_map_group_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 如果查询的设备ID不是本CMS ID*/
    if (0 != sstrcmp(callee_id, strDeviceID))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取默认逻辑设备分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", strDeviceID);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get the default logical device grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", strDeviceID);
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组关系配置关系信息 */
    strSQL.clear();
    strSQL = "select * from LogicDeviceMapGroupConfig";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_device_map_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取默认逻辑设备分组关系配置信息开始查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get the default logical device grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_map_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_map_group_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LogicDeviceMapGroupConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"LogicDeviceMapGroupConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_map_group_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_map_group_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取默认逻辑设备分组关系配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get the default logical device grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_device_map_group_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    CPacket* pOutPacket = NULL;

    do
    {
        int id = 0;
        string strGroupID = "";
        unsigned int DeviceIndex = 0;
        string strCMSID = "";
        int SortID = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_device_map_group_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateDeviceMapGroupConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", id);

        /* 点位组编号 */
        strGroupID.clear();
        pUser_Srv_dboper->GetFieldValue("GroupID", strGroupID);

        /* 逻辑设备索引 */
        pUser_Srv_dboper->GetFieldValue("DeviceIndex", DeviceIndex);

        /* CMS 编号 */
        strCMSID.clear();
        pUser_Srv_dboper->GetFieldValue("CMSID", strCMSID);

        /* 排序编号 */
        pUser_Srv_dboper->GetFieldValue("SortID", SortID);

        /* 加入Item 值 */
        i = AddDeviceMapGroupConfigToXMLItem(pOutPacket, ListAccNode, id, strGroupID, DeviceIndex, strCMSID, SortID);

        if ((query_count % MAX_DEVICE_MAP_GROUP_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取默认逻辑设备分组关系配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to logical device group configuration information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_device_map_group_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取默认逻辑设备分组关系配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to the default logic devices group configuration information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_map_group_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取默认逻辑设备分组关系配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to the default logic devices group configuration information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取默认逻辑设备分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get the default logic equipment group configuration information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_device_map_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_user_device_map_group_config_proc
 功能描述  : 用户获取逻辑设备重新分组关系配置表
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_user_device_map_group_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    /* 用户登录成功之后获取逻辑设备分组关系配置表
      */
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_device_map_group_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_user_device_map_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取用户分组关系配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access user group relationship cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get user grouping relationship information failed.:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserIndex", strUserIndex);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_user_device_map_group_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserIndex=%s \r\n", strSN, strUserIndex);

    /* 如果查询的用户索引为空 */
    if (strUserIndex[0] == '\0')
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的用户索引为空");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User get user grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"The query user index is empty");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() exit---: User Index Is NULL \r\n");
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组关系配置关系信息 */
    strSQL.clear();
    strSQL = "select * from UserLogicDeviceMapGroupConfig as G, UserLogicDeviceGroupConfig as GDP WHERE G.GroupID = GDP.GroupID and GDP.UserIndex = ";
    strSQL += strUserIndex;
    strSQL += " order by G.GroupID asc";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_user_device_map_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取用户分组关系配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get user grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"UserLogicDeviceMapGroupConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserIndex");
        outPacket.SetElementValue(AccNode, strUserIndex);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"UserLogicDeviceMapGroupConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_map_group_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取用户分组关系配置信息查询数据库失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get user grouping relationship information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_device_map_group_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    CPacket* pOutPacket = NULL;

    do
    {
        int id = 0;
        string strGroupID = "";
        unsigned int DeviceIndex = 0;
        int SortID = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_device_map_group_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateUserDeviceMapGroupConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strUserIndex, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", id);

        /* 点位组编号 */
        strGroupID.clear();
        pUser_Srv_dboper->GetFieldValue("GroupID", strGroupID);

        /* 逻辑设备索引 */
        pUser_Srv_dboper->GetFieldValue("DeviceIndex", DeviceIndex);

        /* 排序编号 */
        pUser_Srv_dboper->GetFieldValue("SortID", SortID);

        /* 加入Item 值 */
        i = AddUserDeviceMapGroupConfigToXMLItem(pOutPacket, ListAccNode, id, strGroupID, DeviceIndex, SortID);

        if ((query_count % MAX_USER_DEVICE_MAP_GROUP_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取用户分组关系配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to user grouping relationship information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_user_device_map_group_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取用户分组关系配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to user grouping relationship information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_map_group_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取用户分组关系配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to user grouping relationship information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取用户分组关系配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get user grouping relationship information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_user_device_map_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_poll_config_proc
 功能描述  : 用户查询轮巡表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_poll_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};
    char pcUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_poll_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_poll_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取轮巡配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access polling cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取轮巡配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User get polling information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_poll_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询轮巡权限表，获取pollid */
    strSQL.clear();

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        strSQL = "select * from PollConfig order by PollName asc";
    }
    else
    {
        strSQL = "select PC.ID,PC.PollName,PC.StartTime,PC.DurationTime,PC.Type,PC.ScheduledRun,PC.UserID,PC.Resved1 from PollConfig as PC, UserPollConfig as UPC WHERE PC.ID = UPC.PollID and UPC.UserID = ";
        snprintf(pcUserIndex, 32, "%u", pUserInfo->user_index);
        strSQL += pcUserIndex;
        strSQL += " order by PC.PollName asc";
    }

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_poll_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取轮巡配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get polling information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"PollConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取轮巡配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get polling information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_poll_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iScheduledRun = 0;
        string strPollName = "";
        int iStartTime = 0;
        int iDurationTime = 0;
        string strUserID = "";
        int iType = 0;
        int iResved1 = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_poll_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreatePollConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* 轮巡名称*/
        strPollName.clear();
        pUser_Srv_dboper->GetFieldValue("PollName", strPollName);

        /* 是否定时执行 */
        pUser_Srv_dboper->GetFieldValue("ScheduledRun", iScheduledRun);

        /* 开始时间 */
        pUser_Srv_dboper->GetFieldValue("StartTime", iStartTime);

        /* 持续时间 */
        pUser_Srv_dboper->GetFieldValue("DurationTime", iDurationTime);

        /* 用户ID */
        strUserID.clear();
        pUser_Srv_dboper->GetFieldValue("UserID", strUserID);

        /* 前台轮巡还是后台轮巡 */
        pUser_Srv_dboper->GetFieldValue("Type", iType);

        /* 是否正在执行 */
        pUser_Srv_dboper->GetFieldValue("Resved1", iResved1);

        /* 加入Item 值 */
        i = AddPollConfigToXMLItem(pOutPacket, ListAccNode, iID, strPollName, iScheduledRun, iStartTime, iDurationTime, strUserID, iType, iResved1);

        if ((query_count % MAX_POLL_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取轮巡配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to polling information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取轮巡配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to polling information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取轮巡配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to polling information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取轮巡配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get polling information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_poll_action_config_proc
 功能描述  : 用户查询轮巡动作配置数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月18日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_poll_action_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};
    char pcUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_poll_action_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_poll_action_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取轮巡动作配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access polling action cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取轮巡动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User get polling action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_action_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_poll_action_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询轮巡权限表，获取pollid */
    strSQL.clear();

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        strSQL = "select * from PollActionConfig order by ID asc";
    }
    else
    {
        strSQL = "select PAC.ID,PAC.PollID,PAC.Type,PAC.SourceID,PAC.DestID,PAC.ScreenID,PAC.LiveTime,PAC.DestSortID,PAC.SourceSortID,PAC.StreamType from PollActionConfig as PAC, PollConfig as PC, UserPollConfig as UPC WHERE PC.ID = PAC.PollID and PC.ID = UPC.PollID and UPC.UserID = ";
        snprintf(pcUserIndex, 32, "%u", pUserInfo->user_index);
        strSQL += pcUserIndex;
        strSQL += " order by PAC.ID asc";
    }

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_poll_action_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取轮巡动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get polling action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_action_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_action_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollActionConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"PollActionConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_action_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_action_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取轮巡动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get polling action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_poll_action_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iPollID = 0;
        int iType = 0;
        string strSourceID = "";
        string strDestID = "";
        int iScreenID = 0;
        int iLiveTime = 0;
        int iDestSortID = 0;
        int iSourceSortID = 0;
        int iStreamType = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_poll_action_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreatePollActionConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* PollID */
        pUser_Srv_dboper->GetFieldValue("PollID", iPollID);

        /* Type */
        pUser_Srv_dboper->GetFieldValue("Type", iType);

        /* SourceID */
        strSourceID.clear();
        pUser_Srv_dboper->GetFieldValue("SourceID", strSourceID);

        /* DestID */
        strDestID.clear();
        pUser_Srv_dboper->GetFieldValue("DestID", strDestID);

        /* ScreenID */
        pUser_Srv_dboper->GetFieldValue("ScreenID", iScreenID);

        /* LiveTime */
        pUser_Srv_dboper->GetFieldValue("LiveTime", iLiveTime);

        /* DestSortID */
        pUser_Srv_dboper->GetFieldValue("DestSortID", iDestSortID);

        /* SourceSortID */
        pUser_Srv_dboper->GetFieldValue("SourceSortID", iSourceSortID);

        /* StreamType */
        pUser_Srv_dboper->GetFieldValue("StreamType", iStreamType);

        /* 加入Item 值 */
        i = AddPollActionConfigToXMLItem(pOutPacket, ListAccNode, iID, iPollID, iType, strSourceID, strDestID, iScreenID, iLiveTime, iDestSortID, iSourceSortID, iStreamType);

        if ((query_count % MAX_POLL_ACTION_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取轮巡动作配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to  polling action information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取轮巡动作配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to  polling action information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取轮巡动作配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to  polling action information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取轮巡动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_POLL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get  polling action information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_action_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_plan_config_proc
 功能描述  : 用户查询预案表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_plan_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};
    char pcUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_plan_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_plan_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取预案配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access reserved plan cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取预案配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User get plan information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_plan_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询预案权限表，获取planid */
    strSQL.clear();

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        strSQL = "select * from PlanConfig order by PlanName asc";
    }
    else
    {
        strSQL = "select PC.ID,PC.PlanName,PC.StartTime,PC.Type,PC.UserLevel,PC.ScheduledRun,PC.UserID from PlanConfig as PC, UserPlanConfig as UPC WHERE PC.ID = UPC.PlanID and UPC.UserID = ";
        snprintf(pcUserIndex, 32, "%u", pUserInfo->user_index);
        strSQL += pcUserIndex;
        strSQL += " order by PC.PlanName asc";
    }

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_plan_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取预案配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get plan information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PlanConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"PlanConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_plan_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取预案配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get plan information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_plan_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        string strPlanName = "";
        int iStartTime = 0;
        int iScheduledRun = 0;
        string strUserID = "";
        int iType = 0;
        int iUserLevel = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_plan_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreatePlanConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* 预案名称*/
        strPlanName.clear();
        pUser_Srv_dboper->GetFieldValue("PlanName", strPlanName);

        /* 开始时间 */
        pUser_Srv_dboper->GetFieldValue("StartTime", iStartTime);

        /* 是否定时执行 */
        pUser_Srv_dboper->GetFieldValue("ScheduledRun", iScheduledRun);

        /* 用户ID */
        strUserID.clear();
        pUser_Srv_dboper->GetFieldValue("UserID", strUserID);

        /* 前台轮巡还是后台轮巡 */
        pUser_Srv_dboper->GetFieldValue("Type", iType);

        /* 被动执行用户级别 */
        pUser_Srv_dboper->GetFieldValue("UserLevel", iUserLevel);

        /* 加入Item 值 */
        i = AddPlanConfigToXMLItem(pOutPacket, ListAccNode, iID, strPlanName, iStartTime, iScheduledRun, strUserID, iType, iUserLevel);

        if ((query_count % MAX_PLAN_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取预案配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to plan information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取预案配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to plan information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取预案配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to plan information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取预案配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get plan information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_plan_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_plan_action_config_proc
 功能描述  : 用户查询预案动作配置数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月18日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_plan_action_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};
    char pcUserIndex[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_plan_action_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    /* 状态置为2， 表示用户登录获取完所有信息，可以发送状态信息 */
    //pUserInfo->reg_status = 2;
    //DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_plan_action_config_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_plan_action_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取预案动作配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access plan action cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取预案动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User get plan action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_action_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_plan_action_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询预案权限表，获取planid */
    strSQL.clear();

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        strSQL = "select * from PlanActionConfig order by ID asc";
    }
    else
    {
        strSQL = "select PAC.ID,PAC.PlanID,PAC.Type,PAC.DeviceIndex,PAC.DestID,PAC.ScreenID,PAC.ControlData,PAC.StreamType from PlanActionConfig as PAC, PlanConfig as PC, UserPlanConfig as UPC WHERE PC.ID = PAC.PlanID and PC.ID = UPC.PlanID and UPC.UserID = ";
        snprintf(pcUserIndex, 32, "%u", pUserInfo->user_index);
        strSQL += pcUserIndex;
        strSQL += " order by PAC.ID asc";
    }

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_plan_action_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取预案动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get plan action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_action_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_action_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PlanActionConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"PlanActionConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_plan_action_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_plan_action_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取预案动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get plan action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_plan_action_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iPlanID = 0;
        int iType = 0;
        unsigned int uDeviceIndex = 0;
        unsigned int uDestID = 0;
        unsigned int uScreenID = 0;
        unsigned int uControlData = 0;
        unsigned int uStreamType = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_plan_action_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreatePlanActionConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* PlanID */
        pUser_Srv_dboper->GetFieldValue("PlanID", iPlanID);

        /* Type */
        pUser_Srv_dboper->GetFieldValue("Type", iType);

        /* DeviceIndex */
        pUser_Srv_dboper->GetFieldValue("DeviceIndex", uDeviceIndex);

        /* DestID */
        pUser_Srv_dboper->GetFieldValue("DestID", uDestID);

        /* ScreenID */
        pUser_Srv_dboper->GetFieldValue("ScreenID", uScreenID);

        /* ControlData */
        pUser_Srv_dboper->GetFieldValue("ControlData", uControlData);

        /* StreamType */
        pUser_Srv_dboper->GetFieldValue("StreamType", uStreamType);

        /* 加入Item 值 */
        i = AddPlanActionConfigToXMLItem(pOutPacket, ListAccNode, iID, iPlanID, iType, uDeviceIndex, uDestID, uScreenID, uControlData, uStreamType);

        if ((query_count % MAX_PLAN_ACTION_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取预案动作配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to plan action information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取预案动作配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to plan action information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取预案动作配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to plan action information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取预案动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_PLAN_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get plan action information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_plan_action_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_cruise_config_proc
 功能描述  : 用户查询巡航表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_cruise_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_cruise_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_cruise_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取巡航配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access navigation cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取巡航配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get plan action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_cruise_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询巡航权限表，获取pollid */
    strSQL.clear();

    strSQL = "select * from CruiseConfig order by CruiseName asc";

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_cruise_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取巡航配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "User get Cruise information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"CruiseConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"CruiseConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_cruise_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "用户获取巡航配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "User get Cruise information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_cruise_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iScheduledRun = 0;
        string strCruiseName = "";
        unsigned int uDeviceIndex = 0;
        int iStartTime = 0;
        int iDurationTime = 0;
        int iResved1 = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_cruise_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateCruiseConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* 巡航名称*/
        strCruiseName.clear();
        pUser_Srv_dboper->GetFieldValue("CruiseName", strCruiseName);

        /* DeviceIndex */
        pUser_Srv_dboper->GetFieldValue("DeviceIndex", uDeviceIndex);

        /* 是否定时执行 */
        pUser_Srv_dboper->GetFieldValue("ScheduledRun", iScheduledRun);

        /* 开始时间 */
        pUser_Srv_dboper->GetFieldValue("StartTime", iStartTime);

        /* 持续时间 */
        pUser_Srv_dboper->GetFieldValue("DurationTime", iDurationTime);

        /* 是否正在执行 */
        pUser_Srv_dboper->GetFieldValue("Resved1", iResved1);

        /* 加入Item 值 */
        i = AddCruiseConfigToXMLItem(pOutPacket, ListAccNode, iID, strCruiseName, uDeviceIndex, iScheduledRun, iStartTime, iDurationTime, iResved1);

        if ((query_count % MAX_CRUISE_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取巡航配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "Users access to Cruise information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取巡航配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to Cruise information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取巡航配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to Cruise information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取巡航配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to get Cruise information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_cruise_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_cruise_action_config_proc
 功能描述  : 用户查询巡航动作配置数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_cruise_action_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_cruise_action_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_cruise_action_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取巡航动作配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access navigation action cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取巡航动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get Cruise action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_action_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_cruise_action_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询巡航权限表，获取pollid */
    strSQL.clear();

    strSQL = "select * from CruiseActionConfig order by ID asc";

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_cruise_action_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取巡航动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "User get Cruise action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_action_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_action_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"CruiseActionConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"CruiseActionConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_cruise_action_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_cruise_action_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "用户获取巡航动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "User get Cruise action information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_cruise_action_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iCruiseID = 0;
        unsigned int uDeviceIndex = 0;
        int iPresetID = 0;
        int iLiveTime = 0;
        int iSortID = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_cruise_action_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateCruiseActionConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* CruiseID */
        pUser_Srv_dboper->GetFieldValue("CruiseID", iCruiseID);

        /* DeviceIndex */
        pUser_Srv_dboper->GetFieldValue("DeviceIndex", uDeviceIndex);

        /* PresetID */
        pUser_Srv_dboper->GetFieldValue("PresetID", iPresetID);

        /* LiveTime */
        pUser_Srv_dboper->GetFieldValue("LiveTime", iLiveTime);

        /* SortID */
        pUser_Srv_dboper->GetFieldValue("SortID", iSortID);

        /* 加入Item 值 */
        i = AddCruiseActionConfigToXMLItem(pOutPacket, ListAccNode, iID, iCruiseID, uDeviceIndex, iPresetID, iLiveTime, iSortID);

        if ((query_count % MAX_POLL_ACTION_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取轮巡动作配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "Users access to Cruise action information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取轮巡动作配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to Cruise action information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取轮巡动作配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to Cruise action information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取巡航动作配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to get Cruise action information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_cruise_action_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_web_interface_config_proc
 功能描述  : 用户获取 URL信息
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_web_interface_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_web_interface_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_web_interface_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取URL配置信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access URL cofiguration information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {

        SystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取URL配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User get URL information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_web_interface_config_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_web_interface_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    if (pcUserID[0] == '\0')
    {
        osip_strncpy(pcUserID, pUserInfo->user_id, 20);
    }

    /* 根据UserID，查询预案权限表，获取planid */
    strSQL.clear();
    //strSQL = "select PC.* from PollConfig as PC, PollPermissionConfig as PP where PC.ID=PB.PollID and PC.UserID like '";
    strSQL = "select * from WebInterFaceConfig order by ID asc";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_web_interface_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取URL配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get URL information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_web_interface_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_web_interface_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"WebInterFaceConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, pcUserID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"WebInterFaceList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_web_interface_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_web_interface_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取URL配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get URL information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_web_interface_config_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iWebStytle = 0;
        string strURL = "";
        string strServerIP = "";
        int iPort = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_web_interface_config_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateWebInterfaceConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, pcUserID, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue("ID", iID);

        /* 风格 */
        pUser_Srv_dboper->GetFieldValue("WebStytle", iWebStytle);

        /* URL */
        strURL.clear();
        pUser_Srv_dboper->GetFieldValue("URL", strURL);

        /* 服务器IP */
        strServerIP.clear();
        pUser_Srv_dboper->GetFieldValue("ServerIP", strServerIP);

        /* 端口号 */
        pUser_Srv_dboper->GetFieldValue("Port", iPort);

        /* 加入Item 值 */
        i = AddWebInterfaceConfigToXMLItem(pOutPacket, ListAccNode, iID, iWebStytle, strURL, strServerIP, iPort);

        if ((query_count % MAX_WEB_INTERFACE_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取URL配置信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to URL information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取URL配置信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to URL information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取URL配置信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to URL information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取URL配置信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_URL_CONFIG_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get URL information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_web_interface_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_alarm_record_proc
 功能描述  : 用户获取告警信息
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
             DBOper* pUserLogDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月11日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_alarm_record_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper, DBOper* pUserLogDbOper)
{
    int i = 0;
    int alarm_type_count = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strAlarmType[32] = {0};
    char strAlarmLevel[32] = {0};
    char strStartTime[32] = {0};
    char strStopTime[32] = {0};
    char strInfo[128] = {0};
    char strConfirmFlag[16] = {0};
    unsigned int uAlarmType = 0;
    char strTmpAlarmType[32] = {0};

    unsigned int uStartTime = 0;
    char pcStartTime[32] = {0};

    unsigned int uStopTime = 0;
    char pcStopTime[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;
    int iFlag = 0;
    int iAlarmTypeFlag = 0;

    unsigned int uAlarmTypeMap[32][2] =
    {
        {0, EV9000_BEHAVIORANALYSIS_ANALYSISRESULTABNORMALITIES},
        {0, EV9000_BEHAVIORANALYSIS_UNDIRECTEDTRIPWIRE},
        {0, EV9000_BEHAVIORANALYSIS_DIRECTEDTRIPWIRE},
        {0, EV9000_BEHAVIORANALYSIS_IRRUPT},
        {0, EV9000_BEHAVIORANALYSIS_TRANSBOUNDARY},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_ANALYSISRESULTABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_DEFINITIONABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_LIGHTABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_COLORFULABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_SNOWABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_VIDEOHUNGS},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_SIGNALLOSSABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_SCREENTINGLEABNORMALITIES},
        {0, EV9000_VIDEOQUALITYDIAGNOSTIC_VIDEOOCCLUSIONABNORMALITIES},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0},
        {0, 0}
    };

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_alarm_record_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUserLogDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_alarm_record_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取告警信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access alarm information.");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR, "User get alarm information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_alarm_record_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"AlarmType", strAlarmType);
    inPacket.GetElementValue((char*)"AlarmLevel", strAlarmLevel);
    inPacket.GetElementValue((char*)"StartTime", strStartTime);
    inPacket.GetElementValue((char*)"StopTime", strStopTime);
    inPacket.GetElementValue((char*)"Info", strInfo);
    inPacket.GetElementValue((char*)"Confirm", strConfirmFlag);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_alarm_record_proc() \
            \r\n XML Para: \
            \r\n SN=%s, DeviceID=%s, AlarmType=%s, AlarmLevel=%s, StartTime=%s, StopTime=%s, Info=%s \r\n", strSN, strDeviceID, strAlarmType, strAlarmLevel, strStartTime, strStopTime, strInfo);

    /* 根据UserID，查询轮巡权限表，获取pollid */
    strSQL.clear();
    strSQL = "SELECT a.ID,b.DeviceID,a.Type,a.Level,a.StartTime,a.StopTime,a.Info FROM AlarmRecord a JOIN EV9000DB.GBLogicDeviceConfig b ON a.LogicDeviceIndex = b.ID";

    if (strDeviceID[0] != '\0'
        || strAlarmType[0] != '\0'
        || strAlarmLevel[0] != '\0'
        || strStartTime[0] != '\0'
        || strStopTime[0] != '\0'
        || strInfo[0] != '\0')
    {
        strSQL += " WHERE";

        iFlag = 0;

        if (strDeviceID[0] != '\0')
        {
            if (iFlag)
            {
                strSQL += " AND b.DeviceID like '";
            }
            else
            {
                strSQL += " b.DeviceID like '";
            }

            strSQL += strDeviceID;
            strSQL += "'";

            iFlag = 1;
        }

        if (strAlarmType[0] != '\0')
        {
            uAlarmType = strtoul(strAlarmType, NULL, 10);

            if (uAlarmType > 0)
            {
                if (iFlag)
                {
                    strSQL += " AND (a.Type = ";
                }
                else
                {
                    strSQL += " (a.Type = ";
                }

                /* 先将对应关系的数组赋值 */
                for (alarm_type_count = 0; alarm_type_count < 32; alarm_type_count++)
                {
                    uAlarmTypeMap[alarm_type_count][0] = (uAlarmType >> alarm_type_count) & 1;
                }

                /* 生成SQL语句 */
                iAlarmTypeFlag = 0;

                for (alarm_type_count = 0; alarm_type_count < 32; alarm_type_count++)
                {
                    if (uAlarmTypeMap[alarm_type_count][0] && uAlarmTypeMap[alarm_type_count][1] > 0)
                    {
                        memset(strTmpAlarmType, 0, 32);
                        snprintf(strTmpAlarmType, 32, "%u", uAlarmTypeMap[alarm_type_count][1]);

                        if (iAlarmTypeFlag)
                        {
                            strSQL += " OR Type = ";
                            strSQL += strTmpAlarmType;
                        }
                        else
                        {
                            strSQL += strTmpAlarmType;
                            iAlarmTypeFlag = 1;
                        }
                    }
                }

                iAlarmTypeFlag = 0;

                strSQL += ")";
                iFlag = 1;
            }
        }

        if (strAlarmLevel[0] != '\0')
        {
            if (iFlag)
            {
                strSQL += " AND a.Level = ";
            }
            else
            {
                strSQL += " a.Level = ";
            }

            strSQL += strAlarmLevel;
            iFlag = 1;
        }

        if (strStartTime[0] != '\0' && strStopTime[0] == '\0')
        {
            uStartTime = analysis_time(strStartTime);
            snprintf(pcStartTime, 32 , "%u", uStartTime);

            if (iFlag)
            {
                strSQL += " AND a.StartTime = ";
            }
            else
            {
                strSQL += " a.StartTime = ";
            }

            strSQL += pcStartTime;
            iFlag = 1;
        }
        else if (strStartTime[0] == '\0' && strStopTime[0] != '\0')
        {
            uStopTime = analysis_time(strStopTime);
            snprintf(pcStopTime, 32 , "%u", uStopTime);

            if (iFlag)
            {
                strSQL += " AND a.StopTime = ";
            }
            else
            {
                strSQL += " a.StopTime = ";
            }

            strSQL += pcStopTime;
            iFlag = 1;
        }
        else if (strStartTime[0] != '\0' && strStopTime[0] != '\0')
        {
            uStartTime = analysis_time(strStartTime);
            snprintf(pcStartTime, 32 , "%u", uStartTime);
            uStopTime = analysis_time(strStopTime);
            snprintf(pcStopTime, 32 , "%u", uStopTime);

            if (iFlag)
            {
                strSQL += " AND a.StartTime >= ";
            }
            else
            {
                strSQL += " a.StartTime >= ";
            }

            strSQL += pcStartTime;
            strSQL += " AND a.StopTime <= ";
            strSQL += pcStopTime;
            iFlag = 1;
        }

        if (strInfo[0] != '\0')
        {
            if (iFlag)
            {
                strSQL += " AND a.Info like '%";
            }
            else
            {
                strSQL += " a.Info like '%";
            }

            strSQL += strInfo;
            strSQL += "%'";
            iFlag = 1;
        }

        if (strConfirmFlag[0] != '\0')
        {
            if (iFlag)
            {
                strSQL += " AND a.Resved1 = ";
            }
            else
            {
                strSQL += " a.Resved1 = ";
            }

            strSQL += strConfirmFlag;
            iFlag = 1;
        }

        iFlag = 0;

        strSQL += " LIMIT 0, 300"; /* 限制查询300条数据 */
    }
    else
    {
        strSQL += " LIMIT 0, 300"; /* 限制查询300条数据 */
    }

    record_count = pUserLogDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_alarm_record_proc() record_count=%d,strSQL=%s \r\n", record_count, (char*)strSQL.c_str());

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUserLogDbOper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get alarm information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUserLogDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_alarm_record_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_alarm_record_proc() ErrorMsg=%s\r\n", pUserLogDbOper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"AlarmRecord");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"AlarmRecordList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_alarm_record_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_alarm_record_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get alarm information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_alarm_record_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        unsigned int uID = 0;
        string strTmpDeviceID = "";
        int nAlarmType = 0;
        int nAlarmLevel = 0;
        int nStartTime = 0;
        int nStopTime = 0;
        string strAlarmInfo = "";

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_alarm_record_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateAlarmRecordResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, &ListAccNode);

        /* ID */
        pUserLogDbOper->GetFieldValue("ID", uID);

        /* DeviceID */
        strTmpDeviceID.clear();
        pUserLogDbOper->GetFieldValue("DeviceID", strTmpDeviceID);

        /* Type */
        pUserLogDbOper->GetFieldValue("Type", nAlarmType);

        /* Level */
        pUserLogDbOper->GetFieldValue("Level", nAlarmLevel);

        /* 开始时间 */
        pUserLogDbOper->GetFieldValue("StartTime", nStartTime);

        /* 停止时间 */
        pUserLogDbOper->GetFieldValue("StopTime", nStopTime);

        /* AlarmInfo */
        strAlarmInfo.clear();
        pUserLogDbOper->GetFieldValue("Info", strAlarmInfo);

        /* 加入Item 值 */
        i = AddAlarmRecordToXMLItem(pOutPacket, ListAccNode, uID, strTmpDeviceID, nAlarmType, nAlarmLevel, nStartTime, nStopTime, strAlarmInfo);

        if ((query_count % MAX_ALARM_RECORD_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取告警信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to alarm information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取告警信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to alarm information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUserLogDbOper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取告警信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to alarm information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_QUERY_ALARM_RECORD_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get alarm information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_alarm_record_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_online_user_proc
 功能描述  : 用户获取在线用户信息
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年10月21日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_online_user_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    char strSN[32] = {0};

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_online_user_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_online_user_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取在线用户信息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access online user information");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取在线用户信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR, "User get online user information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Query ID is not the ID of the local CMS", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_online_user_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_online_user_proc() \
            \r\n XML Para: \
            \r\n SN=%s \r\n", strSN);

    /* 查询在线用户信息表 */
    strSQL.clear();
    strSQL = "select GDP.ID,GDP.UserName,GDP.RealName,GDP.Tel,GDP.Resved2,G.LoginIP,G.Port from OnLineUserConfig as G, UserConfig as GDP WHERE G.ID = GDP.ID order by ID asc";
    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_online_user_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取在线用户信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR,  "User get online user information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_online_user_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_online_user_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetOnLineUser");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"OnLineUserList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_online_user_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_online_user_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户获取在线用户信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_WARNING,  "User get online user information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_online_user_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        unsigned int uUserIndex = 0;
        string strUserName = "";
        string strRealName = "";
        string strTel = "";
        string strResved2 = "";
        string strLoginIP = "";
        int iPort = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_online_user_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateOnlineUserConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, &ListAccNode);

        /* 索引 */
        pUser_Srv_dboper->GetFieldValue(0, uUserIndex);

        /* 用户名 */
        strUserName.clear();
        pUser_Srv_dboper->GetFieldValue(1, strUserName);

        /* 真实名 */
        strRealName.clear();
        pUser_Srv_dboper->GetFieldValue(2, strRealName);

        /* 联系方式 */
        strTel.clear();
        pUser_Srv_dboper->GetFieldValue(3, strTel);

        /* 备注2 */
        strResved2.clear();
        pUser_Srv_dboper->GetFieldValue(4, strResved2);

        /* 登录IP地址 */
        strLoginIP.clear();
        pUser_Srv_dboper->GetFieldValue(5, strLoginIP);

        /* 端口 */
        pUser_Srv_dboper->GetFieldValue(6, iPort);

        /* 加入Item 值 */
        i = AddOnlineUserConfigToXMLItem(pOutPacket, ListAccNode, uUserIndex, strUserName, strRealName, strTel, strResved2, strLoginIP, iPort);

        if ((query_count % MAX_ONLINE_USER_CONFIG_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR, "用户获取在线用户信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR, "Users access to  online user information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_poll_config_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取在线用户信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to  online user information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_poll_config_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取在线用户信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to  online user information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取在线用户信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_ONLINE_USER_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to get online user information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_online_user_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_data_value_proc
 功能描述  : 用户查询前端点位数据值处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年5月5日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_data_value_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strTransferSN[32] = {0};
    DOMElement* AccSnNode = NULL;
    unsigned int old_xml_sn = 0;
    unsigned int transfer_xml_sn = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_data_value_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_data_value_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取前端点位数据值, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User access device data value，device ID=%s", callee_id);

    /* 获取解码器通道状态消息直接转发给前端解码器
      */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_channel_status_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            AccSnNode = inPacket.SearchElement((char*)"SN");

            if (NULL != AccSnNode)
            {
                g_transfer_xml_sn++;
                snprintf(strTransferSN, 32, "%u", g_transfer_xml_sn);
                inPacket.SetElementValue(AccSnNode, strTransferSN);
                //inPacket.SetTextContent();
            }

            /* 将查询消息转发出去 */
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取前端点位数据值失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get device data value failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取解码器通道状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User get device data value successfuly,forwarding messages to the front end physical devices:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发前端物理设备ID=%s, IP地址=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_channel_status_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);

                old_xml_sn = strtoul(strSN, NULL, 10);
                transfer_xml_sn = strtoul(strTransferSN, NULL, 10);
                i = transfer_xml_msg_add(XML_QUERY_DATA_VALUE, old_xml_sn, transfer_xml_sn, pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, strDeviceID);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_channel_status_proc() transfer_xml_msg_add: Type=%d, old_xml_sn=%u, transfer_xml_sn=%u, DeviceID=%s, pos=%d \r\n", XML_QUERY_DATA_VALUE, old_xml_sn, transfer_xml_sn, strDeviceID, i);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取前端点位数据值失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get device data value failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", strDeviceID);
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取前端点位数据值失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的逻辑设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get device data value failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding logic device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_channel_status_proc() Find GBDevice Info Error:device_id=%s \r\n", strDeviceID);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_query_label_record_proc
 功能描述  : 用户获取标签录像数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年4月6日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_label_record_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */
    int send_count = 0;   /* 发送的次数 */
    int query_count = 0;  /* 查询数据统计 */

    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strNewDeviceID[32] = {0};
    char strDeviceIndex[32] = {0};
    char strStartTime[32] = {0};
    char strEndTime[32] = {0};
    char strType[32] = {0};
    unsigned int device_index = 0;

    DOMElement* ListAccNode = NULL;

    string strSQL = "";
    int while_count = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_label_record_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_query_label_record_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户获取标签录像信息, 前端逻辑设备ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User get label record information");

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"StartTime", strStartTime);
    inPacket.GetElementValue((char*)"EndTime", strEndTime);
    inPacket.GetElementValue((char*)"Type", strType); /* 录像类型 */

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_query_label_record_proc() \
            \r\n XML Para: \
            \r\n SN=%s, DeviceID=%s, StartTime=%s, EndTime=%s, Type=%s \r\n", strSN, strDeviceID, strStartTime, strEndTime, strType);

    /* 获取逻辑点位信息 */
    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL == pGBLogicDeviceInfo)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"获取逻辑设备信息失败,逻辑设备ID=", strDeviceID);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User get label record information failed:User ID=%s, User IP=%s, Port=%d, reason=%s%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Get GB Logic Device Info Error, DeviceId=", strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_label_record_proc() exit---: GBLogicDevice_info_find Error:DeviceID=%s \r\n", strDeviceID);
        return -1;
    }

    /* 根据业务类型和码流类型组建新的ID */
    snprintf(strNewDeviceID, 32, "%s%d%s", strDeviceID, 1, strType);

    device_index = crc32((unsigned char*)strNewDeviceID, 22);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_label_record_proc() Source NewDeviceID=%s, device_index=%u \r\n", strNewDeviceID, device_index);

    snprintf(strDeviceIndex, 32, "%u", device_index);

    /* 查询标签录像信息表 */
    strSQL.clear();
    strSQL = "select * from LableRecordTable WHERE DeviceIndex = ";
    strSQL += strDeviceIndex;
    strSQL += " and LableTime >= ";
    strSQL += strStartTime;
    strSQL += " and LableTime <= ";
    strSQL += strEndTime;
    strSQL += " and Type = ";
    strSQL += strType;
    strSQL += " order by LableTime asc";

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_query_label_record_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "User get label record information failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_label_record_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_label_record_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LabelRecordConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"DeviceID");
        outPacket.SetElementValue(AccNode, strDeviceID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"OK");

        AccNode = outPacket.CreateElement((char*)"SumNum");
        outPacket.SetElementValue(AccNode, (char*)"0");

        ListAccNode = outPacket.CreateElement((char*)"LabelRecordConfigList");
        outPacket.SetElementAttr(ListAccNode, (char*)"Num", (char*)"0");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_label_record_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_label_record_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "用户获取标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING,  "User get label record information failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"No data has been queried from the database");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_label_record_proc() exit---: No Record Count \r\n");
        return i;

    }

    CPacket* pOutPacket = NULL;

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        unsigned int uID = 0;
        unsigned int uLablelTime = 0;
        string strInfo = "";
        int iType = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_label_record_proc() While Count=%d \r\n", while_count);
        }

        query_count++;

        /* 创建XML头部 */
        i = CreateLableRecordConfigResponseXMLHead(&pOutPacket, query_count, record_count, strSN, strDeviceID, &ListAccNode);

        /* 数据库索引 */
        pUser_Srv_dboper->GetFieldValue("ID", uID);

        /* 时间 */
        pUser_Srv_dboper->GetFieldValue("LableTime", uLablelTime);

        /* 信息 */
        strInfo.clear();
        pUser_Srv_dboper->GetFieldValue("Info", strInfo);

        /* 类型 */
        pUser_Srv_dboper->GetFieldValue("Type", iType);

        /* 加入Item 值 */
        i = AddLableRecordConfigToXMLItem(pOutPacket, ListAccNode, uID, uLablelTime, strInfo, iType);

        if ((query_count % MAX_LABLE_RECORD_COUT_SEND == 0) || (query_count == record_count))
        {
            if (NULL != pOutPacket)
            {
                send_count++;
                /* 发送出去 */
                i |= SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)pOutPacket->GetXml(NULL).c_str(), pOutPacket->GetXml(NULL).length());

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户获取标签录像信息, 发送Message消息到用户失败:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "Users access to label record information, send a message to the user failed: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_query_label_record_proc() SIP_SendMessage Error:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获取标签录像信息, 发送Message消息到用户成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access to label record information, send a message to the user successfully: user ID = % s, IP address = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_label_record_proc() SIP_SendMessage OK:dest_id=%s, dest_ip=%s, dest_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                delete pOutPacket;
                pOutPacket = NULL;
            }
        }
    }
    while (pUser_Srv_dboper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户获取标签录像信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 记录数=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users access to label record information: user ID = % s, = % s IP address, port number = % d, record number = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户获取标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to get label record information: user ID = % s, = % s IP address, port number = % d, reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_query_label_record_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_add_poll_config_proc
 功能描述  : 用户添加轮巡表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int user_add_poll_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;
    poll_srv_t* pPollSrv = NULL;

    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strPollName[MAX_128CHAR_STRING_LEN + 4] = {0};
    char strStartTime[32] = {0};
    char strDurationTime[32] = {0};

    string strQuerySQL = "";
    string strInsertSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_add_poll_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_add_poll_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"PollName", strPollName);
    inPacket.GetElementValue((char*)"StartTime", strStartTime);
    inPacket.GetElementValue((char*)"DurationTime", strDurationTime);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_add_poll_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, PollName=%s, StartTime=%s, DurationTime=%s \r\n", strSN, strPollName, strStartTime, strDurationTime);

    /* 将数据写入数据库 */
    /* 1、查询SQL语句 */
    strQuerySQL.clear();
    strQuerySQL = "select * from PollConfig WHERE PollName like '";
    strQuerySQL += strPollName;
    strQuerySQL += "'";

    /* 2、插入SQL语句 */
    strInsertSQL.clear();
    strInsertSQL = "insert into PollConfig (PollName,StartTime,DurationTime) values (";

    strInsertSQL += "'";
    strInsertSQL += strPollName;
    strInsertSQL += "'";

    strInsertSQL += ",";

    strInsertSQL += strStartTime;

    strInsertSQL += ",";

    strInsertSQL += strDurationTime;

    strInsertSQL += ")";

    /* 查询数据库 */
    record_count = pUser_Srv_dboper->DB_Select(strQuerySQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_add_poll_config_proc() DB Select:strSQL=%s,record_count=%d \r\n", strQuerySQL.c_str(), record_count);

    if (record_count < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() DB Oper Error:strQuerySQL=%s, record_count=%d \r\n", strQuerySQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count > 0) /* 已经存在 */
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() exit---: Poll Config Record Already Exist \r\n");
        return -1;
    }

    iRet = pUser_Srv_dboper->DB_Insert("", "", strInsertSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() DB Oper Error:strInsertSQL=%s, iRet=%d \r\n", strInsertSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 再次查询数据库，获取到索引值 */
    record_count = pUser_Srv_dboper->DB_Select(strQuerySQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_add_poll_config_proc() DB Select:strSQL=%s,record_count=%d \r\n", strQuerySQL.c_str(), record_count);

    if (record_count <= 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        return -1;
    }

    unsigned int uID = 0;

    pUser_Srv_dboper->GetFieldValue("ID", uID);

    if (uID <= 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        return -1;
    }

    /* 增加到内存 */
    iRet = poll_srv_init(&pPollSrv);

    if (iRet != 0)
    {
        /* 数据库中是否需要回退 */

        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        return iRet;
    }

    pPollSrv->poll_id = uID;
    osip_strncpy(pPollSrv->poll_name, strPollName, MAX_128CHAR_STRING_LEN);
    pPollSrv->start_time = osip_atoi(strStartTime);
    pPollSrv->duration_time = osip_atoi(strDurationTime);

    /* 添加到队列 */
    if (poll_srv_add(pPollSrv) < 0)
    {
        poll_srv_free(pPollSrv);
        pPollSrv = NULL;

        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() Poll Srv Add Error");
        return -1;
    }

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;
    char strID[32] = {0};

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"PollConfig");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    snprintf(strID, 32, "%u", uID);
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i != 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_del_poll_config_proc
 功能描述  : 用户删除轮巡表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int user_del_poll_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;

    char strSN[32] = {0};
    char strID[32] = {0};

    string strDeltetSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_del_poll_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_del_poll_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"ID", strID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_del_poll_config_proc() \
                \r\n XML Para: \
                \r\n SN=%s, ID=%s \r\n", strSN, strID);

    /* 将数据写入数据库 */
    /* 删除SQL语句 */
    strDeltetSQL.clear();
    strDeltetSQL = "delete from PollConfig WHERE ID = ";
    strDeltetSQL += strID;

    iRet = pUser_Srv_dboper->DB_Delete(strDeltetSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, strID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_del_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() DB Oper Error:strDeltetSQL=%s, iRet=%d \r\n", strDeltetSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 关联删除action */
    strDeltetSQL.clear();
    strDeltetSQL = "delete from PollActionConfig WHERE PollID = ";
    strDeltetSQL += strID;

    iRet = pUser_Srv_dboper->DB_Delete(strDeltetSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, strID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_del_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() DB Oper Error:strDeltetSQL=%s, iRet=%d \r\n", strDeltetSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 停止轮巡任务 */
    i = stop_poll_srv_by_id(osip_atoi(strID));

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"PollConfig");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i != 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_poll_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_del_poll_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_add_label_record_config_proc
 功能描述  : 用户增加标签录像表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年04月06日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_add_label_record_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;

    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strNewDeviceID[32] = {0};
    char strDeviceIndex[32] = {0};
    char strLabelTime[32] = {0};
    char strType[32] = {0};
    char strInfo[64] = {0};
    unsigned int device_index = 0;

    string strQuerySQL = "";
    string strInsertSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_add_label_record_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_add_label_record_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"LabelTime", strLabelTime);
    inPacket.GetElementValue((char*)"Type", strType);
    inPacket.GetElementValue((char*)"Info", strInfo);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_add_label_record_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, DeviceID=%s, LabelTime=%s, Type=%s, Info=%s \r\n", strSN, strDeviceID, strLabelTime, strType, strInfo);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户添加标签录像信息, 前端逻辑设备ID=%s, 标签时间=%s, 标签类型=%s, 标签信息=%s", strDeviceID, strLabelTime, strType, strInfo);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "Users add tags record information, Front logical device ID = % s, label, time = % s label type = % s, label information = %s", strDeviceID, strLabelTime, strType, strInfo);

    /* 根据业务类型和码流类型组建新的ID */
    snprintf(strNewDeviceID, 32, "%s%d%s", strDeviceID, 1, strType);

    device_index = crc32((unsigned char*)strNewDeviceID, 22);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_add_label_record_config_proc() Source NewDeviceID=%s, device_index=%u \r\n", strNewDeviceID, device_index);

    snprintf(strDeviceIndex, 32, "%u", device_index);

    /* 将数据写入数据库 */
    /* 1、插入SQL语句 */
    strInsertSQL.clear();
    strInsertSQL = "insert into LableRecordTable (LableTime,DeviceIndex,Info,Type) values (";

    strInsertSQL += strLabelTime;

    strInsertSQL += ",";
    strInsertSQL += strDeviceIndex;

    strInsertSQL += ",";
    strInsertSQL += "'";
    strInsertSQL += strInfo;
    strInsertSQL += "'";

    strInsertSQL += ",";
    strInsertSQL += strType;

    strInsertSQL += ")";

    iRet = pUser_Srv_dboper->DB_Insert("", "", strInsertSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LabelRecordInsert");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_label_record_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户添加标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"操作数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users add tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database operation failure", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() DB Oper Error:strInsertSQL=%s, iRet=%d \r\n", strInsertSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 查询数据库，获取到索引值 */
    /* 1、查询SQL语句 */
    strQuerySQL.clear();
    strQuerySQL = "select ID from LableRecordTable WHERE LableTime = ";
    strQuerySQL += strLabelTime;
    strQuerySQL += " and DeviceIndex = ";
    strQuerySQL += strDeviceIndex;
    strQuerySQL += " and Type = ";
    strQuerySQL += strType;
    strQuerySQL += " and Info like '";
    strQuerySQL += strInfo;
    strQuerySQL += "'";

    record_count = pUser_Srv_dboper->DB_Select(strQuerySQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_add_label_record_config_proc() DB Select:strSQL=%s,record_count=%d \r\n", strQuerySQL.c_str(), record_count);

    if (record_count <= 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LabelRecordInsert");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_label_record_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户添加标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users add tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database query failure", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() DB Oper Error:strQuerySQL=%s, iRet=%d \r\n", strQuerySQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    unsigned int uID = 0;

    pUser_Srv_dboper->GetFieldValue("ID", uID);

    if (uID <= 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LabelRecordInsert");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, (char*)"");

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_add_label_record_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户添加标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, uID=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"标签数据库索引错误", uID);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users add tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"label database index error ", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_add_label_record_config_proc() ID Error:ID=%d \r\n", uID);
        return -1;
    }

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;
    char strID[32] = {0};

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"LabelRecordInsert");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    snprintf(strID, 32, "%u", uID);
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户添加标签录像信息成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "Users add video tag information successfully: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户添加标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users add tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"send SIP response message failed ", pUser_Srv_dboper->GetLastDbErrorMsg());
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_del_label_record_config_proc
 功能描述  : 用户删除标签录像表数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年04月06日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_del_label_record_config_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;

    char strSN[32] = {0};
    char strID[32] = {0};

    string strDeltetSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_del_label_record_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_del_label_record_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"ID", strID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_del_label_record_config_proc() \
                \r\n XML Para: \
                \r\n SN=%s, ID=%s \r\n", strSN, strID);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户删除标签录像信息, 前端逻辑设备ID=%s, 标签录像索引=%s", callee_id, strID);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "Users delete tags information, Front-end logical device ID = % s, label video index = %s", callee_id, strID);

    /* 将数据写入数据库 */
    /* 删除SQL语句 */
    strDeltetSQL.clear();
    strDeltetSQL = "delete from LableRecordTable WHERE ID = ";
    strDeltetSQL += strID;

    iRet = pUser_Srv_dboper->DB_Delete(strDeltetSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"LabelRecordDelete");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"ID");
        outPacket.SetElementValue(AccNode, strID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_label_record_config_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_del_label_record_config_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户删除标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"操作数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users delete tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database operation failure ", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_label_record_config_proc() DB Oper Error:strDeltetSQL=%s, iRet=%d \r\n", strDeltetSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_del_label_record_config_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"LabelRecordDelete");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户删除标签录像信息成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "Users delete video tag information successfully: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户删除标签录像信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users delete tags failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"send SIP response message failed ", pUser_Srv_dboper->GetLastDbErrorMsg());
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_change_password_proc
 功能描述  : 用户修改用户密码处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年4月16日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_change_password_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;

    char strSN[32] = {0};
    char strUserID[32] = {0};
    char strUserName[32] = {0};
    char strPassword[32] = {0};

    string strUpdateSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_change_password_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_change_password_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", strUserID);
    inPacket.GetElementValue((char*)"UserName", strUserName);
    inPacket.GetElementValue((char*)"Password", strPassword);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_change_password_proc() \
                \r\n XML Para: \
                \r\n SN=%s, UserID=%s, UserName=%s, Password=%s \r\n", strSN, strUserID, strUserName, strPassword);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户修改用户密码, UserID=%s, UserName=%s, Password=%s", strUserID, strUserName, strPassword);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "Users modify the user password, UserID=%s, UserName=%s, Password=%s", strUserID, strUserName, strPassword);

    /* 将数据写入数据库 */
    strUpdateSQL.clear();
    strUpdateSQL = "UPDATE UserConfig SET Password = '";
    strUpdateSQL += strPassword;
    strUpdateSQL += "' WHERE UserID like '";
    strUpdateSQL += strUserID;
    strUpdateSQL += "' AND UserName like '";
    strUpdateSQL += strUserName;
    strUpdateSQL += "'";

    iRet = pUser_Srv_dboper->DB_Update(strUpdateSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"ChangeUserPassword");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"UserID");
        outPacket.SetElementValue(AccNode, strUserID);

        AccNode = outPacket.CreateElement((char*)"UserName");
        outPacket.SetElementValue(AccNode, strUserName);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_change_password_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_change_password_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户修改用户密码失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"操作数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users modify the user password failure:user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database operation failure ", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_change_password_proc() DB Oper Error:strUpdateSQL=%s, iRet=%d \r\n", strUpdateSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_change_password_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"ChangeUserPassword");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, strUserID);

    AccNode = outPacket.CreateElement((char*)"UserName");
    outPacket.SetElementValue(AccNode, strUserName);


    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户修改用户密码成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "Users modify the user password successfully: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户修改用户密码失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users modify the user password failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"send SIP response message failed ", pUser_Srv_dboper->GetLastDbErrorMsg());
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_confirm_alarm_proc
 功能描述  : 用户确认告警信息操作
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
             DBOper* pUserLogDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年6月29日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_confirm_alarm_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper, DBOper* pUserLogDbOper)
{
    int i = 0;
    int iRet = 0;

    char strSN[32] = {0};
    char strAlarmID[32] = {0};

    string strUpdateSQL = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_confirm_alarm_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUserLogDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_confirm_alarm_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"AlarmID", strAlarmID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_confirm_alarm_proc() \
                \r\n XML Para: \
                \r\n SN=%s, AlarmID=%s\r\n", strSN, strAlarmID);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户确认告警信息, AlarmID=%s", strAlarmID);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "Users Confirm the alarm information, AlarmID=%s", strAlarmID);

    if (strAlarmID[0] == '\0')
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"AlarmID");
        outPacket.SetElementValue(AccNode, strAlarmID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_confirm_alarm_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_confirm_alarm_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户确认告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"获取告警信息ID失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users Confirm the alarm information failure: User ID = % s, = % s IP address, port number = % d, alarm, ID = % s reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"Failed to get the alarm information ID");
        return -1;
    }

    if (osip_atoi(strAlarmID) <= 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"AlarmID");
        outPacket.SetElementValue(AccNode, strAlarmID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_confirm_alarm_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_confirm_alarm_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户确认告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"告警信息ID不合法");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users Confirm the alarm information failure: User ID = % s, = % s IP address, port number = % d, alarm, ID = % s reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"The alarm information ID is not legal");
        return -1;
    }

    /* 将数据写入数据库 */
    strUpdateSQL.clear();
    strUpdateSQL = "UPDATE AlarmRecord SET Resved1 = 1";
    strUpdateSQL += " WHERE ID = ";
    strUpdateSQL += strAlarmID;

    iRet = pUserLogDbOper->DB_Update(strUpdateSQL.c_str(), 1);

    if (iRet < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"AlarmID");
        outPacket.SetElementValue(AccNode, strAlarmID);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"ERROR");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_confirm_alarm_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_confirm_alarm_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户确认告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"操作数据库失败", pUserLogDbOper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users Confirm the alarm information failure: user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database operation failure ", pUserLogDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_confirm_alarm_proc() DB Oper Error:strUpdateSQL=%s, iRet=%d \r\n", strUpdateSQL.c_str(), iRet);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_confirm_alarm_proc() ErrorMsg=%s\r\n", pUserLogDbOper->GetLastDbErrorMsg());
        return -1;
    }

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"DeviceControl");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"AlarmID");
    outPacket.SetElementValue(AccNode, strAlarmID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i != 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户确认告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "Users Confirm the alarm information failure: video information, user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"send SIP response message failed ", pUser_Srv_dboper->GetLastDbErrorMsg());
    }

    /* 通知所有在线用户 */
    CPacket outPacket1;
    DOMElement* AccNode1 = NULL;

    outPacket1.SetRootTag("Notify");
    AccNode1 = outPacket1.CreateElement((char*)"CmdType");
    outPacket1.SetElementValue(AccNode1, (char*)"ConfirmAlarm");

    AccNode1 = outPacket1.CreateElement((char*)"SN");
    outPacket1.SetElementValue(AccNode1, strSN);

    AccNode1 = outPacket1.CreateElement((char*)"AlarmID");
    outPacket1.SetElementValue(AccNode1, strAlarmID);

    i = SendMessageToOnlineUser((char*)outPacket1.GetXml(NULL).c_str(), outPacket1.GetXml(NULL).length(), 0);

    if (i > 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户确认告警信息成功:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "user confirm the alarm information successfully, user ID = % s = % s IP address, port number = % d, the alarm ID = % s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID);
    }
    else if (i < 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "用户确认告警信息失败:用户ID=%s, IP地址=%s, 端口号=%d, 告警ID=%s, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"发送告警确认通知消息给在线用户失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR,  "user confirm the alarm information failed:User ID = % s, = % s IP address, port number = % d, alarm, ID = % s reason = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, strAlarmID, (char*)"Alarm confirmation notice sending message to online user failed");
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_notify_alarm_proc
 功能描述  : 用户报警事件通知信息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_alarm_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 报警事件通知和分发
          控制流程见9.4.2
          该命令由前端设备发出，用户端暂时没有此类消息处理

          命令包括如下字段:
          <!-- 命令类型：报警通知（必选） -->
          <element name="CmdType" fixed = "Alarm" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 报警设备编码（必选）-->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 报警级别（必选），1为一级警情，2为二级警情，3为三级警情，4为四级警情-->
          <element name="AlarmPriority" type="string" />
          <!-- 报警方式（必选），取值1为电话报警，2为设备报警，3为短信报警，4为GPS报警，5为视频报警，6
          为设备故障报警，7其它报警-->
          <element name= "AlarmMethod" type= "string" />
          <!--报警时间（必选）-->
          <element name= "AlarmTime" type="dateTime" />
          <!-- 经纬度信息可选 -->
          <element name="Longitude" type="double" minOccurs= "0"/>
          <element name="Latitude" type="double" minOccurs= "0"/>
          <!-- 扩展信息，可多项 -->
          <element name= "Info" minOccurs= "0" maxOccurs="unbounded">
          <restriction base= "string">
          <maxLength value= "1024" />
          </restriction>
          </element>
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_keep_alive_proc
 功能描述  : 用户保活信息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_keep_alive_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strStatus[32] = {0};

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_keep_alive_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_keep_alive_proc() exit---: Param Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_keep_alive_proc() Enter---: caller_id=%s, callee_id=%s\r\n", caller_id, callee_id);

    /* 设备状态信息报送消息
          控制流程见9.6.2.

          命令包括如下字段:
          <!-- 命令类型：设备状态信息报送（必选） -->
          < element name="CmdType" fixed ="Keepalive" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 源设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 是否正常工作（必选） -->
          <element name="Status" type="tg:resultType" />
     */

    /* 查看被叫是否是本CMS ID */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        DEBUG_TRACE(MODULE_USER, LOG_WARN,  "user_notify_keep_alive_proc() exit---: Not Belong To Mine \r\n");
        //return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"Status", strStatus);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_keep_alive_proc() \
    \r\n XML Para: \
    \r\n SN=%s, DeviceID=%s, Status=%s, reg_status=%d \r\n ", strSN, strDeviceID, strStatus, pUserInfo->reg_status);

    if (3 == pUserInfo->reg_status)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户保活失败，用户user_id=%s, 用户端口=%d, 用户login_port=%d, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"用户即将注销");
        return -1;
    }

    if (sstrcmp(strStatus, "OK") == 0)
    {
        if (pUserInfo->reg_status <= 0)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_notify_keep_alive_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }
        else if (pUserInfo->reg_status == 1)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_notify_keep_alive_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }

        SIP_UASUpdateRegisterExpires(pUserInfo->reg_info_index);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_connect_tv_proc
 功能描述  : 用户通知连接DC处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月14日 星期三
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_connect_tv_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int iRet = 0;
    int dialog_index = -1;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strStreamID[32] = {0};
    char strDecoderChannelID[32] = {0};
    char strStreamType[32] = {0};
    int iStreamType = 0;

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_connect_tv_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_connect_tv_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 用户通知连接解码器

          命令包括如下字段:
          <?xml version="1.0"?>
              <Notify>
              <CmdType>ConnectTV</ CmdType>
              <SN>1234</SN>
              <DeviceID>逻辑设备ID</DeviceID>
              <StreamID>流ID</StreamID>
              <StreamType>码流类型</StreamType>
              <DecoderChannelID>解码器逻辑通道编码</DecoderChannelID>
              </Notify>

     */
    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        /* 取得数据*/
        inPacket.GetElementValue((char*)"SN", strSN);
        inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
        inPacket.GetElementValue((char*)"StreamID", strStreamID);
        inPacket.GetElementValue((char*)"StreamType", strStreamType);
        inPacket.GetElementValue((char*)"DecoderChannelID", strDecoderChannelID);

        DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_connect_tv_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s, StreamID=%s, StreamType=%s, DecoderChannelID=%s \r\n", strSN, strDeviceID, strStreamID, strStreamType, strDecoderChannelID);

        UserLog(EV9000_USER_LOG_CONNECT_TVWALL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知切换电视墙业务, 源逻辑设备ID=%s, 解码器通道ID=%s, 码流类型=%s", strDeviceID, strDecoderChannelID, strStreamType);
        EnUserLog(EV9000_USER_LOG_CONNECT_TVWALL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to switch TV wall business，source logic deviceID=%s, decoder channel ID=%s, stream type =%s", strDeviceID, strDecoderChannelID, strStreamType);

        if (strStreamType[0] == '\0')
        {
            dialog_index = start_connect_tv_proc(strDeviceID, EV9000_STREAM_TYPE_MASTER, strDecoderChannelID, 0);
        }
        else
        {
            iStreamType = osip_atoi(strStreamType);

            if (strStreamType <= 0)
            {
                dialog_index = start_connect_tv_proc(strDeviceID, EV9000_STREAM_TYPE_MASTER, strDecoderChannelID, 0);
            }
            else
            {
                dialog_index = start_connect_tv_proc(strDeviceID, iStreamType, strDecoderChannelID, 0);
            }
        }

        if (dialog_index < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() start_connect_tv_proc Error:DeviceID=%s, DecoderChannelID=%s, dialog_index=%d\r\n", strDeviceID, strDecoderChannelID, dialog_index);

            /* 通知客户端, 回复响应,组建消息 */
            outPacket.SetRootTag("Response");
            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"ConnectTV");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"Result");
            outPacket.SetElementValue(AccNode, (char*)"Error");

            /* 发送响应消息 */
            iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_connect_tv_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() exit---: start_connect_tv_proc Error \r\n");
            return -1;
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_notify_connect_tv_proc() start_connect_tv_proc OK:DeviceID=%s, DecoderChannelID=%s, dialog_index=%d\r\n", strDeviceID, strDecoderChannelID, dialog_index);

            /* 加入到需要回应消息队列 */
            iRet = user_response_msg_add(XML_NOTIFY_CONNECT_TV, strSN, pUserInfo, strDeviceID, strDecoderChannelID, dialog_index);

            if (0 != iRet)
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_connect_tv_proc() User Response Message Add Error \r\n");
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_connect_tv_proc() User Response Message Add OK \r\n");
            }
        }
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() exit---: Callee ID Not Belong To Mine \r\n");
        return -1;
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_execute_plan_proc
 功能描述  : 用户通知执行预案
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年3月14日 星期五
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_execute_plan_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int iRet = 0;
    char strSN[32] = {0};
    char strPlanID[32] = {0};
    char strLowerLevelFlag[32] = {0};
    string strSQL = "";
    string strPlanName = "";
    char pcPlanID[32] = {0};
    int record_count = 0;

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    /* 用户通知执行预案

          命令包括如下字段:
          <?xml version="1.0"?>
              <Notify>
              <CmdType>ExecutePlan</CmdType>
              <SN>1234</SN>
              <PlanID>预案ID</PlanID>
              <LowerLevelFlag>是否发给下级用户</LowerLevelFlag>
              </Notify>
     */

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_plan_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_plan_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_plan_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        /* 取得数据*/
        inPacket.GetElementValue((char*)"SN", strSN);
        inPacket.GetElementValue((char*)"PlanID", strPlanID);
        inPacket.GetElementValue((char*)"LowerLevelFlag", strLowerLevelFlag);

        DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_execute_plan_proc() \
        \r\n XML Para: \
        \r\n SN=%s, PlanID=%s, LowerLevelFlag=%s \r\n", strSN, strPlanID, strLowerLevelFlag);

        UserLog(EV9000_USER_LOG_EXECUTE_PLAN, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知执行预案, 预案ID=%s", strPlanID);
        EnUserLog(EV9000_USER_LOG_EXECUTE_PLAN, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to run plan，plan ID=%s", strPlanID);

        /* 根据plan_id，查询预案动作表，获取预案的具体数据 */
        strSQL.clear();
        strSQL = "select * from PlanConfig WHERE ID = ";
        strSQL += strPlanID;
        record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

        if (record_count < 0)
        {
            SystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行预案失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"操作数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
            EnSystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute plan failure: user ID = % s = % s IP address, port number = % d, reason = %:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Database operation failure ", pUser_Srv_dboper->GetLastDbErrorMsg());
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_plan_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_plan_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
            return -1;
        }
        else if (record_count == 0)
        {
            SystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行预案失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 预案ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"没有找到数据库记录", strPlanID);
            EnSystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute plan failure:User ID = % s, = % s IP address, port number = % d, reason = % s, plan ID = %s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"The database record not found", strPlanID);
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_execute_plan_proc() exit---: No Record Count \r\n");
            return 0;
        }

        pUser_Srv_dboper->GetFieldValue("PlanName", strPlanName);

        if (!strPlanName.empty())
        {
            snprintf(pcPlanID, 32, "%s", (char*)strPlanName.c_str());
        }

        /* 根据预案ID 执行预案动作表 */
        iRet = StartPlanActionByPlanID(pUserInfo, strPlanID, pcPlanID, pUser_Srv_dboper);

        if (iRet != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_plan_proc() StartPlanActionByPlanID Error:PlanID=%s, iRet=%d\r\n", strPlanID, iRet);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_plan_proc() StartPlanActionByPlanID OK:PlanID=%s, iRet=%d\r\n", strPlanID, iRet);
        }

        if (iRet != 0)
        {
            /* 通知客户端, 回复响应,组建消息 */
            outPacket.SetRootTag("Response");
            AccNode = outPacket.CreateElement((char*)"CmdType");
            outPacket.SetElementValue(AccNode, (char*)"ExecutePlan");

            AccNode = outPacket.CreateElement((char*)"SN");
            outPacket.SetElementValue(AccNode, strSN);

            AccNode = outPacket.CreateElement((char*)"Result");
            outPacket.SetElementValue(AccNode, (char*)"Error");

            /* 发送响应消息 */
            iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_plan_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_plan_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
            }

            SystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行预案失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 预案ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"执行预案失败", strPlanID);
            EnSystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute plan failed:User ID=%s, User IP=%s, Port=%d, reason=%s, Plan ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Execute plan failed", strPlanID);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() exit---: StartPlanActionByPlanID Error \r\n");
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行预案失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"被叫侧的ID不是本CMS ID");
        EnSystemLog(EV9000_CMS_EXECUTE_PLAN_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute plan failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Called side ID is not local CMS ID");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_plan_proc() exit---: Callee ID Not Belong To Mine \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户通知执行预案成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "User notify to execute plan successfully:User ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_execute_poll_proc
 功能描述  : 用户通知执行轮巡
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年4月1日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_execute_poll_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int iRet = 0;
    char strSN[32] = {0};
    char strPollID[32] = {0};
    char strRunFlag[32] = {0};

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_poll_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_poll_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 用户通知执行轮巡

          命令包括如下字段:
          <?xml version="1.0"?>
              <Notify>
              <CmdType>ExecutePoll</ CmdType>
              <SN>1234</SN>
              <PollID>轮询ID</PollID>
              <RunFlag>Stop</RunFlay>
              </Notify>

     */
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_poll_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        /* 取得数据*/
        inPacket.GetElementValue((char*)"SN", strSN);
        inPacket.GetElementValue((char*)"PollID", strPollID);
        inPacket.GetElementValue((char*)"RunFlag", strRunFlag);

        DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_execute_poll_proc() \
        \r\n XML Para: \
        \r\n SN=%s, PollID=%s, RunFlag=%s \r\n", strSN, strPollID, strRunFlag);

        if (0 == sstrcmp(strRunFlag, (char*)"Start")) /* 启动轮巡 */
        {
            UserLog(EV9000_USER_LOG_EXECUTE_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知执行轮巡, 轮巡ID=%s", strPollID);
            EnUserLog(EV9000_USER_LOG_EXECUTE_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to run polling，polling ID=%s", strPollID);

            /* 根据预案ID 执行轮巡动作表 */
            iRet = start_poll_srv_by_id(pUserInfo, strtoul(strPollID, NULL, 10), pUser_Srv_dboper);

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() start_poll_srv_by_id Error:poll_id=%u, iRet=%d\r\n", strtoul(strPollID, NULL, 10), iRet);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_poll_proc() start_poll_srv_by_id OK:poll_id=%u, iRet=%d\r\n", strtoul(strPollID, NULL, 10), iRet);
            }

            if (iRet != 0)
            {
                /* 通知客户端, 回复响应,组建消息 */
                outPacket.SetRootTag("Response");
                AccNode = outPacket.CreateElement((char*)"CmdType");
                outPacket.SetElementValue(AccNode, (char*)"ExecutePoll");

                AccNode = outPacket.CreateElement((char*)"SN");
                outPacket.SetElementValue(AccNode, strSN);

                AccNode = outPacket.CreateElement((char*)"Result");
                outPacket.SetElementValue(AccNode, (char*)"Error");

                /* 发送响应消息 */
                iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (iRet != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_poll_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行轮巡失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 轮巡ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"执行轮巡失败", strPollID);
                EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute polling failed:User ID=%s, User IP=%s, Port=%d, reason=%s, Polling ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Execute polling failed", strPollID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() exit---: start_poll_srv_by_id Error \r\n");
                return -1;
            }
        }
        else if (0 == sstrcmp(strRunFlag, (char*)"Stop")) /* 停止轮巡 */
        {
            UserLog(EV9000_USER_LOG_STOP_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知停止轮巡, 轮巡ID=%s", strPollID);
            EnUserLog(EV9000_USER_LOG_STOP_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to stop polling，polling ID=%s", strPollID);

            /* 根据预案ID 执行轮巡动作表 */
            iRet = stop_poll_srv_by_id(strtoul(strPollID, NULL, 10));

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() stop_poll_srv_by_id Error:poll_id=%u, iRet=%d\r\n", strtoul(strPollID, NULL, 10), iRet);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_poll_proc() stop_poll_srv_by_id OK:poll_id=%u, iRet=%d\r\n", strtoul(strPollID, NULL, 10), iRet);
            }

            if (iRet != 0)
            {
                /* 通知客户端, 回复响应,组建消息 */
                outPacket.SetRootTag("Response");
                AccNode = outPacket.CreateElement((char*)"CmdType");
                outPacket.SetElementValue(AccNode, (char*)"ExecutePoll");

                AccNode = outPacket.CreateElement((char*)"SN");
                outPacket.SetElementValue(AccNode, strSN);

                AccNode = outPacket.CreateElement((char*)"Result");
                outPacket.SetElementValue(AccNode, (char*)"Error");

                /* 发送响应消息 */
                iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (iRet != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_poll_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知停止轮巡失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 轮巡ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"停止轮巡失败", strPollID);
                EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to stop polling failed:User ID=%s, User IP=%s, Port=%d, reason=%s, Polling ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Stop polling failed", strPollID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() exit---: stop_poll_srv_by_id Error \r\n");
                return -1;
            }
        }
    }
    else
    {
        SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行轮巡失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"被叫侧的ID不是本CMS ID");
        EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute polling failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Called side ID is not local CMS ID");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() exit---: Callee ID Not Belong To Mine \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户通知执行轮巡成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "User notify to execute polling successfully:User ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_execute_cruise_proc
 功能描述  : 用户通知执行巡航
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_execute_cruise_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int iRet = 0;
    char strSN[32] = {0};
    char strCruiseID[32] = {0};
    char strRunFlag[32] = {0};

    CPacket outPacket;
    DOMElement* AccNode = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_cruise_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_execute_cruise_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 用户通知执行巡航

          命令包括如下字段:
          <?xml version="1.0"?>
              <Notify>
              <CmdType>ExecuteCruise</ CmdType>
              <SN>1234</SN>
              <PollID>巡航ID</PollID>
              <RunFlag>Stop</RunFlay>
              </Notify>

     */
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_cruise_proc() Enter---: caller_id=%s, caller_ip=%s, caller_port=%d, callee_id=%s\r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id);

    if (0 == strncmp(callee_id, local_cms_id_get(), 20))
    {
        /* 取得数据*/
        inPacket.GetElementValue((char*)"SN", strSN);
        inPacket.GetElementValue((char*)"CruiseID", strCruiseID);
        inPacket.GetElementValue((char*)"RunFlag", strRunFlag);

        DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_execute_cruise_proc() \
        \r\n XML Para: \
        \r\n SN=%s, CruiseID=%s, RunFlag=%s \r\n", strSN, strCruiseID, strRunFlag);

        if (0 == sstrcmp(strRunFlag, (char*)"Start")) /* 启动轮巡 */
        {
            UserLog(EV9000_USER_LOG_EXECUTE_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知执行巡航, 巡航ID=%s", strCruiseID);
            EnUserLog(EV9000_USER_LOG_EXECUTE_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to run navigation，navigation ID=%s", strCruiseID);

            /* 根据预案ID 执行预案动作表 */
            iRet = start_cruise_srv_by_id(pUserInfo, strtoul(strCruiseID, NULL, 10), pUser_Srv_dboper);

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() start_cruise_srv_by_id Error:cruise_id=%u, iRet=%d\r\n", strtoul(strCruiseID, NULL, 10), iRet);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_cruise_proc() start_cruise_srv_by_id OK:cruise_id=%u, iRet=%d\r\n", strtoul(strCruiseID, NULL, 10), iRet);
            }

            if (iRet != 0)
            {
                /* 通知客户端, 回复响应,组建消息 */
                outPacket.SetRootTag("Response");
                AccNode = outPacket.CreateElement((char*)"CmdType");
                outPacket.SetElementValue(AccNode, (char*)"ExecuteCruise");

                AccNode = outPacket.CreateElement((char*)"SN");
                outPacket.SetElementValue(AccNode, strSN);

                AccNode = outPacket.CreateElement((char*)"Result");
                outPacket.SetElementValue(AccNode, (char*)"Error");

                /* 发送响应消息 */
                iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (iRet != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_cruise_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行巡航失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 巡航ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"执行轮巡失败", strCruiseID);
                EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute cruise failed:User ID=%s, User IP=%s, Port=%d, reason=%s, Cruise ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Execute cruise failed", strCruiseID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() exit---: start_cruise_srv_by_id Error \r\n");
                return -1;
            }
        }
        else if (0 == sstrcmp(strRunFlag, (char*)"Stop")) /* 停止轮巡 */
        {
            UserLog(EV9000_USER_LOG_STOP_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知停止巡航, 巡航ID=%s", strCruiseID);
            EnUserLog(EV9000_USER_LOG_STOP_POLL, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify to stop navigation, navigation ID=%s", strCruiseID);

            /* 根据预案ID 执行预案动作表 */
            iRet = stop_cruise_srv_by_id(strtoul(strCruiseID, NULL, 10));

            if (iRet != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() stop_cruise_srv_by_id Error:poll_id=%u, iRet=%d\r\n", strtoul(strCruiseID, NULL, 10), iRet);
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_cruise_proc() stop_cruise_srv_by_id OK:poll_id=%u, iRet=%d\r\n", strtoul(strCruiseID, NULL, 10), iRet);
            }

            if (iRet != 0)
            {
                /* 通知客户端, 回复响应,组建消息 */
                outPacket.SetRootTag("Response");
                AccNode = outPacket.CreateElement((char*)"CmdType");
                outPacket.SetElementValue(AccNode, (char*)"ExecuteCruise");

                AccNode = outPacket.CreateElement((char*)"SN");
                outPacket.SetElementValue(AccNode, strSN);

                AccNode = outPacket.CreateElement((char*)"Result");
                outPacket.SetElementValue(AccNode, (char*)"Error");

                /* 发送响应消息 */
                iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (iRet != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_execute_cruise_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
                }

                SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知停止巡航失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s, 巡航ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"停止巡航失败", strCruiseID);
                EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to stop cruise failed:User ID=%s, User IP=%s, Port=%d, reason=%s, Cruise ID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Stop cruise failed", strCruiseID);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_cruise_proc() exit---: stop_cruise_srv_by_id Error \r\n");
                return -1;
            }
        }
    }
    else
    {
        SystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通知执行巡航失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"被叫侧的ID不是本CMS ID");
        EnSystemLog(EV9000_CMS_EXECUTE_POLL_ERROR, EV9000_LOG_LEVEL_ERROR,  "User notify to execute cruise failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Called side ID is not local CMS ID");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_execute_poll_proc() exit---: Callee ID Not Belong To Mine \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户通知执行巡航成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "User notify to execute cruise successfully:User ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_tv_status_proc
 功能描述  : 用户通知电视墙状态
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月25日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_tv_status_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int i = 0;
    GBDevice_info_t* pGBDeviceInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_tv_status_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_tv_status_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知解码器通道状态, 解码器通道ID=%s", callee_id);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify decoder channel status，decoder channel ID=%s", callee_id);

    /* 获取前端图像参数的命令直接转发给前段设备，不做处理

          命令包括如下字段:

      <?xml version="1.0"?>
      <Notify>
      <CmdType>TVStatus</ CmdType>
      <SN>1234</SN>
      <DecoderChannelID>解码器逻辑通道编码</DecoderChannelID>
      <Status></Status>        //  max  normal
      </Notify>
      */

    pGBLogicDeviceInfo = GBLogicDevice_info_find(callee_id);

    if (NULL != pGBLogicDeviceInfo)
    {
        pGBDeviceInfo = GBDevice_info_get_by_stream_type(pGBLogicDeviceInfo, EV9000_STREAM_TYPE_MASTER);

        if (NULL != pGBDeviceInfo)
        {
            i = SIP_SendMessage(NULL, local_cms_id_get(), callee_id, pGBDeviceInfo->strRegServerIP, pGBDeviceInfo->iRegServerPort, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port, (char*)inPacket.GetXml(NULL).c_str(), inPacket.GetXml(NULL).length());

            if (i != 0)
            {

                SystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通知电视墙状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"转发消息到前端物理设备失败", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User notify TV wall status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s, Front-end physical device ID=%s, IP=%s, Port=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, (char*)"Forwarding message to front-end physical device failed", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() SIP_SendMessage Error:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
            else
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通知电视墙状态成功,转发消息到前端物理设备:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端物理设备ID=%s, IP=%s, 端口=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User notification state TV wall, forwarding messages to the front end physical device: user ID = % s, = % s IP address, port number = % d, logical device ID = % s, front end physical device ID = % s, IP = % s, port = % d", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_connect_tv_proc() SIP_SendMessage OK:device_id=%s, device_ip=%s, device_port=%d \r\n", pGBDeviceInfo->device_id, pGBDeviceInfo->login_ip, pGBDeviceInfo->login_port);
            }
        }
        else
        {
            SystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通知电视墙状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的物理设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            EnSystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User notify TV wall status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding physical device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_connect_tv_proc() exit---: Get LogicDevice's GBDevice Info Error: DeviceID=%s \r\n", callee_id);
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通知电视墙状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=没有找到对应的逻辑设备信息:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
        EnSystemLog(EV9000_CMS_NOTIFY_DEC_STATUS_ERROR, EV9000_LOG_LEVEL_ERROR, "User notify TV wall status failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=Not find the corresponding logic device information:DeviceID=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, callee_id, callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_tv_status_proc() exit---: Find GBDevice Info Error: DeviceID=%s \r\n", callee_id);
        return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_notify_send_notify_proc
 功能描述  : 高级别用户发送通知消息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年10月21日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_send_notify_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int iRet = 0;
    char strSN[32] = {0};
    char strMessage[512] = {0};
    char strSumNum[16] = {0};
    string strNotifyUserListNum = "";
    int iSumNum = 0;
    int iNotifyUserListNum = 0;
    int iItemNumCount = 0;

    char strUserIndex[64] = {0};
    char strLoginIP[64] = {0};
    char strPort[64] = {0};
    string strSQL = "";
    int record_count = 0;
    string strUserName = "";
    string strRealName = "";
    string strTel = "";
    string strResved2 = "";

    unsigned int uUserIndex = 0;
    user_info_t* pSendUserInfo = NULL;

    CPacket outPacket;
    DOMElement* AccNode = NULL;
    DOMElement* ItemAccNode = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_send_notify_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_send_notify_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 高级别用户发送通知命令

          命令包括如下字段:
         <?xml version="1.0" encoding="UTF-8"?>
         <request>
            <cmdtype>SendNotify </cmdtype>
            < SN >xxxxxxxx-xxxx-xxxx-xxxxxx-xxxxxxxxxx</ SN >
            <message>happy </message>
            < SumNum >2</ SumNum >
            < NotifyUserList Num = "2">
            <Item>
                <!--用户的INDEX-->
                <id>1</ id >
                <!--用户登录IP-->
                <ipaddress>192.168.1.120</ipaddress>
                <!--用户登录端口-->
                <port>9087</port>
            </ Item >
            < Item >
                <id>2</id>
                <ipaddress>192.168.1.121</ipaddress>
                <port>9080</port>
            </ Item >
         </ request >

     */
    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户发送通知消息");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User send notification message");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送的服务器的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Sending server's ID is not local CMS ID.", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_send_notify_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"Message", strMessage);
    inPacket.GetElementValue((char*)"SumNum", strSumNum);
    inPacket.GetElementAttr((char*)"NotifyUserList", (char*)"Num", strNotifyUserListNum);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_notify_send_notify_proc() \
        \r\n XML Para: \
        \r\n SN=%s, Message=%s, SumNum=%s, NotifyUserList Num=%s \r\n", strSN, strMessage, strSumNum, (char*)strNotifyUserListNum.c_str());

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户发送通知消息, 消息内容=%s", strMessage);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User send notification, message content=%s", strMessage);

    if (strSumNum[0] == '\0')
    {
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知消息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"获取XML中携带的分组信息总数失败");
        EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to get total grouping information from XML.");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "user_notify_send_notify_proc() exit---: Get Sun Num Error \r\n");
        return -1;
    }

    /* 查询数据库，获取用户信息 */
    memset(strUserIndex, 0, 64);
    snprintf(strUserIndex, 64 , "%u", pUserInfo->user_index);

    strSQL.clear();
    strSQL = "select * from UserConfig WHERE ID = ";
    strSQL += strUserIndex;

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    if (record_count < 0)
    {
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知消息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"查询数据库失败失败");
        EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to query the database");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_send_notify_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_send_notify_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知消息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:用户索引=%u", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"未查到数据库中的用户信息", pUserInfo->user_index);
        EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s:User index=%u", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Not found user information from the database .", pUserInfo->user_index);
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_send_notify_proc() exit---: No Record Count \r\n");
        return -1;
    }

    /* 用户名 */
    strUserName.clear();
    pUser_Srv_dboper->GetFieldValue("UserName", strUserName);

    /* 真实名 */
    strRealName.clear();
    pUser_Srv_dboper->GetFieldValue("RealName", strRealName);

    /* 联系方式 */
    strTel.clear();
    pUser_Srv_dboper->GetFieldValue("Tel", strTel);

    /* 备注2 */
    strResved2.clear();
    pUser_Srv_dboper->GetFieldValue("Resved2", strResved2);

    /* 通知客户端, 组建消息 */
    outPacket.SetRootTag("Notify");
    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"SendNotify");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    outPacket.SetElementValue(AccNode, strUserIndex);

    AccNode = outPacket.CreateElement((char*)"UserName");
    outPacket.SetElementValue(AccNode, (char*)strUserName.c_str());

    AccNode = outPacket.CreateElement((char*)"RealName");
    outPacket.SetElementValue(AccNode, (char*)strRealName.c_str());

    AccNode = outPacket.CreateElement((char*)"Tel");
    outPacket.SetElementValue(AccNode, (char*)strTel.c_str());

    AccNode = outPacket.CreateElement((char*)"Resved2");
    outPacket.SetElementValue(AccNode, (char*)strResved2.c_str());

    AccNode = outPacket.CreateElement((char*)"LoginIP");
    outPacket.SetElementValue(AccNode, pUserInfo->login_ip);

    AccNode = outPacket.CreateElement((char*)"Port");
    snprintf(strPort, 16 , "%d", pUserInfo->login_port);
    outPacket.SetElementValue(AccNode, strPort);

    AccNode = outPacket.CreateElement((char*)"Message");
    outPacket.SetElementValue(AccNode, strMessage);

    iSumNum = osip_atoi(strSumNum);
    iNotifyUserListNum = osip_atoi((char*)strNotifyUserListNum.c_str());
    DEBUG_TRACE(MODULE_USER, LOG_TRACE,  "user_notify_send_notify_proc() SumNum=%d, NotifyUserListNum=%d \r\n", iSumNum, iNotifyUserListNum);

    if (iSumNum > 0)
    {
        if (iNotifyUserListNum <= 0)
        {
            SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知消息失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"XML中携带的分组信息数目不正确");
            EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"The grouping information carried in XML is incorrect");
            DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "user_notify_send_notify_proc() exit---: NotifyUserListNum Error \r\n");
            return -1;
        }

        /* 获取所有的Item 数据 */
        ItemAccNode = inPacket.SearchElement((char*)"Item");

        if (!ItemAccNode)
        {
            SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户发送通知失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"获取XML中的Item条目信息失败");
            EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User send notification failed:User ID=%s, User IP=%s, Port=%d, reason=%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Failed to get Item number information from XML");
            DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "user_notify_send_notify_proc() exit---: Get Item Node Error \r\n");
            return -1;
        }

        /* 循环读取数据，发送消息通知给用户端 */
        inPacket.SetCurrentElement(ItemAccNode);

        while (ItemAccNode)
        {
            iItemNumCount++;

            if (iItemNumCount > iNotifyUserListNum)
            {
                break;
            }

            /* 用户索引 */
            memset(strUserIndex, 0, 64);
            inPacket.GetElementValue((char*)"ID", strUserIndex);

            if (strUserIndex[0] == '\0')
            {
                ItemAccNode = inPacket.SearchNextElement(true);
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_send_notify_proc() Get UserIndex Error\r\n");
                continue;
            }

            /* 登录IP */
            memset(strLoginIP, 0, 64);
            inPacket.GetElementValue((char*)"LoginIP", strLoginIP);

            if (strLoginIP[0] == '\0')
            {
                ItemAccNode = inPacket.SearchNextElement(true);
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_send_notify_proc() Get LoginIP Error\r\n");
                continue;
            }

            /* 端口号 */
            memset(strPort, 0, 64);
            inPacket.GetElementValue((char*)"Port", strPort);

            if (strPort[0] == '\0')
            {
                ItemAccNode = inPacket.SearchNextElement(true);
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_send_notify_proc() Get LoginPort Error\r\n");
                continue;
            }

            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户发送通知消息消息:用户索引=%s, 登录IP地址=%s, 端口号=%s", strUserIndex, strLoginIP, strPort);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users send notification messages: index = % s, login = % s IP address, port number = %s", strUserIndex, strLoginIP, strPort);

            uUserIndex = strtoul(strUserIndex, NULL, 10);

            pSendUserInfo = user_info_get_by_user_index_and_ip(uUserIndex, strLoginIP, osip_atoi(strPort));

            if (NULL != pSendUserInfo)
            {
                /* 发送通知消息给指定用户 */
                iRet |= SIP_SendMessage(NULL, local_cms_id_get(), pSendUserInfo->user_id, pSendUserInfo->strRegServerIP, pSendUserInfo->iRegServerPort, pSendUserInfo->login_ip, pSendUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

                if (iRet != 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_send_notify_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", pSendUserInfo->user_id, pSendUserInfo->login_ip, pSendUserInfo->login_port);
                }
                else
                {
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_notify_send_notify_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", pSendUserInfo->user_id, pSendUserInfo->login_ip, pSendUserInfo->login_port);
                }
            }
            else
            {
                DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_notify_send_notify_proc() user_info_get_by_user_index Error:UserIndex=%u, LoginIP=%s, strPort=%s \r\n", uUserIndex, strLoginIP, strPort);
            }

            ItemAccNode = inPacket.SearchNextElement(true);
        }
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户发送通知消息成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "Users to send notification message success: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_switch_alarm_proc
 功能描述  : 用户通知切换告警消息发送状态
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年11月11日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_switch_alarm_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    char strSN[32] = {0};
    char strStatus[16] = {0};

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_switch_alarm_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_switch_alarm_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户切换发送告警信息状态");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User switch alarm status");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户切换发送告警信息状态失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送的服务器的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User switch alarm status failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Sending server's ID is not local CMS ID.", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_switch_alarm_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"Status", strStatus);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户切换发送告警信息状态, 状态=%s", strStatus);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User switch alarm status, status=%s", strStatus);

    if (strStatus[0] != '\0')
    {
        if (0 == sstrcmp(strStatus, (char*)"OFF"))
        {
            pUserInfo->alarm_info_send_flag = 0;
        }
        else
        {
            pUserInfo->alarm_info_send_flag = 1;
        }
    }
    else
    {
        pUserInfo->alarm_info_send_flag = 0;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户切换发送告警信息状态成功:用户ID=%s, IP地址=%s, 端口号=%d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Users switch to send the alarm information state success: user ID = % s, = % s IP address, port number = %d", caller_id, pUserInfo->login_ip, pUserInfo->login_port);

    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_shdb_cmd_proc
 功能描述  : 用户发送上海地标命令处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年3月14日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_shdb_cmd_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int iRet = 0;
    char strSubType[16] = {0};
    int iSubType = 0;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_shdb_cmd_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_notify_shdb_cmd_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知上海地标监管平台命令发送操作");
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify Shanghai command ");

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通知上海地标命令失败:用户ID=%s, IP地址=%s, 端口号=%d, 原因=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"发送的服务器的ID不是本CMS的ID", callee_id);
        EnSystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "User notify Shanghai local standard command failed:User ID=%s, User IP=%s, Port=%d, reason=%s:%s", caller_id, pUserInfo->login_ip, pUserInfo->login_port, (char*)"Sending server's ID is not local CMS ID.", callee_id);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_notify_shdb_cmd_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SubType", strSubType);

    UserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "用户通知上海地标监管平台命令发送操作, 子命令类型=%s", strSubType);
    EnUserLog(EV9000_CMS_USER_OPERATION_INFO, EV9000_LOG_LEVEL_NORMAL, pUserInfo, "User notify Shanghai local standard supervisory platform send command, The child command type =%s", strSubType);

    iSubType = osip_atoi(strSubType);

    //iRet = shdb_user_notify_cmd_proc(pUserInfo, iSubType, inPacket, pUser_Srv_dboper);

    return iRet;
}

/*****************************************************************************
 函 数 名  : user_device_control_response_proc
 功能描述  : 用户设备控制响应处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_device_control_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 设备控制的响应消息
          控制流程见9.3.2
          该命令由前端设备发出，用户端暂时没有此类消息处理

          命令包括如下字段:
          <!-- 命令类型：设备控制（必选） -->
          <element name="CmdType" fixed ="DeviceControl" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 执行结果标志（必选） -->
          <element name="Result" type="tg:resultType" />
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_notify_alarm_response_proc
 功能描述  : 用户告警信息响应处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_notify_alarm_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 报警响应消息暂时不需要处理

        命令包括如下字段:
        <!-- 命令类型：报警通知（必选） -->
        <element name="CmdType" fixed ="Alarm" />
        <!-- 命令序列号（必选） -->
        <element name="SN" type="integer" minInclusive value = "1" />
        <!-- 目标设备编码（必选） -->
        <element name="DeviceID" type="tg:deviceIDType" />
        <!-- 执行结果标志（必选） -->
        <element name="Result" type="tg:resultType" />
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_query_catalog_response_proc
 功能描述  : 用户目录查询响应消息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月21日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_query_catalog_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 网络设备信息查询响应消息
          控制流程见9.5.2
          该命令由前端设备发出，用户端暂时没有此类消息处理

          命令包括如下字段:
          <!-- 命令类型：设备目录查询（必选） -->
          <element name="CmdType" fixed ="Catalog" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 设备目录项列表,num表示目录项个数 -->
          <element name="DeviceList">
          <attribute name="Num" type="integer"/>
          <choice minOccurs= "0" maxOccurs= " unbounded " >
          <element name="Item" type="tg:itemType"/>
          </choice>
          </element>
          <!-- 扩展信息，可多项 -->
          <element name= "Info" minOccurs= "0" maxOccurs="unbounded">
          <restriction base= "string">
          <maxLength value= "1024" />
          </restriction>
          </element>
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_device_info_response_proc
 功能描述  : 用户设备设备信息查询响应处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_device_info_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 网络设备信息查询响应消息
          控制流程见9.5.2
          该命令由前端设备发出，用户端暂时没有此类消息处理

          命令包括如下字段:
          <!-- 命令类型：设备信息查询（必选） -->
          <element name="CmdType" fixed ="DeviceInfo" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 查询结果（必选） -->
          <element name="Result" type="tg:resultType" />
          <!-- 设备生产商（可选） -->
          <element name ="Manufacturer" type="normalizedString" minOccurs= "0"/ >
          <!-- 设备型号（可选） -->
          <element name ="Model" type="string" minOccurs= "0"/>
          <!-- 设备固件版本（可选） -->
          <element name ="Firmware" type="string" minOccurs= "0"/>
          <!-- 视频输入通道数（可选） -->
          <element name ="Channel" type="integer" minInclusive value = "0" minOccurs= "0"/ >
          <!-- 扩展信息，可多项 -->
          <element name= "Info" minOccurs= "0" maxOccurs="unbounded">
          <restriction base= "string">
          <maxLength value= "1024" />
          </restriction>
          </element>
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_device_status_response_proc
 功能描述  : 用户设备状态查询响应处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_device_status_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 网络设备信息查询响应命令
          控制流程见9.5.2
          该命令由前端设备发出，用户端暂时没有此类消息处理

          命令包括如下字段:
          <!-- 命令类型：设备状态查询（必选） -->
          <element name="CmdType" fixed ="DeviceStatus" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 目标设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 查询结果标志（必选） -->
          <element name="Result" type="tg:resultType" />
          <!-- 是否在线（必选） -->
          <element name="Online" >
          <restriction base= "string">
          <enumeration value= "ONLINE" />
          <enumeration value= "OFFLINE" />
          </restriction>
          </element>
          <!-- 是否正常工作（必选） -->
          <element name="Status" type="tg:relultType" />
          <!-- 不正常工作原因（可选） -->
          <element name="Reason" type="string" minOccurs= "0"/>
          <!-- 是否编码（可选） -->
          <element name="Encode" type="tg:statusType" minOccurs= "0"/>
          <!-- 是否录像（可选） -->
          <element name="Record" type=" tg:statusType" minOccurs= "0"/>
          <!-- 设备时间和日期（可选） -->
          <element name ="DeviceTime" type="dateTime" minOccurs= "0"/>
          <!-- 报警设备状态列表,num表示列表项个数（可选） -->
          <element name="Alarmstatus" minOccurs="0">
          <attribute name="Num" type="integer"/>
          <element name="Item" minOccurs="0" maxOccurs=" unbounded ">
          <simpleType>
          <sequence>
          <!-- 报警设备编码（必选） -->
          <element name="DeviceID" type=" tg:deviceIDType " minOccurs= "0"/>
          <!-- 报警设备状态（必选） -->
          <element name="Status" minOccurs= "0">
          <restriction base="string">
          <enumeration value="ONDUTY"/>
          <enumeration value="OFFDUTY"/>
          <enumeration value="ALARM"/>
          </restriction>
          </element>
          </sequence>
          </simpleType>
          </element>
          </element>
          <!-- 扩展信息，可多项 -->
          <element name= "Info" minOccurs= "0" maxOccurs="unbounded">
          <restriction base= "string">
          <maxLength value= "1024" />
          </restriction>
          </element>
      */

    return 0;
}

/*****************************************************************************
 函 数 名  : user_record_info_response_proc
 功能描述  : 用户录像信息查询响应处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月13日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_record_info_response_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    /* 设备视音频文件检索
          控制流程见9.7.2
          服务端直接回复检索到的数据，这里不需要处理
      */
    return 0;
}

/*****************************************************************************
 函 数 名  : user_get_system_info_proc
 功能描述  : 用户获取系统配置数据
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年6月3日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_get_system_info_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strKeyName[32] = {0};

    string strQuerySQL = "";
    string strKeyValue = "";

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_system_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id || NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_system_info_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 如果不是获取本CMS，则返回 */
    if (0 != strncmp(callee_id, local_cms_id_get(), 20))
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() exit---: Device ID Not Belong To Mine CMSID:callee_id=%s \r\n", callee_id);
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"KeyName", strKeyName);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_get_system_info_proc() \
            \r\n XML Para: \
            \r\n SN=%s, KeyName=%s\r\n", strSN, strKeyName);

    /* 将数据写入数据库 */
    /* 1、查询SQL语句 */
    strQuerySQL.clear();
    strQuerySQL = "select * from SystemConfig WHERE KeyName like '";
    strQuerySQL += strKeyName;
    strQuerySQL += "'";

    /* 查询数据库 */
    record_count = pUser_Srv_dboper->DB_Select(strQuerySQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_get_system_info_proc() DB Select:strSQL=%s,record_count=%d \r\n", strQuerySQL.c_str(), record_count);

    if (record_count < 0)
    {
        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetSystemInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"KeyName");
        outPacket.SetElementValue(AccNode, strKeyName);

        AccNode = outPacket.CreateElement((char*)"KeyValue");
        outPacket.SetElementValue(AccNode, (char*)" ");

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_system_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() DB Oper Error:strQuerySQL=%s, record_count=%d \r\n", strQuerySQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count > 0) /* 已经存在 */
    {
        pUser_Srv_dboper->GetFieldValue("KeyValue", strKeyValue);

        /* 回复响应,组建消息 */
        CPacket outPacket;
        DOMElement* AccNode = NULL;

        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetSystemInfo");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"KeyName");
        outPacket.SetElementValue(AccNode, strKeyName);

        AccNode = outPacket.CreateElement((char*)"KeyValue");

        if (strKeyValue.empty())
        {
            outPacket.SetElementValue(AccNode, (char*)" ");
        }
        else
        {
            outPacket.SetElementValue(AccNode, (char*)strKeyValue.c_str());
        }

        i = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_system_info_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_system_info_proc() exit---: Poll Config Record Already Exist \r\n");
        return 0;
    }

    return -1;
}

/*****************************************************************************
 函 数 名  : user_answer_invite_for_playback_proc
 功能描述  : 客户端历史视频查看处理
 输入参数  : cr_t* pCrData
             int record_type
             int start_time
             int end_time
             int play_time
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月23日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_answer_invite_for_playback_proc(cr_t* pCrData, int record_type, int start_time, int end_time, int play_time)
{
    int i = -1;
    int tsu_index = -1;
    int iRecordCRPos = -1;
    char* tsu_ip = NULL;
    sdp_message_t* pLocalSDP = NULL;
    sdp_param_t sdp_param;
    int send_port = 0;
    cr_t* pRecordCrData = NULL;
    tsu_resource_info_t* pTsuResourceInfo = NULL;
    char* sdp_tsu_ip = NULL;

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_answer_invite_for_playback_proc() exit---: Param Error \r\n");
        return EV9000_CMS_ERR_INVITE_GET_CR_DATA_ERROR;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 历史视频查看或下载处理", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, history video view or download", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

    /* 获取空闲的TSU资源 */
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_answer_invite_for_playback_proc() get_idle_tsu_by_resource_balance_for_replay: Begin--- \r\n");
    tsu_index = get_idle_tsu_by_resource_balance_for_replay();
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_answer_invite_for_playback_proc() get_idle_tsu_by_resource_balance_for_replay: End--- tsu_index=%d \r\n", tsu_index);

    if (tsu_index < 0)
    {
        if (-2 == tsu_index)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源队列为空");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }
        else if (-3 == tsu_index)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源信息错误");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }
        else if (-4 == tsu_index)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源都没有启用");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }
        else if (-5 == tsu_index)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源都不在线");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }
        else if (-9 == tsu_index)
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,通过ICE获取所有的TSU资源状态失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }
        else
        {
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
        }

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Get Idle TSU Index Error \r\n");
        return EV9000_CMS_ERR_TSU_GET_IDLE_TSU_INDEX_ERROR;
    }

    pTsuResourceInfo = tsu_resource_info_get(tsu_index);

    if (NULL == pTsuResourceInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Get TSU Resource Info Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_index=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取录像回放的TSU资源失败", tsu_index);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get free TSU resource failed");
        return EV9000_CMS_ERR_TSU_GET_TSU_INFO_ERROR;
    }

    /* 获取和TSU通信的IP地址 */
    tsu_ip = get_tsu_ip(pTsuResourceInfo, default_eth_name_get());

    if (NULL == tsu_ip)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Get TSU IP Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU IP地址失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address failed");
        return EV9000_CMS_ERR_TSU_GET_IP_ERROR;
    }

    /* 获取TSU 发送端口号 */
    send_port = get_send_port_by_tsu_resource(tsu_ip);

    if (send_port <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", tsu_ip);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", tsu_ip);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU send port failed", tsu_ip);
        return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
    }

    pCrData->callee_transfer_type = pCrData->caller_transfer_type; /* 传输方式赋值 */

    /* 添加TSU的信息到呼叫资源信息 */
    osip_strncpy(pCrData->tsu_device_id, pTsuResourceInfo->tsu_device_id, MAX_ID_LEN);
    pCrData->tsu_resource_index = tsu_index;
    pCrData->tsu_send_port = send_port;
    osip_strncpy(pCrData->tsu_ip, tsu_ip, MAX_IP_LEN);

    i = TSUResourceIPAddrListClone(pTsuResourceInfo->pTSUIPAddrList, pCrData);

    if (i != 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: TSU IP Addr List Clone Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"添加本地TSU IP地址失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Add local TSU IP address failed");
        return EV9000_CMS_ERR_TSU_IP_CLONE_ERROR;
    }

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_device_id=%s \r\n", pCrData->tsu_device_id);
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_ip=%s \r\n", pCrData->tsu_ip);
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_device_ip=%s \r\n", pCrData->tsu_device_ip);
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_code=%d \r\n", pCrData->tsu_code);
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_port=%d \r\n", pCrData->tsu_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 查找该点位的录像任务，通知TSU更新结束时间 */
    iRecordCRPos = record_call_record_find_by_calleeid_and_streamtype(pCrData->callee_id, pCrData->callee_stream_type);
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_answer_invite_for_playback_proc():record_call_record_find_by_calleeid_and_streamtype:callee_id=%s, callee_stream_type=%d, RecordCRPos=%d\r\n", pCrData->callee_id, pCrData->callee_stream_type, iRecordCRPos);

    if (iRecordCRPos >= 0)
    {
        pRecordCrData = call_record_get(iRecordCRPos);

        if (NULL != pRecordCrData)
        {
            i = notify_tsu_update_mysql_record_stoptime(pRecordCrData->tsu_ip, pRecordCrData->task_id);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_answer_invite_for_playback_proc():notify_tsu_update_mysql_record_stoptime:tsu_ip=%s, task_id=%s, i=%d \r\n", pRecordCrData->tsu_ip, pRecordCrData->task_id, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: call_record_get Error: RecordCRPos=%d \r\n", iRecordCRPos);
        }
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: record_call_record_find_by_calleeid_and_streamtype Error: callee_id=%s, callee_stream_type=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type);
    }

    /* 通知TSU 添加回放任务，同时获取到时间段的文件编码类型*/
    i = notify_tsu_add_replay_task(pCrData, 1, record_type, start_time, end_time, play_time);

    if (i < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: notify_tsu_add_replay_task Error: TSU IP=%s, i=%d \r\n", pCrData->tsu_ip, i);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"通知TSU的添加回放任务失败", pCrData->tsu_ip, i);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, TSU IP=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Notify TSU add playback task failed.", pCrData->tsu_ip, i);
        return EV9000_CMS_ERR_TSU_NOTIFY_ADD_REPLAY_ERROR;
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "历史视频回放请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 通知TSU的添加回放任务成功, TSU IP=%s, task_id=%s, iRet=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "History video playback request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, notify the TSU add playback mission success, TSU IP = % s, task_id = % s, iRet =%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->tsu_ip, pCrData->task_id, i);
    }

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_answer_invite_for_playback_proc() pCrData->tsu_code=%d \r\n", pCrData->tsu_code);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 媒体协商，生成本地SDP信息 */
    memset(&sdp_param, 0, sizeof(sdp_param_t));
    osip_strncpy(sdp_param.o_username, local_cms_id_get(), 32);
    osip_strncpy(sdp_param.s_name, (char*)"Playback", 32);

    sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->caller_server_ip_ethname);

    if (NULL == sdp_tsu_ip)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Get Caller TSU SDP IP Error:caller_server_ip_ethname=%s \r\n", pCrData->caller_server_ip_ethname);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, caller_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取主叫侧的SDP消息中的TSU的IP地址失败", pCrData->caller_server_ip_ethname);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, caller_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address  from calling side SIP message failed.", pCrData->caller_server_ip_ethname);
        return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
    }

    osip_strncpy(sdp_param.sdp_ip, sdp_tsu_ip, MAX_IP_LEN);
    sdp_param.video_port = pCrData->tsu_send_port;
    sdp_param.video_code_type = pCrData->tsu_code;
    sdp_param.media_direction = MEDIA_DIRECTION_TYPE_SENDONLY;
    sdp_param.start_time = start_time;
    sdp_param.end_time = end_time;
    sdp_param.play_time = play_time;

    /* 传输方式赋值 */
    if (TRANSFER_PROTOCOL_TCP == pCrData->caller_transfer_type)
    {
        sdp_param.trans_type = 2;
    }
    else
    {
        sdp_param.trans_type = 1;
    }

    i = SIP_GeneratingSDPAnswerEx(pCrData->caller_ua_index, &pLocalSDP, &sdp_param, NULL);

    if ((i != 0) || (NULL == pLocalSDP))
    {
        i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_answer_invite_for_playback_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_answer_invite_for_playback_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
        }

        sdp_message_free(pLocalSDP);
        pLocalSDP = NULL;

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Not Support Media:tsu_code=%d \r\n", pCrData->tsu_code);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"生成SDP应答消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)" Create reply SDP message failed.");
        return EV9000_CMS_ERR_SDP_GENERAL_MSG_ERROR;
    }

    /* 回应200 ok消息给主叫侧*/
    i = SIP_AcceptInvite(pCrData->caller_ua_index, pLocalSDP);

    if (i != 0)
    {
        sdp_message_free(pLocalSDP);
        pLocalSDP = NULL;

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: Accept Invite Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"接收INVITE消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Receive INVITE message failed");
        return EV9000_CMS_ERR_INVITE_ACCEPT_ERROR;
    }

    /* 通知TSU开始发送录像文件码流 */
    i = notify_tsu_start_replay(pCrData->tsu_ip, pCrData->task_id);

    if (i != 0)
    {
        i = SIP_SendBye(pCrData->caller_ua_index);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_answer_invite_for_playback_proc() SIP_SendBye To Caller:caller_ua_index=%d, i=%d \r\n", pCrData->caller_ua_index, i);

        i = notify_tsu_delete_replay_task(pCrData->tsu_ip, pCrData->task_id);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_answer_invite_for_playback_proc() notify_tsu_delete_replay_task Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_answer_invite_for_playback_proc() notify_tsu_delete_replay_task OK:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
        }

        sdp_message_free(pLocalSDP);
        pLocalSDP = NULL;

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_playback_proc() exit---: notify_tsu_start_replay Error:tsu_ip=%s, task_id=%s, i=%d \r\n", pCrData->tsu_ip, pCrData->task_id, i);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "历史视频回放请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"通知TSU开始发送录像文件码流失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Historical video playback request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Notify TSU to start send stream of video file failed.");
        return EV9000_CMS_ERR_TSU_NOTIFY_START_REPLAY_ERROR;
    }

    sdp_message_free(pLocalSDP);
    pLocalSDP = NULL;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理成功:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Historical video playback request processing successfully:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_answer_invite_for_realplay_proc
 功能描述  : 客户端实时视频查看被叫端是本级CMS并且有录像业务时候的处理
 输入参数  : cr_t* pCurrentCrData
             cr_t* pCalleeCrData
             int service_type
             int stream_type
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年5月23日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_answer_invite_for_realplay_proc(cr_t* pCurrentCrData, cr_t* pCalleeCrData, int service_type, int stream_type)
{
    int i = -1;
    int send_port = 0;
    sdp_message_t* pLocalSDP = NULL;
    sdp_param_t sdp_param;
    char* sdp_tsu_ip = NULL;

    if (NULL == pCurrentCrData || NULL == pCalleeCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_answer_invite_for_realplay_proc() exit---: Param Error \r\n");
        return EV9000_CMS_ERR_INVITE_GET_CR_DATA_ERROR;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端已有视频流业务处理", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, front-end for video business processing", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id);

    /* 添加被叫端信息到业务记录*/
    osip_strncpy(pCurrentCrData->callee_sdp_ip, pCalleeCrData->callee_sdp_ip, MAX_IP_LEN);
    pCurrentCrData->callee_sdp_port = pCalleeCrData->callee_sdp_port;
    pCurrentCrData->callee_transfer_type = pCalleeCrData->callee_transfer_type; /* 重新赋值 */

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_invite_response_msg_proc() pCurrentCrData->callee_sdp_ip=%s \r\n", pCurrentCrData->callee_sdp_ip);
    printf(" user_invite_response_msg_proc() pCurrentCrData->callee_sdp_port=%d \r\n", pCurrentCrData->callee_sdp_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 添加TSU 信息到业务记录*/
    osip_strncpy(pCurrentCrData->tsu_device_id, pCalleeCrData->tsu_device_id, MAX_ID_LEN);
    pCurrentCrData->tsu_resource_index = pCalleeCrData->tsu_resource_index;
    osip_strncpy(pCurrentCrData->tsu_ip, pCalleeCrData->tsu_ip, MAX_IP_LEN);

    memcpy(&pCurrentCrData->TSUVideoIP, &pCalleeCrData->TSUVideoIP, sizeof(ip_pair_t));
    memcpy(&pCurrentCrData->TSUDeviceIP, &pCalleeCrData->TSUDeviceIP, sizeof(ip_pair_t));

    pCurrentCrData->tsu_code = pCalleeCrData->tsu_code;
    pCurrentCrData->tsu_recv_port = pCalleeCrData->tsu_recv_port;

    //发送端口号从新获取
    if (TRANSFER_PROTOCOL_TCP == pCurrentCrData->caller_transfer_type) /* TCP的情况下，直接调用TSU转发接口，返回值是TSU的发送端口号 */
    {
        /* 通知TSU开始转发码流*/
        i = notify_tsu_add_transfer_task(pCurrentCrData, service_type, stream_type);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: notify_tsu_add_transfer_task Error: TSU IP=%s, i=%d \r\n", pCurrentCrData->tsu_ip, i);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"通知TSU开始发转发码流失败", pCurrentCrData->tsu_ip, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Copy TSU IP failed");
            return EV9000_CMS_ERR_TSU_NOTIFY_ADD_TRANSFER_ERROR;
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 通知TSU添加转发任务成功, TSU IP=%s, task_id=%s, iRet=%d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, pCurrentCrData->tsu_ip, pCurrentCrData->task_id, i);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, notify the TSU add forward mission success, TSU IP = % s, task_id = % s, iRet = %d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, pCurrentCrData->tsu_ip, pCurrentCrData->task_id, i);
        }

        send_port = i;

        if (send_port <= 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCalleeCrData->tsu_ip);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCalleeCrData->tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Get TSU send port failed", pCalleeCrData->tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
        }

        DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_answer_invite_for_realplay_proc() tsu_send_port=%d \r\n", send_port);

        pCurrentCrData->tsu_send_port = send_port;
    }
    else
    {
        send_port = get_send_port_by_tsu_resource(pCalleeCrData->tsu_ip);

        if (send_port <= 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: Get TSU Send Port Error:tsu_ip=%s \r\n", pCalleeCrData->tsu_ip);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"获取TSU的发送端口号失败", pCalleeCrData->tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Get TSU send port failed", pCalleeCrData->tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
        }

        pCurrentCrData->tsu_send_port = send_port;

        /* 通知TSU开始转发码流*/
        i = notify_tsu_add_transfer_task(pCurrentCrData, service_type, stream_type);

        if (i < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: notify_tsu_add_transfer_task Error: TSU IP=%s, i=%d \r\n", pCurrentCrData->tsu_ip, i);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, TSU IP=%s, iRet=%d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"通知TSU开始发转发码流失败", pCurrentCrData->tsu_ip, i);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, TSU IP=%s, iRet=%d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Notify TSU to start to forwarded stream failed", pCurrentCrData->tsu_ip, i);
            return EV9000_CMS_ERR_TSU_NOTIFY_ADD_TRANSFER_ERROR;
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 通知TSU添加转发任务成功, TSU IP=%s, task_id=%s, iRet=%d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, pCurrentCrData->tsu_ip, pCurrentCrData->task_id, i);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, notify the TSU add forward mission success, TSU IP = % s, task_id = % s, iRet = %d", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, pCurrentCrData->tsu_ip, pCurrentCrData->task_id, i);
        }
    }

    if (0 == pCurrentCrData->tsu_code)
    {
        pCurrentCrData->tsu_code = EV9000_STREAMDATA_TYPE_PS; /* 设置一个默认的 */
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_answer_invite_for_realplay_proc() Caller TSU Code Error:tsu_code=%d \r\n", pCurrentCrData->tsu_code);
    }

#if 0
    printf("\r\n\r\n ************************************************* \r\n");
    printf(" user_answer_invite_for_realplay_proc() pCrData->tsu_device_id=%s \r\n", pCurrentCrData->tsu_device_id);
    printf(" user_answer_invite_for_realplay_proc() pCrData->tsu_ip=%s \r\n", pCurrentCrData->tsu_ip);
    printf(" user_answer_invite_for_realplay_proc() pCrData->tsu_device_ip=%s \r\n", pCurrentCrData->tsu_device_ip);
    printf(" user_answer_invite_for_realplay_proc() pCrData->tsu_code=%d \r\n", pCurrentCrData->tsu_code);
    printf(" user_answer_invite_for_realplay_proc() pCrData->tsu_port=%d \r\n", pCurrentCrData->tsu_port);
    printf(" ************************************************* \r\n\r\n ");
#endif

    /* 组建本地SDP信息*/
    memset(&sdp_param, 0, sizeof(sdp_param_t));
    osip_strncpy(sdp_param.o_username, local_cms_id_get(), 32);
    osip_strncpy(sdp_param.s_name, (char*)"Play", 32);

    sdp_tsu_ip = get_cr_sdp_tsu_ip(pCurrentCrData, pCurrentCrData->caller_server_ip_ethname);

    if (NULL == sdp_tsu_ip)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: Get Caller TSU SDP IP Error:caller_server_ip_ethname=%s \r\n", pCurrentCrData->caller_server_ip_ethname);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, caller_server_ip_ethname=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"获取主叫侧的SDP消息中的TSU的IP地址失败", pCurrentCrData->caller_server_ip_ethname);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, caller_server_ip_ethname=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Get TSU IP address  from the calling side SIP message failed", pCurrentCrData->caller_server_ip_ethname);
        return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
    }

    osip_strncpy(sdp_param.sdp_ip, sdp_tsu_ip, MAX_IP_LEN);
    sdp_param.video_port = pCurrentCrData->tsu_send_port;
    sdp_param.video_code_type = pCurrentCrData->tsu_code;
    sdp_param.media_direction = MEDIA_DIRECTION_TYPE_SENDONLY;

    /* 传输方式赋值 */
    if (TRANSFER_PROTOCOL_TCP == pCurrentCrData->callee_transfer_type)
    {
        sdp_param.trans_type = 2;
    }
    else
    {
        sdp_param.trans_type = 1;
    }

    i = SIP_GeneratingSDPAnswerEx(pCurrentCrData->caller_ua_index, &pLocalSDP, &sdp_param, NULL);

    if ((i != 0) || (NULL == pLocalSDP))
    {
        sdp_message_free(pLocalSDP);
        pLocalSDP = NULL;

        /* 通知TSU停止转发码流 */
        i = notify_tsu_delete_transfer_task(pCurrentCrData->tsu_ip, pCurrentCrData->task_id);

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: Not Support Media:tsu_code=%d \r\n", pCurrentCrData->tsu_code);
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"生成SDP应答消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Create reply SDP message failed");
        return EV9000_CMS_ERR_SDP_GENERAL_MSG_ERROR;
    }

    /* 回应200 ok消息给主叫侧*/
    i = SIP_AcceptInvite(pCurrentCrData->caller_ua_index, pLocalSDP);

    if (i != 0)
    {
        sdp_message_free(pLocalSDP);
        pLocalSDP = NULL;

        /* 通知TSU停止转发码流 */
        i = notify_tsu_delete_transfer_task(pCurrentCrData->tsu_ip, pCurrentCrData->task_id);

        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_answer_invite_for_realplay_proc() exit---: Accept Invite Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"接收INVITE消息失败");
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id, (char*)"Receive INVITE message failed");
        return EV9000_CMS_ERR_INVITE_ACCEPT_ERROR;
    }

    sdp_message_free(pLocalSDP);
    pLocalSDP = NULL;

    if (CALL_STATUS_WAIT_ANSWER == pCurrentCrData->call_status)
    {
        pCurrentCrData->call_status = CALL_STATUS_NULL;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理成功:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing success: the requester ID = % s, the requester = % s IP address, port number = % d, logical device ID =%s", pCurrentCrData->caller_id, pCurrentCrData->caller_ip, pCurrentCrData->caller_port, pCurrentCrData->callee_id);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_transfer_invite_to_dest_proc
 功能描述  : 转发INVITE到目的地
 输入参数  : cr_t* pCrData
             sdp_message_t* pClientSDP
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年5月23日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_transfer_invite_to_dest_proc(cr_t* pCrData, sdp_message_t* pClientSDP)
{
    int i = -1;
    int tsu_index = -1;
    char* tsu_ip = NULL;
    int callee_dialog_pos = -1;
    int receive_port = 0;
    tsu_resource_info_t* pTsuResourceInfo = NULL;
    char* sdp_tsu_ip = NULL;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发INVITE到前端处理", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, forward the INVITE to the front-end processing", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到下级CMS平台", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, stream without forward at the corresponding level, the forward message directly to the CMS platform at a lower level", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        /* 获取空闲的TSU资源 */
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_transfer_invite_to_dest_proc() get_idle_tsu_by_resource_balance_for_transfer: Begin--- \r\n");
        tsu_index = get_idle_tsu_by_resource_balance_for_transfer();
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_transfer_invite_to_dest_proc() get_idle_tsu_by_resource_balance_for_transfer: End--- tsu_index=%d \r\n", tsu_index);

        if (tsu_index < 0)
        {
            if (-2 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败,TSU资源队列为空");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-3 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败,TSU资源信息错误");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-4 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败,TSU资源都没有启用");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-5 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败,TSU资源都不在线");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-9 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败,通过ICE获取所有的TSU资源状态失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的转发TSU资源索引失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Get Idle TSU Index Error \r\n");
            return EV9000_CMS_ERR_TSU_GET_IDLE_TSU_INDEX_ERROR;
        }

        pTsuResourceInfo = tsu_resource_info_get(tsu_index);

        if (NULL == pTsuResourceInfo)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Get TSU Resource Info Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_index=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取转发TSU资源失败", tsu_index);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            return EV9000_CMS_ERR_TSU_GET_TSU_INFO_ERROR;
        }

        /* 获取和TSU通信的IP地址 */
        tsu_ip = get_tsu_ip(pTsuResourceInfo, default_eth_name_get());

        if (NULL == tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Get TSU IP Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address failed");
            return EV9000_CMS_ERR_TSU_GET_IP_ERROR;
        }

        /* 获取TSU 接收端口号 */
        receive_port = get_recv_port_by_tsu_resource(tsu_ip);

        if (receive_port <= 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Get TSU Recv Port Error:tsu_ip=%s \r\n", tsu_ip);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的接收端口号失败", tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU receiving port failed", tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_RECV_PORT_ERROR;
        }

        /* 添加TSU的信息到呼叫资源信息 */
        osip_strncpy(pCrData->tsu_device_id, pTsuResourceInfo->tsu_device_id, MAX_ID_LEN);
        pCrData->tsu_resource_index = tsu_index;
        pCrData->tsu_recv_port = receive_port;
        osip_strncpy(pCrData->tsu_ip, tsu_ip, MAX_IP_LEN);

        i = TSUResourceIPAddrListClone(pTsuResourceInfo->pTSUIPAddrList, pCrData);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: TSU IP Addr List Clone Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"添加本地TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Add local TSU IP address failed");
            return EV9000_CMS_ERR_TSU_IP_CLONE_ERROR;
        }

#if 0
        printf("\r\n\r\n ************************************************* \r\n");
        printf(" user_transfer_invite_to_dest_proc() pCrData->tsu_device_id=%s \r\n", pCrData->tsu_device_id);
        printf(" user_transfer_invite_to_dest_proc() pCrData->tsu_device_ip=%s \r\n", pCrData->tsu_device_ip);
        printf(" user_transfer_invite_to_dest_proc() pCrData->tsu_ip=%s \r\n", pCrData->tsu_ip);
        printf(" user_transfer_invite_to_dest_proc() pCrData->tsu_port=%d \r\n", pCrData->tsu_port);
        printf(" ************************************************* \r\n\r\n ");
#endif

        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->callee_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Get Callee TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->callee_server_ip_ethname);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取被叫侧的SDP消息中的TSU的IP地址失败", pCrData->callee_server_ip_ethname);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address from the called side SIP message failed.");
            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改客户端SDP 中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pClientSDP, sdp_tsu_ip, pCrData->tsu_recv_port);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Modify SDP IP And Addr Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息中的IP和端口号失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify the IP and port of the SDP information failed.");
            return EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR;
        }

        /* 修改SDP中的协议传输类型 */
        if (pCrData->caller_transfer_type != pCrData->callee_transfer_type)
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->callee_transfer_type)
            {
                i = ModifySDPTransProtocol(pClientSDP, 1);
            }
            else
            {
                i = ModifySDPTransProtocol(pClientSDP, 0);
            }

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Modify SDP Protocol Error \r\n");
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息中的协议传输类型失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify the transmission protocol type of the SDP information failed");
                return EV9000_CMS_ERR_SDP_MODIFY_PROTOCOL_ERROR;
            }
        }
    }

    /* 转发INVITE消息 到被叫方*/
    callee_dialog_pos = SIP_ProxyForwardInviteWithinDialog(pCrData->caller_ua_index, local_cms_id_get(), pCrData->callee_server_ip, pCrData->callee_server_port, NULL, pCrData->callee_ip, pCrData->callee_port, pClientSDP);
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_transfer_invite_to_dest_proc() SIP_ProxyForwardInviteWithinDialog:callee_dialog_pos=%d, callee_ip=%s, callee_port=%d \r\n", callee_dialog_pos, pCrData->callee_ip, pCrData->callee_port);

    if (callee_dialog_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_proc() exit---: Forward Message To Callee Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_dialog_pos=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"转发INVITE消息到目的地失败", callee_dialog_pos);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Forward the INVITE message to the destination failed.");
        return EV9000_CMS_ERR_INVITE_TRANSFER_MSG_TO_DEST_ERROR;
    }

    /* 添加被叫的pos到crdata */
    pCrData->callee_ua_index = callee_dialog_pos;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发INVITE消息到目的地, 目的地IP=%s, 目的地端口=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_ip, pCrData->callee_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, Forwards the INVITE message to the destination, Destination IP=%s, Destination Port=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_ip, pCrData->callee_port);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_transfer_invite_to_dest_for_record_play_proc
 功能描述  : 用户请求录像视频转发INVITE到目的地
 输入参数  : cr_t* pCrData
             sdp_message_t* pClientSDP
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年3月7日 星期五
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_transfer_invite_to_dest_for_record_play_proc(cr_t* pCrData, sdp_message_t* pClientSDP)
{
    int i = -1;
    int tsu_index = -1;
    char* tsu_ip = NULL;
    int callee_dialog_pos = -1;
    int recv_port = 0;
    tsu_resource_info_t* pTsuResourceInfo = NULL;
    char* sdp_tsu_ip = NULL;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 历史视频查看或下载, 转发INVITE到前端处理", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:Caller_ID=%s, Caller_IP_Address=%s, Port=%d, Logic_Device_ID=%s, History video view or download, forward the INVITE to the front-end processing", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到下级CMS平台", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:Caller_ID=%s, Caller_IP_Address=%s, Port=%d, Logic_Device_ID=%s,Media stream without forward at the corresponding level, forwarding message directly to the CMS platform at a lower level", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        /* 获取空闲的TSU资源 */
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() get_idle_tsu_by_resource_balance_for_replay: Begin--- \r\n", tsu_index);
        tsu_index = get_idle_tsu_by_resource_balance_for_replay();
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() get_idle_tsu_by_resource_balance_for_replay: End--- tsu_index=%d \r\n", tsu_index);

        if (tsu_index < 0)
        {
            if (-2 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源队列为空");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-3 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源信息错误");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-4 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源都没有启用");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-5 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,TSU资源都不在线");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else if (-9 == tsu_index)
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败,通过ICE获取所有的TSU资源状态失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }
            else
            {
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找可用的录像回放TSU资源失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            }

            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Get Idle TSU Index Error \r\n");
            return EV9000_CMS_ERR_TSU_GET_IDLE_TSU_INDEX_ERROR;
        }

        pTsuResourceInfo = tsu_resource_info_get(tsu_index);

        if (NULL == pTsuResourceInfo)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Get TSU Resource Info Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_index=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取录像回放的TSU资源失败", tsu_index);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get free TSU resource failed");
            return EV9000_CMS_ERR_TSU_GET_TSU_INFO_ERROR;
        }

        /* 获取和TSU通信的IP地址 */
        tsu_ip = get_tsu_ip(pTsuResourceInfo, default_eth_name_get());

        if (NULL == tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Get TSU IP Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address failed");
            return EV9000_CMS_ERR_TSU_GET_IP_ERROR;
        }

        /* 获取TSU 接收端口号 */
        recv_port = get_recv_port_by_tsu_resource(tsu_ip);

        if (recv_port <= 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Get TSU Recv Port Error:tsu_ip=%s \r\n", tsu_ip);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的接收端口号失败", tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU receiving port failed.", tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_RECV_PORT_ERROR;
        }

        /* 添加TSU的信息到呼叫资源信息 */
        osip_strncpy(pCrData->tsu_device_id, pTsuResourceInfo->tsu_device_id, MAX_ID_LEN);
        pCrData->tsu_resource_index = tsu_index;
        pCrData->tsu_recv_port = recv_port;
        osip_strncpy(pCrData->tsu_ip, tsu_ip, MAX_IP_LEN);

        i = TSUResourceIPAddrListClone(pTsuResourceInfo->pTSUIPAddrList, pCrData);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: TSU IP Addr List Clone Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"添加本地TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Add local TSU IP address failed");
            return EV9000_CMS_ERR_TSU_IP_CLONE_ERROR;
        }

#if 0
        printf("\r\n\r\n ************************************************* \r\n");
        printf(" user_transfer_invite_to_dest_for_record_play_proc() pCrData->tsu_device_id=%s \r\n", pCrData->tsu_device_id);
        printf(" user_transfer_invite_to_dest_for_record_play_proc() pCrData->tsu_device_ip=%s \r\n", pCrData->tsu_device_ip);
        printf(" user_transfer_invite_to_dest_for_record_play_proc() pCrData->tsu_ip=%s \r\n", pCrData->tsu_ip);
        printf(" user_transfer_invite_to_dest_for_record_play_proc() pCrData->tsu_port=%d \r\n", pCrData->tsu_port);
        printf(" ************************************************* \r\n\r\n ");
#endif

        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->callee_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Get Callee TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->callee_server_ip_ethname);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取被叫侧的SDP消息中的TSU的IP地址失败", pCrData->callee_server_ip_ethname);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, callee_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address from the called side SIP message failed.", pCrData->callee_server_ip_ethname);
            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改客户端SDP 中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pClientSDP, sdp_tsu_ip, pCrData->tsu_recv_port);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Modify SDP IP And Addr Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息中的IP和端口号失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify the IP and port of the SDP information failed");
            return EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR;
        }

        /* 修改SDP中的协议传输类型 */
        if (pCrData->caller_transfer_type != pCrData->callee_transfer_type)
        {
            if (TRANSFER_PROTOCOL_TCP == pCrData->callee_transfer_type)
            {
                i = ModifySDPTransProtocol(pClientSDP, 1);
            }
            else
            {
                i = ModifySDPTransProtocol(pClientSDP, 0);
            }

            if (i != 0)
            {
                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Modify SDP Protocol Error \r\n");
                SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息中的协议传输类型失败");
                EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify the transmission protocol type of the SDP information failed");
                return EV9000_CMS_ERR_SDP_MODIFY_PROTOCOL_ERROR;
            }
        }
    }

    /* 转发INVITE消息 到被叫方*/
    callee_dialog_pos = SIP_ProxyForwardInviteWithinDialog(pCrData->caller_ua_index, local_cms_id_get(), pCrData->callee_server_ip, pCrData->callee_server_port, NULL, pCrData->callee_ip, pCrData->callee_port, pClientSDP);
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_transfer_invite_to_dest_for_record_play_proc() SIP_ProxyForwardInviteWithinDialog:callee_dialog_pos=%d \r\n", callee_dialog_pos);

    if (callee_dialog_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_record_play_proc() exit---: Forward Message To Callee Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_dialog_pos=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"转发INVITE消息到目的地失败", callee_dialog_pos);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Forward the INVITE message to the destination failed");
        return EV9000_CMS_ERR_INVITE_TRANSFER_MSG_TO_DEST_ERROR;
    }

    /* 添加被叫的pos到crdata */
    pCrData->callee_ua_index = callee_dialog_pos;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发INVITE消息到目的地, 目的地IP=%s, 目的地端口=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_ip, pCrData->callee_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, Forward the INVITE message to the destination failed", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_transfer_invite_to_dest_for_audio_proc
 功能描述  : 用户请求实时音频对讲转发INVITE到目的地
 输入参数  : cr_t* pCrData
             sdp_message_t* pClientSDP
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年4月25日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_transfer_invite_to_dest_for_audio_proc(cr_t* pCrData, sdp_message_t* pClientSDP)
{
    int i = 0;
    int tsu_index = -1;
    char* tsu_ip = NULL;
    int callee_dialog_pos = -1;
    int send_port = 0;
    tsu_resource_info_t* pTsuResourceInfo = NULL;
    char* sdp_tsu_ip = NULL;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时音频对讲请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 历史视频查看或下载, 转发INVITE到前端处理", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real Audio Intercom request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, History video view or download, forward the INVITE to the front-end processing", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

    if (!g_LocalMediaTransferFlag
        && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
    {
        /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 直接转发消息到下级CMS平台", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d,Logic Device ID=%s,Media stream without forward at the corresponding level, forwarding message directly to the CMS platform at a lower level", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    }
    else
    {
        /* 获取空闲的TSU资源 */
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() get_idle_tsu_for_audio_transfer: Begin--- \r\n", tsu_index);
        tsu_index = get_idle_tsu_for_audio_transfer();
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() get_idle_tsu_for_audio_transfer: End--- tsu_index=%d \r\n", tsu_index);

        if (tsu_index < 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Get Idle TSU Index Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找空闲的TSU资源失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find free TSU resource failed");
            return EV9000_CMS_ERR_TSU_GET_IDLE_TSU_INDEX_ERROR;
        }

        pTsuResourceInfo = tsu_resource_info_get(tsu_index);

        if (NULL == pTsuResourceInfo)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Get TSU Resource Info Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取空闲的TSU资源失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get free TSU resource failed");
            return EV9000_CMS_ERR_TSU_GET_TSU_INFO_ERROR;
        }

        /* 获取和TSU通信的IP地址 */
        tsu_ip = get_tsu_ip(pTsuResourceInfo, default_eth_name_get());

        if (NULL == tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Get TSU IP Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address failed");
            return EV9000_CMS_ERR_TSU_GET_IP_ERROR;
        }

        /* 获取TSU 音频发送端口号 */
        send_port = get_tsu_audio_send_port(tsu_ip);

        if (send_port <= 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Get TSU Recv Port Error:tsu_ip=%s \r\n", tsu_ip);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取TSU的发送端口号失败", tsu_ip);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, tsu_ip=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU send port failed", tsu_ip);
            return EV9000_CMS_ERR_TSU_GET_SEND_PORT_ERROR;
        }

        /* 添加TSU的信息到呼叫资源信息 */
        osip_strncpy(pCrData->tsu_device_id, pTsuResourceInfo->tsu_device_id, MAX_ID_LEN);
        pCrData->tsu_resource_index = tsu_index;
        pCrData->tsu_send_port = send_port;
        osip_strncpy(pCrData->tsu_ip, tsu_ip, MAX_IP_LEN);

        i = TSUResourceIPAddrListClone(pTsuResourceInfo->pTSUIPAddrList, pCrData);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: TSU IP Addr List Clone Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"添加本地TSU IP地址失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Add local TSU IP address failed");
            return EV9000_CMS_ERR_TSU_IP_CLONE_ERROR;
        }

#if 0
        printf("\r\n\r\n ************************************************* \r\n");
        printf(" user_transfer_invite_to_dest_for_audio_proc() pCrData->tsu_device_id=%s \r\n", pCrData->tsu_device_id);
        printf(" user_transfer_invite_to_dest_for_audio_proc() pCrData->tsu_device_ip=%s \r\n", pCrData->tsu_device_ip);
        printf(" user_transfer_invite_to_dest_for_audio_proc() pCrData->tsu_ip=%s \r\n", pCrData->tsu_ip);
        printf(" user_transfer_invite_to_dest_for_audio_proc() pCrData->tsu_port=%d \r\n", pCrData->tsu_port);
        printf(" ************************************************* \r\n\r\n ");
#endif

        sdp_tsu_ip = get_cr_sdp_tsu_ip(pCrData, pCrData->callee_server_ip_ethname);

        if (NULL == sdp_tsu_ip)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Get Callee TSU SDP IP Error:callee_server_ip_ethname=%s\r\n", pCrData->callee_server_ip_ethname);
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取被叫侧的SDP消息中的TSU的IP地址失败", pCrData->callee_server_ip_ethname);
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s, callee_server_ip_ethname=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get TSU IP address from the called side SIP message failed.", pCrData->callee_server_ip_ethname);
            return EV9000_CMS_ERR_TSU_GET_CALLER_TSU_IP_ERROR;
        }

        /* 修改客户端SDP 中的ip地址和端口号*/
        i = ModifySDPIPAndPort(pClientSDP, sdp_tsu_ip, pCrData->tsu_send_port);

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Modify SDP Info Error \r\n");
            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"修改SDP信息失败");
            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Modify SDP information failed.");
            return EV9000_CMS_ERR_SDP_MODIFY_IP_ERROR;
        }
    }

    /* 转发INVITE消息 到被叫方*/
    callee_dialog_pos = SIP_ProxyForwardInviteWithinDialog(pCrData->caller_ua_index, local_cms_id_get(), pCrData->callee_server_ip, pCrData->callee_server_port, NULL, pCrData->callee_ip, pCrData->callee_port, pClientSDP);
    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_transfer_invite_to_dest_for_audio_proc() SIP_ProxyForwardInviteWithinDialog:callee_dialog_pos=%d \r\n", callee_dialog_pos);

    if (callee_dialog_pos < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_transfer_invite_to_dest_for_audio_proc() exit---: Forward Message To Callee Error \r\n");
        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时音频对讲请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, callee_dialog_pos=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"转发INVITE消息到目的地失败", callee_dialog_pos);
        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real Audio Intercom request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Forward the INVITE message to the destination failed");
        return EV9000_CMS_ERR_INVITE_TRANSFER_MSG_TO_DEST_ERROR;
    }

    /* 添加被叫的pos到crdata */
    pCrData->callee_ua_index = callee_dialog_pos;

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时音频对讲请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 转发INVITE消息到目的地, 目的地IP=%s, 目的地端口=%d", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_ip, pCrData->callee_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real Audio Intercom request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,  Forward the INVITE message to the destination failed", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
    return 0;
}

/*****************************************************************************
 函 数 名  : user_video_sevice_current_cms_proc
 功能描述  : 客户端调看本级平台视频业务
 输入参数  : cr_t* pCrData
             sdp_message_t* pClientSDP
             call_type_t eCallType
             int start_time
             int end_time
             int play_time
             int is_callee_record:是否前端录像
             int record_type:录像类型
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2000000年5月23日 星期四
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_video_sevice_current_cms_proc(cr_t* pCrData, sdp_message_t* pClientSDP, call_type_t eCallType, int start_time, int end_time, int play_time, int is_callee_record, int record_type)
{
    int i = -1;
    int cr_pos = -1;
    int record_info_pos = -1;
    cr_t* pCalleeCrData = NULL;
    record_info_t* pRecordInfo = NULL;

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_video_sevice_current_cms_proc() exit---: Call Record Info Error \r\n");
        return EV9000_CMS_ERR_INVITE_GET_CR_DATA_ERROR;
    }

    if (NULL == pClientSDP)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_video_sevice_current_cms_proc() exit---: Client SDP Info Error \r\n");
        return EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR;
    }

    if (CALL_TYPE_RECORD_PLAY == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端设备属于本级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"历史视频查看");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,The front-end equipment belong to CMS at the corresponding level,Call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"History video to see");
    }
    else if (CALL_TYPE_DOWNLOAD == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端设备属于本级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"视频文件下载");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,The front-end equipment belong to CMS at the corresponding level,Call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Video file download");
    }
    else if (CALL_TYPE_REALTIME == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端设备属于本级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"实时视频查看");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,The front-end equipment belong to CMS at the corresponding level,Call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Real-time video viewing");
    }

    if (CALL_TYPE_RECORD_PLAY == eCallType || CALL_TYPE_DOWNLOAD == eCallType)
    {
        if (1 == is_callee_record)/* 在前端录像的情况下，直接转发出去 */
        {
            i = user_transfer_invite_to_dest_proc(pCrData, pClientSDP);
        }
        else
        {
            i = user_answer_invite_for_playback_proc(pCrData, record_type, start_time, end_time, play_time);
        }
    }
    else if (CALL_TYPE_REALTIME == eCallType)
    {
        if (!g_LocalMediaTransferFlag
            && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
        {
            /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 不检查本地是否有录像或者实时视频业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,Media stream without forward at the corresponding level, do not check local whether there is a video or real time video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

            pCrData->callee_service_type = 0;
            i = user_transfer_invite_to_dest_proc(pCrData, pClientSDP);
        }
        /*本级CMS的点位处理*/
        else
        {
            /* 查询是否有录像业务 */
            cr_pos = find_GBLogic_device_has_record_service(pCrData->callee_id, pCrData->callee_stream_type);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_current_cms_proc() find_GBLogic_device_has_record_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

            if (cr_pos >= 0)
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在录像业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, Media stream type=%d, There have been a video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);

                pCalleeCrData = call_record_get(cr_pos);

                if (NULL == pCalleeCrData)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed.");
                    return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                }

                if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                    || pCalleeCrData->callee_sdp_port <= 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Callee Record Proc Not Complete \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备的录像流程没有结束");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Recording process of logic devices is not over.");
                    return EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR;
                }

                record_info_pos = record_info_find_by_cr_index(cr_pos);

                if (record_info_pos < 0)
                {
                    /* 可能存在另外错误的一个录像任务信息 */
                    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
                    i = call_record_remove(cr_pos);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() :call_record_remove, cr_pos=%d \r\n", cr_pos);

                    /* 再次查找一遍是否有录像业务 */
                    cr_pos = find_GBLogic_device_has_record_service(pCrData->callee_id, pCrData->callee_stream_type);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_current_cms_proc() find_GBLogic_device_has_record_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

                    if (cr_pos >= 0)
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在录像业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, Media stream type=%d, There have been a video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);

                        pCalleeCrData = call_record_get(cr_pos);

                        if (NULL == pCalleeCrData)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed.");
                            return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                        }

                        if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                            || pCalleeCrData->callee_sdp_port <= 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Callee Record Proc Not Complete \r\n");
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备的录像流程没有结束");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Recording process of logic devices is not over.");
                            return EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR;
                        }

                        record_info_pos = record_info_find_by_cr_index(cr_pos);

                        if (record_info_pos < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Find Record Info Error:cr_pos=%d \r\n", cr_pos);
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找录像信息失败");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find the video information failed.");
                            return EV9000_CMS_ERR_INVITE_FIND_CALLEE_RECORD_INFO_ERROR;
                        }
                    }
                }

                pRecordInfo = record_info_get(record_info_pos);

                if (NULL == pRecordInfo)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Get Record Info Error \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取录像信息失败");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get the video information failed.");
                    return EV9000_CMS_ERR_INVITE_GET_CALLEE_RECORD_INFO_ERROR;
                }

                pCrData->callee_service_type = 1;
                pCrData->callee_record_type = pRecordInfo->record_type;
                i = user_answer_invite_for_realplay_proc(pCrData, pCalleeCrData, pCrData->callee_service_type, pCrData->callee_record_type);
            }
            else
            {
                /* 查询是否有实时视频业务 */
                cr_pos = find_GBLogic_device_has_realplay_service(pCrData->callee_id, pCrData->callee_stream_type);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_current_cms_proc() find_GBLogic_device_has_realplay_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

                if (cr_pos >= 0)
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在实时视频业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, Media stream type=%d, There have been a real-time video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);

                    pCalleeCrData = call_record_get(cr_pos);

                    if (NULL == pCalleeCrData)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed");
                        return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                    }

                    if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                        || pCalleeCrData->callee_sdp_port <= 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_current_cms_proc() exit---: Callee Video Proc Not Complete \r\n");
                        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备已有的视频流程没有结束");
                        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Logical devices existing video process is not over.");
                        return EV9000_CMS_ERR_INVITE_CALLEE_VIDEO_NOT_COMPLETE_ERROR;
                    }

                    pCrData->callee_service_type = 0;
                    i = user_answer_invite_for_realplay_proc(pCrData, pCalleeCrData, pCrData->callee_service_type, pCalleeCrData->callee_stream_type);
                }
                else
                {
                    pCrData->callee_service_type = 0;
                    i = user_transfer_invite_to_dest_proc(pCrData, pClientSDP);
                }
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_video_sevice_sub_cms_proc
 功能描述  : 用户视频业务源端在下级平台时候的处理
 输入参数  : cr_t* pCrData
             sdp_message_t* pClientSDP
             video_play_type_t eVideoPlayType
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年11月27日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int user_video_sevice_sub_cms_proc(cr_t* pCrData, sdp_message_t* pClientSDP, call_type_t eCallType)
{
    int i = -1;
    int cr_pos = -1;
    int record_info_pos = -1;
    cr_t* pCalleeCrData = NULL;
    record_info_t* pRecordInfo = NULL;

    if (NULL == pCrData)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_video_sevice_sub_cms_proc() exit---: Call Record Info Error \r\n");
        return EV9000_CMS_ERR_INVITE_GET_CR_DATA_ERROR;
    }

    if (NULL == pClientSDP)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_video_sevice_sub_cms_proc() exit---: Client SDP Info Error \r\n");
        return EV9000_CMS_ERR_INVITE_CALLER_SDP_MSG_ERROR;
    }

    if (CALL_TYPE_RECORD_PLAY == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s,前端设备属于下级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"历史视频查看");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, The front-end equipment belongs to the lower CMS front-end equipment,call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"History Video Review");
    }
    else if (CALL_TYPE_DOWNLOAD == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端设备属于下级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"视频文件下载");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, The front-end equipment belongs to the lower CMS front-end equipment,call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Video file download");
    }
    else if (CALL_TYPE_REALTIME == eCallType)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 前端设备属于下级CMS,呼叫类型是:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"实时视频查看");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, The front-end equipment belongs to the lower CMS front-end equipment,call type:%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Real-time video viewing");
    }

    /*playback download 处理*/
    if (CALL_TYPE_RECORD_PLAY == eCallType || CALL_TYPE_DOWNLOAD == eCallType)
    {
        i = user_transfer_invite_to_dest_for_record_play_proc(pCrData, pClientSDP);
    }
    else if (CALL_TYPE_REALTIME == eCallType)
    {
        if (!g_LocalMediaTransferFlag
            && EV9000_DEVICETYPE_SIPSERVER == pCrData->callee_gb_device_type)
        {
            /* 如果是跨级CMS的点位并且不需要本级TSU转发码流，直接转发消息 */
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流不经过本级转发, 不检查本地是否有录像或者实时视频业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,Media stream without forward at the corresponding level, do not check local whether there is a video or real time video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);

            pCrData->callee_service_type = 0;
            i = user_transfer_invite_to_dest_proc(pCrData, pClientSDP);
        }
        else
        {
            /* 查询是否有录像业务 */
            cr_pos = find_GBLogic_device_has_record_service(pCrData->callee_id, pCrData->callee_stream_type);
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_sub_cms_proc() find_GBLogic_device_has_record_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

            if (cr_pos >= 0)
            {
                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在录像业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,There have been a video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
                pCalleeCrData = call_record_get(cr_pos);

                if (NULL == pCalleeCrData)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed");
                    return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                }

                if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                    || pCalleeCrData->callee_sdp_port <= 0)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Callee Record Proc Not Complete \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备的录像流程没有结束");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Recording process of logic devices is not over.");
                    return EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR;
                }

                record_info_pos = record_info_find_by_cr_index(cr_pos);

                if (record_info_pos < 0)
                {
                    /* 可能存在另外错误的一个录像任务信息 */
                    i = call_record_set_call_status(cr_pos, CALL_STATUS_WAIT_RELEASE);
                    i = call_record_remove(cr_pos);
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() :call_record_remove, cr_pos=%d \r\n", cr_pos);

                    /* 再次查找一遍是否有录像业务 */
                    cr_pos = find_GBLogic_device_has_record_service(pCrData->callee_id, pCrData->callee_stream_type);
                    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_sub_cms_proc() find_GBLogic_device_has_record_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

                    if (cr_pos >= 0)
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在录像业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request processing:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s,There have been a video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id);
                        pCalleeCrData = call_record_get(cr_pos);

                        if (NULL == pCalleeCrData)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed");
                            return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                        }

                        if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                            || pCalleeCrData->callee_sdp_port <= 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Callee Record Proc Not Complete \r\n");
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备的录像流程没有结束");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Recording process of logic devices is not over.");
                            return EV9000_CMS_ERR_INVITE_CALLEE_RECORD_NOT_COMPLETE_ERROR;
                        }

                        record_info_pos = record_info_find_by_cr_index(cr_pos);

                        if (record_info_pos < 0)
                        {
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Find Record Info Error:cr_pos=%d \r\n", cr_pos);
                            SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"查找录像信息失败");
                            EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Find the video information failed");
                            return EV9000_CMS_ERR_INVITE_FIND_CALLEE_RECORD_INFO_ERROR;
                        }
                    }
                }

                pRecordInfo = record_info_get(record_info_pos);

                if (NULL == pRecordInfo)
                {
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Get Record Info Error \r\n");
                    SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取录像信息失败");
                    EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get the video information failed");
                    return EV9000_CMS_ERR_INVITE_GET_CALLEE_RECORD_INFO_ERROR;
                }

                pCrData->callee_service_type = 1;
                pCrData->callee_record_type = pRecordInfo->record_type;
                i = user_answer_invite_for_realplay_proc(pCrData, pCalleeCrData, pCrData->callee_service_type, pCrData->callee_record_type);
            }
            else
            {
                /* 查询是否有实时视频业务 */
                cr_pos = find_GBLogic_device_has_realplay_service(pCrData->callee_id, pCrData->callee_stream_type);
                DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_video_sevice_sub_cms_proc() find_GBLogic_device_has_realplay_service:callee_id=%s, callee_stream_type=%d, cr_pos=%d \r\n", pCrData->callee_id, pCrData->callee_stream_type, cr_pos);

                if (cr_pos >= 0)
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "实时视频请求处理:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 媒体流类型=%d, 已经存在实时视频业务", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Real-time video request handling: ID = % s, the requester = % s IP address, port number = % d, logical device ID = % s, media stream type = % d, existing real-time video business", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, pCrData->callee_stream_type);

                    pCalleeCrData = call_record_get(cr_pos);

                    if (NULL == pCalleeCrData)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Get Callee Cr Data Error \r\n");
                        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"获取逻辑设备的实时视频呼叫资源失败");
                        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Get real-time video of logical device call resource failed");
                        return EV9000_CMS_ERR_INVITE_GET_CALLEE_CR_DATA_ERROR;
                    }

                    if (pCalleeCrData->callee_sdp_ip[0] == '\0'
                        || pCalleeCrData->callee_sdp_port <= 0)
                    {
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_video_sevice_sub_cms_proc() exit---: Callee Video Proc Not Complete \r\n");
                        SystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "实时视频请求处理失败:请求方ID=%s, 请求方IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"逻辑设备已有的视频流程没有结束");
                        EnSystemLog(EV9000_CMS_VIDEO_REQUEST_ERROR, EV9000_LOG_LEVEL_ERROR, "Real-time video request processing failed:caller ID=%s, caller IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pCrData->caller_id, pCrData->caller_ip, pCrData->caller_port, pCrData->callee_id, (char*)"Logical devices existing video process is not over");
                        return EV9000_CMS_ERR_INVITE_CALLEE_VIDEO_NOT_COMPLETE_ERROR;
                    }

                    pCrData->callee_service_type = 0;
                    i = user_answer_invite_for_realplay_proc(pCrData, pCalleeCrData, pCrData->callee_service_type, pCalleeCrData->callee_stream_type);
                }
                else
                {
                    pCrData->callee_service_type = 0;
                    i = user_transfer_invite_to_dest_proc(pCrData, pClientSDP);
                }
            }
        }
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_get_service_id_proc
 功能描述  : 用户获取服务器ID和用户ID
 输入参数  : char* caller_id
             char* caller_ip
             int caller_port
             char* callee_id
             char* local_ip
             int local_port
             char* pcSN
             char* pcServerIP
             char* pcUserName
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年6月12日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_get_service_id_proc(char* caller_id, char* caller_ip, int caller_port, char* callee_id, char* local_ip, int local_port, char* pcSN, char* pcServerIP, char* pcUserName, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;

    string strSQL = "";
    int record_count = 0;
    int iUserIndex = 0;
    int iUserEnable = 0;
    int iUserLevel = 0;
    string strUserID = "";
    string strUserPassword = "";
    CPacket outPacket;
    DOMElement* AccNode = NULL;
    int user_pos = -1;
    user_info_t* pUserInfo = NULL;
    char strErrorCode[32] = {0};

    if (NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_service_id_proc() exit---: User Srv dboper Error \r\n");
        return -1;
    }

    if ((NULL == caller_id) || (NULL == caller_ip) || (caller_port <= 0))
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_service_id_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if ((NULL == callee_id) || (NULL == local_ip) || (local_port <= 0))
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_service_id_proc() exit---: Callee Info Error \r\n");
        return -1;
    }

    if ((NULL == pcServerIP) || (pcServerIP[0] == '\0') || (NULL == pcUserName) || (pcUserName[0] == '\0'))
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_service_id_proc() exit---: Server Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc Select UserConfig Enter--- \r\n");
    //printf("\r\n ********** user_get_service_id_proc Select UserConfig Enter--- \r\n");
    //printf_system_time();
    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前开始获取服务器ID和用户ID开始查询数据库:IP地址=%s, 端口号=%d, 用户名=%s, 服务器IP=%s", caller_ip, caller_port, pcUserName, pcServerIP);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Before the user log in,start to get server ID and user ID:user IP=%s , port=%d , user name=%d, server IP= %s", caller_ip, caller_port, pcUserName, pcServerIP);

    /* 看是否要插入默认数据 */
    if (sstrcmp(pcUserName, (char*)"WiscomV") == 0)
    {
        iRet = InsertDefaultUserInfo(pcUserName, pUser_Srv_dboper);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() InsertDefaultUserInfo:iRet=%d \r\n", iRet);
    }
    else if (sstrcmp(pcUserName, (char*)"admin") == 0)
    {
        iRet = InsertDefaultUserInfo(pcUserName, pUser_Srv_dboper);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() InsertDefaultUserInfo:iRet=%d \r\n", iRet);
    }

    /* 从数据库获取用户ID */
    strSQL.clear();
    strSQL = "select * from UserConfig WHERE UserName like '";
    strSQL += pcUserName;
    strSQL += "'";

    record_count = pUser_Srv_dboper->DB_Select(strSQL.c_str(), 1);

    if (record_count < 0)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, pcSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_OPER_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database Query Error");

        i = SIP_SendMessage(NULL, caller_id, callee_id, local_ip, local_port, caller_ip, caller_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前开始获取服务器ID和用户ID失败:IP地址=%s, 端口号=%d, 原因=%s:%s", caller_ip, caller_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "Before the user log in,start to get server ID and user ID failed:user IP:%s , port=%d , reason= %s:%s", caller_ip, caller_port, (char*)"Failed to query the database.", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, pcSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_NORECORD_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database No Record");

        i = SIP_SendMessage(NULL, caller_id, callee_id, local_ip, local_port, caller_ip, caller_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前开始获取服务器ID和用户ID失败:IP地址=%s, 端口号=%d, 原因=%s:%s", caller_ip, caller_port, (char*)"查询数据库失败", pUser_Srv_dboper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "Before the user log in,start to get server ID and user ID failed:user IP:%s , port=%d , reason= %s:%s", caller_ip, caller_port, (char*)"Failed to query the database.", pUser_Srv_dboper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() ErrorMsg=%s\r\n", pUser_Srv_dboper->GetLastDbErrorMsg());
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc Select UserConfig Exit--- \r\n");
    //printf("\r\n ********** user_get_service_id_proc Select UserConfig Exit--- \r\n");
    //printf_system_time();
    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前开始获取服务器ID和用户ID查询数据库成功:IP地址=%s, 端口号=%d", caller_ip, caller_port);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Before the user log in,start to get server ID and user ID:user IP=%s, port=%d", caller_ip, caller_port);

    /* 用户索引 */
    iUserIndex = 0;
    pUser_Srv_dboper->GetFieldValue("ID", iUserIndex);

    /* 是否启用 */
    iUserEnable = 0;
    pUser_Srv_dboper->GetFieldValue("Enable", iUserEnable);

    /* 用户统一编号id */
    strUserID.clear();
    pUser_Srv_dboper->GetFieldValue("UserID", strUserID);

    /* 用户等级 */
    iUserLevel = 0;
    pUser_Srv_dboper->GetFieldValue("Level", iUserLevel);

    /* 用户密码 */
    strUserPassword.clear();
    pUser_Srv_dboper->GetFieldValue("Password", strUserPassword);

    if (!iUserEnable)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, pcSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_USER_NOTENABLE_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"User Not Enable");

        i = SIP_SendMessage(NULL, caller_id, callee_id, local_ip, local_port, caller_ip, caller_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前开始获取服务器ID和用户ID失败:IP地址=%s, 端口号=%d, 原因=%s", caller_ip, caller_port, (char*)"用户已经被禁用");
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "Before the user log in,start to get server ID and user ID failed:user IP:%s , port=%d , reason= %s.", caller_ip, caller_port, (char*)"User have been disabled.");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() exit---: Get User ID Error \r\n");
        return -1;
    }

    if (strUserID.empty())
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, pcSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_USERID_EMPTY_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database User ID Empty");

        i = SIP_SendMessage(NULL, caller_id, callee_id, local_ip, local_port, caller_ip, caller_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

        if (i != 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }
        else
        {
            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, caller_ip, caller_port);
        }

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前开始获取服务器ID和用户ID失败:IP地址=%s, 端口号=%d, 原因=%s", caller_ip, caller_port, (char*)"获取数据库记录字段失败");
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "Before the user log in,start to get server ID and user ID failed:user IP:%s , port=%d , reason= %s.", caller_ip, caller_port, (char*)"Failed to get a database record field.");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_service_id_proc() exit---: Get User ID Error \r\n");
        return -1;
    }

    if (!IsLocalHost(pcServerIP))
    {
        /* ServerIP 可能是客户端通过网闸发过来的IP地址，这个时候这个地址就是服务器在网闸外面的IP地址 */
        user_pos = user_info_find((char*)strUserID.c_str(), caller_ip, caller_port);

        if (user_pos < 0)
        {
            user_info_t* pNewUserInfo = new user_info_t();

            if (pNewUserInfo != NULL)
            {
                pNewUserInfo->user_index = iUserIndex;
                pNewUserInfo->user_level = iUserLevel;
                snprintf(pNewUserInfo->user_id, MAX_ID_LEN + 4, "%s", (char*)strUserID.c_str());
                snprintf(pNewUserInfo->login_ip, MAX_IP_LEN, "%s", caller_ip);
                pNewUserInfo->login_port = caller_port;
                pNewUserInfo->alarm_info_send_flag = 0;
                pNewUserInfo->tvwall_status_send_flag = 0;
                pNewUserInfo->tcp_sock = -1;
                pNewUserInfo->tcp_keep_alive_sock = -1;

                user_pos = user_info_add(pNewUserInfo);

                if (user_pos < 0)
                {
                    delete pNewUserInfo;
                    pNewUserInfo = NULL;
                }
            }
        }

        /* 获取用户信息 */
        if (user_pos >= 0)
        {
            pUserInfo = user_info_get(user_pos);

            if (NULL != pUserInfo)
            {
                memset(pUserInfo->strRegGapIP, 0, 16);
                osip_strncpy(pUserInfo->strRegGapIP, pcServerIP, 15);
            }
        }
    }

    /* 回复响应,组建消息 */
    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"GetServerID");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, pcSN);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, (char*)strUserID.c_str());

    AccNode = outPacket.CreateElement((char*)"ServerID");
    outPacket.SetElementValue(AccNode, local_cms_id_get());

    i = SIP_SendMessage(NULL, caller_id, callee_id, local_ip, local_port, caller_ip, caller_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前开始获取服务器ID和用户ID成功:IP地址=%s, 端口号=%d, 用户ID=%s, 服务器ID=%s", caller_ip, caller_port, (char*)strUserID.c_str(), local_cms_id_get());
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "Before the user log in,start to get server ID and user ID successfully:IP=%s, port=%d, user ID=%s, server ID=%s", caller_ip, caller_port, (char*)strUserID.c_str(), local_cms_id_get());
    }
    else
    {
        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前开始获取服务器ID和用户ID失败:IP地址=%s, 端口号=%d, 原因=%s", caller_ip, caller_port, (char*)"发送SIP响应消息失败");
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "Before the user log in,start to get server ID and user ID failed:IP=%s, port=%d, reson=%s", caller_ip, caller_port, (char*)"SIP response message sent failure");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_service_id_proc() Exit--- \r\n");
    //printf("\r\n ********** user_get_service_id_proc Exit--- \r\n");
    //printf_system_time();

    return i;
}

/*****************************************************************************
 函 数 名  : user_get_db_ip_proc
 功能描述  : 用户获取数据库IP地址
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年11月5日
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int user_get_db_ip_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, CPacket& inPacket)
{
    int iRet = 0;
    char strSN[32] = {0};
    char strEthName1[16] = {0};
    char strEthName2[16] = {0};
    char* local_ip = NULL;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_system_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if (NULL == caller_id || NULL == callee_id)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_get_db_ip_proc() exit---: Param Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_get_db_ip_proc() \
    \r\n XML Para: \
    \r\n SN=%s \r\n", strSN);

    /* 回复响应,组建消息 */
    CPacket outPacket;
    DOMElement* AccNode = NULL;

    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"GetDBIP");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"DBIP");

    if (0 == sstrcmp(pGblconf->db_server_ip, (char*)"127.0.0.1"))
    {
        if (pUserInfo->strRegGapIP[0] != '\0') /* 通过网闸过来的用户 */
        {
            outPacket.SetElementValue(AccNode, pUserInfo->strRegGapIP);
        }
        else
        {
            local_ip = local_ip_get(pUserInfo->strRegServerEthName);

            if (NULL != local_ip)
            {
                outPacket.SetElementValue(AccNode, local_ip);
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"");
            }
        }
    }
    else if (pGblconf->db_server_ip[0] == '\0')
    {
        if (pUserInfo->strRegGapIP[0] != '\0') /* 通过网闸过来的用户 */
        {
            outPacket.SetElementValue(AccNode, pUserInfo->strRegGapIP);
        }
        else
        {
            local_ip = local_ip_get(pUserInfo->strRegServerEthName);

            if (NULL != local_ip)
            {
                outPacket.SetElementValue(AccNode, local_ip);
            }
            else
            {
                outPacket.SetElementValue(AccNode, (char*)"");
            }
        }
    }
    else
    {
        if (pUserInfo->strRegGapIP[0] != '\0') /* 通过网闸过来的用户 */
        {
            outPacket.SetElementValue(AccNode, pUserInfo->strRegGapIP);
        }
        else
        {
            outPacket.SetElementValue(AccNode, pGblconf->db_server_ip);
        }
    }

    iRet = SIP_SendMessage(NULL, local_cms_id_get(), caller_id, pUserInfo->strRegServerIP, pUserInfo->iRegServerPort, pUserInfo->login_ip, pUserInfo->login_port, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length());

    if (iRet != 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_get_db_ip_proc() SIP_SendMessage Error:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }
    else
    {
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_get_db_ip_proc() SIP_SendMessage OK:user_id=%s, user_ip=%s, user_port=%d \r\n", caller_id, pUserInfo->login_ip, pUserInfo->login_port);
    }

    return iRet;
}

/*****************************************************************************
 函 数 名  : user_wiscomv_proc
 功能描述  : 用户WiscomV的消息处理
 输入参数  : user_info_t* pUserInfo
             char* caller_id
             char* callee_id
             CPacket& inPacket
             char* msg_body
             int msg_body_len
             DBOper* pUser_Srv_dboper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年12月2日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_wiscomv_proc(user_info_t* pUserInfo, char* caller_id, char* callee_id, char* msg_body, int msg_body_len, DBOper* pUser_Srv_dboper)
{
    int i = 0;
    int iRet = 0;
    xml_type_t xml_type = XML_TYPE_NULL;
    CPacket inPacket;
    vector<string> NodeName_Vector;

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_wiscomv_proc() exit---: User Info Error \r\n");
        return -1;
    }

    if ((NULL == caller_id) || (NULL == callee_id) || (NULL == msg_body))
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_wiscomv_proc() exit---: Param Error \r\n");
        return -1;
    }

    if (NULL == pUser_Srv_dboper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG,  "user_wiscomv_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    //解析XML
    iRet = inPacket.BuiltTree(msg_body, msg_body_len);//生成DOM树结构.

    if (iRet < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "user_wiscomv_proc() exit---: XML Build Tree Error \r\nmsg=%s \r\n", msg_body);
        return iRet;
    }

    NodeName_Vector.clear();
    DOMDocument* pDOMDocument = inPacket.GetDOMDocument();
    DOMElement* pDOMElement = pDOMDocument->get_root();
    pDOMElement->ClearNodeNumber();

    if (pDOMElement->GetNodeName(NodeName_Vector) <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_wiscomv_proc() exit---: Get Node Name Error \r\n");
        return -1;
    }

    /* 解析出xml的消息类型 */
    xml_type = get_xml_type_from_xml_body(NodeName_Vector, inPacket);
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_wiscomv_proc() get_xml_type_from_xml_body:xml_type=%d \r\n", xml_type);

    switch (xml_type)
    {
        case XML_QUERY_GETDBIP :    /* 获取数据库IP地址 */
            i = user_get_db_ip_proc(pUserInfo, caller_id, callee_id, inPacket);
            break;

        case XML_QUERY_USERCONFIG : /* 用户配置获取 */
            i = user_query_user_config_proc(pUserInfo, caller_id, callee_id, inPacket, pUser_Srv_dboper);
            break;

        default:
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_wiscomv_proc() exit---: Not Support Message Type:%d \r\n", xml_type);
            return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : CreateDeviceGroupConfigResponseXMLHead
 功能描述  : 创建获取逻辑设备分组配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int CreateDeviceGroupConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_DEVICE_GROUP_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_DEVICE_GROUP_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_GROUP_COUT_SEND == 1) && (record_count - query_count >= MAX_DEVICE_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_DEVICE_GROUP_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_GROUP_COUT_SEND == 1) && (record_count - query_count < MAX_DEVICE_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddDeviceGroupConfigToXMLItem
 功能描述  : 添加设备分组配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strGroupID
             string& strCMSID
             string& strName
             int SortID
             string& strParentID
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int AddDeviceGroupConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strGroupID, string& strCMSID, string& strName, int SortID, string& strParentID)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strSortID[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddDeviceGroupConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 组编号 */
    AccNode = pOutPacket->CreateElement((char*)"GroupID");
    pOutPacket->SetElementValue(AccNode, (char*)strGroupID.c_str());

    /* CMS 编号 */
    AccNode = pOutPacket->CreateElement((char*)"CMSID");

    if (strCMSID.length() <= 0)
    {
        pOutPacket->SetElementValue(AccNode, local_cms_id_get());
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)strCMSID.c_str());
    }

    /* 组名称 */
    AccNode = pOutPacket->CreateElement((char*)"Name");
    pOutPacket->SetElementValue(AccNode, (char*)strName.c_str());

    /* 同一父节点下组排序编号 */
    AccNode = pOutPacket->CreateElement((char*)"SortID");
    snprintf(strSortID, 16, "%d", SortID);
    pOutPacket->SetElementValue(AccNode, strSortID);

    /* 父节点编号 */
    AccNode = pOutPacket->CreateElement((char*)"ParentID");
    pOutPacket->SetElementValue(AccNode, (char*)strParentID.c_str());

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateUserDeviceGroupConfigResponseXMLHead
 功能描述  : 创建获取逻辑设备重新分组配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserIndex
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateUserDeviceGroupConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserIndex, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_USER_DEVICE_GROUP_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_USER_DEVICE_GROUP_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_USER_DEVICE_GROUP_COUT_SEND == 1) && (record_count - query_count >= MAX_USER_DEVICE_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_USER_DEVICE_GROUP_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_USER_DEVICE_GROUP_COUT_SEND == 1) && (record_count - query_count < MAX_USER_DEVICE_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddUserDeviceGroupConfigToXMLItem
 功能描述  : 添加设备重新分组配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strGroupID
             char* strUserIndex
             string& strName
             int SortID
             string& strParentID
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddUserDeviceGroupConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strGroupID, char* strUserIndex, string& strName, int SortID, string& strParentID)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strSortID[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddUserDeviceGroupConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 用户索引 */
    AccNode = pOutPacket->CreateElement((char*)"UserIndex");
    pOutPacket->SetElementValue(AccNode, strUserIndex);

    /* 组编号 */
    AccNode = pOutPacket->CreateElement((char*)"GroupID");
    pOutPacket->SetElementValue(AccNode, (char*)strGroupID.c_str());

    /* 组名称 */
    AccNode = pOutPacket->CreateElement((char*)"Name");
    pOutPacket->SetElementValue(AccNode, (char*)strName.c_str());

    /* 同一父节点下组排序编号 */
    AccNode = pOutPacket->CreateElement((char*)"SortID");
    snprintf(strSortID, 16, "%d", SortID);
    pOutPacket->SetElementValue(AccNode, strSortID);

    /* 父节点编号 */
    AccNode = pOutPacket->CreateElement((char*)"ParentID");
    pOutPacket->SetElementValue(AccNode, (char*)strParentID.c_str());

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateDeviceMapGroupConfigResponseXMLHead
 功能描述  : 创建获取逻辑设备分组关系配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int CreateDeviceMapGroupConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_DEVICE_MAP_GROUP_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_DEVICE_MAP_GROUP_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_MAP_GROUP_COUT_SEND == 1) && (record_count - query_count >= MAX_DEVICE_MAP_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_DEVICE_MAP_GROUP_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_MAP_GROUP_COUT_SEND == 1) && (record_count - query_count < MAX_DEVICE_MAP_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddDeviceMapGroupConfigToXMLItem
 功能描述  : 添加逻辑设备分组关系配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strGroupID
             unsigned int DeviceIndex
             string& strCMSID
             int SortID
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int AddDeviceMapGroupConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strGroupID, unsigned int DeviceIndex, string& strCMSID, int SortID)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strDeviceIndex[64] = {0};
    char strSortID[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddDeviceMapGroupConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 点位组编号 */
    AccNode = pOutPacket->CreateElement((char*)"GroupID");
    pOutPacket->SetElementValue(AccNode, (char*)strGroupID.c_str());

    /* 设备ID */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIndex");
    snprintf(strDeviceIndex, 64, "%u", DeviceIndex);
    pOutPacket->SetElementValue(AccNode, strDeviceIndex);

    /* CMS 编号 */
    AccNode = pOutPacket->CreateElement((char*)"CMSID");

    if (strCMSID.length() <= 0)
    {
        pOutPacket->SetElementValue(AccNode, local_cms_id_get());
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)strCMSID.c_str());
    }

    /* 同一父节点下组排序编号 */
    AccNode = pOutPacket->CreateElement((char*)"SortID");
    snprintf(strSortID, 16, "%d", SortID);
    pOutPacket->SetElementValue(AccNode, strSortID);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateUserDeviceMapGroupConfigResponseXMLHead
 功能描述  : 创建获取重新逻辑设备分组关系配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserIndex
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateUserDeviceMapGroupConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserIndex, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_USER_DEVICE_MAP_GROUP_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_USER_DEVICE_MAP_GROUP_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_USER_DEVICE_MAP_GROUP_COUT_SEND == 1) && (record_count - query_count >= MAX_USER_DEVICE_MAP_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_USER_DEVICE_MAP_GROUP_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_USER_DEVICE_MAP_GROUP_COUT_SEND == 1) && (record_count - query_count < MAX_USER_DEVICE_MAP_GROUP_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateUserDeviceMapGroupConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"UserLogicDeviceMapGroupConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserIndex");

        if (NULL != strUserIndex)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserIndex);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"UserLogicDeviceMapGroupConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddUserDeviceMapGroupConfigToXMLItem
 功能描述  : 添加重新逻辑设备分组关系配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strGroupID
             unsigned int DeviceIndex
             int SortID
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月20日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddUserDeviceMapGroupConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strGroupID, unsigned int DeviceIndex, int SortID)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strDeviceIndex[64] = {0};
    char strSortID[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddUserDeviceMapGroupConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 点位组编号 */
    AccNode = pOutPacket->CreateElement((char*)"GroupID");
    pOutPacket->SetElementValue(AccNode, (char*)strGroupID.c_str());

    /* 设备ID */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIndex");
    snprintf(strDeviceIndex, 64, "%u", DeviceIndex);
    pOutPacket->SetElementValue(AccNode, strDeviceIndex);

    /* 同一父节点下组排序编号 */
    AccNode = pOutPacket->CreateElement((char*)"SortID");
    snprintf(strSortID, 16, "%d", SortID);
    pOutPacket->SetElementValue(AccNode, strSortID);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreatePollConfigResponseXMLHead
 功能描述  : 创建获取轮巡数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int CreatePollConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_POLL_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_POLL_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_POLL_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_POLL_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_POLL_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_POLL_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_POLL_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddPollConfigToXMLItem
 功能描述  :  添加轮巡数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string &strPollName
             int iScheduledRun
             int iStartTime
             int iDurationTime
             string& strUserID
             int iType
             int iResved1
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int AddPollConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strPollName, int iScheduledRun, int iStartTime, int iDurationTime, string& strUserID, int iType, int iResved1)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strScheduledRun[16] = {0};
    char strStartTime[16] = {0};
    char strDurationTime[16] = {0};
    char strType[16] = {0};
    char strResved1[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddPollConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 轮巡名称 */
    AccNode = pOutPacket->CreateElement((char*)"PollName");
    pOutPacket->SetElementValue(AccNode, (char*)strPollName.c_str());

    /* 是否定时执行 */
    AccNode = pOutPacket->CreateElement((char*)"ScheduledRun");
    snprintf(strScheduledRun, 16, "%d", iScheduledRun);
    pOutPacket->SetElementValue(AccNode, strScheduledRun);

    /* 开始时间*/
    AccNode = pOutPacket->CreateElement((char*)"StartTime");
    snprintf(strStartTime, 16, "%d", iStartTime);
    pOutPacket->SetElementValue(AccNode, strStartTime);

    /* 持续时间 */
    AccNode = pOutPacket->CreateElement((char*)"DurationTime");
    snprintf(strDurationTime, 16, "%d", iDurationTime);
    pOutPacket->SetElementValue(AccNode, strDurationTime);

    /* 用户ID */
    AccNode = pOutPacket->CreateElement((char*)"UserID");
    pOutPacket->SetElementValue(AccNode, (char*)strUserID.c_str());

    /* 类型 */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strType, 16, "%d", iType);
    pOutPacket->SetElementValue(AccNode, strType);

    /* 是否正在执行 */
    AccNode = pOutPacket->CreateElement((char*)"Resved1");
    snprintf(strResved1, 16, "%d", iResved1);
    pOutPacket->SetElementValue(AccNode, strResved1);

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreatePollActionConfigResponseXMLHead
 功能描述  : 创建获取轮巡动作数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int CreatePollActionConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_POLL_ACTION_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_POLL_ACTION_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_POLL_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_POLL_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_POLL_ACTION_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_POLL_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_POLL_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePollActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PollActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PollActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddPollActionConfigToXMLItem
 功能描述  :  添加轮巡动作数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             int iPollID
             int iType
             string& strSourceID
             string& strDestID
             int iScreenID
             int iLiveTime
             int iDestSortID
             int iSourceSortID
             int iStreamType
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年10月16日
    作    者   : 用户路由信息清理
    修改内容   : 新生成函数

*****************************************************************************/
int AddPollActionConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, int iPollID, int iType, string& strSourceID, string& strDestID, int iScreenID, int iLiveTime, int iDestSortID, int iSourceSortID, int iStreamType)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strPollID[16] = {0};
    char strType[16] = {0};
    char strScreenID[16] = {0};
    char strLiveTime[16] = {0};
    char strDestSortID[16] = {0};
    char strSourceSortID[16] = {0};
    char strStreamType[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddPollActionConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* PollID */
    AccNode = pOutPacket->CreateElement((char*)"PollID");
    snprintf(strPollID, 16, "%d", iPollID);
    pOutPacket->SetElementValue(AccNode, strPollID);

    /* Type */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strType, 16, "%d", iType);
    pOutPacket->SetElementValue(AccNode, strType);

    /* SourceID */
    AccNode = pOutPacket->CreateElement((char*)"SourceID");
    pOutPacket->SetElementValue(AccNode, (char*)strSourceID.c_str());

    /* DestID */
    AccNode = pOutPacket->CreateElement((char*)"DestID");
    pOutPacket->SetElementValue(AccNode, (char*)strDestID.c_str());

    /* ScreenID */
    AccNode = pOutPacket->CreateElement((char*)"ScreenID");
    snprintf(strScreenID, 16, "%d", iScreenID);
    pOutPacket->SetElementValue(AccNode, strScreenID);

    /* LiveTime */
    AccNode = pOutPacket->CreateElement((char*)"LiveTime");
    snprintf(strLiveTime, 16, "%d", iLiveTime);
    pOutPacket->SetElementValue(AccNode, strLiveTime);

    /* DestSortID */
    AccNode = pOutPacket->CreateElement((char*)"DestSortID");
    snprintf(strDestSortID, 16, "%d", iDestSortID);
    pOutPacket->SetElementValue(AccNode, strDestSortID);

    /* SourceSortID */
    AccNode = pOutPacket->CreateElement((char*)"SourceSortID");
    snprintf(strSourceSortID, 16, "%d", iSourceSortID);
    pOutPacket->SetElementValue(AccNode, strSourceSortID);

    /* StreamType */
    AccNode = pOutPacket->CreateElement((char*)"StreamType");
    snprintf(strStreamType, 16, "%d", iStreamType);
    pOutPacket->SetElementValue(AccNode, strStreamType);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreatePlanConfigResponseXMLHead
 功能描述  : 创建获取预案数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreatePlanConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_PLAN_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_PLAN_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_PLAN_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_PLAN_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_PLAN_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_PLAN_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_PLAN_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddPlanConfigToXMLItem
 功能描述  : 添加预案数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strPlanName
             int iStartTime
             int iScheduledRun
             string& strUserID
             int iType
             int iUserLevel
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddPlanConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strPlanName, int iStartTime, int iScheduledRun, string& strUserID, int iType, int iUserLevel)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strScheduledRun[16] = {0};
    char strStartTime[16] = {0};
    char strType[16] = {0};
    char strUserLevel[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddPlanConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 轮巡名称 */
    AccNode = pOutPacket->CreateElement((char*)"PlanName");
    pOutPacket->SetElementValue(AccNode, (char*)strPlanName.c_str());

    /* 开始时间*/
    AccNode = pOutPacket->CreateElement((char*)"StartTime");
    snprintf(strStartTime, 16, "%d", iStartTime);
    pOutPacket->SetElementValue(AccNode, strStartTime);

    /* 是否定时执行 */
    AccNode = pOutPacket->CreateElement((char*)"ScheduledRun");
    snprintf(strScheduledRun, 16, "%d", iScheduledRun);
    pOutPacket->SetElementValue(AccNode, strScheduledRun);

    /* 用户ID */
    AccNode = pOutPacket->CreateElement((char*)"UserID");
    pOutPacket->SetElementValue(AccNode, (char*)strUserID.c_str());

    /* 类型 */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strType, 16, "%d", iType);
    pOutPacket->SetElementValue(AccNode, strType);

    /* 被动执行用户级别 */
    AccNode = pOutPacket->CreateElement((char*)"UserLevel");
    snprintf(strUserLevel, 16, "%d", iUserLevel);
    pOutPacket->SetElementValue(AccNode, strUserLevel);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreatePlanActionConfigResponseXMLHead
 功能描述  : 创建获取预案动作数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreatePlanActionConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_PLAN_ACTION_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_PLAN_ACTION_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_PLAN_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_PLAN_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_PLAN_ACTION_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_PLAN_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_PLAN_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePlanActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PlanActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PlanActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddPlanConfigToXMLItem
 功能描述  : 添加预案动作数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             int iPlanID
             int iType
             unsigned int uDeviceIndex
             unsigned int uDestID
             unsigned int uScreenID
             unsigned int uControlData
             unsigned int uStreamType
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddPlanActionConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, int iPlanID, int iType, unsigned int uDeviceIndex, unsigned int uDestID, unsigned int uScreenID, unsigned int uControlData, unsigned int uStreamType)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strPlanID[16] = {0};
    char strType[16] = {0};
    char strDeviceIndex[32] = {0};
    char strDestID[16] = {0};
    char strScreenID[16] = {0};
    char strControlData[16] = {0};
    char strStreamType[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddPlanActionConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* PlanID */
    AccNode = pOutPacket->CreateElement((char*)"PlanID");
    snprintf(strPlanID, 16, "%d", iPlanID);
    pOutPacket->SetElementValue(AccNode, strPlanID);

    /* Type */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strType, 16, "%d", iType);
    pOutPacket->SetElementValue(AccNode, strType);

    /* DeviceIndex */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIndex");
    snprintf(strDeviceIndex, 32, "%u", uDeviceIndex);
    pOutPacket->SetElementValue(AccNode, strDeviceIndex);

    /* DestID */
    AccNode = pOutPacket->CreateElement((char*)"DestID");
    snprintf(strDestID, 16, "%u", uDestID);
    pOutPacket->SetElementValue(AccNode, strDestID);

    /* ScreenID */
    AccNode = pOutPacket->CreateElement((char*)"ScreenID");
    snprintf(strScreenID, 16, "%u", uScreenID);
    pOutPacket->SetElementValue(AccNode, strScreenID);

    /* ControlData */
    AccNode = pOutPacket->CreateElement((char*)"ControlData");
    snprintf(strControlData, 16, "%u", uControlData);
    pOutPacket->SetElementValue(AccNode, strControlData);

    /* StreamType */
    AccNode = pOutPacket->CreateElement((char*)"StreamType");
    snprintf(strStreamType, 16, "%u", uStreamType);
    pOutPacket->SetElementValue(AccNode, strStreamType);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateCruiseConfigResponseXMLHead
 功能描述  : 创建获取巡航数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateCruiseConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_CRUISE_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_CRUISE_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_CRUISE_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_CRUISE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_CRUISE_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_CRUISE_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_CRUISE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddCruiseConfigToXMLItem
 功能描述  : 添加巡航数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             string& strCruiseName
             unsigned int uDeviceIndex
             int iScheduledRun
             int iStartTime
             int iDurationTime
             int iResved1
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddCruiseConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, string& strCruiseName, unsigned int uDeviceIndex, int iScheduledRun, int iStartTime, int iDurationTime, int iResved1)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strScheduledRun[16] = {0};
    char strStartTime[16] = {0};
    char strDurationTime[16] = {0};
    char strResved1[16] = {0};
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddCruiseConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 巡航名称 */
    AccNode = pOutPacket->CreateElement((char*)"CruiseName");
    pOutPacket->SetElementValue(AccNode, (char*)strCruiseName.c_str());

    /* DeviceID */
    AccNode = pOutPacket->CreateElement((char*)"DeviceID");
    //snprintf(strDeviceIndex, 32, "%u", uDeviceIndex);
    pGBLogicDeviceInfo = GBLogicDevice_info_find_by_device_index(uDeviceIndex);

    if (NULL != pGBLogicDeviceInfo)
    {
        pOutPacket->SetElementValue(AccNode, pGBLogicDeviceInfo->device_id);
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)"");
    }

    /* 是否定时执行 */
    AccNode = pOutPacket->CreateElement((char*)"ScheduledRun");
    snprintf(strScheduledRun, 16, "%d", iScheduledRun);
    pOutPacket->SetElementValue(AccNode, strScheduledRun);

    /* 开始时间*/
    AccNode = pOutPacket->CreateElement((char*)"StartTime");
    snprintf(strStartTime, 16, "%d", iStartTime);
    pOutPacket->SetElementValue(AccNode, strStartTime);

    /* 持续时间 */
    AccNode = pOutPacket->CreateElement((char*)"DurationTime");
    snprintf(strDurationTime, 16, "%d", iDurationTime);
    pOutPacket->SetElementValue(AccNode, strDurationTime);

    /* 是否正在执行 */
    AccNode = pOutPacket->CreateElement((char*)"Resved1");
    snprintf(strResved1, 16, "%d", iResved1);
    pOutPacket->SetElementValue(AccNode, strResved1);

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateCruiseActionConfigResponseXMLHead
 功能描述  : 创建获取巡航动作数据配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateCruiseActionConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_CRUISE_ACTION_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_CRUISE_ACTION_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_CRUISE_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_POLL_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_CRUISE_ACTION_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_CRUISE_ACTION_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_CRUISE_ACTION_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateCruiseActionConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"CruiseActionConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"CruiseActionConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddCruiseActionConfigToXMLItem
 功能描述  : 添加巡航动作数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             int iCruiseID
             unsigned int uDeviceIndex
             int iPresetID
             int iLiveTime
             int iSortID
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年7月6日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddCruiseActionConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, int iCruiseID, unsigned int uDeviceIndex, int iPresetID, int iLiveTime, int iSortID)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strCruiseID[16] = {0};
    char strDeviceIndex[32] = {0};
    char strPresetID[16] = {0};
    char strLiveTime[16] = {0};
    char strSortID[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddCruiseActionConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* CruiseID */
    AccNode = pOutPacket->CreateElement((char*)"CruiseID");
    snprintf(strCruiseID, 16, "%d", iCruiseID);
    pOutPacket->SetElementValue(AccNode, strCruiseID);

    /* DeviceIndex */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIndex");
    snprintf(strDeviceIndex, 32, "%u", uDeviceIndex);
    pOutPacket->SetElementValue(AccNode, strDeviceIndex);

    /* PresetID */
    AccNode = pOutPacket->CreateElement((char*)"PresetID");
    snprintf(strPresetID, 16, "%d", iPresetID);
    pOutPacket->SetElementValue(AccNode, strPresetID);

    /* LiveTime */
    AccNode = pOutPacket->CreateElement((char*)"LiveTime");
    snprintf(strLiveTime, 16, "%d", iLiveTime);
    pOutPacket->SetElementValue(AccNode, strLiveTime);

    /* DestSortID */
    AccNode = pOutPacket->CreateElement((char*)"SortID");
    snprintf(strSortID, 16, "%d", iSortID);
    pOutPacket->SetElementValue(AccNode, strSortID);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateWebInterfaceConfigResponseXMLHead
 功能描述  : 创建获取URL信息配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strUserID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateWebInterfaceConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strUserID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateWebInterfaceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_WEB_INTERFACE_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_WEB_INTERFACE_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"WebInterFaceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"WebInterFaceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_WEB_INTERFACE_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_WEB_INTERFACE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateWebInterfaceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_WEB_INTERFACE_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"WebInterFaceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"WebInterFaceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_WEB_INTERFACE_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_WEB_INTERFACE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateWebInterfaceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"WebInterFaceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"UserID");

        if (NULL != strUserID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strUserID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"WebInterFaceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddWebInterfaceConfigToXMLItem
 功能描述  : 添加URL数据配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             int iWebStytle
             string& strURL
             string& strServerIP
             int iPort
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月4日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddWebInterfaceConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, int iWebStytle, string& strURL, string& strServerIP, int iPort)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strWebStytle[16] = {0};
    char strPort[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddWebInterfaceConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 风格 */
    AccNode = pOutPacket->CreateElement((char*)"WebStytle");
    snprintf(strWebStytle, 16, "%d", iWebStytle);
    pOutPacket->SetElementValue(AccNode, strWebStytle);

    /* URL */
    AccNode = pOutPacket->CreateElement((char*)"URL");
    pOutPacket->SetElementValue(AccNode, (char*)strURL.c_str());

    /* ServerIP */
    AccNode = pOutPacket->CreateElement((char*)"ServerIP");
    pOutPacket->SetElementValue(AccNode, (char*)strServerIP.c_str());

    /* 风格 */
    AccNode = pOutPacket->CreateElement((char*)"Port");
    snprintf(strPort, 16, "%d", iPort);
    pOutPacket->SetElementValue(AccNode, strPort);

    /* 保留1 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved1");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    /* 保留2 */
    //AccNode = pOutPacket->CreateElement((char*)"Resved2");
    //pOutPacket->SetElementValue(AccNode, (char*)"");

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateRecordInfoQueryResponseXMLHead
 功能描述  : 创建获取录像文件查询回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             char* strDeviceName
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年8月6日 星期二
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int CreateRecordInfoQueryResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, char* strDeviceName, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateRecordInfoQueryResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_USER_RECORD_INFO_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_USER_RECORD_INFO_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Name");

        if (NULL != strDeviceName)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceName);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)" ");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"RecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_USER_RECORD_INFO_COUT_SEND == 1) && (record_count - query_count >= MAX_USER_RECORD_INFO_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateRecordInfoQueryResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_USER_RECORD_INFO_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Name");

        if (NULL != strDeviceName)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceName);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)" ");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"RecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);

    }
    else if ((query_count % MAX_USER_RECORD_INFO_COUT_SEND == 1) && (record_count - query_count < MAX_USER_RECORD_INFO_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateRecordInfoQueryResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"RecordInfo");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Name");

        if (NULL != strDeviceName)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceName);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)" ");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"RecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);

    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddDeviceMapGroupConfigToXMLItem
 功能描述  : 添加录像文件信息到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             VideoRecord& stVideoRecord
             char* strDeviceID
             char* strDeviceName
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int AddRecordInfoToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, VideoRecord& stVideoRecord, char* strDeviceID, char* strDeviceName)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    //char strStorageIndex[32] = {0};
    char strStartTime[32] = {0};
    char strEndTime[32] = {0};
    char str_date[12] = {0};
    char str_time[12] = {0};
    //char strSize[32] = {0};
    time_t sStartTime;
    time_t sStopTime;
    struct tm local_start_time = { 0 };
    struct tm local_stop_time = { 0 };

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddRecordInfoToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

#if 0
    AccNode = pOutPacket->CreateElement((char*)"DeviceID");

    if (NULL != strDeviceID)
    {
        pOutPacket->SetElementValue(AccNode, strDeviceID);
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)"");
    }

    AccNode = pOutPacket->CreateElement((char*)"Name");

    if (NULL != strDeviceName)
    {
        pOutPacket->SetElementValue(AccNode, strDeviceName);
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)" ");
    }

    AccNode = pOutPacket->CreateElement((char*)"StorageIndex");
    snprintf(strStorageIndex, 32, "%d", stVideoRecord.StorageIndex);
    pOutPacket->SetElementValue(AccNode, strStorageIndex);
#endif

    AccNode = pOutPacket->CreateElement((char*)"StartTime");
    sStartTime = stVideoRecord.StartTime;
    localtime_r(&sStartTime, &local_start_time);
    memset(str_date, 0, 12);
    memset(str_time, 0, 12);
    memset(strStartTime, 0, 32);
    strftime(str_date, sizeof(str_date), "%Y-%m-%d", &local_start_time);
    strftime(str_time, sizeof(str_time), "%H:%M:%S", &local_start_time);
    snprintf(strStartTime, 32, "%sT%s", str_date, str_time);
    //DEBUG_TRACE(MODULE_USER, LOG_INFO,"AddDeviceGroupConfigToXMLItem() strStartTime=%s \r\n", strStartTime);
    pOutPacket->SetElementValue(AccNode, strStartTime);

    AccNode = pOutPacket->CreateElement((char*)"EndTime");
    sStopTime = stVideoRecord.StopTime;
    localtime_r(&sStopTime, &local_stop_time);
    memset(str_date, 0, 12);
    memset(str_time, 0, 12);
    memset(strEndTime, 0, 32);
    strftime(str_date, sizeof(str_date), "%Y-%m-%d", &local_stop_time);
    strftime(str_time, sizeof(str_time), "%H:%M:%S", &local_stop_time);
    snprintf(strEndTime, 32, "%sT%s", str_date, str_time);
    //DEBUG_TRACE(MODULE_USER, LOG_INFO,"AddDeviceGroupConfigToXMLItem() strEndTime=%s \r\n", strEndTime);
    pOutPacket->SetElementValue(AccNode, strEndTime);

#if 0
    AccNode = pOutPacket->CreateElement((char*)"Size");
    snprintf(strSize, 32, "%d", stVideoRecord.Size);
    pOutPacket->SetElementValue(AccNode, strSize);

    AccNode = pOutPacket->CreateElement((char*)"StorageIP");

    if (stVideoRecord.StorageIP.length() > 0)
    {
        pOutPacket->SetElementValue(AccNode, (char*)stVideoRecord.StorageIP.c_str());
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)"");
    }

    AccNode = pOutPacket->CreateElement((char*)"FilePath");

    if (stVideoRecord.StoragePath.length() > 0)
    {
        pOutPacket->SetElementValue(AccNode, (char*)stVideoRecord.StoragePath.c_str());
    }
    else
    {
        pOutPacket->SetElementValue(AccNode, (char*)"");
    }

    AccNode = pOutPacket->CreateElement((char*)"Address");
    pOutPacket->SetElementValue(AccNode, (char*)"Address 1");

    AccNode = pOutPacket->CreateElement((char*)"Secrecy");
    pOutPacket->SetElementValue(AccNode, (char*)"0");

    AccNode = pOutPacket->CreateElement((char*)"Type");
    pOutPacket->SetElementValue(AccNode, (char*)"time");

#endif

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateAlarmRecordResponseXMLHead
 功能描述  : 创建获取报警信息查询回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月11日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateAlarmRecordResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateAlarmRecordResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_ALARM_RECORD_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_ALARM_RECORD_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"AlarmRecord");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"AlarmRecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_ALARM_RECORD_COUT_SEND == 1) && (record_count - query_count >= MAX_ALARM_RECORD_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateAlarmRecordResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_ALARM_RECORD_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"AlarmRecord");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"AlarmRecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_ALARM_RECORD_COUT_SEND == 1) && (record_count - query_count < MAX_ALARM_RECORD_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateAlarmRecordResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"AlarmRecord");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"AlarmRecordList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddAlarmRecordToXMLItem
 功能描述  : 添加报警记录信息到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             unsigned int uID
             string& strDeviceID
             int iAlarmType
             int iAlarmLevel
             int iStartTime
             int iStopTime
             string& strInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年9月11日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddAlarmRecordToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, unsigned int uID, string& strDeviceID, int iAlarmType, int iAlarmLevel, int iStartTime, int iStopTime, string& strInfo)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[32] = {0};
    char strAlarmType[16] = {0};
    char strAlarmLevel[16] = {0};

    char strStartTime[32] = {0};
    char strEndTime[32] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddAlarmRecordToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* ID */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 32, "%u", uID);
    pOutPacket->SetElementValue(AccNode, strID);

    /* DeviceID */
    AccNode = pOutPacket->CreateElement((char*)"DeviceID");
    pOutPacket->SetElementValue(AccNode, (char*)strDeviceID.c_str());

    /* Type */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strAlarmType, 16, "%d", iAlarmType);
    pOutPacket->SetElementValue(AccNode, strAlarmType);

    /* Level */
    AccNode = pOutPacket->CreateElement((char*)"Level");
    snprintf(strAlarmLevel, 16, "%d", iAlarmLevel);
    pOutPacket->SetElementValue(AccNode, strAlarmLevel);

    /* StartTime */
    AccNode = pOutPacket->CreateElement((char*)"StartTime");
    snprintf(strStartTime, 32, "%d", iStartTime);
    pOutPacket->SetElementValue(AccNode, strStartTime);

    /* StopTime */
    AccNode = pOutPacket->CreateElement((char*)"StopTime");
    snprintf(strEndTime, 32, "%d", iStopTime);
    pOutPacket->SetElementValue(AccNode, strEndTime);

    /* Info */
    AccNode = pOutPacket->CreateElement((char*)"Info");
    pOutPacket->SetElementValue(AccNode, (char*)strInfo.c_str());

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateOnlineUserConfigResponseXMLHead
 功能描述  : 创建获取在线用户信息的XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年10月21日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateOnlineUserConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateOnlineUserConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_ONLINE_USER_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_ONLINE_USER_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"GetOnLineUser");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"OnLineUserList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_ONLINE_USER_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_ONLINE_USER_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateOnlineUserConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_ONLINE_USER_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"GetOnLineUser");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"OnLineUserList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_ONLINE_USER_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_ONLINE_USER_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateOnlineUserConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"GetOnLineUser");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"OnLineUserList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddOnlineUserConfigToXMLItem
 功能描述  : 添加在线用户信息到XML消息
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             unsigned int uUserIndex
             string& strUserName
             string& strRealName
             string& strLoginIP
             int iPort
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年10月21日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddOnlineUserConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, unsigned int uUserIndex, string& strUserName, string& strRealName, string& strTel, string& strResved2, string& strLoginIP, int iPort)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strUserIndex[64] = {0};
    char strPort[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddOnlineUserConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strUserIndex, 64, "%u", uUserIndex);
    pOutPacket->SetElementValue(AccNode, strUserIndex);

    /* 用户名 */
    AccNode = pOutPacket->CreateElement((char*)"UserName");
    pOutPacket->SetElementValue(AccNode, (char*)strUserName.c_str());

    /* 真实名 */
    AccNode = pOutPacket->CreateElement((char*)"RealName");
    pOutPacket->SetElementValue(AccNode, (char*)strRealName.c_str());

    /* 联系方式 */
    AccNode = pOutPacket->CreateElement((char*)"Tel");
    pOutPacket->SetElementValue(AccNode, (char*)strTel.c_str());

    /* 备注2 */
    AccNode = pOutPacket->CreateElement((char*)"Resved2");
    pOutPacket->SetElementValue(AccNode, (char*)strResved2.c_str());

    /* 登录IP地址 */
    AccNode = pOutPacket->CreateElement((char*)"LoginIP");
    pOutPacket->SetElementValue(AccNode, (char*)strLoginIP.c_str());

    /* 端口 */
    AccNode = pOutPacket->CreateElement((char*)"Port");
    snprintf(strPort, 16, "%d", iPort);
    pOutPacket->SetElementValue(AccNode, strPort);

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateTopologyPhyDeviceConfigResponseXMLHead
 功能描述  : 创建获取拓扑物理设备配置表XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年11月27日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateTopologyPhyDeviceConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateTopologyPhyDeviceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"TopologyPhyDeviceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"TopologyPhyDeviceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND == 1) && (record_count - query_count >= MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateTopologyPhyDeviceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"TopologyPhyDeviceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"TopologyPhyDeviceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND == 1) && (record_count - query_count < MAX_TOPOLOGY_DEVICE_CONFIG_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateTopologyPhyDeviceConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"TopologyPhyDeviceConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"TopologyPhyDeviceConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddTopologyPhyDeviceConfigToXMLItem
 功能描述  : 添加获取拓扑物理设备配置表XML消息
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             string& strDeviceID
             string& strDeviceName
             int iDeviceType
             string& strDeviceIP
             int iStatus
             string& strCMSID
             int iLinkType
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2014年11月27日 星期四
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddTopologyPhyDeviceConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, string& strDeviceID, string& strDeviceName, int iDeviceType, string& strDeviceIP, int iStatus, string& strCMSID, int iLinkType)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strDeviceType[16] = {0};
    char strStatus[16] = {0};
    char strLinkType[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddTopologyPhyDeviceConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 设备ID */
    AccNode = pOutPacket->CreateElement((char*)"DeviceID");
    pOutPacket->SetElementValue(AccNode, (char*)strDeviceID.c_str());

    /* 设备名称 */
    AccNode = pOutPacket->CreateElement((char*)"DeviceName");
    pOutPacket->SetElementValue(AccNode, (char*)strDeviceName.c_str());

    /* 设备类型 */
    AccNode = pOutPacket->CreateElement((char*)"DeviceType");
    snprintf(strDeviceType, 16, "%d", iDeviceType);
    pOutPacket->SetElementValue(AccNode, strDeviceType);

    /* 设备IP */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIP");
    pOutPacket->SetElementValue(AccNode, (char*)strDeviceIP.c_str());

    /* 设备状态 */
    AccNode = pOutPacket->CreateElement((char*)"Status");
    snprintf(strStatus, 16, "%d", iStatus);
    pOutPacket->SetElementValue(AccNode, strStatus);

    /* 所属 CMS 编号 */
    AccNode = pOutPacket->CreateElement((char*)"CMSID");
    pOutPacket->SetElementValue(AccNode, (char*)strCMSID.c_str());

    /* 是否同级 */
    AccNode = pOutPacket->CreateElement((char*)"LinkType");
    snprintf(strLinkType, 16, "%d", iLinkType);
    pOutPacket->SetElementValue(AccNode, strLinkType);

    return 0;
}

/*****************************************************************************
 函 数 名  : CreateLableRecordConfigResponseXMLHead
 功能描述  : 创建获取标签录像信息的XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年04月06日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreateLableRecordConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateLableRecordConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_LABLE_RECORD_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_LABLE_RECORD_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LabelRecordConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LabelRecordConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_LABLE_RECORD_COUT_SEND == 1) && (record_count - query_count >= MAX_LABLE_RECORD_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateLableRecordConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_LABLE_RECORD_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LabelRecordConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LabelRecordConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_LABLE_RECORD_COUT_SEND == 1) && (record_count - query_count < MAX_LABLE_RECORD_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreateLableRecordConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"LabelRecordConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");

        if (NULL != strSN)
        {
            (*pOutPacket)->SetElementValue(AccNode, strSN);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");

        if (NULL != strDeviceID)
        {
            (*pOutPacket)->SetElementValue(AccNode, strDeviceID);
        }
        else
        {
            (*pOutPacket)->SetElementValue(AccNode, (char*)"");
        }

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"LabelRecordConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddLableRecordConfigToXMLItem
 功能描述  : 添加标签录像信息到XML消息
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             unsigned int uID
             unsigned int uLableTime
             string& strInfo
             int iType
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年04月06日 星期二
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int AddLableRecordConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, unsigned int uID, unsigned int uLabelTime, string& strInfo, int iType)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[32] = {0};
    char strLabelTime[32] = {0};
    char strType[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddLableRecordConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 32, "%u", uID);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 时间 */
    AccNode = pOutPacket->CreateElement((char*)"LabelTime");
    snprintf(strLabelTime, 32, "%u", uLabelTime);
    pOutPacket->SetElementValue(AccNode, strLabelTime);

    /* 信息内容 */
    AccNode = pOutPacket->CreateElement((char*)"Info");
    pOutPacket->SetElementValue(AccNode, (char*)strInfo.c_str());

    /* 类型 */
    AccNode = pOutPacket->CreateElement((char*)"Type");
    snprintf(strType, 16, "%d", iType);
    pOutPacket->SetElementValue(AccNode, strType);

    return 0;
}

/*****************************************************************************
 函 数 名  : CreatePresetConfigResponseXMLHead
 功能描述  : 创建获取预置位配置表回应XML头部
 输入参数  : CPacket** pOutPacket
             int query_count
             int record_count
             char* strSN
             char* strDeviceID
             DOMElement** ListAccNode
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年3月20日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int CreatePresetConfigResponseXMLHead(CPacket** pOutPacket, int query_count, int record_count, char* strSN, char* strDeviceID, DOMElement** ListAccNode)
{
    DOMElement* AccNode = NULL;

    char strSumNum[32] = {0};
    char strRecordCount[32] = {0};

    snprintf(strSumNum, 32, "%d", record_count);

    /* 添加发送的xml头部 */
    if (query_count == 1)
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePresetConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        if (record_count <= MAX_DEVICE_PRESET_COUT_SEND)
        {
            snprintf(strRecordCount, 32, "%d", record_count);
        }
        else
        {
            snprintf(strRecordCount, 32, "%d", MAX_DEVICE_PRESET_COUT_SEND);
        }

        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PresetConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PresetConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_PRESET_COUT_SEND == 1) && (record_count - query_count >= MAX_DEVICE_PRESET_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePresetConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", MAX_DEVICE_PRESET_COUT_SEND);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PresetConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PresetConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }
    else if ((query_count % MAX_DEVICE_PRESET_COUT_SEND == 1) && (record_count - query_count < MAX_DEVICE_PRESET_COUT_SEND))
    {
        *pOutPacket = new CPacket();

        if (NULL == *pOutPacket)
        {
            DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "CreatePresetConfigResponseXMLHead() exit---: Create XML Packet Error \r\n");
            return -1;
        }

        snprintf(strRecordCount, 32, "%d", record_count - query_count + 1);
        (*pOutPacket)->SetRootTag("Response");

        AccNode = (*pOutPacket)->CreateElement((char*)"CmdType");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"PresetConfig");

        AccNode = (*pOutPacket)->CreateElement((char*)"SN");
        (*pOutPacket)->SetElementValue(AccNode, strSN);

        AccNode = (*pOutPacket)->CreateElement((char*)"DeviceID");
        (*pOutPacket)->SetElementValue(AccNode, strDeviceID);

        AccNode = (*pOutPacket)->CreateElement((char*)"Result");
        (*pOutPacket)->SetElementValue(AccNode, (char*)"OK");

        AccNode = (*pOutPacket)->CreateElement((char*)"SumNum");
        (*pOutPacket)->SetElementValue(AccNode, strSumNum);

        (*ListAccNode) = (*pOutPacket)->CreateElement((char*)"PresetConfigList");
        (*pOutPacket)->SetElementAttr((*ListAccNode), (char*)"Num", strRecordCount);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : AddPresetConfigToXMLItem
 功能描述  : 添加预置位配置到XML的Item
 输入参数  : CPacket* pOutPacket
             DOMElement* ListAccNode
             int id
             int nDeviceIndex
             int nPresetID
             string& strPresetName
             int nResved1
             string& strResved2
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2013年7月27日 星期六
    作    者   : yanghaifeng
    修改内容   : 新生成函数

*****************************************************************************/
int AddPresetConfigToXMLItem(CPacket* pOutPacket, DOMElement* ListAccNode, int id, unsigned int nDeviceIndex, int nPresetID, string& strPresetName, int nResved1, string& strResved2)
{
    DOMElement* ItemAccNode = NULL;
    DOMElement* AccNode = NULL;

    char strID[16] = {0};
    char strDeviceIndex[32] = {0};
    char strPresetID[16] = {0};
    char strResved1[16] = {0};

    if (NULL == pOutPacket || NULL == ListAccNode)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "AddDeviceGroupConfigToXMLItem() exit---: Param Error \r\n");
        return -1;
    }

    /* 填写XML数据*/
    pOutPacket->SetCurrentElement(ListAccNode);
    ItemAccNode = pOutPacket->CreateElement((char*)"Item");
    pOutPacket->SetCurrentElement(ItemAccNode);

    /* 索引 */
    AccNode = pOutPacket->CreateElement((char*)"ID");
    snprintf(strID, 16, "%d", id);
    pOutPacket->SetElementValue(AccNode, strID);

    /* 点位索引 */
    AccNode = pOutPacket->CreateElement((char*)"DeviceIndex");
    snprintf(strDeviceIndex, 32, "%u", nDeviceIndex);
    pOutPacket->SetElementValue(AccNode, strDeviceIndex);

    /* 预置位ID */
    AccNode = pOutPacket->CreateElement((char*)"PresetID");
    snprintf(strPresetID, 16, "%d", nPresetID);
    pOutPacket->SetElementValue(AccNode, strPresetID);

    /* 预置位名称 */
    AccNode = pOutPacket->CreateElement((char*)"PresetName");
    pOutPacket->SetElementValue(AccNode, (char*)strPresetName.c_str());

    /* 预留1 */
    AccNode = pOutPacket->CreateElement((char*)"Resved1");
    snprintf(strResved1, 16, "%d", nResved1);
    pOutPacket->SetElementValue(AccNode, strResved1);

    /* 预留2 */
    AccNode = pOutPacket->CreateElement((char*)"Resved2");
    pOutPacket->SetElementValue(AccNode, (char*)strResved2.c_str());

    return 0;
}

/*****************************************************************************
 函 数 名  : UserLockDeviceProc
 功能描述  : 用户锁定操作处理
 输入参数  : char* strLockCmd
             char* strDeviceID
             user_info_t* pUserInfo
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年4月7日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int UserLockDeviceProc(char* strLockCmd, char* strDeviceID, user_info_t* pUserInfo)
{
    int i = 0;
    user_info_t* pOldUserInfo = NULL;
    GBLogicDevice_info_t* pGBLogicDeviceInfo = NULL;

    if (NULL == strLockCmd || NULL == strDeviceID || NULL == pUserInfo)
    {
        return -1;
    }

    pGBLogicDeviceInfo = GBLogicDevice_info_find(strDeviceID);

    if (NULL != pGBLogicDeviceInfo)
    {
        if (0 == sstrcmp(strLockCmd, (char*)"Lock")) /* 锁定 */
        {
            if (LOCK_STATUS_OFF == pGBLogicDeviceInfo->lock_status) /* 没有锁定 */
            {
                pGBLogicDeviceInfo->lock_status = LOCK_STATUS_USER_LOCK;
                pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                pGBLogicDeviceInfo->pLockUserInfo = pUserInfo;

                i = device_auto_unlock_use(pGBLogicDeviceInfo->id);

                if (i != 0)
                {
                    SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"添加到自动解锁队列失败");
                    EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Adding to the list of auto unlock failed.");
                    DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                }
                else
                {
                    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理, 锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User device control command processing, lock point successfully:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_use OK \r\n");
                }
            }
            else if (LOCK_STATUS_USER_LOCK == pGBLogicDeviceInfo->lock_status) /* 已经被用户锁定 */
            {
                if (NULL != pGBLogicDeviceInfo->pLockUserInfo) /* 原有用户锁定存在 */
                {
                    /* 高等级用户直接抢占原有锁定用户 */
                    if (pUserInfo->user_level > pGBLogicDeviceInfo->pLockUserInfo->user_level)
                    {
                        pOldUserInfo = pGBLogicDeviceInfo->pLockUserInfo;

                        pGBLogicDeviceInfo->lock_status = LOCK_STATUS_USER_LOCK;
                        pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                        pGBLogicDeviceInfo->pLockUserInfo = pUserInfo;

                        i = device_auto_unlock_use(pGBLogicDeviceInfo->id);

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"添加到自动解锁队列失败");
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Adding to the list of auto unlock failed.");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 抢占锁定原有锁定点位:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原有锁定用户ID=%s, 原有锁定用户IP地址=%s, 原有锁定用户端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pOldUserInfo->user_id, pOldUserInfo->login_ip, pOldUserInfo->login_port);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing,Preempt the lock locking original point:User ID=%s, IP=%s, port=%d, Logice Device ID=%s, Original Lock User ID=%s, Original Lock User IP=%s, Original Lock User Port=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pOldUserInfo->user_id, pOldUserInfo->login_ip, pOldUserInfo->login_port);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_use OK \r\n");
                        }
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 锁定的用户ID=%s, 锁定的用户IP地址=%s, 锁定的用户端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"点位已经被高等级用户锁定", pGBLogicDeviceInfo->pLockUserInfo->user_id, pGBLogicDeviceInfo->pLockUserInfo->login_ip, pGBLogicDeviceInfo->pLockUserInfo->login_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Device Has locked by high level User");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                    }
                }
                else /* 原有用户锁定无效 */
                {
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_USER_LOCK;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                    pGBLogicDeviceInfo->pLockUserInfo = pUserInfo;

                    i = device_auto_unlock_use(pGBLogicDeviceInfo->id);

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"添加到自动解锁队列失败");
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Adding to the list of auto unlock failed.");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有锁定用户失效, 锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing, lock point successfully:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_use OK \r\n");
                    }
                }
            }
            else if (LOCK_STATUS_ROUTE_LOCK == pGBLogicDeviceInfo->lock_status) /* 已经被上级锁定 */
            {
                if (NULL != pGBLogicDeviceInfo->pLockRouteInfo) /* 原有上级锁定存在 */
                {
                    /* 判断上级是否有效 */
                    if (0 == pGBLogicDeviceInfo->pLockRouteInfo->reg_status) /* 原有上级锁定无效 */
                    {
                        /* 更改为用户锁定 */
                        pGBLogicDeviceInfo->lock_status = LOCK_STATUS_USER_LOCK;
                        pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                        pGBLogicDeviceInfo->pLockUserInfo = pUserInfo;

                        i = device_auto_unlock_use(pGBLogicDeviceInfo->id);

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"添加到自动解锁队列失败");
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Adding to the list of auto unlock failed.");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有上级锁定信息失效，更改为用户锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing,original superior lock information failure, changing the locking points for the user successfully :用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_use OK \r\n");
                        }
                    }
                    else /* 有效 */
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 锁定的上级CMS ID=%s, 锁定的上级CMS IP地址=%s, 锁定的上级CMS 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"点位已经被上级平台锁定", pGBLogicDeviceInfo->pLockRouteInfo->server_id, pGBLogicDeviceInfo->pLockRouteInfo->server_ip, pGBLogicDeviceInfo->pLockRouteInfo->server_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Device Has locked by route CMS");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                    }
                }
                else /* 原有上级锁定无效 */
                {
                    /* 更改为用户锁定 */
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_USER_LOCK;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                    pGBLogicDeviceInfo->pLockUserInfo = pUserInfo;

                    i = device_auto_unlock_use(pGBLogicDeviceInfo->id);

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"添加到自动解锁队列失败");
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Adding to the list of auto unlock failed.");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有上级锁定信息失效，更改为用户锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing,original superior lock information failure, changing the locking points for the user successfully :用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_use OK \r\n");
                    }
                }
            }
        }
        else if (0 == sstrcmp(strLockCmd, (char*)"UnLock")) /* 解除锁定 */
        {
            if (LOCK_STATUS_USER_LOCK == pGBLogicDeviceInfo->lock_status) /* 已经被用户锁定 */
            {
                if (NULL != pGBLogicDeviceInfo->pLockUserInfo) /* 判断用户锁定是否有效 */
                {
                    /* 判断是否锁定的是否就是该用户 */
                    if (pGBLogicDeviceInfo->pLockUserInfo == pUserInfo)
                    {
                        pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                        pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                        pGBLogicDeviceInfo->pLockUserInfo = NULL;

                        i = device_auto_unlock_remove(pGBLogicDeviceInfo->id);

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"从自动解锁队列移除失败");
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, unlock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Remove from the list of auto unlock failed.");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_remove Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户设备控制命令处理, 解除锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User device control command processing, unlock point successfully:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_remove OK \r\n");
                        }
                    }
                    else /* 原有锁定是其他用户锁定 */
                    {
                        /* 高等级的用户可以直接解锁低等级的用户锁定 */
                        if (pUserInfo->user_level > pGBLogicDeviceInfo->pLockUserInfo->user_level)
                        {
                            pOldUserInfo = pGBLogicDeviceInfo->pLockUserInfo;

                            pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                            pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                            pGBLogicDeviceInfo->pLockUserInfo = NULL;

                            i = device_auto_unlock_remove(pGBLogicDeviceInfo->id);

                            if (i != 0)
                            {
                                SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"从自动解锁队列移除失败");
                                EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, unlock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Remove from the list of auto unlock failed.");
                                DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_remove Error \r\n");
                            }
                            else
                            {
                                SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 解除原有低等级锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原有锁定用户ID=%s, 原有锁定用户IP地址=%s, 原有锁定用户端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pOldUserInfo->user_id, pOldUserInfo->login_ip, pOldUserInfo->login_port);
                                EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing, Remove the original lower level locking point successfully:User ID=%s, IP=%s, port=%d, Logic Device ID=%s, Original Lock User ID=%s, Original Lock User IP=%s, Original Lock User port=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, pOldUserInfo->user_id, pOldUserInfo->login_ip, pOldUserInfo->login_port);
                                DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_remove OK \r\n");
                            }
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 锁定的用户ID=%s, 锁定的用户IP地址=%s, 锁定的用户端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"点位已经被高等级用户锁定", pGBLogicDeviceInfo->pLockUserInfo->user_id, pGBLogicDeviceInfo->pLockUserInfo->login_ip, pGBLogicDeviceInfo->pLockUserInfo->login_port);
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Device Has locked by high level User");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                        }
                    }
                }
                else /* 原有锁定用户无效 */
                {
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                    pGBLogicDeviceInfo->pLockUserInfo = NULL;

                    i = device_auto_unlock_remove(pGBLogicDeviceInfo->id);

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"从自动解锁队列移除失败");
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, unlock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Remove from the list of auto unlock failed");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_remove Error \r\n");
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有锁定用户已经无效, 解除锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing, Original lock users is invalid, unlock point successfully:User ID=%s, IP=%s, port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_remove OK \r\n");
                    }
                }
            }
            else if (LOCK_STATUS_ROUTE_LOCK == pGBLogicDeviceInfo->lock_status)
            {
                if (NULL != pGBLogicDeviceInfo->pLockRouteInfo) /* 判断锁定上级平台是否有效 */
                {
                    if (0 == pGBLogicDeviceInfo->pLockRouteInfo->reg_status) /* 原有上级锁定无效 */
                    {
                        pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                        pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                        pGBLogicDeviceInfo->pLockUserInfo = NULL;

                        i = device_auto_unlock_remove(pGBLogicDeviceInfo->id);

                        if (i != 0)
                        {
                            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"从自动解锁队列移除失败");
                            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, unlock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Remove from the list of auto unlock failed.");
                            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_remove Error \r\n");
                        }
                        else
                        {
                            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有锁定上级平台已经无效, 解除锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing, Original locking superior platform is invalid, unlock point successfully:User ID=%s, IP=%s, port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                            DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_remove OK \r\n");
                        }
                    }
                    else /* 有效 */
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s, 锁定的上级CMS ID=%s, 锁定的上级CMS IP地址=%s, 锁定的上级CMS 端口号=%d", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"点位已经被上级CMS锁定", pGBLogicDeviceInfo->pLockRouteInfo->server_id, pGBLogicDeviceInfo->pLockRouteInfo->server_ip, pGBLogicDeviceInfo->pLockRouteInfo->server_port);
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Device Has locked by high CMS");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_use Error \r\n");
                    }
                }
                else /* 原有上级锁定无效 */
                {
                    pGBLogicDeviceInfo->lock_status = LOCK_STATUS_OFF;
                    pGBLogicDeviceInfo->pLockRouteInfo = NULL;
                    pGBLogicDeviceInfo->pLockUserInfo = NULL;

                    i = device_auto_unlock_remove(pGBLogicDeviceInfo->id);

                    if (i != 0)
                    {
                        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 解除锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"从自动解锁队列移除失败");
                        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, unlock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, (char*)"Remove from the list of auto unlock failed.");
                        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() device_auto_unlock_remove Error \r\n");
                    }
                    else
                    {
                        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "用户设备控制命令处理, 原有锁定上级平台已经无效, 解除锁定点位成功:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_WARNING, "User device control command processing, Original locking superior platform is invalid, unlock point successfully:User ID=%s, IP=%s, port=%d, Logic Device ID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID);
                        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserLockDeviceProc() device_auto_unlock_remove OK \r\n");
                    }
                }
            }
            else if (LOCK_STATUS_OFF == pGBLogicDeviceInfo->lock_status)
            {

            }
        }
        else
        {
            SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=不支持的锁定命令:LockCmd=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strLockCmd);
            EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, Lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s,  reason=unsupportable lock command:LockCmd=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strLockCmd);
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() Lock Cmd Error: LockCmd=%s \r\n", strLockCmd);
            return -1;
        }
    }
    else
    {
        SystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "用户设备控制命令处理, 锁定点位失败:用户ID=%s, IP地址=%s, 端口号=%d, 逻辑设备ID=%s, 原因=查找逻辑设备失败:DeviceID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
        EnSystemLog(EV9000_CMS_DEVICE_CONTROL_ERROR, EV9000_LOG_LEVEL_ERROR, "User device control command processing, Lock point failed:User ID=%s, User IP=%s, Port=%d, Logic Device ID=%s, reason=find logical device failed:DeviceID=%s", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, strDeviceID, strDeviceID);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserLockDeviceProc() exit---: Find GB LogicDevice Info Error: DeviceID=%s \r\n", strDeviceID);
        return -1;
    }

    return 0;
}

#if DECS("用户登录的时候通过TCP获取信息")
/*****************************************************************************
 函 数 名  : UserTCPLoginParseClientData
 功能描述  : 解析客户端命令
 输入参数  : char* user_ip
             int user_port
             int user_sock
             unsigned char* buf
             int len
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年8月29日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int UserTCPLoginParseClientData(char* user_ip, int user_port, int user_sock, char* buf, int len, DBOper* pDbOper)
{
    int i = 0;
    xml_type_t xml_type = XML_TYPE_NULL;
    CPacket inPacket;
    vector<string> NodeName_Vector;

    if (NULL == user_ip || user_sock <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG,  "UserTCPLoginParseClientData() exit---: Param Error \r\n");
        return -1;
    }

    if (buf == NULL || len <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG,  "UserTCPLoginParseClientData() exit---: Buffer Error \r\n");
        return -1;
    }

    if (NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG,  "UserTCPLoginParseClientData() exit---: DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "UserTCPLoginParseClientData() User: IP=%s, Port=%d, Socket=%d, buf=%s \r\n", user_ip, user_port, user_sock, buf);

    //解析XML
    i = inPacket.BuiltTree(buf, len);//生成DOM树结构.

    if (i < 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR,  "UserTCPLoginParseClientData() exit---: XML Build Tree Error \r\nmsg=%s \r\n", buf);
        return -99;
    }

    NodeName_Vector.clear();
    DOMDocument* pDOMDocument = inPacket.GetDOMDocument();
    DOMElement* pDOMElement = pDOMDocument->get_root();
    pDOMElement->ClearNodeNumber();

    if (pDOMElement->GetNodeName(NodeName_Vector) <= 0)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserTCPLoginParseClientData() exit---: Get Node Name Error \r\n");
        return -1;
    }

    /* 解析出xml的消息类型 */
    xml_type = get_xml_type_from_xml_body(NodeName_Vector, inPacket);
    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "UserTCPLoginParseClientData() get_xml_type_from_xml_body:xml_type=%d \r\n", xml_type);

    switch (xml_type)
    {
        case XML_QUERY_CATALOG :
            i = user_tcp_query_catalog_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_CATALOG_RCU:
            i = user_tcp_query_RCU_catalog_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_DEVICEGROUP:               /* 逻辑设备分组信息 */
            i = user_tcp_query_device_group_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_USERDEVICEGROUP:           /* 逻辑设备重新分组信息 */
            i = user_tcp_query_user_device_group_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_DEVICEMAPGROUP :
            i = user_tcp_query_device_map_group_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_USERDEVICEMAPGROUP :
            i = user_tcp_query_user_device_map_group_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_NOTIFY_KEEPLIVE :
            i = user_tcp_notify_keep_alive_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_NOTIFY_TCP_CONNECT_INFO :
            i = user_tcp_notify_tcp_connect_info_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_NOTIFY_SHDB_CMD : /* 用户通知上海地标协议操作 */
            i = user_tcp_notify_cmd_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_SERVERID : /* 查询服务器ID */
            i = user_tcp_get_service_id_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_USERCONFIG : /* 用户配置获取 */
            i = user_tcp_query_user_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        case XML_QUERY_WEBINTERFACECONFIG : /* 获取 URL信息  */
            i = user_tcp_query_web_interface_config_proc(user_ip, user_port, user_sock, inPacket, pDbOper);
            break;

        default:
            DEBUG_TRACE(MODULE_USER, LOG_ERROR, "UserTCPLoginParseClientData() exit---: Not Support Message Type:%d \r\n", xml_type);
            return -1;
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_catalog_proc
 功能描述  : 用户TCP方式获取点位信息
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年8月29日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_catalog_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strUserID[32] = {0};

    user_info_t* pUserInfo = NULL;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_catalog_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_catalog_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d \r\n", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"UserID", strUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_catalog_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s,UserID=%s \r\n", strSN, strDeviceID, strUserID);

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取逻辑设备信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access logic device information through TCP,user IP:%s , port=%d , user Sock= %d.", user_ip, user_port, user_sock);

    /* 获取用户信息 */
    pUserInfo = user_info_get_by_user_id(strUserID);

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_catalog_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error:UserID=%s \r\n", user_ip, user_port, user_sock, strUserID);
        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取逻辑设备信息失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s, UserID=%s", user_ip, user_port, user_sock, (char*)"获取用户信息失败", strUserID);
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to access logic device information through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d, UserID= %s", user_ip, user_port, user_sock, (char*)"Failed to get user information", strUserID);
        return -1;
    }

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        i = UserGetAllGBDeviceListAndSendCataLogToClientForTCP(user_ip, user_port, user_sock, strDeviceID, strSN, pDbOper);
    }
    else
    {
        i = UserGetGBDeviceListAndSendCataLogToClientForTCP(user_ip, user_port, user_sock, pUserInfo->user_index, strDeviceID, strSN, pDbOper);
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_catalog_proc() Exit---\r\n");

    return i;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_RCU_catalog_proc
 功能描述  : 用户TCP方式获取RCU点位信息
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年10月12日 星期六
    作    者   : 李磊
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_RCU_catalog_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strUserID[32] = {0};

    user_info_t* pUserInfo = NULL;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_RCU_catalog_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_RCU_catalog_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d \r\n", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"UserID", strUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_RCU_catalog_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s,UserID=%s \r\n", strSN, strDeviceID, strUserID);

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取RCU逻辑设备信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access RCU logic device information through TCP,user IP:%s , port=%d , user Sock= %d.", user_ip, user_port, user_sock);

    /* 获取用户信息 */
    pUserInfo = user_info_get_by_user_id(strUserID);

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_RCU_catalog_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error:UserID=%s \r\n", user_ip, user_port, user_sock, strUserID);
        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取RCU逻辑设备信息失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s, UserID=%s", user_ip, user_port, user_sock, (char*)"获取用户信息失败", strUserID);
        EnSystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to access RCU logic device information through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d, UserID= %s", user_ip, user_port, user_sock, (char*)"Failed to get user information", strUserID);
        return -1;
    }

    if (0 == sstrcmp(pUserInfo->user_name, (char*)"WiscomV") || 0 == sstrcmp(pUserInfo->user_name, (char*)"admin"))
    {
        i = UserGetAllGBDeviceListAndSendRCUCataLogToClientForTCP(user_ip, user_port, user_sock, strDeviceID, strSN, pDbOper);
    }
    else
    {
        i = UserGetGBDeviceListAndSendRCUCataLogToClientForTCP(user_ip, user_port, user_sock, pUserInfo->user_index, strDeviceID, strSN, pDbOper);
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_RCU_catalog_proc() Exit---\r\n");

    return i;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_device_group_config_proc
 功能描述  : 用户通过TCP获取逻辑设备分组配置表
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年12月6日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_device_group_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    int iRet = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};

    EV9000_TCP_Head stTCPHead;
    EV9000_LogicDeviceGroupConfig stEV9000LogicDeviceGroup;

    string strSQL = "";
    int while_count = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_device_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取默认逻辑设备分组配置信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_device_group_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组配置信息 */
    strSQL.clear();
    strSQL = "select * from LogicDeviceGroupConfig order by GroupID asc";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_query_device_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取默认逻辑设备分组配置信息查询数据库失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_device_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_device_group_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户通过TCP获取默认逻辑设备分组配置信息查询数据库失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_device_group_config_proc() exit---: No Record Count \r\n");
        return 0;
    }

    /* 通过结构体发送出去 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(record_count);
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int id = 0;
        string strName = "";
        string strGroupID = "";
        int SortID = 0;
        string strParentID = "";

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_device_group_config_proc() While Count=%d \r\n", while_count);
        }

        memset(&stEV9000LogicDeviceGroup, 0, sizeof(EV9000_LogicDeviceGroupConfig));

        /* 索引 */
        pDbOper->GetFieldValue("ID", id);
        stEV9000LogicDeviceGroup.nID = htonl(id);

        /* 点位组编号 */
        strGroupID.clear();
        pDbOper->GetFieldValue("GroupID", strGroupID);
        osip_strncpy(stEV9000LogicDeviceGroup.strGroupID, (char*)strGroupID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 组名称 */
        strName.clear();
        pDbOper->GetFieldValue("Name", strName);
        osip_strncpy(stEV9000LogicDeviceGroup.strName, (char*)strName.c_str(), EV9000_LONG_STRING_LEN);

        /* 同一父节点下组排序编号 */
        SortID = 0;
        pDbOper->GetFieldValue("SortID", SortID);
        stEV9000LogicDeviceGroup.nSortID = htonl(SortID);

        /* 父节点编号 */
        strParentID.clear();
        pDbOper->GetFieldValue("ParentID", strParentID);
        osip_strncpy(stEV9000LogicDeviceGroup.strParentID, (char*)strParentID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 发送出去 */
        iRet = send(user_sock, &stEV9000LogicDeviceGroup, sizeof(EV9000_LogicDeviceGroupConfig), 0);

        if (iRet <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取默认逻辑设备分组配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, iRet, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取默认逻辑设备分组配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, iRet);
        }
    }
    while (pDbOper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取默认逻辑设备分组配置信息成功:用户IP=%s, 端口号=%d, Socket=%d, 记录数=%d", user_ip, user_port, user_sock, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取默认逻辑设备分组配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"发送响应消息失败");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_device_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_user_device_group_config_proc
 功能描述  : 用户通过TCP获取逻辑设备重新分组配置表
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年12月6日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_user_device_group_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    int iRet = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strUserIndex[32] = {0};

    EV9000_TCP_Head stTCPHead;
    EV9000_LogicDeviceGroupConfig stEV9000LogicDeviceGroup;

    string strSQL = "";
    int while_count = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_user_device_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户逻辑设备分组配置信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserIndex", strUserIndex);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_user_device_group_config_proc() \
        \r\n XML Para: \
        \r\n SN=%s, UserIndex=%s \r\n", strSN, strUserIndex);

    /* 如果查询的用户索引为空 */
    if (strUserIndex[0] == '\0')
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组配置信息失败:用户IP=%s, 用户端口=%d, 用户Sock, 原因=%s", user_ip, user_port, user_sock, (char*)"查询的用户索引为空");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_group_config_proc() exit---: User Index Is NULL \r\n");
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组配置信息 */
    strSQL.clear();
    strSQL = "select * from UserLogicDeviceGroupConfig WHERE UserIndex = ";
    strSQL += strUserIndex;
    strSQL += " order by GroupID asc";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_query_user_device_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组配置信息查询数据库失败:用户IP=%s, 用户端口=%d, 用户Sock, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_group_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户通过TCP获取默认逻辑设备分组配置信息查询数据库失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_user_device_group_config_proc() exit---: No Record Count \r\n");
        return 0;
    }

    /* 通过结构体发送出去 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(record_count);
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int id = 0;
        string strName = "";
        string strGroupID = "";
        int SortID = 0;
        string strParentID = "";

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_user_device_group_config_proc() While Count=%d \r\n", while_count);
        }

        memset(&stEV9000LogicDeviceGroup, 0, sizeof(EV9000_LogicDeviceGroupConfig));

        /* 索引 */
        pDbOper->GetFieldValue("ID", id);
        stEV9000LogicDeviceGroup.nID = htonl(id);

        /* 点位组编号 */
        strGroupID.clear();
        pDbOper->GetFieldValue("GroupID", strGroupID);
        osip_strncpy(stEV9000LogicDeviceGroup.strGroupID, (char*)strGroupID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 组名称 */
        strName.clear();
        pDbOper->GetFieldValue("Name", strName);
        osip_strncpy(stEV9000LogicDeviceGroup.strName, (char*)strName.c_str(), EV9000_LONG_STRING_LEN);

        /* 同一父节点下组排序编号 */
        SortID = 0;
        pDbOper->GetFieldValue("SortID", SortID);
        stEV9000LogicDeviceGroup.nSortID = htonl(SortID);

        /* 父节点编号 */
        strParentID.clear();
        pDbOper->GetFieldValue("ParentID", strParentID);
        osip_strncpy(stEV9000LogicDeviceGroup.strParentID, (char*)strParentID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 发送出去 */
        iRet = send(user_sock, &stEV9000LogicDeviceGroup, sizeof(EV9000_LogicDeviceGroupConfig), 0);

        if (iRet <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, iRet, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户逻辑设备分组配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, iRet);
        }
    }
    while (pDbOper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户获通过TCP取用户逻辑设备分组配置信息成功:用户IP=%s, 用户端口=%d, 用户Sock=%d, 记录数=%d", user_ip, user_port, user_sock, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组配置信息失败:用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"发送响应消息失败");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_user_device_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_device_map_group_config_proc
 功能描述  : 用户通过TCP方式获取分组关系
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年8月29日 星期六
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_device_map_group_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    /* 用户登录成功之后获取逻辑设备分组关系配置表
      */
    int i = 0;
    int iRet = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strDeviceID[32] = {0};

    EV9000_TCP_Head stTCPHead;
    EV9000_LogicDeviceMapGroupConfig stEV9000LogicDeviceMapGroup;

    string strSQL = "";
    int while_count = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_device_map_group_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_device_map_group_config_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d \r\n", user_ip, user_port, user_sock);
    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取默认逻辑设备分组关系配置信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User failed to access logic device group information through TCP，User IP=%s, User port=%d, User Sock=%d", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_device_map_group_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, DeviceID=%s \r\n", strSN, strDeviceID);

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组关系配置关系信息 */
    strSQL.clear();
    strSQL = "select * from LogicDeviceMapGroupConfig";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_query_device_map_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通过TCP获取默认逻辑设备分组关系配置信息开始查询数据库失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User failed to access the default logic device group information through TCP because database query failed:User IP=%s, User port=%d, User Sock=%d, reason=%s:%s", user_ip, user_port, user_sock, (char*)"Failed to query the database", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_device_map_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_device_map_group_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户通过TCP获取默认逻辑设备分组关系配置信息查询数据库失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "User failed to access the default logic device group relationship information through TCP because database query failed:User IP=%s, User port=%d, User Sock=%d, reason=%s", user_ip, user_port, user_sock, (char*)"No data has been queried from the database.");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_device_map_group_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    /* 通过结构体发送出去 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(record_count);
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

    do
    {
        unsigned int id = 0;
        string strGroupID = "";
        unsigned int DeviceIndex = 0;
        string strCMSID = "";
        unsigned int SortID = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_device_map_group_config_proc() While Count=%d \r\n", while_count);
        }

        memset(&stEV9000LogicDeviceMapGroup, 0, sizeof(EV9000_LogicDeviceMapGroupConfig));

        /* 索引 */
        pDbOper->GetFieldValue("ID", id);
        stEV9000LogicDeviceMapGroup.nID = htonl(id);

        /* 点位组编号 */
        strGroupID.clear();
        pDbOper->GetFieldValue("GroupID", strGroupID);
        osip_strncpy(stEV9000LogicDeviceMapGroup.strGroupID, (char*)strGroupID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 逻辑设备索引 */
        pDbOper->GetFieldValue("DeviceIndex", DeviceIndex);
        stEV9000LogicDeviceMapGroup.nDeviceIndex = htonl(DeviceIndex);

        /* CMS 编号 */
        strCMSID.clear();
        pDbOper->GetFieldValue("CMSID", strCMSID);
        osip_strncpy(stEV9000LogicDeviceMapGroup.strCMSID, (char*)strCMSID.c_str(), EV9000_IDCODE_LEN);

        /* 排序编号 */
        pDbOper->GetFieldValue("SortID", SortID);
        stEV9000LogicDeviceMapGroup.nSortID = htonl(SortID);

        /* 发送出去 */
        iRet = send(user_sock, &stEV9000LogicDeviceMapGroup, sizeof(EV9000_LogicDeviceMapGroupConfig), 0);

        if (iRet <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取默认逻辑设备分组关系配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, iRet, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取默认逻辑设备分组关系配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, iRet);
        }
    }
    while (pDbOper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户通过TCP获取默认逻辑设备分组关系配置信息成功:用户IP=%s, 端口号=%d, Socket=%d, 记录数=%d", user_ip, user_port, user_sock, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "User successfully access the default logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, records=%d", user_ip, user_port, user_sock, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户获取默认逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"发送消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User failed to access the default logic device group relationship information:User IP=%s, User port=%d, User Sock=%d, reason=%s", user_ip, user_port, user_sock, (char*)"Send message failed.");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_device_map_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_user_device_map_group_config_proc
 功能描述  : 用户通过TCP方式获取逻辑设备重新分组关系配置表
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年8月31日 星期一
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_user_device_map_group_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    /* 用户登录成功之后获取逻辑设备分组关系配置表
      */
    int i = 0;
    int iRet = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char strUserIndex[32] = {0};

    EV9000_TCP_Head stTCPHead;
    EV9000_LogicDeviceMapGroupConfig stEV9000LogicDeviceMapGroup;

    string strSQL = "";
    int while_count = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_user_device_map_group_config_proc() exit---: User Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_user_device_map_group_config_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d \r\n", user_ip, user_port, user_sock);
    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户逻辑设备分组关系配置信息，用户IP=%s, 用户端口=%d, 用户Sock=%d", user_ip, user_port, user_sock);
    EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "User access the user logic device group relationship information，User IP=%s, User port=%d, User Sock=%d", user_ip, user_port, user_sock);

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserIndex", strUserIndex);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_user_device_map_group_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserIndex=%s \r\n", strSN, strUserIndex);

    /* 如果查询的用户索引为空 */
    if (strUserIndex[0] == '\0')
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"查询的用户索引为空");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR, "User failed to access the user logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, reason=%s", user_ip, user_port, user_sock, (char*)"The user index for querying is empty");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_map_group_config_proc() exit---: User Index Is NULL \r\n");
        return -1;
    }

    /* 根据查询条件，查找数据库，找到相应的逻辑设备分组关系配置关系信息 */
    strSQL.clear();
    strSQL = "select * from UserLogicDeviceMapGroupConfig as G, UserLogicDeviceGroupConfig as GDP WHERE G.GroupID = GDP.GroupID and GDP.UserIndex = ";
    strSQL += strUserIndex;
    strSQL += " order by G.GroupID asc";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_query_user_device_map_group_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通过TCP获取用户逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User failed to access the user logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, reason=%s:%s", user_ip, user_port, user_sock, (char*)"Failed to query the database", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_map_group_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_device_map_group_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }

    if (record_count == 0)
    {
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = 0;
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "用户通过TCP获取用户逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_WARNING,  "User failed to access the user logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, reason=%s", user_ip, user_port, user_sock, (char*)"No data has been queried from the database.");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_user_device_map_group_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    /* 通过结构体发送出去 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(record_count);
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

    do
    {
        unsigned int id = 0;
        string strGroupID = "";
        unsigned int DeviceIndex = 0;
        unsigned int SortID = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_device_map_group_config_proc() While Count=%d \r\n", while_count);
        }

        memset(&stEV9000LogicDeviceMapGroup, 0, sizeof(EV9000_LogicDeviceMapGroupConfig));

        /* 索引 */
        pDbOper->GetFieldValue("ID", id);
        stEV9000LogicDeviceMapGroup.nID = htonl(id);

        /* 点位组编号 */
        strGroupID.clear();
        pDbOper->GetFieldValue("GroupID", strGroupID);
        osip_strncpy(stEV9000LogicDeviceMapGroup.strGroupID, (char*)strGroupID.c_str(), EV9000_SHORT_STRING_LEN);

        /* 逻辑设备索引 */
        pDbOper->GetFieldValue("DeviceIndex", DeviceIndex);
        stEV9000LogicDeviceMapGroup.nDeviceIndex = htonl(DeviceIndex);

        /* 排序编号 */
        pDbOper->GetFieldValue("SortID", SortID);
        stEV9000LogicDeviceMapGroup.nSortID = htonl(SortID);

        /* 发送出去 */
        iRet = send(user_sock, &stEV9000LogicDeviceMapGroup, sizeof(EV9000_LogicDeviceMapGroupConfig), 0);

        if (iRet <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户逻辑设备分组关系配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, iRet, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户逻辑设备分组关系配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, iRet);
        }
    }
    while (pDbOper->MoveNext() >= 0);

    if (i == 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "用户通过TCP获取用户逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 记录数=%d", user_ip, user_port, user_sock, record_count);
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL,  "User failed to access the user logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, records=%d", user_ip, user_port, user_sock, record_count);
    }
    else
    {
        SystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "用户通过TCP获取用户逻辑设备分组关系配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"发送消息失败");
        EnSystemLog(EV9000_CMS_GET_DEIVCE_MAP_GROUP_ERROR, EV9000_LOG_LEVEL_ERROR,  "User failed to access the user logic device group relationship information through TCP:User IP=%s, User port=%d, User Sock=%d, reason=%s", user_ip, user_port, user_sock, (char*)"Send message failed");
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_device_map_group_config_proc() Exit--- \r\n");

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_notify_keep_alive_proc
 功能描述  : 用户通过TCP接口保活
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2015年11月16日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_notify_keep_alive_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strStatus[32] = {0};
    char strPort[32] = {0};
    char strAlarmMsgSendFlag[32] = {0};
    char strTVWALLStatusMsgSendFlag[32] = {0};
    int iUserPort = 0;
    user_info_t* pUserInfo = NULL;
    EV9000_TCP_Head stTCPHead;
    EV9000_TCP_Data stTCPData;
    char* msg = NULL;
    int msg_len = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_notify_keep_alive_proc() exit---: User Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_notify_keep_alive_proc() Enter---: user_ip=%s, user_port=%d\r\n", user_ip, user_port);

    /* 设备状态信息报送消息
          控制流程见9.6.2.

          命令包括如下字段:
          <!-- 命令类型：设备状态信息报送（必选） -->
          < element name="CmdType" fixed ="Keepalive" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 源设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 是否正常工作（必选） -->
          <element name="Status" type="tg:resultType" />
          <AlarmMsgSendFlag>ON/OFF</AlarmMsgSendFlag>                  // 告警消息发送标识:ON:发送，OFF:不发送,默认不发送
          <TVWALLStatusMsgSendFlag>ON/OFF</TVWALLStatusMsgSendFlag>    // 电视墙状态消息发送标识:ON:发送，OFF:不发送,默认不发送
    */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"Status", strStatus);
    inPacket.GetElementValue((char*)"Port", strPort);
    inPacket.GetElementValue((char*)"AlarmMsgSendFlag", strAlarmMsgSendFlag);
    inPacket.GetElementValue((char*)"TVWALLStatusMsgSendFlag", strTVWALLStatusMsgSendFlag);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_notify_keep_alive_proc() \
    \r\n XML Para: \
    \r\n SN=%s, DeviceID=%s, Port=%s, Status=%s, AlarmMsgSendFlag=%s, TVWALLStatusMsgSendFlag=%s\r\n ", strSN, strDeviceID, strPort, strStatus, strAlarmMsgSendFlag, strTVWALLStatusMsgSendFlag);

    if (strPort[0] != '\0')
    {
        iUserPort = osip_atoi(strPort);
    }
    else
    {
        iUserPort = 5062;
    }

    /* 获取用户信息 */
    if (strDeviceID[0] != '\0')
    {
        pUserInfo = user_info_get_by_user_info(strDeviceID, user_ip, iUserPort);
    }
    else
    {
        pUserInfo = user_info_get_by_user_ip_and_port(user_ip, iUserPort);
    }

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_notify_keep_alive_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error\r\n", user_ip, user_port, user_sock);
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP保活失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"获取用户信息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to keep alive through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d", user_ip, user_port, user_sock, (char*)"Failed to get user information");
        return -1;
    }

    if (3 == pUserInfo->reg_status)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_notify_keep_alive_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error\r\n", user_ip, user_port, user_sock);
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP保活失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"用户即将注销");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to keep alive through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d", user_ip, user_port, user_sock, (char*)"Failed to get user information");
        return -1;
    }

    if (sstrcmp(strStatus, "OK") == 0)
    {
        if (pUserInfo->reg_status <= 0)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_notify_keep_alive_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }
        else if (pUserInfo->reg_status == 1)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_notify_keep_alive_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }

        SIP_UASUpdateRegisterExpires(pUserInfo->reg_info_index);

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(inPacket.GetXml(NULL).length());

        memset(&stTCPData, 0, sizeof(EV9000_TCP_Data));
        memcpy(&stTCPData.stTCPHead, &stTCPHead, sizeof(EV9000_TCP_Head));
        msg = (char*)inPacket.GetXml(NULL).c_str();
        msg_len = inPacket.GetXml(NULL).length();
        memcpy(&stTCPData.stTCPBody, msg, msg_len);

        i = send(user_sock, &stTCPData, sizeof(EV9000_TCP_Head) + msg_len, 0);

        if (i <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP保活, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, i, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP保活, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, i);
        }

        /* 设置告警消息发送标识 */
        if (strAlarmMsgSendFlag[0] != '\0')
        {
            if (sstrcmp(strAlarmMsgSendFlag, "ON") == 0)
            {
                pUserInfo->alarm_info_send_flag = 1;
            }
            else if (sstrcmp(strAlarmMsgSendFlag, "OFF") == 0)
            {
                pUserInfo->alarm_info_send_flag = 0;
            }
            else
            {
                pUserInfo->alarm_info_send_flag = 0;
            }
        }

        /* 设置电视墙消息发送标识 */
        if (strTVWALLStatusMsgSendFlag[0] != '\0')
        {
            if (sstrcmp(strTVWALLStatusMsgSendFlag, "ON") == 0)
            {
                pUserInfo->tvwall_status_send_flag = 1;
            }
            else if (sstrcmp(strTVWALLStatusMsgSendFlag, "OFF") == 0)
            {
                pUserInfo->tvwall_status_send_flag = 0;
            }
            else
            {
                pUserInfo->tvwall_status_send_flag = 0;
            }
        }
        else
        {
            pUserInfo->tvwall_status_send_flag = 0;
        }

        /* 设置用户的TCP 保活 Socket */
        pUserInfo->tcp_keep_alive_sock = user_sock;

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP通知保活成功: 用户IP=%s, 用户端口=%d, 用户Sock=%d, 告警消息发送标识=%s, 电视墙状态消息发送标识=%s", user_ip, user_port, user_sock, strAlarmMsgSendFlag, strTVWALLStatusMsgSendFlag);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_notify_cmd_proc
 功能描述  : 用户通过TCP通知上海地标消息
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年3月21日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_notify_cmd_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int iRet = 0;
    int iUserPort = 0;
    char strPort[32] = {0};
    char strUserID[32] = {0};
    char strSubType[16] = {0};
    int iSubType = 0;
    user_info_t* pUserInfo = NULL;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_notify_cmd_proc() exit---: User Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_notify_cmd_proc() Enter---: user_ip=%s, user_port=%d\r\n", user_ip, user_port);

    /* 设备状态信息报送消息
          控制流程见9.6.2.

          命令包括如下字段:
          <!-- 命令类型：设备状态信息报送（必选） -->
          < element name="CmdType" fixed ="Keepalive" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 源设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 是否正常工作（必选） -->
          <element name="Status" type="tg:resultType" />
     */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"UserID", strUserID);
    inPacket.GetElementValue((char*)"Port", strPort);
    inPacket.GetElementValue((char*)"SubType", strSubType);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_notify_cmd_proc() \
    \r\n XML Para: \
    \r\n UserID=%s, Port=%s, SubType=%s \r\n ", strUserID, strPort, strSubType);

    if (strPort[0] != '\0')
    {
        iUserPort = osip_atoi(strPort);
    }
    else
    {
        iUserPort = 5062;
    }

    /* 获取用户信息 */
    if (strUserID[0] != '\0')
    {
        pUserInfo = user_info_get_by_user_info(strUserID, user_ip, iUserPort);
    }
    else
    {
        pUserInfo = user_info_get_by_user_ip_and_port(user_ip, iUserPort);
    }

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_notify_cmd_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error\r\n", user_ip, user_port, user_sock);
        SystemLog(EV9000_CMS_SEND_NOTIFY_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通知上海地标命令失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"获取用户信息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to notify cmd through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d", user_ip, user_port, user_sock, (char*)"Failed to get user information");
        return -1;
    }

    iSubType = osip_atoi(strSubType);

    //iRet = shdb_user_notify_cmd_proc(pUserInfo, iSubType, inPacket, pDbOper);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_notify_cmd_proc() Exit---: shdb_user_notify_cmd_proc: iRet=%d\r\n", iRet);

    return iRet;
}

/*****************************************************************************
 函 数 名  : user_tcp_notify_tcp_connect_info_proc
 功能描述  : 用户通过TCP连接通知TCP连接信息
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年1月5日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_notify_tcp_connect_info_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    char strSN[32] = {0};
    char strDeviceID[32] = {0};
    char strStatus[32] = {0};
    char strPort[32] = {0};
    char strAlarmMsgSendFlag[32] = {0};
    char strTVWALLStatusMsgSendFlag[32] = {0};
    int iUserPort = 0;
    user_info_t* pUserInfo = NULL;
    EV9000_TCP_Head stTCPHead;
    EV9000_TCP_Data stTCPData;
    char* msg = NULL;
    int msg_len = 0;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_notify_tcp_connect_info_proc() exit---: User Info Error \r\n");
        return -1;
    }

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_notify_tcp_connect_info_proc() Enter---: user_ip=%s, user_port=%d\r\n", user_ip, user_port);

    /* 设备状态信息报送消息
          控制流程见9.6.2.

          命令包括如下字段:
          <!-- 命令类型：设备状态信息报送（必选） -->
          < element name="CmdType" fixed ="TCPConnectInfo" />
          <!-- 命令序列号（必选） -->
          <element name="SN" type="integer" minInclusive value = "1" />
          <!-- 源设备的设备编码（必选） -->
          <element name="DeviceID" type="tg:deviceIDType" />
          <!-- 是否正常工作（必选） -->
          <element name="Status" type="tg:resultType" />
          <AlarmMsgSendFlag>ON/OFF</AlarmMsgSendFlag>                  // 告警消息发送标识:ON:发送，OFF:不发送,默认不发送
          <TVWALLStatusMsgSendFlag>ON/OFF</TVWALLStatusMsgSendFlag>    // 电视墙状态消息发送标识:ON:发送，OFF:不发送,默认不发送
    */

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"DeviceID", strDeviceID);
    inPacket.GetElementValue((char*)"Status", strStatus);
    inPacket.GetElementValue((char*)"Port", strPort);
    inPacket.GetElementValue((char*)"AlarmMsgSendFlag", strAlarmMsgSendFlag);
    inPacket.GetElementValue((char*)"TVWALLStatusMsgSendFlag", strTVWALLStatusMsgSendFlag);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_notify_tcp_connect_info_proc() \
    \r\n XML Para: \
    \r\n SN=%s, DeviceID=%s, Port=%s, Status=%s, AlarmMsgSendFlag=%s, TVWALLStatusMsgSendFlag=%s\r\n ", strSN, strDeviceID, strPort, strStatus, strAlarmMsgSendFlag, strTVWALLStatusMsgSendFlag);

    if (strPort[0] != '\0')
    {
        iUserPort = osip_atoi(strPort);
    }
    else
    {
        iUserPort = 5062;
    }

    /* 获取用户信息 */
    if (strDeviceID[0] != '\0')
    {
        pUserInfo = user_info_get_by_user_info(strDeviceID, user_ip, iUserPort);
    }
    else
    {
        pUserInfo = user_info_get_by_user_ip_and_port(user_ip, iUserPort);
    }

    if (NULL == pUserInfo)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_notify_tcp_connect_info_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error\r\n", user_ip, user_port, user_sock);
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP通知TCP连接信息失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"获取用户信息失败");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to keep alive through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d", user_ip, user_port, user_sock, (char*)"Failed to get user information");
        return -1;
    }

    if (3 == pUserInfo->reg_status)
    {
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_notify_tcp_connect_info_proc() Enter---: user_ip=%s, user_port=%d, user_sock=%d: Get User Info Error\r\n", user_ip, user_port, user_sock);
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP通知TCP连接信息失败，用户IP=%s, 用户端口=%d, 用户Sock=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"用户即将注销");
        EnSystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "User failed to keep alive through TCP,user IP:%s , port=d% , user Sock=%d ,reason= %d", user_ip, user_port, user_sock, (char*)"Failed to get user information");
        return -1;
    }

    if (sstrcmp(strStatus, "OK") == 0)
    {
        if (pUserInfo->reg_status <= 0)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_notify_tcp_connect_info_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }
        else if (pUserInfo->reg_status == 1)
        {
            pUserInfo->reg_status = 2;
            DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_notify_tcp_connect_info_proc():user_id=%s, login_ip=%s, login_port=%d, reg_status=%d \r\n", pUserInfo->user_id, pUserInfo->login_ip, pUserInfo->login_port, pUserInfo->reg_status);
        }

        SIP_UASUpdateRegisterExpires(pUserInfo->reg_info_index);

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(inPacket.GetXml(NULL).length());

        memset(&stTCPData, 0, sizeof(EV9000_TCP_Data));
        memcpy(&stTCPData.stTCPHead, &stTCPHead, sizeof(EV9000_TCP_Head));
        msg = (char*)inPacket.GetXml(NULL).c_str();
        msg_len = inPacket.GetXml(NULL).length();
        memcpy(&stTCPData.stTCPBody, msg, msg_len);

        i = send(user_sock, &stTCPData, sizeof(EV9000_TCP_Head) + msg_len, 0);

        if (i <= 0)
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP通知TCP连接信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, i, errno);
        }
        else
        {
            SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP通知TCP连接信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, i);
        }

        /* 设置告警消息发送标识 */
        if (strAlarmMsgSendFlag[0] != '\0')
        {
            if (sstrcmp(strAlarmMsgSendFlag, "ON") == 0)
            {
                pUserInfo->alarm_info_send_flag = 1;
            }
            else if (sstrcmp(strAlarmMsgSendFlag, "OFF") == 0)
            {
                pUserInfo->alarm_info_send_flag = 0;
            }
            else
            {
                pUserInfo->alarm_info_send_flag = 0;
            }
        }
        else
        {
            pUserInfo->alarm_info_send_flag = 0;
        }

        /* 设置电视墙消息发送标识 */
        if (strTVWALLStatusMsgSendFlag[0] != '\0')
        {
            if (sstrcmp(strTVWALLStatusMsgSendFlag, "ON") == 0)
            {
                pUserInfo->tvwall_status_send_flag = 1;
            }
            else if (sstrcmp(strTVWALLStatusMsgSendFlag, "OFF") == 0)
            {
                pUserInfo->tvwall_status_send_flag = 0;
            }
            else
            {
                pUserInfo->tvwall_status_send_flag = 0;
            }
        }
        else
        {
            pUserInfo->tvwall_status_send_flag = 0;
        }

        /* 设置用户的TCP Socket */
        pUserInfo->tcp_sock = user_sock;

        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP通知TCP连接信息成功: 用户IP=%s, 用户端口=%d, 用户Sock=%d, 告警消息发送标识=%s, 电视墙状态消息发送标识=%s", user_ip, user_port, user_sock, strAlarmMsgSendFlag, strTVWALLStatusMsgSendFlag);
    }

    return 0;
}

/*****************************************************************************
 函 数 名  : user_tcp_get_service_id_proc
 功能描述  : 用户通过TCP获取服务器ID
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年12月15日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_get_service_id_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    int iRet = 0;
    char strSN[32] = {0};
    char strServerIP[MAX_IP_LEN] = {0};
    char strUserName[36] = {0};

    string strSQL = "";
    int record_count = 0;
    int iUserIndex = 0;
    int iUserEnable = 0;
    int iUserLevel = 0;
    string strUserID = "";
    string strUserPassword = "";

    vector<string> NodeName_Vector;
    CPacket outPacket;
    DOMElement* AccNode = NULL;
    char strErrorCode[32] = {0};
    EV9000_TCP_Head stTCPHead;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_get_service_id_proc() exit---: User Info Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"ServerIP", strServerIP);
    inPacket.GetElementValue((char*)"UserName", strUserName);

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前通过TCP开始获取服务器ID处理:用户IP=%s, 端口号=%d, Socket=%d, 用户名=%s, 服务器IP=%s", user_ip, user_port, user_sock, strUserName, strServerIP);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_get_service_id_proc() \
    \r\n XML Para: \
    \r\n SN=%s, ServerIP=%s, UserName=%s \r\n", strSN, strServerIP, strUserName);

    if (pGblconf->board_id[0] == '\0' || pGblconf->center_code[0] == '\0' || pGblconf->trade_code[0] == '\0')
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_LOCAL_CMS_ID_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"CMS ID Not Config Or Not Right");

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(outPacket.GetXml(NULL).length());
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
        send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"服务器ID没有配置或配置错误");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() exit---: CMS ID Not Config Or Not Right \r\n");
        return -1;

    }

    /* 看是否要插入默认数据 */
    if (sstrcmp(strUserName, (char*)"WiscomV") == 0)
    {
        iRet = InsertDefaultUserInfo(strUserName, pDbOper);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_get_service_id_proc() InsertDefaultUserInfo:iRet=%d \r\n", iRet);
    }
    else if (sstrcmp(strUserName, (char*)"admin") == 0)
    {
        iRet = InsertDefaultUserInfo(strUserName, pDbOper);
        DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_get_service_id_proc() InsertDefaultUserInfo:iRet=%d \r\n", iRet);
    }

    /* 从数据库获取用户ID */
    strSQL.clear();
    strSQL = "select * from UserConfig WHERE UserName like '";
    strSQL += strUserName;
    strSQL += "'";

    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    if (record_count < 0)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_OPER_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database Query Error");

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(outPacket.GetXml(NULL).length());
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
        send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_NORECORD_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database No Record");

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(outPacket.GetXml(NULL).length());
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
        send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }

    SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前通过TCP开始获取服务器ID查询数据库成功:用户IP=%s, 端口号=%d, Socket=%d", user_ip, user_port, user_sock);

    /* 用户索引 */
    iUserIndex = 0;
    pDbOper->GetFieldValue("ID", iUserIndex);

    /* 是否启用 */
    iUserEnable = 0;
    pDbOper->GetFieldValue("Enable", iUserEnable);

    /* 用户统一编号id */
    strUserID.clear();
    pDbOper->GetFieldValue("UserID", strUserID);

    /* 用户等级 */
    iUserLevel = 0;
    pDbOper->GetFieldValue("Level", iUserLevel);

    /* 用户密码 */
    strUserPassword.clear();
    pDbOper->GetFieldValue("Password", strUserPassword);

    if (!iUserEnable)
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_USER_NOTENABLE_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"User Not Enable");

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(outPacket.GetXml(NULL).length());
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
        send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"用户已经被禁用");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() exit---: Get User ID Error \r\n");
        return -1;
    }

    if (strUserID.empty())
    {
        /* 回复响应,组建消息 */
        outPacket.SetRootTag("Response");

        AccNode = outPacket.CreateElement((char*)"CmdType");
        outPacket.SetElementValue(AccNode, (char*)"GetServerID");

        AccNode = outPacket.CreateElement((char*)"SN");
        outPacket.SetElementValue(AccNode, strSN);

        AccNode = outPacket.CreateElement((char*)"Result");
        outPacket.SetElementValue(AccNode, (char*)"Error");

        AccNode = outPacket.CreateElement((char*)"ErrCode");
        memset(strErrorCode, 0, 32);
        snprintf(strErrorCode, 32, "%d", EV9000_CMS_ERR_DB_USERID_EMPTY_ERROR);
        outPacket.SetElementValue(AccNode, strErrorCode);

        AccNode = outPacket.CreateElement((char*)"Reason");
        outPacket.SetElementValue(AccNode, (char*)"Database User ID Empty");

        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(outPacket.GetXml(NULL).length());
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
        send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

        SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"获取数据库记录字段失败");
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_get_service_id_proc() exit---: Get User ID Error \r\n");
        return -1;
    }

    /* 回复响应,组建消息 */
    outPacket.SetRootTag("Response");

    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"GetServerID");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, (char*)strUserID.c_str());

    AccNode = outPacket.CreateElement((char*)"ServerID");
    outPacket.SetElementValue(AccNode, local_cms_id_get());

    /* 回复响应 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(outPacket.GetXml(NULL).length());
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
    i = send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

    if (i <= 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户登录前通过TCP开始获取服务器ID处理, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 用户名=%s, 返回的用户ID=%s, 服务器ID=%s, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, strUserName, (char*)strUserID.c_str(), local_cms_id_get(), i, errno);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户登录前通过TCP开始获取服务器ID处理, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 用户名=%s, 返回的用户ID=%s, 服务器ID=%s, 返回结果=%d", user_ip, user_port, user_sock, strUserName, (char*)strUserID.c_str(), local_cms_id_get(), i);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_user_config_proc
 功能描述  : 用户通过TCP获取用户配置
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2016年12月15日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_user_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    /* 用户登录成功之后获取配置信息
      */
    int i = 0;
    int record_count = 0;
    char strSN[32] = {0};
    char strUserID[32] = {0};

    char strID[32] = {0};
    int iID = 0;

    char strPermission[32] = {0};
    int iPermission = 0;
    char strLevel[32] = {0};
    int iLevel = 0;
    string strUserName = "";
    string strPassword = "";
    string strLogInIP = "";
    string strLogInMAC = "";

    CPacket outPacket;
    DOMElement* AccNode = NULL;
    string strSQL = "";
    EV9000_TCP_Head stTCPHead;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_user_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得查询条件数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", strUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_user_config_proc() \
    \r\n XML Para: \
    \r\n SN=%s, UserID=%s \r\n", strSN, strUserID);

    SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户配置信息:用户IP=%s, 端口号=%d, Socket=%d, 获取的用户ID=%s", user_ip, user_port, user_sock, strUserID);

    /* 根据查询条件，查找数据库，找到相应的录像记录 */
    strSQL.clear();
    strSQL = "select * from UserConfig WHERE UserID like '";
    strSQL += strUserID;
    strSQL += "'";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_TRACE, "user_tcp_query_user_config_proc() Select UserConfig:record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(0);
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_user_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(0);
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "用户通过TCP获取用户配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_query_user_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    pDbOper->GetFieldValue("ID", iID);
    pDbOper->GetFieldValue("Permission", iPermission);
    pDbOper->GetFieldValue("Level", iLevel);
    pDbOper->GetFieldValue("UserName", strUserName);
    pDbOper->GetFieldValue("Password", strPassword);
    pDbOper->GetFieldValue("LogInIP", strLogInIP);
    pDbOper->GetFieldValue("LogInMAC", strLogInMAC);

    /* 回复响应,组建消息 */
    outPacket.SetRootTag("Response");
    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"UserConfig");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"ID");
    snprintf(strID, 32, "%d", iID);
    outPacket.SetElementValue(AccNode, strID);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, strUserID);

    AccNode = outPacket.CreateElement((char*)"UserName");
    outPacket.SetElementValue(AccNode, (char*)strUserName.c_str());

    AccNode = outPacket.CreateElement((char*)"PassWord");
    outPacket.SetElementValue(AccNode, (char*)strPassword.c_str());

    AccNode = outPacket.CreateElement((char*)"Level");
    snprintf(strLevel, 32, "%d", iLevel);
    outPacket.SetElementValue(AccNode, strLevel);

    AccNode = outPacket.CreateElement((char*)"Permission");
    snprintf(strPermission, 32, "%d", iPermission);
    outPacket.SetElementValue(AccNode, strPermission);

    AccNode = outPacket.CreateElement((char*)"LoginIP");
    outPacket.SetElementValue(AccNode, user_ip);

    AccNode = outPacket.CreateElement((char*)"LoginMac");
    outPacket.SetElementValue(AccNode, (char*)strLogInMAC.c_str());

    AccNode = outPacket.CreateElement((char*)"Resved1");
    outPacket.SetElementValue(AccNode, (char*)"");

    AccNode = outPacket.CreateElement((char*)"Resved2");
    outPacket.SetElementValue(AccNode, (char*)"");

    /* 回复响应 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(outPacket.GetXml(NULL).length());
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
    i = send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

    if (i <= 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取用户配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, i, errno);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取用户配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, i);
    }

    return i;
}

/*****************************************************************************
 函 数 名  : user_tcp_query_web_interface_config_proc
 功能描述  : 用户通过TCP获取URL信息
 输入参数  : char* user_ip
             int user_port
             int user_sock
             CPacket& inPacket
             DBOper* pDbOper
 输出参数  : 无
 返 回 值  :
 调用函数  :
 被调函数  :

 修改历史      :
  1.日    期   : 2017年1月6日
    作    者   : 杨海锋
    修改内容   : 新生成函数

*****************************************************************************/
int user_tcp_query_web_interface_config_proc(char* user_ip, int user_port, int user_sock, CPacket& inPacket, DBOper* pDbOper)
{
    int i = 0;
    int record_count = 0; /* 记录数 */

    char strSN[32] = {0};
    char pcUserID[32] = {0};

    CPacket outPacket;
    DOMElement* AccNode = NULL;
    char strSumNum[32] = {0};

    string strSQL = "";
    int while_count = 0;
    EV9000_TCP_Head stTCPHead;

    if (NULL == user_ip || user_sock <= 0 || NULL == pDbOper)
    {
        DEBUG_TRACE(MODULE_USER, LOG_DEBUG, "user_tcp_query_web_interface_config_proc() exit---: User Srv DB Oper Error \r\n");
        return -1;
    }

    /* 取得数据*/
    inPacket.GetElementValue((char*)"SN", strSN);
    inPacket.GetElementValue((char*)"UserID", pcUserID);

    DEBUG_TRACE(MODULE_USER, LOG_INFO,  "user_tcp_query_web_interface_config_proc() \
            \r\n XML Para: \
            \r\n SN=%s, UserID=%s \r\n", strSN, pcUserID);

    SystemLog(EV9000_CMS_GET_SERVERID_ERROR, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取URL配置信息:用户IP=%s, 端口号=%d, Socket=%d, 获取的用户ID=%s", user_ip, user_port, user_sock, pcUserID);

    /* 根据UserID，查询预案权限表，获取planid */
    strSQL.clear();
    //strSQL = "select PC.* from PollConfig as PC, PollPermissionConfig as PP where PC.ID=PB.PollID and PC.UserID like '";
    strSQL = "select * from WebInterFaceConfig order by ID asc";
    record_count = pDbOper->DB_Select(strSQL.c_str(), 1);

    DEBUG_TRACE(MODULE_USER, LOG_INFO, "user_tcp_query_web_interface_config_proc() record_count=%d \r\n", record_count);

    if (record_count < 0)
    {
        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(0);
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取URL配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s:%s", user_ip, user_port, user_sock, (char*)"查询数据库失败", pDbOper->GetLastDbErrorMsg());
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_web_interface_config_proc() DB Oper Error:strSQL=%s, record_count=%d \r\n", strSQL.c_str(), record_count);
        DEBUG_TRACE(MODULE_USER, LOG_ERROR, "user_tcp_query_web_interface_config_proc() ErrorMsg=%s\r\n", pDbOper->GetLastDbErrorMsg());
        return -1;
    }
    else if (record_count == 0)
    {
        /* 回复响应 */
        memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
        stTCPHead.mark = '$';
        stTCPHead.length = htons(0);
        send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);

        SystemLog(EV9000_CMS_GET_USER_INFO_ERROR, EV9000_LOG_LEVEL_WARNING, "用户通过TCP获取URL配置信息失败:用户IP=%s, 端口号=%d, Socket=%d, 原因=%s", user_ip, user_port, user_sock, (char*)"未查询到数据库记录");
        DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_web_interface_config_proc() exit---: No Record Count \r\n");
        return i;
    }

    /* 回复响应,组建消息 */
    snprintf(strSumNum, 32, "%d", record_count);

    outPacket.SetRootTag("Response");
    AccNode = outPacket.CreateElement((char*)"CmdType");
    outPacket.SetElementValue(AccNode, (char*)"WebInterFaceConfig");

    AccNode = outPacket.CreateElement((char*)"SN");
    outPacket.SetElementValue(AccNode, strSN);

    AccNode = outPacket.CreateElement((char*)"UserID");
    outPacket.SetElementValue(AccNode, pcUserID);

    AccNode = outPacket.CreateElement((char*)"Result");
    outPacket.SetElementValue(AccNode, (char*)"OK");

    AccNode = outPacket.CreateElement((char*)"SumNum");
    outPacket.SetElementValue(AccNode, strSumNum);

    AccNode = outPacket.CreateElement((char*)"WebInterFaceConfigList");
    outPacket.SetElementAttr(AccNode, (char*)"Num", strSumNum);

    /* 循环查找数据库，将数据组成XML 发送给客户端 */
    do
    {
        int iID = 0;
        int iWebStytle = 0;
        string strURL = "";
        string strServerIP = "";
        int iPort = 0;

        while_count++;

        if (while_count % 10000 == 0)
        {
            DEBUG_TRACE(MODULE_USER, LOG_WARN, "user_tcp_query_web_interface_config_proc() While Count=%d \r\n", while_count);
        }

        /* 索引 */
        pDbOper->GetFieldValue("ID", iID);

        /* 风格 */
        pDbOper->GetFieldValue("WebStytle", iWebStytle);

        /* URL */
        strURL.clear();
        pDbOper->GetFieldValue("URL", strURL);

        /* 服务器IP */
        strServerIP.clear();
        pDbOper->GetFieldValue("ServerIP", strServerIP);

        /* 端口号 */
        pDbOper->GetFieldValue("Port", iPort);

        /* 加入Item 值 */
        i = AddWebInterfaceConfigToXMLItem(&outPacket, AccNode, iID, iWebStytle, strURL, strServerIP, iPort);
    }
    while (pDbOper->MoveNext() >= 0);

    /* 回复响应 */
    memset(&stTCPHead, 0, sizeof(EV9000_TCP_Head));
    stTCPHead.mark = '$';
    stTCPHead.length = htons(record_count);
    send(user_sock, &stTCPHead, sizeof(EV9000_TCP_Head), 0);
    i = send(user_sock, (char*)outPacket.GetXml(NULL).c_str(), outPacket.GetXml(NULL).length(), 0);

    if (i <= 0)
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_ERROR, "用户通过TCP获取URL配置信息, 发送结果给用户失败:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d, errno=%d", user_ip, user_port, user_sock, i, errno);
    }
    else
    {
        SystemLog(EV9000_CMS_SYSTEM_RUN_INFO, EV9000_LOG_LEVEL_NORMAL, "用户通过TCP获取URL配置信息, 发送结果给用户成功:用户IP=%s, 端口号=%d, Socket=%d, 返回结果=%d", user_ip, user_port, user_sock, i);
    }

    return 0;
}
#endif
